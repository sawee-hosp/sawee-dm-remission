<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>สวีคุมหวาน · ลงทะเบียน/แดชบอร์ด</title>

  <!-- Font ไทยสวยอ่านง่าย -->
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Thai:wght@300;400;600;700&display=swap" rel="stylesheet" />

  <!-- Chart.js สำหรับกราฟ -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <style>
    :root{
      --green:#06C755;
      --bg:#F4F7FB;
      --card:#fff;
      --text:#1d2433;
      --muted:#77839a;
      --ring:#e6edf7;
      --shadow: 0 10px 30px rgba(21, 24, 35, .06);
      --radius: 18px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; background:var(--bg); color:var(--text);
      font-family: "Noto Sans Thai", system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
    }
    .wrap{max-width:980px; margin:0 auto; padding:24px 16px 60px}
    header{display:flex; align-items:center; gap:12px; margin-bottom:14px}
    header .logo{
      width:40px; height:40px; border-radius:12px; background:var(--green);
      display:grid; place-items:center; color:#fff; font-weight:700; box-shadow:var(--shadow)
    }
    header h1{font-size:20px; margin:0 0 2px 0}
    header .sub{color:var(--muted); font-size:13px}

    .card{
      background:var(--card); border:1px solid var(--ring);
      border-radius:var(--radius); box-shadow:var(--shadow);
      padding:18px 16px; margin:14px 0;
    }
    .card h2{font-size:18px; margin:0 0 10px 0}
    .card .meta{color:var(--muted); font-size:13px}
    .row{display:grid; gap:14px}
    @media(min-width:820px){ .row.cols-2{grid-template-columns:1fr 1fr} }

    .form{display:grid; gap:14px}
    .field label{display:block; font-weight:600; margin-bottom:6px}
    .field input, .field select{
      width:100%; padding:12px 14px; border:1px solid var(--ring);
      border-radius:12px; background:#fbfdff; outline:none;
      font-size:15px;
    }
    .consent{display:flex; gap:10px; align-items:flex-start; font-size:14px; color:#223}
    .btn{
      width:100%; padding:14px 16px; border:0; border-radius:12px;
      background:var(--green); color:#fff; font-weight:700; font-size:16px;
      box-shadow:var(--shadow); cursor:pointer;
    }
    .btn[disabled]{opacity:.6; cursor:not-allowed}
    .ghost{background:#e9f7ee; color:#0a6b2a}

    .profile{
      display:flex; gap:12px; align-items:center;
    }
    .avatar{
      width:56px; height:56px; border-radius:16px; background:#eef2f7;
      background-size:cover; background-position:center; flex:none;
      border:1px solid var(--ring);
    }
    .kv{display:grid; grid-template-columns:120px 1fr; gap:6px 10px; font-size:15px}
    .chip{
      display:inline-flex; align-items:center; gap:8px;
      background:#f3f7fd; border:1px solid var(--ring);
      padding:6px 10px; border-radius:999px; font-size:13px; color:#265;
    }
    .goal{
      border:1px solid var(--ring); border-radius:14px; padding:12px; margin-top:10px; background:#fbfeff;
    }
    .goal h3{margin:0 0 6px 0; font-size:16px}
    .goal .small{font-size:13px; color:var(--muted)}
    canvas{width:100% !important; height:260px !important}
    .empty{color:var(--muted); font-style:italic}
    .note{font-size:12px; color:#666; margin-top:8px}
    .build{margin-top:10px; color:#9aa6b2; font-size:12px; text-align:center}
    .actions{display:flex; gap:10px; margin-top:8px; flex-wrap:wrap}
    .secondary{background:#f5f8fc; color:#1c2a39}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="logo">หวี</div>
      <div>
        <h1>สวีคุมหวาน</h1>
        <div class="sub">ลงทะเบียนผู้ป่วย · แดชบอร์ดส่วนตัว</div>
      </div>
    </header>

    <!-- SECTION: Registration (shown if no profile yet) -->
    <section id="sec-register" class="card" style="display:none">
      <h2>ลงทะเบียน</h2>
      <div class="meta">กรอกข้อมูลเบื้องต้นเพื่อให้พี่หวีดูแลได้เหมาะสม</div>
      <form id="registrationForm" class="form">
        <div class="field">
          <label for="hn">รหัสโรงพยาบาล (HN)</label>
          <input id="hn" name="hn" type="tel" inputmode="numeric" placeholder="เช่น 550001234 (เฉพาะตัวเลข)" required />
        </div>
        <div class="field">
          <label for="name_use">ชื่อที่อยากให้เรียก</label>
          <input id="name_use" name="name_use" type="text" placeholder="เช่น น้องส้ม / คุณอารีย์ / ลุงสมชาย" required />
        </div>
        <div class="field">
          <label for="gender">เพศ</label>
          <select id="gender" name="gender" required>
            <option value="">— เลือกเพศ —</option>
            <option value="Male">ชาย</option>
            <option value="Female">หญิง</option>
            <option value="Other">อื่น ๆ / ไม่ระบุ</option>
          </select>
        </div>
        <div class="field">
          <label for="age">อายุ (ปี)</label>
          <input id="age" name="age" type="tel" inputmode="numeric" pattern="[0-9]*" placeholder="เช่น 52" required />
        </div>
        <label class="consent">
          <input id="pdpa" type="checkbox" required />
          <span>ฉันยินยอมให้เก็บและประมวลผลข้อมูลส่วนบุคคล/สุขภาพเพื่อการดูแลรักษา (PDPA)</span>
        </label>
        <button id="submitBtn" class="btn" type="submit">ลงทะเบียน</button>
        <div id="regStatus" class="note"></div>
      </form>
    </section>

    <!-- SECTION: Dashboard (shown if profile exists) -->
    <section id="sec-dash" style="display:none">
      <!-- Profile -->
      <div class="card">
        <h2>ข้อมูลส่วนตัว</h2>
        <div class="profile">
          <div id="avatar" class="avatar"></div>
          <div>
            <div id="displayName" style="font-weight:700; font-size:16px">—</div>
            <div id="nameUse" class="meta">—</div>
            <div class="actions">
              <button id="btnRefresh" class="btn secondary" type="button">รีเฟรชข้อมูล</button>
              <button id="btnEdit" class="btn secondary" type="button">แก้ไขข้อมูล</button>
            </div>
          </div>
        </div>
        <div class="kv" style="margin-top:12px">
          <div class="meta">HN</div><div id="kvHN">—</div>
          <div class="meta">เพศ</div><div id="kvGender">—</div>
          <div class="meta">อายุ</div><div id="kvAge">—</div>
          <div class="meta">ลงทะเบียนเมื่อ</div><div id="kvCreated">—</div>
        </div>
      </div>

      <!-- Goals -->
      <div class="card">
        <h2>เป้าหมาย (SMART Goals)</h2>
        <div id="goalsWrap" class="row"></div>
        <div id="goalsEmpty" class="empty" style="display:none">ยังไม่มีการตั้งเป้าหมาย</div>
      </div>

      <!-- History & Charts -->
      <div class="card">
        <h2>ประวัติการบันทึก</h2>
        <div id="chartsWrap" class="row cols-2"></div>
        <div id="chartsEmpty" class="empty" style="display:none">ยังไม่มีข้อมูลเพียงพอสำหรับสร้างกราฟ</div>
      </div>

      <!-- AI Advice -->
      <div class="card">
        <h2>คำแนะนำ (โดยพี่จุ๋ม · พยาบาล AI)</h2>
        <div id="aiWrap" class="row"></div>
        <div id="aiEmpty" class="empty" style="display:none">ยังไม่มีคำแนะนำ</div>
        <div class="note">หมายเหตุ: พี่จุ๋มคือปัญญาประดิษฐ์ (AI) ที่ช่วยแนะนำในบทบาทพยาบาลคลินิกเบาหวาน โปรดพิจารณาคำแนะนำนี้ หรือปรึกษาบุคลากรทางการแพทย์นะคะ</div>
      </div>
    </section>

    <div class="build" id="build">Build: —</div>
  </div>

  <!-- libs -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

  <script>
    // ============ CONFIG ============
    const GAS_WEB_APP_URL = "https://script.google.com/macros/s/AKfycbyUmJKG7zE0WC7yL4XB4M9qFUYWgQPiUjzuc4WuYGasTy9FotqubfegZOJIpeFeT9gP3w/exec";
    const LIFF_ID = "2007840605-zKl7p3Aa";
    const BUILD_ID = new Date().toISOString().replace('T',' ').slice(0,19);

    // ============ STATE ============
    let gUserId = null;
    let gProfile = null;
    let gDashboard = null;

    // ============ HELPERS ============
    const qs = (sel) => document.querySelector(sel);
    function show(el){ el.style.display=''; }
    function hide(el){ el.style.display='none'; }

    function fmtDateTH(dstr){
      if(!dstr) return '—';
      const d = (dstr instanceof Date)? dstr : new Date(dstr);
      if(!(d instanceof Date) || isNaN(d)) return '—';
      const th = ["","ม.ค.","ก.พ.","มี.ค.","เม.ย.","พ.ค.","มิ.ย.","ก.ค.","ส.ค.","ก.ย.","ต.ค.","พ.ย.","ธ.ค."];
      return `${d.getDate()} ${th[d.getMonth()+1]} ${d.getFullYear()}`;
    }

    function groupBy(arr, keyFn){
      const out = {};
      for(const it of arr){
        const k = keyFn(it) || 'UNKNOWN';
        (out[k] ||= []).push(it);
      }
      return out;
    }

    function ensureCors(url){
      const sep = url.includes('?') ? '&' : '?';
      return `${url}${sep}_=${Date.now()}`; // cache-bust
    }

    // ============ RENDER ============
    function renderProfile(p){
      const avatar = qs('#avatar');
      if(p?.PictureURL) avatar.style.backgroundImage = `url('${p.PictureURL}')`;
      qs('#displayName').textContent = p?.DisplayName || '—';
      qs('#nameUse').textContent = 'ชื่อที่อยากให้เรียก: ' + (p?.NameUse || '—');
      qs('#kvHN').textContent = p?.HN || '—';
      qs('#kvGender').textContent = p?.Gender || '—';
      qs('#kvAge').textContent = p?.Age || '—';
      qs('#kvCreated').textContent = fmtDateTH(p?.Timestamp);
    }

    function renderGoals(goals){
      const wrap = qs('#goalsWrap');
      wrap.innerHTML = '';
      if(!goals || !goals.length){
        show(qs('#goalsEmpty')); return;
      }
      hide(qs('#goalsEmpty'));
      goals.forEach(g=>{
        const el = document.createElement('div');
        el.className = 'goal';
        el.innerHTML = `
          <h3>${g.goal_category || '-'} · <span class="small">${g.goal_id || ''}</span></h3>
          <div style="margin:6px 0 8px 0; font-weight:600">${g.goal_specific || '-'}</div>
          <div class="small">วิธีวัดผล: ${g.goal_measurable || '-'}</div>
          <div class="small">เหมาะสม/ทำได้จริง: ${g.goal_achievable || '-'}</div>
          <div class="small">เหตุผล: ${g.goal_relevant || '-'}</div>
          <div class="chip" style="margin-top:8px">กรอบเวลา: ${g.goal_timebound || '-'}</div>
        `;
        wrap.appendChild(el);
      });
    }

    function renderCharts(events){
      const wrap = qs('#chartsWrap');
      wrap.innerHTML = '';
      if(!events || !events.length){ show(qs('#chartsEmpty')); return; }
      hide(qs('#chartsEmpty'));

      // แปลง timestamp เป็น Date และกรองเฉพาะ metric ที่วาดได้
      const rows = events.map(r=>({
        ts: new Date(r.timestamp),
        type: r.event_type,
        sub: r.event_subtype || '',
        v1: (r.value_numeric_1!=null && r.value_numeric_1!=='') ? Number(r.value_numeric_1) : null,
        v2: (r.value_numeric_2!=null && r.value_numeric_2!=='') ? Number(r.value_numeric_2) : null,
        unit: r.value_unit || ''
      })).filter(r=>r.ts instanceof Date && !isNaN(r.ts));

      const byType = groupBy(rows, r=>r.type);

      const wantOrder = ['SBGM','BP','WEIGHT','WAIST','HBA1C','BODY_FAT'];
      const keys = Object.keys(byType).sort((a,b)=>wantOrder.indexOf(a)-wantOrder.indexOf(b));

      keys.forEach(k=>{
        const list = byType[k].sort((a,b)=>a.ts-b.ts);
        const card = document.createElement('div');
        card.className='card';
        const titleTH = ({
          SBGM:'ค่าน้ำตาล (mg/dL)',
          BP:'ความดัน (mmHg)',
          WEIGHT:'น้ำหนัก (กก.)',
          WAIST:'รอบเอว (ซม.)',
          HBA1C:'HbA1c (%)',
          BODY_FAT:'ไขมันในร่างกาย (%)'
        })[k] || k;
        card.innerHTML = `<h2 style="margin-top:0">${titleTH}</h2><canvas></canvas>`;
        wrap.appendChild(card);

        const cvs = card.querySelector('canvas');
        const labels = list.map(r=> r.ts.toLocaleDateString('th-TH', { month:'short', day:'numeric' }));
        if(k==='BP'){
          const s = list.map(r=> r.v1);
          const d = list.map(r=> r.v2);
          new Chart(cvs, {
            type:'line',
            data:{
              labels,
              datasets:[
                { label:'ตัวบน (SBP)', data:s, tension:.25, borderWidth:2, pointRadius:2 },
                { label:'ตัวล่าง (DBP)', data:d, tension:.25, borderWidth:2, pointRadius:2 }
              ]
            },
            options:{ responsive:true, maintainAspectRatio:false, plugins:{ legend:{position:'bottom'} } }
          });
        }else{
          const y = list.map(r=> r.v1);
          new Chart(cvs, {
            type:'line',
            data:{ labels, datasets:[{ label:titleTH, data:y, tension:.25, borderWidth:2, pointRadius:2 }] },
            options:{ responsive:true, maintainAspectRatio:false, plugins:{ legend:{display:false} } }
          });
        }
      });
    }

    function renderAI(advs){
      const wrap = qs('#aiWrap');
      wrap.innerHTML='';
      if(!advs || !advs.length){ show(qs('#aiEmpty')); return; }
      hide(qs('#aiEmpty'));
      advs.forEach(a=>{
        const card = document.createElement('div');
        card.className='goal';
        card.innerHTML = `
          <h3>${a.metric_type || '—'} <span class="small">· ${fmtDateTH(a.timestamp)}</span></h3>
          <div style="white-space:pre-wrap; margin-top:6px">${a.advice_text || '-'}</div>
          <div class="small" style="margin-top:8px; color:#6a7b8d">โมเดล: ${a.model || '-'} | latency: ${a.latency_ms || '-'} ms</div>
        `;
        wrap.appendChild(card);
      });
    }

    function renderDashboard(data){
      gDashboard = data || {};
      // Profile
      renderProfile(data.profile || {});
      // Goals
      renderGoals(data.goals || []);
      // Charts
      renderCharts(data.events || []);
      // AI latest per metric
      renderAI(data.ai_latest || []);
    }

    // ============ LOAD ============
    async function loadDashboard(){
      try{
        const url = ensureCors(`${GAS_WEB_APP_URL}?action=getDashboard&userId=${encodeURIComponent(gUserId)}`);
        const res = await fetch(url, { method:'GET', mode:'cors', headers:{ 'Accept':'application/json' } });
        if(!res.ok) throw new Error('HTTP '+res.status);
        const data = await res.json();

        if(data?.profile && (data.profile.Consent === true || String(data.profile.Consent).toUpperCase()==='TRUE')){
          hide(qs('#sec-register'));
          show(qs('#sec-dash'));
          renderDashboard(data);
        }else{
          show(qs('#sec-register'));
          hide(qs('#sec-dash'));
        }
      }catch(err){
        // ถ้า CORS ยังไม่พร้อม → แสดงฟอร์มไว้ก่อน (ผู้ใช้ใหม่)
        console.warn('getDashboard failed:', err);
        show(qs('#sec-register'));
        hide(qs('#sec-dash'));
      }
    }

    // ============ MAIN ============
    async function main(){
      // กันแคช URL (บังคับรีโหลดเมื่ออัปเดต)
      if(!/[?&]v=\d+$/.test(location.href)){
        const sep = location.search ? '&' : '?';
        location.replace(location.href + sep + 'v=' + Date.now());
        return;
      }

      qs('#build').textContent = 'Build: ' + BUILD_ID;

      try{
        await liff.init({ liffId: LIFF_ID });
      }catch(e){
        alert('LIFF เริ่มต้นไม่สำเร็จ กรุณาลองใหม่'); return;
      }
      if(!liff.isLoggedIn()){ liff.login(); return; }

      gProfile = await liff.getProfile();
      gUserId  = gProfile.userId;

      // ปรับ avatar ตั้งต้น
      if(gProfile?.pictureUrl) qs('#avatar').style.backgroundImage = `url('${gProfile.pictureUrl}')`;
      qs('#displayName').textContent = gProfile?.displayName || '—';

      // โหลดแดชบอร์ด (หรือแสดงฟอร์ม)
      await loadDashboard();

      // ฟอร์มลงทะเบียน
      $('#registrationForm').on('submit', async (e)=>{
        e.preventDefault();
        const $btn = $('#submitBtn');
        $btn.prop('disabled', true).text('กำลังลงทะเบียน...');

        const payload = {
          action: 'registerUser',
          userId: gUserId,
          displayName: gProfile?.displayName || '',
          pictureUrl: gProfile?.pictureUrl || '',
          hn: $('#hn').val().trim(),
          name_use: $('#name_use').val().trim(),
          gender: $('#gender').val(),
          age: $('#age').val().trim(),
          consent: $('#pdpa').is(':checked')
        };

        try{
          // พยายามใช้ CORS ก่อน
          const res = await fetch(GAS_WEB_APP_URL, {
            method: 'POST',
            headers: { 'Content-Type':'application/json' },
            body: JSON.stringify(payload),
            mode: 'cors'
          });
          if(!res.ok){
            // fallback สไตล์เดิม
            await fetch(GAS_WEB_APP_URL, {
              method: 'POST',
              headers: { 'Content-Type':'application/json' },
              body: JSON.stringify(payload),
              mode: 'no-cors'
            });
            alert('ลงทะเบียนเสร็จแล้วค่ะ (โหมด no-cors)'); 
            // ปิดหน้าตามพฤติกรรมเดิม
            liff.closeWindow();
            return;
          }
          const data = await res.json();
          if(data?.ok){
            $('#regStatus').text('ลงทะเบียนสำเร็จ ✓').css('color','#0a6b2a');
            await loadDashboard();
            window.scrollTo({top:0, behavior:'smooth'});
          }else{
            throw new Error(data?.error || 'บันทึกไม่สำเร็จ');
          }
        }catch(err){
          console.error(err);
          $('#regStatus').text('เกิดข้อผิดพลาด: ' + err.message).css('color','#b22');
        }finally{
          $btn.prop('disabled', false).text('ลงทะเบียน');
        }
      });

      // ปุ่มรีเฟรช
      $('#btnRefresh').on('click', loadDashboard);
      // ปุ่มแก้ไข: เปิดฟอร์มพร้อมกรอกค่าเดิม
      $('#btnEdit').on('click', ()=>{
        if(!gDashboard?.profile) return;
        $('#hn').val(gDashboard.profile.HN || '');
        $('#name_use').val(gDashboard.profile.NameUse || '');
        $('#gender').val(gDashboard.profile.Gender || '');
        $('#age').val(gDashboard.profile.Age || '');
        $('#pdpa').prop('checked', gDashboard.profile.Consent === true || String(gDashboard.profile.Consent).toUpperCase()==='TRUE');
        show(qs('#sec-register'));
        window.scrollTo({top:0, behavior:'smooth'});
      });
    }

    main();
  </script>
</body>
</html>
