<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
  <title>‡∏™‡∏ß‡∏µ‡∏Ñ‡∏∏‡∏°‡∏´‡∏ß‡∏≤‡∏ô ‚Ä¢ DM Remission</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Mali:ital,wght@0,300;0,400;0,500;0,600;0,700;1,300&display=swap" rel="stylesheet">

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

  <style>
    /* --- CORE VARIABLES --- */
    :root{
      --bg: #fffbf0; --card: #ffffff; --ink: #2c3e50; --muted: #7f8c8d; 
      --brand: #f39c12; --brand-light: #fef5e7; --brand-dark: #d35400;
      --ok: #27ae60; --warn: #e67e22; --danger: #c0392b;
      --shadow: 0 8px 20px rgba(0,0,0,0.08);
      --radius: 16px; --radius-sm: 10px;
      --font-main: 'Mali', sans-serif;
    }

    /* --- GLOBAL STYLES --- */
    *{box-sizing:border-box}
    html,body{height:100%; scroll-behavior: smooth;}
    body{ margin:0; padding:0; background:var(--bg); font-family:var(--font-main); color:var(--ink); font-size:16px; -webkit-tap-highlight-color: transparent; }
    
    h1, h2, h3, h4 { margin: 0 0 10px 0; font-weight: 700; }
    button, input, select, textarea { font-family: var(--font-main); }
    
    input, select, textarea { 
      width: 100%; padding: 14px; font-size: 20px; 
      border: 2px solid #eee; border-radius: 12px; background: #fff; 
      transition: 0.3s; color: var(--ink);
    }
    input:focus, select:focus, textarea:focus { border-color: var(--brand); outline: none; box-shadow: 0 0 0 4px rgba(243, 156, 18, 0.1); }
    input.invalid, textarea.invalid { border-color: var(--danger); background: #fff5f5; animation: shake 0.3s; }
    @keyframes shake { 0%, 100% {transform: translateX(0);} 25% {transform: translateX(-5px);} 75% {transform: translateX(5px);} }

    /* Buttons */
    .btn { 
      border: none; outline: none; background: linear-gradient(135deg, #f1c40f, #f39c12); 
      color: #fff; padding: 14px 20px; border-radius: 12px; font-size: 18px; font-weight: 700; 
      width: 100%; cursor: pointer; transition: 0.2s; box-shadow: 0 4px 10px rgba(243, 156, 18, 0.3); 
      text-align: center; display: inline-block; text-decoration: none;
    }
    .btn:active { transform: scale(0.98); box-shadow: none; }
    .btn:disabled { background: #bdc3c7; cursor: not-allowed; box-shadow: none; color: #fff; }
    .btn-close { background: #ecf0f1; color: #7f8c8d; box-shadow: none; width: auto; font-size: 16px; padding: 8px 16px; }
    .btn.danger { background: linear-gradient(135deg, #e74c3c, #c0392b); box-shadow: 0 4px 10px rgba(192, 57, 43, 0.3); }
    .btn-small { padding: 4px 10px; font-size: 14px; border-radius: 8px; width: auto; margin: 2px; }

    /* Navbar */
    .navbar{ background: #fff; padding: 12px 16px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); display: flex; align-items: center; justify-content: space-between; position: sticky; top: 0; z-index: 100; }
    .nav-brand{ display: flex; align-items: center; gap: 10px; font-weight: 700; font-size: 20px; color: var(--brand-dark); }
    .nav-brand img { width: 40px; height: 40px; object-fit: contain; }

    /* Containers */
    .container{ max-width: 800px; margin: 0 auto; padding: 16px; padding-bottom: 80px; }
    .card { background: var(--card); border-radius: var(--radius); padding: 20px; margin-bottom: 16px; box-shadow: var(--shadow); border: 1px solid #fdfdfd; }
    
    /* ========================================= */
    /* === NEW SECTION: NOTE GRID UI (4x3) === */
    /* ========================================= */
    .note-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 14px; margin-top: 20px; }
    .note-item { 
      background: #fff; border-radius: var(--radius); padding: 20px 8px; 
      display: flex; flex-direction: column; align-items: center; text-align: center; gap: 10px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.06); border: 2px solid transparent; 
      cursor: pointer; transition: 0.2s; position: relative; overflow: hidden;
    }
    .note-item:active { transform: scale(0.96); border-color: var(--brand); background: var(--brand-light); }
    .note-icon { font-size: 48px; line-height: 1; filter: drop-shadow(0 2px 4px rgba(0,0,0,0.1)); }
    .note-label { font-size: 15px; font-weight: 600; line-height: 1.2; color: var(--ink); }
    
    /* Specific Colors for Grid Items */
    .bg-sugar { color: #c0392b; } .bg-bp { color: #2980b9; } .bg-food { color: #27ae60; }
    .bg-weight { color: #8e44ad; } .bg-waist { color: #d35400; } .bg-ex { color: #e67e22; }

    /* ========================================= */
    /* === NEW SECTION: LARGE FORM MODAL === */
    /* ========================================= */
    .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.7); z-index: 2000; display: none; align-items: flex-end; justify-content: center; backdrop-filter: blur(3px); }
    .modal-sheet { background: #fff; width: 100%; max-width: 600px; border-radius: 24px 24px 0 0; padding: 24px; box-shadow: 0 -10px 40px rgba(0,0,0,0.2); animation: slideUp 0.35s cubic-bezier(0.165, 0.84, 0.44, 1); max-height: 90vh; overflow-y: auto; display: flex; flex-direction: column; }
    @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
    
    .form-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; padding-bottom: 12px; border-bottom: 1px solid #eee; }
    .form-title { font-size: 24px; font-weight: 700; color: var(--ink); }
    .form-group { margin-bottom: 24px; }
    .form-label { display: block; font-size: 18px; font-weight: 600; margin-bottom: 8px; color: var(--muted); }
    .soft-alert { color: var(--danger); font-size: 15px; margin-top: 6px; display: none; align-items: center; gap: 6px; font-weight: 500; background: #fff5f5; padding: 8px; border-radius: 8px; border: 1px solid #fadbd8; }

    /* Success Card (Flex Simulation) */
    .success-card { background: #06c755; color: white; border-radius: 20px; padding: 30px; text-align: center; display: none; animation: popIn 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55); margin: 20px; box-shadow: 0 10px 30px rgba(6, 199, 85, 0.4); width: 85%; max-width: 350px; position: relative; }
    @keyframes popIn { from { transform: scale(0.5); opacity: 0; } to { transform: scale(1); opacity: 1; } }
    .success-icon { font-size: 70px; margin-bottom: 16px; display: block; filter: drop-shadow(0 4px 6px rgba(0,0,0,0.2)); }
    .success-title { font-size: 26px; font-weight: 700; margin-bottom: 8px; }
    .success-detail { font-size: 18px; opacity: 0.95; font-weight: 500; }

    /* ========================================= */
    /* === LEGACY STYLES (Dashboard, History) === */
    /* ========================================= */
    .profile-grid { display: grid; grid-template-columns: 120px 1fr; gap: 16px; align-items: center; }
    .profile-left .avatar { width: 100px; height: 100px; border-radius: 50%; object-fit: cover; border: 3px solid #f6e3a6; }
    .pill { display: inline-block; padding: 4px 10px; border-radius: 20px; background: #fff8d8; border: 1px solid #f2dfab; color: #4b3a1a; font-weight: 600; font-size: 14px; margin-right: 6px; }
    
    .menu-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 14px; margin: 16px 0; }
    .menu-btn { display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 8px; padding: 16px; background: #fff; border: 1px solid #eee; border-radius: var(--radius); box-shadow: var(--shadow); cursor: pointer; font-weight: 600; font-size: 16px; color: var(--ink); }
    .menu-btn .emoji { font-size: 32px; }

    .table-wrap { overflow-x: auto; -webkit-overflow-scrolling: touch; border: 1px solid #eee; border-radius: 12px; margin-top: 12px; }
    table { width: 100%; border-collapse: collapse; min-width: 400px; }
    th, td { padding: 12px; text-align: left; border-bottom: 1px solid #eee; }
    th { background: #f9f9f9; font-weight: 600; color: var(--muted); }
    
    .filter-controls { margin-bottom: 12px; display: flex; flex-wrap: wrap; gap: 8px; }
    .filter-btn { padding: 6px 12px; border-radius: 20px; border: 1px solid #ddd; background: #fff; color: #777; cursor: pointer; }
    .filter-btn.active { background: var(--brand); color: #fff; border-color: var(--brand); }

    .charts-grid { display: grid; gap: 16px; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); }
    .chart-card { background: #fff; padding: 16px; border-radius: var(--radius); box-shadow: var(--shadow); }
    
    /* Loading Spinner */
    #loading { position: fixed; inset: 0; background: rgba(255,255,255,0.9); display: none; place-items: center; z-index: 9999; flex-direction: column; justify-content: center; gap: 16px;}
    .spinner { width: 50px; height: 50px; border: 5px solid #f3f3f3; border-top: 5px solid var(--brand); border-radius: 50%; animation: spin 1s linear infinite; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

    /* Utility to Toggle Views */
    .view-section { display: none; } /* Hide all by default */
    .view-section.active { display: block; animation: fadeIn 0.3s; }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

  </style>
</head>
<body>

  <div id="loading">
    <div class="spinner"></div>
    <div style="color:var(--muted); font-weight:600;">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</div>
  </div>

  <div id="notification"></div>

  <div id="note-view" class="view-section">
    <nav class="navbar">
      <div class="nav-brand">
        <img src="https://img2.pic.in.th/pic/ChatGPT-Image-10-..-2568-12_48_07.png" alt="Logo">
        <span>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ú‡∏•‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û</span>
      </div>
      <button class="btn-close" onclick="liff.closeWindow()">‡∏õ‡∏¥‡∏î</button>
    </nav>

    <div class="container">
      <div class="note-grid">
        <div class="note-item" onclick="openNoteForm('SBGM')">
          <div class="note-icon bg-sugar">ü©∏</div><div class="note-label">‡∏ô‡πâ‡∏≥‡∏ï‡∏≤‡∏•<br>‡πÉ‡∏ô‡πÄ‡∏•‡∏∑‡∏≠‡∏î</div>
        </div>
        <div class="note-item" onclick="openNoteForm('BP')">
          <div class="note-icon bg-bp">üíì</div><div class="note-label">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡∏±‡∏ô<br>‡πÇ‡∏•‡∏´‡∏¥‡∏ï</div>
        </div>
        <div class="note-item" onclick="openNoteForm('FOOD')">
          <div class="note-icon bg-food">üçΩÔ∏è</div><div class="note-label">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å<br>‡∏≠‡∏≤‡∏´‡∏≤‡∏£</div>
        </div>
        <div class="note-item" onclick="openNoteForm('WEIGHT')">
          <div class="note-icon bg-weight">‚öñÔ∏è</div><div class="note-label">‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å<br>‡∏ï‡∏±‡∏ß</div>
        </div>
        <div class="note-item" onclick="openNoteForm('EXERCISE')">
          <div class="note-icon bg-ex">üèÉ‚Äç‚ôÄÔ∏è</div><div class="note-label">‡∏≠‡∏≠‡∏Å‡∏Å‡∏≥‡∏•‡∏±‡∏á<br>‡∏Å‡∏≤‡∏¢</div>
        </div>
        <div class="note-item" onclick="openNoteForm('ADVERSE')">
          <div class="note-icon" style="color:#e74c3c">‚ö†Ô∏è</div><div class="note-label">‡∏≠‡∏≤‡∏Å‡∏≤‡∏£<br>‡∏ú‡∏¥‡∏î‡∏õ‡∏Å‡∏ï‡∏¥</div>
        </div>
        <div class="note-item" onclick="openNoteForm('DEPRESSION')">
          <div class="note-icon" style="color:#34495e">üòü</div><div class="note-label">‡∏Ñ‡∏ß‡∏≤‡∏°<br>‡πÄ‡∏Ñ‡∏£‡∏µ‡∏¢‡∏î</div>
        </div>
        <div class="note-item" onclick="openNoteForm('WEIGHT')">
          <div class="note-icon bg-weight">‚öñÔ∏è</div><div class="note-label">‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å<br>(‡∏™‡∏≥‡∏£‡∏≠‡∏á)</div>
        </div>
        <div class="note-item" onclick="openNoteForm('WAIST')">
          <div class="note-icon bg-waist">üìè</div><div class="note-label">‡∏£‡∏≠‡∏ö<br>‡πÄ‡∏≠‡∏ß</div>
        </div>
        <div class="note-item" onclick="openNoteForm('HBA1C')">
          <div class="note-icon" style="color:#8e44ad">üß™</div><div class="note-label">HbA1C</div>
        </div>
        <div class="note-item" onclick="openNoteForm('WAIST')">
          <div class="note-icon bg-waist">üìè</div><div class="note-label">‡∏£‡∏≠‡∏ö‡πÄ‡∏≠‡∏ß<br>(‡∏™‡∏≥‡∏£‡∏≠‡∏á)</div>
        </div>
        <div class="note-item" onclick="openNoteForm('BODY_FAT')">
          <div class="note-icon" style="color:#d35400">üßç‚Äç‚ôÄÔ∏è</div><div class="note-label">% ‡πÑ‡∏Ç‡∏°‡∏±‡∏ô</div>
        </div>
      </div>

      <div style="text-align:center; margin-top:30px;">
        <button class="btn" style="background:#fff; border:1px solid #ddd; color:#555; width:auto; font-weight:600;" onclick="switchView('dashboard')">
          ‡∏î‡∏π‡∏Å‡∏£‡∏≤‡∏ü‡πÅ‡∏•‡∏∞‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á üìà
        </button>
      </div>
    </div>
  </div>

  <div id="dashboard-view" class="view-section">
    <nav class="navbar">
      <div class="nav-brand">
        <img src="https://img2.pic.in.th/pic/ChatGPT-Image-10-..-2568-12_48_07.png" alt="Logo">
        <span>‡∏™‡∏ß‡∏µ‡∏Ñ‡∏∏‡∏°‡∏´‡∏ß‡∏≤‡∏ô</span>
      </div>
      <button class="btn-nav-help" onclick="toggleHelpModal(true)">‡∏ß‡∏¥‡∏ò‡∏µ‡πÉ‡∏ä‡πâ</button>
    </nav>

    <div class="container">
      <div id="profile-card" class="card">
        <div class="form-header" style="margin-bottom:12px; padding-bottom:0; border:none;">
          <h2 style="margin:0">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß</h2>
          <button id="btnEditProfile" class="btn-small btn-close">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
        </div>
        <div class="profile-grid">
          <div class="profile-left"><img id="avatar" class="avatar" src="" alt="avatar"></div>
          <div class="profile-right">
            <div class="row" style="justify-content: flex-start; margin-bottom:8px;"><span class="pill">‡∏ä‡∏∑‡πà‡∏≠</span> <span id="p_name" style="font-size:20px; font-weight:700;">-</span></div>
            <div class="row" style="justify-content: flex-start;"><span class="pill">HN</span> <span id="p_hn">-</span></div>
          </div>
        </div>
      </div>

      <div id="main-menu">
        <div class="menu-grid">
          <button class="menu-btn" onclick="switchView('note')"><span class="emoji">üìù</span><span>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ú‡∏•</span></button>
          <button class="menu-btn" data-target="historyCard"><span class="emoji">üìà</span><span>‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥</span></button>
          <button class="menu-btn" data-target="goalsCard"><span class="emoji">üéØ</span><span>‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢</span></button>
          <button class="menu-btn" data-target="foodCard"><span class="emoji">ü•ó</span><span>‡πÄ‡∏°‡∏ô‡∏π‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥</span></button>
          <button class="menu-btn" data-target="adviceCard"><span class="emoji">ü§ñ</span><span>AI ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå</span></button>
        </div>
      </div>

      <div id="goalsCard" class="content-card card" style="display:none"></div>
      <div id="adviceCard" class="content-card card" style="display:none"></div>
      <div id="foodCard" class="content-card card" style="display:none"></div>
      
      <div id="historyCard" class="content-card card" style="display:none">
        <div class="form-header">
          <h2>üìà ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</h2>
          <button class="btn-close" onclick="closeContentCard()">‡∏õ‡∏¥‡∏î</button>
        </div>
        <div class="filter-controls" id="history-filters">
          </div>
        <div class="table-wrap">
          <table id="history-table">
            <thead><tr><th>‡πÄ‡∏ß‡∏•‡∏≤</th><th>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</th><th>‡∏Ñ‡πà‡∏≤</th><th></th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
        <div style="margin-top:20px;">
          <h3>üìä ‡∏Å‡∏£‡∏≤‡∏ü‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û</h3>
          <div id="chartsWrap" class="charts-grid"></div>
        </div>
      </div>

    </div>
  </div>

  <div id="form-modal" class="modal-overlay">
    <div class="modal-sheet">
      <div class="form-header">
        <div class="form-title" id="modal-title">üìù ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</div>
        <button class="btn-close" onclick="closeNoteForm()">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
      </div>

      <div id="modal-body">
        </div>

      <div style="margin-top: 24px;">
        <button id="btn-save-form" class="btn" disabled>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
      </div>
    </div>
  </div>

  <div id="success-modal" class="modal-overlay" style="align-items: center;">
    <div class="success-card">
      <span class="success-icon">‚úÖ</span>
      <div class="success-title">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!</div>
      <div class="success-detail" id="success-msg">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ñ‡∏π‡∏Å‡∏™‡πà‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏•‡πâ‡∏ß</div>
      <div style="margin-top:20px; font-size:14px; opacity:0.8;">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á...</div>
    </div>
  </div>

  <div id="reg-view" class="view-section" style="padding:20px;">
    <div class="card">
      <h2>‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡πÉ‡∏´‡∏°‡πà</h2>
      <p class="muted">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</p>
      <div class="form-group"><label class="form-label">HN (‡πÄ‡∏•‡∏Ç‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢)</label><input id="hn" type="text" placeholder="9 ‡∏´‡∏•‡∏±‡∏Å"></div>
      <div class="form-group"><label class="form-label">‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô / ‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏µ‡∏¢‡∏Å</label><input id="nameuse" type="text"></div>
      <div class="grid" style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
        <div class="form-group"><label class="form-label">‡πÄ‡∏û‡∏®</label><select id="gender"><option value="Male">‡∏ä‡∏≤‡∏¢</option><option value="Female">‡∏´‡∏ç‡∏¥‡∏á</option></select></div>
        <div class="form-group"><label class="form-label">‡∏≠‡∏≤‡∏¢‡∏∏</label><input id="age" type="number"></div>
      </div>
      <div style="margin:20px 0;"><input type="checkbox" id="consent" style="width:20px;height:20px;vertical-align:middle;"> <span style="vertical-align:middle;">‡∏â‡∏±‡∏ô‡∏¢‡∏¥‡∏ô‡∏¢‡∏≠‡∏°‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏Å‡∏©‡∏≤</span></div>
      <button id="btnSaveReg" class="btn">‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô</button>
    </div>
  </div>

  <div id="help-modal" class="modal-overlay" style="align-items:center;">
    <div class="modal-sheet" style="max-height:80vh;">
      <div class="form-header"><h2>‡∏Ñ‡∏π‡πà‡∏°‡∏∑‡∏≠‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</h2><button class="btn-close" onclick="toggleHelpModal(false)">‡∏õ‡∏¥‡∏î</button></div>
      <div style="line-height:1.8;">
        <p>1. ‡∏Å‡∏î <strong>"‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ú‡∏•"</strong> ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏à‡∏î‡∏Ñ‡πà‡∏≤‡∏ô‡πâ‡∏≥‡∏ï‡∏≤‡∏• ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡∏±‡∏ô ‡∏´‡∏£‡∏∑‡∏≠‡∏≠‡∏≤‡∏´‡∏≤‡∏£</p>
        <p>2. ‡∏Å‡∏î <strong>"‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥"</strong> ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏Å‡∏£‡∏≤‡∏ü‡πÅ‡∏•‡∏∞‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á</p>
        <p>3. ‡∏´‡∏≤‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ‡πÉ‡∏´‡πâ‡πÑ‡∏õ‡∏ó‡∏µ‡πà‡∏´‡∏ô‡πâ‡∏≤‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥ ‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° "‡∏•‡∏ö" ‡∏´‡∏•‡∏±‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏±‡πâ‡∏ô</p>
      </div>
    </div>
  </div>

<script>
    // ============================================================
    // CONFIGURATION & GLOBAL STATE
    // ============================================================
    const LIFF_ID = '2007840605-zKl7p3Aa';
    const GAS_URL = 'https://script.google.com/macros/s/AKfycbwDi08IqlCBBESqXYkQgvA1EdvCjLchwZdBYAtobMr83NEWkvtgwVdTnzts5T9tvbM0/exec';

    // *** STRICT VALIDATION RULES (Matched with Chatbot Code) ***
    const METRIC_CONFIG = {
      'SBGM': { 
        title: 'ü©∏ ‡∏ô‡πâ‡∏≥‡∏ï‡∏≤‡∏•‡πÉ‡∏ô‡πÄ‡∏•‡∏∑‡∏≠‡∏î', unit: 'mg/dL', 
        min: 20, max: 600, 
        placeholder: '‡πÄ‡∏ä‡πà‡∏ô 120', 
        subtypes: ['‡∏Å‡πà‡∏≠‡∏ô‡∏≠‡∏≤‡∏´‡∏≤‡∏£', '‡∏´‡∏•‡∏±‡∏á‡∏≠‡∏≤‡∏´‡∏≤‡∏£ 2 ‡∏ä‡∏°.', '‡∏™‡∏∏‡πà‡∏°‡∏ß‡∏±‡∏î'] 
      },
      'BP': { 
        title: 'üíì ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡∏±‡∏ô‡πÇ‡∏•‡∏´‡∏¥‡∏ï', unit: 'mmHg', 
        sys_min: 20, sys_max: 300, 
        dia_min: 20, dia_max: 130, 
        placeholder_sys: '120', placeholder_dia: '80'
      },
      'WEIGHT': { 
        title: '‚öñÔ∏è ‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å', unit: '‡∏Å‡∏Å.', 
        min: 30, max: 250, 
        placeholder: '‡πÄ‡∏ä‡πà‡∏ô 65.5' 
      },
      'WAIST': { 
        title: 'üìè ‡∏£‡∏≠‡∏ö‡πÄ‡∏≠‡∏ß', unit: '‡∏ã‡∏°.', 
        min: 50, max: 200, 
        placeholder: '‡πÄ‡∏ä‡πà‡∏ô 85' 
      },
      'EXERCISE': { 
        title: 'üèÉ‚Äç‚ôÄÔ∏è ‡∏≠‡∏≠‡∏Å‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Å‡∏≤‡∏¢', unit: '‡∏ô‡∏≤‡∏ó‡∏µ', 
        min: 5, max: 300, 
        placeholder: '‡πÄ‡∏ä‡πà‡∏ô 30',
        subtypes: ['‡πÄ‡∏î‡∏¥‡∏ô‡πÄ‡∏£‡πá‡∏ß', '‡∏ß‡∏¥‡πà‡∏á', '‡∏õ‡∏±‡πà‡∏ô‡∏à‡∏±‡∏Å‡∏£‡∏¢‡∏≤‡∏ô', '‡πÅ‡∏Å‡∏ß‡πà‡∏á‡πÅ‡∏Ç‡∏ô', '‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏ö‡πâ‡∏≤‡∏ô', '‡∏≠‡∏∑‡πà‡∏ô‡πÜ']
      },
      'FOOD': { 
        title: 'üçΩÔ∏è ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏≠‡∏≤‡∏´‡∏≤‡∏£', unit: '', 
        placeholder: '‡πÄ‡∏ä‡πà‡∏ô ‡∏Ç‡πâ‡∏≤‡∏ß‡∏Å‡∏∞‡πÄ‡∏û‡∏£‡∏≤ 1 ‡∏à‡∏≤‡∏ô, ‡∏ô‡∏°‡∏à‡∏∑‡∏î 1 ‡∏Å‡∏•‡πà‡∏≠‡∏á',
        subtypes: ['‡∏°‡∏∑‡πâ‡∏≠‡πÄ‡∏ä‡πâ‡∏≤', '‡∏°‡∏∑‡πâ‡∏≠‡∏Å‡∏•‡∏≤‡∏á‡∏ß‡∏±‡∏ô', '‡∏°‡∏∑‡πâ‡∏≠‡πÄ‡∏¢‡πá‡∏ô', '‡∏°‡∏∑‡πâ‡∏≠‡∏ß‡πà‡∏≤‡∏á']
      },
      'HBA1C': { 
        title: 'üß™ HbA1c (‡∏ô‡πâ‡∏≥‡∏ï‡∏≤‡∏•‡∏™‡∏∞‡∏™‡∏°)', unit: '%', 
        min: 3, max: 20, 
        placeholder: '‡πÄ‡∏ä‡πà‡∏ô 6.5' 
      },
      'BODY_FAT': { 
        title: 'üßç‚Äç‚ôÄÔ∏è % ‡πÑ‡∏Ç‡∏°‡∏±‡∏ô', unit: '%', 
        min: 5, max: 60, 
        placeholder: '‡πÄ‡∏ä‡πà‡∏ô 25' 
      },
      'ADVERSE': { 
        title: '‚ö†Ô∏è ‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡∏ú‡∏¥‡∏î‡∏õ‡∏Å‡∏ï‡∏¥', 
        type: 'select', 
        options: ['‡πÄ‡∏ß‡∏µ‡∏¢‡∏ô‡∏´‡∏±‡∏ß', '‡πÉ‡∏à‡∏™‡∏±‡πà‡∏ô', '‡∏Ñ‡∏•‡∏∑‡πà‡∏ô‡πÑ‡∏™‡πâ', '‡∏°‡∏∑‡∏≠‡∏™‡∏±‡πà‡∏ô', '‡∏´‡∏ô‡πâ‡∏≤‡∏°‡∏∑‡∏î', '‡∏≠‡∏∑‡πà‡∏ô‡πÜ'] 
      },
      'DEPRESSION': { 
        title: 'üòü ‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏Ñ‡∏£‡∏µ‡∏¢‡∏î', 
        type: 'select', 
        options: ['‡πÑ‡∏°‡πà‡πÄ‡∏Ñ‡∏£‡∏µ‡∏¢‡∏î', '‡πÄ‡∏Ñ‡∏£‡∏µ‡∏¢‡∏î‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢', '‡πÄ‡∏Ñ‡∏£‡∏µ‡∏¢‡∏î‡∏õ‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á', '‡πÄ‡∏Ñ‡∏£‡∏µ‡∏¢‡∏î‡∏°‡∏≤‡∏Å'] 
      }
    };

    let liffProfile = {};
    let allEventsData = [];
    let currentMetric = '';
    let currentHistoryFilter = 'ALL';
    let chartInstances = {};

    // *** FIX: Changed from getElementById to querySelector to handle '#' correctly ***
    const $ = selector => document.querySelector(selector);
    const $$ = selector => document.querySelectorAll(selector);
    const show = id => $(id).classList.add('active');
    const hide = id => $(id).classList.remove('active');
    const toggleHelpModal = (show) => $('#help-modal').style.display = show ? 'flex' : 'none';
    const fmtDate = d => new Date(d).toLocaleString('th-TH');

    // ============================================================
    // MAIN INITIALIZATION
    // ============================================================
async function main() {
      // Safe check for loading element
      const loadingEl = $('#loading');
      if(loadingEl) loadingEl.style.display = 'flex';

      try {
        // 1. Initialize LIFF
        await liff.init({ liffId: LIFF_ID });

        // 2. Check Login Status
        if (!liff.isLoggedIn()) { 
            liff.login(); 
            return; 
        }

        // 3. Try to get Profile (‡∏à‡∏∏‡∏î‡∏ó‡∏µ‡πà‡∏°‡∏±‡∏Å‡∏à‡∏∞‡πÄ‡∏Å‡∏¥‡∏î Error Token Expire)
        try {
            liffProfile = await liff.getProfile();
        } catch (profileError) {
            console.warn("Token expired or invalid, forcing re-login...", profileError);
            // üö® ‡∏ñ‡πâ‡∏≤‡∏î‡∏∂‡∏á‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ ‡πÅ‡∏õ‡∏•‡∏ß‡πà‡∏≤ Token ‡πÄ‡∏ô‡πà‡∏≤ -> ‡∏™‡∏±‡πà‡∏á Logout ‡πÅ‡∏•‡πâ‡∏ß Login ‡πÉ‡∏´‡∏°‡πà‡πÄ‡∏•‡∏¢
            liff.logout();
            liff.login();
            return;
        }

        // Router Logic
        const params = new URLSearchParams(window.location.search);
        const view = params.get('view');
        
        setupGlobalListeners();

        if (view === 'note') {
          switchView('note');
          if(loadingEl) loadingEl.style.display = 'none';
        } else {
          await loadDashboardData();
        }

      } catch (err) {
        // Error ‡∏≠‡∏∑‡πà‡∏ô‡πÜ ‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á Token
        alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + err.message + '\n‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠');
        if(loadingEl) loadingEl.style.display = 'none';
      }
    }

    function switchView(viewName) {
      $$('.view-section').forEach(el => el.classList.remove('active'));
      if (viewName === 'note') $('#note-view').classList.add('active');
      else if (viewName === 'dashboard') $('#dashboard-view').classList.add('active');
      else if (viewName === 'reg') $('#reg-view').classList.add('active');
    }

    // ============================================================
    // PART 1: NOTE FORM & VALIDATION (Strict Logic)
    // ============================================================
    function openNoteForm(metric) {
      currentMetric = metric;
      const conf = METRIC_CONFIG[metric];
      const modalBody = $('#modal-body');
      $('#modal-title').innerText = conf.title;
      $('#btn-save-form').disabled = true;

      let html = '';

      // 1. Subtype Selector (Optional)
      if (conf.subtypes) {
        html += `
          <div class="form-group">
            <label class="form-label">${metric === 'FOOD' ? '‡∏°‡∏∑‡πâ‡∏≠‡∏≠‡∏≤‡∏´‡∏≤‡∏£' : '‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó/‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤'}</label>
            <select id="inp-subtype">
              ${conf.subtypes.map(s => `<option value="${s}">${s}</option>`).join('')}
            </select>
          </div>
        `;
      }

      // 2. Main Input Fields
      if (conf.type === 'select') {
        // Dropdown Input
        html += `
          <div class="form-group">
            <label class="form-label">‡∏£‡∏∞‡∏ö‡∏∏‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</label>
            <select id="inp-val1" onchange="validateForm()">
              <option value="">-- ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å --</option>
              ${conf.options.map(o => `<option value="${o}">${o}</option>`).join('')}
            </select>
          </div>
        `;
      } else if (metric === 'BP') {
        // Dual Input for Blood Pressure
        html += `
          <div class="form-group">
            <label class="form-label">‡∏ï‡∏±‡∏ß‡∏ö‡∏ô (Systolic)</label>
            <input type="number" id="inp-val1" placeholder="${conf.placeholder_sys}" oninput="validateForm()">
            <div id="alert-val1" class="soft-alert">‚ö†Ô∏è ‡∏Ñ‡πà‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏≠‡∏¢‡∏π‡πà‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á ${conf.sys_min} - ${conf.sys_max}</div>
          </div>
          <div class="form-group">
            <label class="form-label">‡∏ï‡∏±‡∏ß‡∏•‡πà‡∏≤‡∏á (Diastolic)</label>
            <input type="number" id="inp-val2" placeholder="${conf.placeholder_dia}" oninput="validateForm()">
            <div id="alert-val2" class="soft-alert">‚ö†Ô∏è ‡∏Ñ‡πà‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏≠‡∏¢‡∏π‡πà‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á ${conf.dia_min} - ${conf.dia_max}</div>
          </div>
        `;
      } else if (metric === 'FOOD') {
        // Text Area for Food
        html += `
          <div class="form-group">
            <label class="form-label">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡πÅ‡∏•‡∏∞‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ì</label>
            <textarea id="inp-val1" rows="3" placeholder="${conf.placeholder}" oninput="validateForm()"></textarea>
            <div id="alert-val1" class="soft-alert">‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠‡∏≠‡∏≤‡∏´‡∏≤‡∏£ (‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 3 ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£)</div>
          </div>
        `;
      } else {
        // Standard Number Input
        html += `
          <div class="form-group">
            <label class="form-label">‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏ß‡∏±‡∏î‡πÑ‡∏î‡πâ (${conf.unit})</label>
            <input type="number" id="inp-val1" placeholder="${conf.placeholder}" step="any" oninput="validateForm()">
            <div id="alert-val1" class="soft-alert">‚ö†Ô∏è ‡∏Ñ‡πà‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏≠‡∏¢‡∏π‡πà‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á ${conf.min} - ${conf.max}</div>
          </div>
        `;
      }

      modalBody.innerHTML = html;
      $('#form-modal').style.display = 'flex';
      
      // Focus on first input
      setTimeout(() => {
        const firstInput = modalBody.querySelector('input, textarea, select');
        if(firstInput) firstInput.focus();
      }, 300);
    }

    function closeNoteForm() {
      $('#form-modal').style.display = 'none';
    }

    function validateForm() {
      const metric = currentMetric;
      const conf = METRIC_CONFIG[metric];
      let isValid = true;

      const checkRange = (id, min, max) => {
        const el = $(id);
        if(!el) return false;
        
        // Find alert element by matching ID suffix
        const suffix = id.split('-').pop(); // e.g. val1
        const alert = $('#alert-' + suffix);
        
        const val = parseFloat(el.value);
        if (isNaN(val) || val < min || val > max) {
          el.classList.add('invalid');
          if(alert) alert.style.display = 'flex';
          return false;
        }
        el.classList.remove('invalid');
        if(alert) alert.style.display = 'none';
        return true;
      };

      if (metric === 'BP') {
        const sysValid = checkRange('#inp-val1', conf.sys_min, conf.sys_max);
        const diaValid = checkRange('#inp-val2', conf.dia_min, conf.dia_max);
        
        // Logical check: Systolic must be > Diastolic
        const sysVal = parseFloat($('#inp-val1').value);
        const diaVal = parseFloat($('#inp-val2').value);
        
        if (sysValid && diaValid && sysVal <= diaVal) {
           // If values are technically in range but logically wrong
           isValid = false; 
        } else {
           isValid = sysValid && diaValid;
        }
      } else if (metric === 'FOOD') {
        const el = $('#inp-val1');
        if (el.value.trim().length < 3) {
          el.classList.add('invalid');
          $('#alert-val1').style.display = 'flex';
          isValid = false;
        } else {
          el.classList.remove('invalid');
          $('#alert-val1').style.display = 'none';
        }
      } else if (conf.type === 'select') {
        isValid = $('#inp-val1').value !== "";
      } else {
        isValid = checkRange('#inp-val1', conf.min, conf.max);
      }

      $('#btn-save-form').disabled = !isValid;
    }

    async function submitForm() {
      $('#btn-save-form').innerText = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...';
      $('#btn-save-form').disabled = true;
      
      const metric = currentMetric;
      const payload = {
        userId: liffProfile.userId,
        type: metric,
        timestamp: new Date().toISOString()
      };

      // Safe Data Collection
      const elSubtype = $('#inp-subtype');
      const elVal1 = $('#inp-val1');
      const elVal2 = $('#inp-val2');

      if (elSubtype) payload.subtype = elSubtype.value;
      if (elVal1) payload.v1 = elVal1.value;
      if (elVal2) payload.v2 = elVal2.value;

      try {
        await apiPost('logEvent', payload);
        
        closeNoteForm();
        
        // Show Success Card with Flex-like details
        let msg = '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢';
        if (metric === 'BP') msg = `‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡∏±‡∏ô ${payload.v1}/${payload.v2} mmHg`;
        else if (metric === 'FOOD') msg = '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡πÅ‡∏•‡πâ‡∏ß';
        else if (METRIC_CONFIG[metric].unit) msg = `${METRIC_CONFIG[metric].title}: ${payload.v1} ${METRIC_CONFIG[metric].unit}`;
        
        $('#success-msg').innerText = msg;
        $('#success-modal').style.display = 'flex';

        // Auto close window
        setTimeout(() => {
          liff.closeWindow();
        }, 2500);

      } catch (err) {
        alert('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + err.message);
        $('#btn-save-form').innerText = '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•';
        $('#btn-save-form').disabled = false;
      }
    }

    // ============================================================
    // PART 2: DASHBOARD & LEGACY LOGIC (History, Graphs)
    // ============================================================
    
    async function loadDashboardData() {
      $('#loading').style.display = 'flex';
      const res = await apiFetch('getDashboard', { userId: liffProfile.userId });
      
      if (!res.profile) {
        switchView('reg');
        $('#loading').style.display = 'none';
        return;
      }

      // Render Profile
      $('#avatar').src = res.profile.PictureURL || liffProfile.pictureUrl;
      $('#p_name').innerText = res.profile.NameUse || liffProfile.displayName;
      $('#p_hn').innerText = res.profile.HN;

      // Process Events
      allEventsData = [];
      if (res.events) {
        Object.keys(res.events).forEach(type => {
          res.events[type].forEach(e => {
            allEventsData.push({
              ts: e.ts, type: type,
              subtype: e.event_subtype || e.subtype,
              v1: e.value_numeric_1 || e.v1,
              v2: e.value_numeric_2 || e.v2,
              text: e.value_text || e.vt
            });
          });
        });
      }
      allEventsData.sort((a,b) => new Date(b.ts) - new Date(a.ts));

      renderHistoryTable();
      renderCharts(res.events);
      
      switchView('dashboard');
      $('#loading').style.display = 'none';
      
      // Auto-open card logic
      const view = new URLSearchParams(window.location.search).get('view');
      if (view === 'history') openContentCard('historyCard');
    }

    function renderHistoryTable() {
      const tableBody = $('#history-table tbody');
      const filters = $('#history-filters');
      
      // Render Filters
      const types = ['ALL', 'SBGM', 'BP', 'WEIGHT', 'FOOD', 'EXERCISE'];
      filters.innerHTML = types.map(t => 
        `<button class="filter-btn ${t === currentHistoryFilter ? 'active' : ''}" onclick="filterHistory('${t}')">${t === 'ALL' ? '‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î' : METRIC_CONFIG[t]?.title || t}</button>`
      ).join('');

      // Filter Data
      const data = currentHistoryFilter === 'ALL' ? allEventsData : allEventsData.filter(e => e.type === currentHistoryFilter);

      if (data.length === 0) {
        tableBody.innerHTML = `<tr><td colspan="4" style="text-align:center; color:#999;">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</td></tr>`;
        return;
      }

      tableBody.innerHTML = data.map(e => {
        let val = e.v1;
        if (e.type === 'BP') val = `${e.v1}/${e.v2}`;
        if (e.type === 'FOOD') val = e.text;
        
        return `
          <tr>
            <td>${fmtDate(e.ts).split(' ')[0]}<br><small style="color:#999">${fmtDate(e.ts).split(' ')[1]}</small></td>
            <td>${METRIC_CONFIG[e.type]?.title || e.type}</td>
            <td>${val || '-'} <small>${e.subtype || ''}</small></td>
            <td style="text-align:right;">
              <button class="btn-small danger" onclick="deleteEvent('${e.ts}', '${e.type}')">‡∏•‡∏ö</button>
            </td>
          </tr>
        `;
      }).join('');
    }

    function filterHistory(type) {
      currentHistoryFilter = type;
      renderHistoryTable();
    }

    function renderCharts(events) {
      const wrap = $('#chartsWrap');
      wrap.innerHTML = '';
      
      const keys = ['SBGM', 'BP', 'WEIGHT'];
      keys.forEach(k => {
        if (!events[k] || events[k].length < 2) return;
        
        const div = document.createElement('div');
        div.className = 'chart-card';
        div.innerHTML = `<h3>${METRIC_CONFIG[k].title}</h3><div class="chart-box"><canvas id="c-${k}"></canvas></div>`;
        wrap.appendChild(div);
        
        const ctx = div.querySelector('canvas').getContext('2d');
        const sorted = events[k].sort((a,b) => new Date(a.ts) - new Date(b.ts));
        
        const datasets = [];
        if (k === 'BP') {
          datasets.push({ label: 'Systolic', data: sorted.map(d=>d.v1), borderColor: '#e74c3c', fill:false });
          datasets.push({ label: 'Diastolic', data: sorted.map(d=>d.v2), borderColor: '#3498db', fill:false });
        } else {
          datasets.push({ label: 'Value', data: sorted.map(d=>d.v1), borderColor: '#f39c12', fill:false });
        }

        new Chart(ctx, {
          type: 'line',
          data: {
            labels: sorted.map(d => fmtDate(d.ts).split(' ')[0]),
            datasets: datasets
          },
          options: { responsive: true, maintainAspectRatio: false }
        });
      });
    }

    async function deleteEvent(ts, type) {
      if(!confirm(`‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ ${type} ‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?`)) return;
      $('#loading').style.display = 'flex';
      await apiPost('deleteEvent', { userId: liffProfile.userId, ts: ts });
      await loadDashboardData(); // Reload
    }

    // ============================================================
    // API HELPERS
    // ============================================================
    async function apiFetch(action, params) {
      const url = new URL(GAS_URL);
      url.searchParams.set('action', action);
      Object.keys(params).forEach(k => url.searchParams.set(k, params[k]));
      const res = await fetch(url);
      return await res.json();
    }

    async function apiPost(action, payload) {
      await fetch(GAS_URL, {
        method: 'POST',
        mode: 'no-cors',
        headers: { 'Content-Type': 'text/plain;charset=utf-8' },
        body: JSON.stringify({ action, payload })
      });
    }

    function setupGlobalListeners() {
      // Content Card Toggles
      $$('.menu-btn').forEach(btn => {
        if(btn.dataset.target) {
          btn.onclick = () => openContentCard(btn.dataset.target);
        }
      });

      // Registration
      $('#btnSaveReg').onclick = async () => {
        if (!$('#consent').checked) return alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏¢‡∏≠‡∏°‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç');
        $('#loading').style.display = 'flex';
        await apiPost('registerUser', {
          userId: liffProfile.userId,
          displayName: liffProfile.displayName,
          pictureUrl: liffProfile.pictureUrl,
          hn: $('#hn').value,
          name_use: $('#nameuse').value,
          gender: $('#gender').value,
          age: $('#age').value,
          consent: true
        });
        location.reload();
      };
    }

    function openContentCard(id) {
      $$('.content-card').forEach(el => el.style.display = 'none');
      $('#main-menu').style.display = 'none';
      $(id).style.display = 'block';
    }

    function closeContentCard() {
      $$('.content-card').forEach(el => el.style.display = 'none');
      $('#main-menu').style.display = 'block';
    }

    // Start App
    window.addEventListener('load', main);

</script>
</body>
</html>