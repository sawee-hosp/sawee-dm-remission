<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"/>
  <title>‡∏™‡∏ß‡∏µ‡∏Ñ‡∏∏‡∏°‡∏´‡∏ß‡∏≤‡∏ô ‚Ä¢ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ú‡∏•</title>

  <link rel="icon" type="image/png" href="https://lh3.googleusercontent.com/d/1gJFmTXj6xpc_w8kfK-rL3HCqqgmnZp1H">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Mali:wght@400;500;600;700&display=swap" rel="stylesheet">
  
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script> 
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    :root{ --bg: #FFF8E1; --ink: #3E2723; --modal-bg-start: #5D4037; --modal-bg-end: #3E2723; --font-main: 'Mali', cursive; }
    * { box-sizing: border-box; font-family: var(--font-main) !important; }
    html, body { height: 100%; margin: 0; padding: 0; background: var(--bg); color: var(--ink); font-size: 20px; -webkit-tap-highlight-color: transparent; }
    input, button, select, textarea, .swal2-popup { font-family: var(--font-main) !important; }
    h1, h2, h3 { margin: 0 0 15px 0; font-weight: 700; }
    
    .btn { 
      border: 3px solid #FFFFFF; outline: none; background: linear-gradient(135deg, #FFEA00 0%, #FF9100 100%);
      color: #3E2723; padding: 18px 30px; border-radius: 50px; font-size: 26px; font-weight: 800; 
      width: 100%; cursor: pointer; box-shadow: 0 8px 20px rgba(255, 145, 0, 0.4); 
      display: flex; align-items: center; justify-content: center; gap: 10px; transition: transform 0.1s; position: relative; overflow: hidden;
    }
    .btn:active { transform: scale(0.96); box-shadow: 0 4px 10px rgba(255, 145, 0, 0.4); }

    .btn-metallic-green {
        background: linear-gradient(135deg, #81C784 0%, #2E7D32 100%); color: #FFF; border: 2px solid #A5D6A7;
        box-shadow: 0 4px 15px rgba(46, 125, 50, 0.4), inset 0 2px 5px rgba(255,255,255,0.5); font-size: 20px !important; margin-bottom: 20px;
    }

    @keyframes shineSweep { 0% { left: -100%; } 20% { left: 100%; } 100% { left: 100%; } }
    .btn::after, div:where(button.swal2-confirm)::after {
        content: ''; position: absolute; top: 0; left: -100%; width: 50px; height: 100%;
        background: rgba(255, 255, 255, 0.6); transform: skewX(-20deg);
        animation: shineSweep 3s infinite ease-in-out; pointer-events: none;
    }

    .btn-close { 
      background: #FF80AB; color: #D32F2F; border: 2px solid #D32F2F;
      width: auto; font-size: 18px; padding: 6px 16px; border-radius: 50px; font-weight:800; cursor: pointer;
      box-shadow: 0 4px 8px rgba(0,0,0,0.1); display: flex; align-items: center; gap: 5px;
    }
    .btn-nav-close { background: #FF80AB; color: #D32F2F; border: 2px solid #D32F2F; border-radius: 15px; font-size: 14px; padding: 4px 10px; cursor: pointer; font-weight: 800; margin-left: 5px; }

    .btn-white-round {
        background: #FFFFFF; color: #5D4037; border: 3px solid #D7CCC8;
        border-radius: 50px; padding: 12px 24px; font-size: 22px; font-weight: 700;
        margin: 15px auto 25px; display: block; cursor: pointer; transition: 0.2s; box-shadow: 0 4px 10px rgba(0,0,0,0.1);
    }

    @keyframes pulse-jiggle { 0%, 80%, 100% { transform: scale(1); box-shadow: 0 0 0 rgba(255, 179, 0, 0); } 90% { transform: scale(1.03); box-shadow: 0 0 10px rgba(255, 179, 0, 0.3); } }
    .note-item { animation: pulse-jiggle 4s infinite; }
    .main-input-anim { animation: pulse-jiggle 2.5s infinite; border-color: #FF9100 !important; box-shadow: 0 0 15px rgba(255, 145, 0, 0.5) !important; }
    .main-input-anim:focus { animation: none; }

    input, select, textarea { width: 100%; padding: 20px; font-size: 28px; border: 3px solid #D7CCC8; border-radius: 30px; background: #FFF; color: #333; text-align: center; margin-bottom: 20px; font-weight: 700; transition: all 0.2s; }
    input:focus { border-color: #FF9100 !important; outline: none; }
    input::placeholder { color: #B0BEC5; font-weight: 400; font-size: 24px; }
    
    /* --- NEW NAVBAR & SHINING TITLE --- */
    .navbar { background: linear-gradient(90deg, #4E342E, #3E2723); padding: 8px 10px; display: flex; align-items: center; justify-content: space-between; position: sticky; top: 0; z-index: 100; box-shadow: 0 4px 15px rgba(0,0,0,0.2); }
    .nav-brand-container { display: flex; align-items: center; gap: 8px; }
    .nav-icon { width: 40px; height: 40px; object-fit: contain; } 
    
    @keyframes metallicShine { 0% { background-position: -200% center; } 100% { background-position: 200% center; } }
    .nav-title { 
        font-size: 24px; font-weight: 800; line-height: 1.2; padding: 4px 0; 
        background: linear-gradient(90deg, #FFB300 0%, #FFF 50%, #FFB300 100%);
        background-size: 200% auto; color: transparent;
        -webkit-background-clip: text; background-clip: text;
        animation: metallicShine 3s infinite linear; filter: drop-shadow(1px 1px 1px rgba(0,0,0,0.8));
    }
    .nav-subtitle { font-size: 14px; font-weight: 400; color: #FFF; animation: none; text-shadow: none; -webkit-background-clip: initial; background-clip: initial;}

    .nav-community-btn {
        background: linear-gradient(135deg, #4FC3F7, #0288D1); color: #FFF; border: 2px solid #E1F5FE; border-radius: 20px;
        padding: 4px 12px; font-size: 14px; font-weight: 800; box-shadow: 0 2px 5px rgba(0,0,0,0.2); cursor: pointer;
        margin-left: auto; margin-right: 5px; animation: pulse-jiggle 3s infinite; white-space: nowrap;
    }
    .nav-return-btn {
        background: linear-gradient(135deg, #81C784, #388E3C); color: #FFF; border: 2px solid #C8E6C9; border-radius: 20px;
        padding: 4px 12px; font-size: 14px; font-weight: 800; box-shadow: 0 2px 5px rgba(0,0,0,0.2); cursor: pointer;
        margin-left: auto; margin-right: 5px; white-space: nowrap;
    }

    .container { max-width: 600px; margin: 0 auto; padding: 15px; padding-bottom: 120px; }
    
    /* --- COMPACT PROFILE CARD (FONT SIZES INCREASED BY +4px) --- */
    .compact-profile { background: linear-gradient(135deg, #A08963, #C9B194); border-radius: 20px; padding: 12px; margin-bottom: 15px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); border: 3px solid #FFF; display: flex; gap: 12px; align-items: flex-start; position: relative; }
    .pic-wrapper { position: relative; cursor: pointer; flex-shrink: 0; margin-top: 5px; }
    .pic-wrapper img { width: 70px; height: 70px; border-radius: 50%; object-fit: cover; border: 3px solid #FFF; box-shadow: 0 2px 6px rgba(0,0,0,0.2); background: #EEE; }
    .change-pic-badge { position: absolute; bottom: -2px; right: -2px; background: #3E2723; color: #FFF; font-size: 8px; padding: 1px 4px; border-radius: 8px; font-weight: 700; border: 1px solid #FFF; }
    
    .compact-info { flex: 1; text-align: left; display: flex; flex-direction: column; gap: 4px; }
    .profile-row-1 { display: flex; align-items: center; gap: 8px; flex-wrap: wrap; }
    .compact-name { font-size: 28px; font-weight: 800; color: #3E2723; line-height: 1; margin: 0; }
    .edit-badge { background:#FFF9C4; color:#F57F17; font-size:15px; padding:2px 8px; border-radius:10px; cursor:pointer; font-weight:800; border:1px solid #FBC02D; box-shadow: 0 2px 4px rgba(0,0,0,0.1);}
    
    .profile-row-2 { display: flex; align-items: center; gap: 5px; flex-wrap: wrap; }
    .compact-badge { background: rgba(255,255,255,0.6); padding: 4px 10px; border-radius: 10px; font-size: 16px; color: #3E2723; font-weight: 700; line-height: 1.2;}
    .compact-text { font-size: 16px; color: #3E2723; line-height: 1.2; font-weight: 700; }
    
    .compact-target { color: #D84315; font-size: 18px; font-weight: 800; margin-top: 4px; line-height: 1.2;}
    
    .profile-row-4 { display: flex; align-items: center; gap: 5px; flex-wrap: wrap; margin-top: 2px; }
    .med-badge-small { position: absolute; top: 12px; right: 12px; background: rgba(0, 131, 143, 0.8); color: #FFF; padding: 4px 10px; border-radius: 15px; font-size: 16px; font-weight: 700; box-shadow: 0 2px 5px rgba(0,0,0,0.2); z-index: 5; }
    .stat-mini-badge { background: #5D4037; color: #FFF; padding: 4px 10px; border-radius: 15px; font-size: 14px; font-weight: 700; display: inline-block; white-space: nowrap; box-shadow: 0 2px 4px rgba(0,0,0,0.2); }

    /* --- GRID MENU (HUGE & SQUARE) --- */
    .note-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 6px; }
    .note-item { 
      border-radius: 15px; 
      padding: 0; 
      aspect-ratio: 1 / 1; 
      display: flex; flex-direction: column; justify-content: center; align-items: center; 
      box-shadow: 0 4px 10px rgba(0,0,0,0.15); cursor: pointer; transition: 0.1s; border: 2px solid rgba(255,255,255,0.3); 
      box-sizing: border-box; overflow: hidden;
    }
    .note-item:active { transform: scale(0.95); filter: brightness(0.9); }
    .note-icon { font-size: 55px; line-height: 1; margin-bottom: 2px; filter: drop-shadow(1px 1px 2px rgba(0,0,0,0.3)); }
    .note-label { font-size: 22px; font-weight: 800; line-height: 1; color: #FFF; text-align: center; text-shadow: 1px 1px 2px rgba(0,0,0,0.6); width: 100%;}
    
    .bg-sbgm { background: linear-gradient(135deg, #e94b3c, #b71c1c); } .bg-bp { background: linear-gradient(135deg, #2b3a67, #1a237e); } .bg-food { background: linear-gradient(135deg, #fe9554, #e65100); } .bg-weight { background: linear-gradient(135deg, #8bd365, #33691e); } .bg-waist { background: linear-gradient(135deg, #00b4d8, #01579b); } .bg-bmi { background: linear-gradient(135deg, #8d6e63, #4e342e); } .bg-ex { background: linear-gradient(135deg, #ab47bc, #4a148c); } .bg-sleep { background: linear-gradient(135deg, #5c6bc0, #1a237e); } .bg-adverse { background: linear-gradient(135deg, #ef5350, #b71c1c); } .bg-hba1c { background: linear-gradient(135deg, #ec407a, #880e4f); } .bg-checkup { background: linear-gradient(135deg, #00acc1, #006064); } .bg-med { background: linear-gradient(135deg, #00897b, #004d40); } .bg-hist { background: linear-gradient(135deg, #757575, #212121); } .bg-doc { background: linear-gradient(135deg, #1976d2, #0d47a1); } .bg-nutri { background: linear-gradient(135deg, #fbc02d, #f57f17); }

    /* --- UNIFIED MODAL --- */
    .modal-overlay { position: fixed; inset: 0; z-index: 2000; display: none; align-items: flex-end; justify-content: center; }
    .modal-sheet { background: linear-gradient(180deg, var(--modal-bg-start), var(--modal-bg-end)); width: 100%; max-width: 600px; border-radius: 40px 40px 0 0; padding: 30px 20px 50px 20px; box-shadow: 0 -10px 40px rgba(0,0,0,0.3); animation: slideUp 0.4s cubic-bezier(0.2, 0.8, 0.2, 1); max-height: 95vh; overflow-y: auto; color: #FFF; border-top: 4px solid #FFD600; position: relative; }
    @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
    
    .modal-header-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
    .modal-main-title { font-size: 32px; font-weight: 800; color: #FFD600; text-shadow: 2px 2px 4px rgba(0,0,0,0.5); }
    .modal-ai-ask { font-size: 26px; font-weight: 700; color: #FFF; text-align: center; margin-bottom: 20px; line-height: 1.4;}
    .name-pink { color: #FF80AB; }
    .form-label { display: block; font-size: 22px; font-weight: 700; margin-bottom: 10px; color: #FFE0B2; text-align: center; }

    .chip-container { display: flex; flex-wrap: wrap; gap: 10px; justify-content: center; width: 100%; margin-bottom: 20px; }
    .chip-btn { background: rgba(255,255,255,0.1); border: 2px solid #D7CCC8; border-radius: 50px; padding: 10px 18px; font-size: 20px; color: #FFF; font-weight: 700; cursor: pointer; transition: 0.2s; flex: 1 1 auto; min-width: 100px; text-align: center; }
    .chip-btn.active { background: #FFD600; color: #3E2723; border-color: #FFD600; transform: scale(1.05); }

    .secondary-modal-overlay { position: fixed; inset: 0; z-index: 2500; display: none; align-items: flex-end; justify-content: center; background: rgba(0,0,0,0.6) !important; }
    .bodycomp-row { display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px; background: rgba(255,255,255,0.1); border-radius: 15px; padding: 6px 12px; }
    .bodycomp-row label { font-size: 18px; font-weight: 700; color: #FFF; width: 45%; text-align: left;}
    .bodycomp-row input { width: 35%; padding: 6px; font-size: 20px; margin-bottom: 0; border-radius: 10px; text-align: center;}
    .bodycomp-row span { font-size: 16px; color: #FFCC80; width: 20%; text-align: right;}

    /* --- HISTORY UI --- */
    .hist-card-flex { display: flex; background: #FFF; border-radius: 20px; padding: 15px; gap: 15px; margin-bottom: 20px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); border: 2px solid #FFE0B2; position: relative; padding-top: 35px; }
    .hist-card-flex.risk { background: #FFEBEE; border-color: #EF9A9A; }
    .hist-date-badge { position: absolute; top: -12px; left: 15px; background: #5D4037; color: #FFF; padding: 4px 15px; border-radius: 20px; font-size: 14px; font-weight: 700; }
    .hist-card-flex.risk .hist-date-badge { background: #C62828; }
    .hist-left { flex-shrink: 0; width: 80px; }
    .hist-left img { width: 80px; height: 80px; border-radius: 10px; object-fit: cover; border: 2px solid #EEE;}
    .hist-right { flex: 1; display: flex; flex-direction: column; gap: 0; }
    .hist-val-row { font-size: 16px; color: #5D4037; font-weight: 600; line-height: 1.2; margin-top: 5px; display:flex; align-items:center; justify-content:space-between;}
    .hist-val-bold { font-size: 26px; font-weight: 800; color: #3E2723; }
    .hist-food-title { font-weight: 800; color: #3E2723; font-size: 18px; display: block; margin-top: 5px;}
    .hist-food-advice { font-weight: 400; color: #5D4037; font-size: 14px; display: block; line-height: 1.3; margin-bottom: 5px;}
    .divider-dashed { border-bottom: 2px dashed #D7CCC8; margin: 8px 0; width: 100%; }

    .alert-badge { padding: 4px 10px; border-radius: 20px; font-size: 14px; font-weight: 800; margin-left: 5px; display: inline-block; vertical-align: middle; line-height: 1;}
    .alert-badge.high { background: #D32F2F !important; color: white !important; border: 2px solid #B71C1C;}
    .alert-badge.low { background: #E65100 !important; color: white !important; border: 2px solid #BF360C;}

    .cal-btn { background: #FFF9C4; color: #5D4037; border: 2px solid #FBC02D; border-radius: 15px; padding: 6px 12px; font-size: 16px; font-weight: 700; cursor: pointer;}
    .edit-hist-btn { background: #E1F5FE; color: #0277BD; border: 2px solid #81D4FA; border-radius: 15px; padding: 6px 12px; font-size: 16px; font-weight: 700; cursor: pointer; margin-left: 5px;}
    
    .cal-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; text-align: center; margin-top: 15px; }
    .cal-day-name { font-size: 14px; font-weight: 700; color: #8D6E63; }
    .cal-date { aspect-ratio: 1; display: flex; align-items: center; justify-content: center; font-size: 16px; border-radius: 50%; color: #3E2723; margin: 2px; }
    .cal-date.has-data { background: #FFE0B2; font-weight: 700; box-shadow: 0 2px 4px rgba(0,0,0,0.1); cursor: pointer;}
    .cal-date.has-risk { background: #FFCDD2; color: #B71C1C; font-weight: 700; border: 2px solid #EF9A9A; box-shadow: 0 2px 4px rgba(0,0,0,0.1); cursor: pointer;}
    
    div:where(.swal2-container) { z-index: 3000 !important; }
    div:where(button.swal2-confirm) { font-weight: 800 !important; border-radius: 50px !important; }
    .swal-red-popup { background: linear-gradient(180deg, #e94b3c, #b71c1c) !important; color: #FFF !important; border: 3px solid #FFCDD2 !important; position: relative; overflow: hidden; }
    .swal-red-popup .swal2-title, .swal-red-popup .swal2-html-container { color: #FFF !important; }
    .nurse-bg-img { position: absolute; bottom: -20px; right: -20px; width: 150px; opacity: 0.3; z-index: 0; pointer-events: none; }
    .swal-green-popup { background: linear-gradient(180deg, #bbe1c3, #66BB6A) !important; color: #1B5E20 !important; border: 3px solid #FFF !important; }
    .swal-green-popup .swal2-title, .swal-green-popup .swal2-html-container { color: #1B5E20 !important; }
    .swal-brown-popup { background: linear-gradient(180deg, #5D4037, #3E2723) !important; color: #FFF !important; border: 3px solid #FFD600 !important; }
    .swal-brown-popup .swal2-title { color: #FFD600 !important; }
    .swal-brown-popup .swal2-html-container { color: #FFF !important; }

    /* LOADING SPINNER AROUND LOGO */
    .loader-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.8); display: none; flex-direction: column; justify-content: center; align-items: center; z-index: 9999; }
    .loader-logo-container { position: relative; width: 100px; height: 100px; display: flex; align-items: center; justify-content: center; }
    .loader-logo { width: 70px; height: 70px; border-radius: 50%; object-fit: contain; z-index: 2; position: relative;}
    
    @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
    .swee-spinner-ring { position: absolute; top: 0; left: 0; right: 0; bottom: 0; border: 6px solid rgba(255,255,255,0.2); border-top: 6px solid #FF9100; border-radius: 50%; animation: spin 1s linear infinite; z-index: 1; }
    
    /* COMMUNITY UI */
    .comm-card { min-width: 260px; max-width: 260px; background: #FFF; border-radius: 20px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); border: 2px solid #81D4FA; flex-shrink: 0; overflow: hidden; display: flex; flex-direction: column; position: relative; }
    .comm-img { width: 100%; height: 160px; object-fit: cover; }
    .comm-body { padding: 12px; }
    .comm-user { font-size: 14px; color: #FFF; background: #0288D1; padding: 4px 10px; border-radius: 10px; display: inline-block; margin-bottom: 5px; font-weight:700;}
    .comm-sbgm { font-size: 14px; color: #D32F2F; margin-top: 5px; font-weight:700; background:#FFCDD2; padding: 2px 6px; border-radius:8px; display:inline-block;}
    
    .like-btn { position: absolute; top: 10px; right: 10px; background: rgba(255,255,255,0.95); border: 2px solid #FFCDD2; border-radius: 20px; padding: 4px 10px; font-size: 14px; font-weight: 800; color: #D32F2F; cursor: pointer; box-shadow: 0 4px 8px rgba(0,0,0,0.2); transition: 0.2s; display: flex; align-items: center; gap: 5px; z-index: 10;}
    .like-btn:active { transform: scale(0.9); }
    .float-up { position: absolute; font-size: 20px; font-weight: bold; color: #FF9100; pointer-events: none; animation: floatUpAnim 1s forwards; opacity: 0; text-shadow: 1px 1px 0 #FFF; z-index: 20;}
    @keyframes floatUpAnim { 0% { opacity: 1; transform: translateY(0) scale(1); } 100% { opacity: 0; transform: translateY(-40px) scale(1.5); } }

    /* Scrollable Carousel Wrapper */
    .comm-carousel-wrapper { 
        overflow-x: auto; overflow-y: hidden; white-space: nowrap; padding-bottom: 15px; 
        scrollbar-width: none; -ms-overflow-style: none; -webkit-overflow-scrolling: touch; cursor: grab;
        display: flex; gap: 15px;
    }
    .comm-carousel-wrapper::-webkit-scrollbar { display: none; }
    
    .medal-card { border-radius: 15px; padding: 15px; margin-bottom: 10px; display: flex; align-items: center; gap: 15px; box-shadow: 0 4px 8px rgba(0,0,0,0.05); }
    .medal-icon { font-size: 60px; width: 90px; height: 90px; display: flex; align-items: center; justify-content: center; border-radius: 50%; flex-shrink: 0; background: rgba(0,0,0,0.05);}

    /* NUTRITION UI */
    .nutri-step { display: none; animation: slideUp 0.4s ease; }
    .nutri-step.active { display: block; }
    .nutri-table { width: 100%; border-collapse: collapse; margin-top: 15px; font-size: 14px; background: #FFF; color: #3E2723; border-radius: 10px; overflow: hidden;}
    .nutri-table th { background: #FFD600; color: #3E2723; padding: 10px; text-align: center; }
    .nutri-table td { border-bottom: 1px solid #EEE; padding: 8px 4px; text-align: center; vertical-align: middle; }
    .nutri-table td:first-child { text-align: left; font-weight: bold; }
  </style>
</head>
<body>

  <!-- Loading Overlay -->
  <div id="loading" class="loader-overlay">
      <div class="loader-logo-container">
          <img src="https://lh3.googleusercontent.com/d/1gJFmTXj6xpc_w8kfK-rL3HCqqgmnZp1H" class="loader-logo">
          <div class="swee-spinner-ring"></div>
      </div>
      <div style="color:#FFF; font-weight:700; margin-top:15px; font-size:20px; letter-spacing:1px;">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</div>
  </div>

  <!-- Navbar -->
  <nav class="navbar">
      <div class="nav-brand-container">
          <img class="nav-icon" src="https://lh3.googleusercontent.com/d/1gJFmTXj6xpc_w8kfK-rL3HCqqgmnZp1H" alt="Logo">
          <div class="nav-title-box">
              <div class="nav-title">‡∏™‡∏ß‡∏µ‡∏Ñ‡∏∏‡∏°‡∏´‡∏ß‡∏≤‡∏ô<span class="nav-subtitle"> ‡πÇ‡∏î‡∏¢ ‡∏£‡∏û.‡∏™‡∏ß‡∏µ</span></div>
          </div>
      </div>
      <div style="display:flex; align-items:center;">
          <button id="nav-mode-btn" class="nav-community-btn" onclick="toggleCommunityMode()">‡∏ä‡∏∏‡∏°‡∏ä‡∏ô‡∏Ñ‡∏ô‡∏Ñ‡∏∏‡∏°‡∏´‡∏ß‡∏≤‡∏ô</button>
          <button class="btn-nav-close" onclick="liff.closeWindow()">‚úñ</button>
      </div>
  </nav>

  <!-- SHARED PROFILE CONTAINER -->
  <div id="shared-profile-container" class="container" style="padding-top: 15px; padding-bottom: 0;">
      <div class="profile-header compact-profile" id="main-profile-header" style="display: none;">
          <div id="head-med-stat" class="med-badge-small" style="display:none;"></div>
          <div class="pic-wrapper" onclick="$('#profile-pic-input').click()">
              <img id="head-avatar" src="https://lh3.googleusercontent.com/d/1gJFmTXj6xpc_w8kfK-rL3HCqqgmnZp1H" alt="Avatar">
              <div class="change-pic-badge">‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏π‡∏õ</div>
          </div>
          <div class="compact-info">
              <div class="profile-row-1"><div class="compact-name" id="head-name">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</div><div class="edit-badge" onclick="openEditProfile()">‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</div></div>
              <div class="profile-row-2"><div class="compact-badge" id="head-start">‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÄ‡∏°‡∏∑‡πà‡∏≠ : ...</div><div class="compact-text" id="head-target">‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏≠‡∏µ‡∏Å ... ‡∏ß‡∏±‡∏ô‡∏à‡∏∞‡∏ñ‡∏∂‡∏á‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢</div></div>
              <div class="compact-target" id="head-weight-target" style="display:none;">‡∏ï‡πâ‡∏≠‡∏á‡∏•‡∏î‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡∏≠‡∏µ‡∏Å ... ‡∏Å‡∏¥‡πÇ‡∏•‡∏Å‡∏£‡∏±‡∏° ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏û‡∏¥‡∏ä‡∏¥‡∏ï‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢</div>
              <div class="profile-row-4">
                  <div class="stat-mini-badge">‡πÄ‡∏à‡∏≤‡∏∞‡πÄ‡∏•‡∏∑‡∏≠‡∏î <span id="stat-sbgm">0</span> ‡∏Ñ‡∏£‡∏±‡πâ‡∏á</div>
                  <div class="stat-mini-badge">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏≠‡∏≤‡∏´‡∏≤‡∏£ <span id="stat-food">0</span> ‡∏Ñ‡∏£‡∏±‡πâ‡∏á</div>
                  <div class="stat-mini-badge">‡∏≠‡∏≠‡∏Å‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Å‡∏≤‡∏¢ <span id="stat-ex">0</span> ‡∏ô‡∏≤‡∏ó‡∏µ</div>
              </div>
          </div>
      </div>
  </div>

  <!-- MAIN CONTENT CONTAINER (Grid Menu) -->
  <div id="main-content" class="container" style="padding-top: 0; padding-bottom: 120px;">
      <!-- MENU GRID -->
      <div class="note-grid" id="main-grid">
        <div class="note-item bg-sbgm" onclick="openNoteForm('SBGM')"><div class="note-icon">ü©∏</div><div class="note-label">‡∏ô‡πâ‡∏≥‡∏ï‡∏≤‡∏•<br>‡∏õ‡∏•‡∏≤‡∏¢‡∏ô‡∏¥‡πâ‡∏ß</div></div>
        <div class="note-item bg-bp" onclick="openNoteForm('BP')"><div class="note-icon">üíì</div><div class="note-label">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡∏±‡∏ô<br>‡πÇ‡∏•‡∏´‡∏¥‡∏ï</div></div>
        <div class="note-item bg-food" onclick="openNoteForm('FOOD')"><div class="note-icon">üç≤</div><div class="note-label">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å<br>‡∏≠‡∏≤‡∏´‡∏≤‡∏£</div></div>
        <div class="note-item bg-weight" onclick="openNoteForm('WEIGHT')"><div class="note-icon">‚öñÔ∏è</div><div class="note-label">‡∏ä‡∏±‡πà‡∏á‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å</div></div>
        <div class="note-item bg-waist" onclick="openNoteForm('WAIST')"><div class="note-icon">üìè</div><div class="note-label">‡∏ß‡∏±‡∏î‡∏£‡∏≠‡∏ö‡πÄ‡∏≠‡∏ß</div></div>
        <div class="note-item bg-bmi" onclick="openNoteForm('BODYCOMP')"><div class="note-icon">üë§</div><div class="note-label">‡∏î‡∏±‡∏ä‡∏ô‡∏µ<br>‡∏°‡∏ß‡∏•‡∏Å‡∏≤‡∏¢</div></div>
        <div class="note-item bg-ex" onclick="openNoteForm('EXERCISE')"><div class="note-icon">üèÉ‚Äç‚ôÄÔ∏è</div><div class="note-label">‡∏≠‡∏≠‡∏Å<br>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Å‡∏≤‡∏¢</div></div>
        <div class="note-item bg-sleep" onclick="openNoteForm('SLEEP')"><div class="note-icon">üò¥</div><div class="note-label">‡∏Å‡∏≤‡∏£‡∏ô‡∏≠‡∏ô/<br>‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏Ñ‡∏£‡∏µ‡∏¢‡∏î</div></div>
        <div class="note-item bg-adverse" onclick="openNoteForm('ADVERSE')"><div class="note-icon">‚ö†Ô∏è</div><div class="note-label">‡∏≠‡∏≤‡∏Å‡∏≤‡∏£<br>‡∏ú‡∏¥‡∏î‡∏õ‡∏Å‡∏ï‡∏¥</div></div>
        <div class="note-item bg-hba1c" onclick="openNoteForm('HBA1C')"><div class="note-icon">üß™</div><div class="note-label">‡∏ô‡πâ‡∏≥‡∏ï‡∏≤‡∏•<br>‡∏™‡∏∞‡∏™‡∏°</div></div>
        <div class="note-item bg-checkup" onclick="openNoteForm('CHECKUP')"><div class="note-icon">üè•</div><div class="note-label">‡∏ï‡∏£‡∏ß‡∏à‡πÑ‡∏ï<br>‡∏ï‡∏≤/‡πÄ‡∏ó‡πâ‡∏≤</div></div>
        <div class="note-item bg-med" onclick="openNoteForm('MED')"><div class="note-icon">üíä</div><div class="note-label">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏¢‡∏≤</div></div>
        <div class="note-item bg-nutri" onclick="openNoteForm('NUTRITION')"><div class="note-icon">ü•ó</div><div class="note-label">‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì<br>‡∏û‡∏•‡∏±‡∏á‡∏á‡∏≤‡∏ô‡∏≠‡∏≤‡∏´‡∏≤‡∏£</div></div>
        <div class="note-item bg-hist" onclick="openHistory()"><div class="note-icon">üìÖ</div><div class="note-label">‡∏î‡∏π‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥</div></div>
        <div class="note-item bg-doc" onclick="openReport()"><div class="note-icon">ü©∫</div><div class="note-label">‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô<br>‡πÅ‡∏û‡∏ó‡∏¢‡πå</div></div>
      </div>
  </div>

  <!-- VIEW: Community Dashboard -->
  <div id="community-view" class="container" style="display:none; padding-top: 0; padding-bottom: 120px;">
      
      <div style="background:#FFF; padding:15px; border-radius:15px; border:2px dashed #FF9100; margin-bottom:20px; font-size:14px; color:#5D4037; line-height:1.4; text-align:center;">
          ‚ù§Ô∏è <b>‡∏Å‡∏≤‡∏£‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡πÄ‡∏ö‡∏≤‡∏´‡∏ß‡∏≤‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏ä‡πâ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÉ‡∏à‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏°‡∏≤‡∏Å</b><br>
          ‡πÄ‡∏£‡∏≤‡∏à‡∏∂‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ä‡∏∏‡∏°‡∏ä‡∏ô‡∏Ñ‡∏ô‡∏Ñ‡∏∏‡∏°‡∏´‡∏ß‡∏≤‡∏ô ‡∏ó‡∏µ‡πà‡∏£‡∏ß‡∏°‡∏ú‡∏π‡πâ‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏û‡∏•‡∏±‡∏á‡πÉ‡∏à‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏±‡∏ö‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏û‡∏§‡∏ï‡∏¥‡∏Å‡∏£‡∏£‡∏° ‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡∏ô‡πâ‡∏≥‡∏ï‡∏≤‡∏•‡πÑ‡∏î‡πâ‡πÇ‡∏î‡∏¢‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏ä‡πâ‡∏¢‡∏≤ ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô ‡∏à‡∏∂‡∏á‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏°‡πà‡∏£‡∏π‡πâ‡∏™‡∏∂‡∏Å‡πÇ‡∏î‡∏î‡πÄ‡∏î‡∏µ‡πà‡∏¢‡∏ß ‡∏¢‡∏±‡∏á‡∏°‡∏µ‡∏≠‡∏µ‡∏Å‡∏´‡∏•‡∏≤‡∏¢‡∏Ñ‡∏ô‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏≥‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡πà‡∏∞
          <br><i style="font-size:11px; color:#9E9E9E;">*‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ñ‡∏π‡∏Å‡∏õ‡∏Å‡∏õ‡∏¥‡∏î‡∏ï‡∏±‡∏ß‡∏ï‡∏ô‡πÅ‡∏•‡∏∞‡∏î‡∏∂‡∏á‡∏°‡∏≤‡∏à‡∏≤‡∏Å‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏à‡∏£‡∏¥‡∏á</i>
      </div>

      <div style="display:flex; gap:10px; margin-bottom:15px;">
          <div style="flex:1; background:#E1F5FE; padding:15px; border-radius:15px; text-align:center; border:2px solid #81D4FA;">
              <div style="font-size:12px; color:#0277BD; font-weight:800;">‡∏Ñ‡∏ô‡∏£‡πà‡∏ß‡∏°‡πÇ‡∏õ‡∏£‡πÅ‡∏Å‡∏£‡∏°</div>
              <div id="comm-total-users" style="font-size:28px; color:#01579B; font-weight:800;">-</div>
          </div>
          <div style="flex:1; background:#FFF9C4; padding:15px; border-radius:15px; text-align:center; border:2px solid #FBC02D;">
              <div style="font-size:12px; color:#F57F17; font-weight:800;">‡∏´‡∏¢‡∏∏‡∏î‡∏¢‡∏≤‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</div>
              <div id="comm-rem-users" style="font-size:28px; color:#E65100; font-weight:800; line-height:1;">-</div>
          </div>
      </div>

      <h3 style="color:#5D4037; font-size:18px;">üåü ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•‡∏ï‡πâ‡∏ô‡πÅ‡∏ö‡∏ö‡∏Ñ‡∏∏‡∏°‡∏´‡∏ß‡∏≤‡∏ô‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå</h3>
      <div class="comm-carousel-wrapper" id="comm-role-models" style="margin-bottom:20px;"></div>

      <h3 style="color:#5D4037; font-size:18px;">üçΩÔ∏è ‡πÑ‡∏≠‡πÄ‡∏î‡∏µ‡∏¢‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡πÜ ‡πÉ‡∏ô‡∏£‡∏≠‡∏ö 7 ‡∏ß‡∏±‡∏ô</h3>
      <p style="font-size:11px; color:#888; margin-top:-10px;">*‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏Å‡∏±‡∏ö‡∏Ñ‡πà‡∏≤‡∏ô‡πâ‡∏≥‡∏ï‡∏≤‡∏•‡πÉ‡∏ô‡πÄ‡∏•‡∏∑‡∏≠‡∏î ‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏Ç‡∏∂‡πâ‡∏ô‡∏≠‡∏¢‡∏π‡πà‡∏Å‡∏±‡∏ö‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏• (‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ó‡∏µ‡πà‡∏Å‡∏≤‡∏£‡πå‡∏î‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏´‡∏¢‡∏∏‡∏î‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô)</p>
      
      <div class="comm-carousel-wrapper" id="comm-carousel"></div>

      <h3 style="color:#5D4037; font-size:18px; margin-top:20px;">üçõ 7 ‡∏°‡∏∑‡πâ‡∏≠‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</h3>
      <div id="comm-my-foods" style="display:flex; flex-direction:column; gap:10px;"></div>
  </div>

  <!-- VIEW: History -->
  <div id="history-view" class="container" style="display:none; padding-bottom: 120px;">
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px; flex-wrap:wrap; gap:5px;">
          <h2 style="color:#5D4037; margin:0; display:flex; align-items:center; gap:10px;">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û</h2>
          <div>
              <button class="cal-btn" onclick="openCalendar()">üìÖ ‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô</button>
              <button class="edit-hist-btn" onclick="openEditHistoryView()">‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥</button>
              <button onclick="closeViews()" style="background:#FF9100; color:#FFF; border:none; border-radius:15px; padding:6px 12px; font-size:16px; font-weight:700; cursor:pointer;">‡∏Å‡∏•‡∏±‡∏ö</button>
          </div>
      </div>
      <div id="history-container"></div> 
  </div>

  <!-- VIEW: Edit History List -->
  <div id="edit-history-view" class="container" style="display:none; padding-bottom: 120px;">
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
          <h2 style="color:#1976D2; margin:0;">‚úèÔ∏è ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</h2>
          <button onclick="$('#edit-history-view').style.display='none'; $('#history-view').style.display='block';" style="background:#9E9E9E; color:#FFF; border:none; border-radius:15px; padding:6px 15px; font-size:16px; font-weight:700; cursor:pointer;">‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö</button>
      </div>
      <div id="edit-history-list" style="display:flex; flex-direction:column; gap:10px;"></div>
  </div>

  <!-- VIEW: Calendar -->
  <div id="calendar-view" class="container" style="display:none; padding-bottom: 120px;">
      <div class="cal-header" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
          <button onclick="changeMonth(-1)" style="background:#FF9100; color:#FFF; border:none; border-radius:50%; width:40px; height:40px; font-size:20px; font-weight:bold; cursor:pointer;">‚óÄ</button>
          <h2 id="cal-month-title" style="color:#5D4037; margin:0;">‡πÄ‡∏î‡∏∑‡∏≠‡∏ô...</h2>
          <button onclick="changeMonth(1)" style="background:#FF9100; color:#FFF; border:none; border-radius:50%; width:40px; height:40px; font-size:20px; font-weight:bold; cursor:pointer;">‚ñ∂</button>
      </div>
      <div style="display:flex; gap:10px; margin-bottom:15px; justify-content:center; font-size:14px;">
          <div><span style="display:inline-block; width:15px; height:15px; background:#FFE0B2; border-radius:50%; vertical-align:middle;"></span> ‡∏õ‡∏Å‡∏ï‡∏¥</div>
          <div><span style="display:inline-block; width:15px; height:15px; background:#FFCDD2; border:2px solid #EF9A9A; border-radius:50%; vertical-align:middle;"></span> ‡∏°‡∏µ‡∏Ñ‡πà‡∏≤‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á</div>
      </div>
      <div class="cal-grid" id="cal-days-header">
          <div class="cal-day-name">‡∏≠‡∏≤</div><div class="cal-day-name">‡∏à</div><div class="cal-day-name">‡∏≠</div><div class="cal-day-name">‡∏û</div><div class="cal-day-name">‡∏û‡∏§</div><div class="cal-day-name">‡∏®</div><div class="cal-day-name">‡∏™</div>
      </div>
      <div class="cal-grid" id="cal-grid-body"></div>
      <button class="btn" style="margin-top:30px;" onclick="$('#calendar-view').style.display='none'; $('#history-view').style.display='block';">‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏î‡∏π‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥ ‚û°Ô∏è</button>
  </div>

  <!-- VIEW: Register -->
  <div id="register-view" style="display:none; background:#FFF8E1; min-height:100vh;">
     <nav class="navbar"><div class="nav-brand" style="margin: 0 auto;">üìù ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏™‡∏ß‡∏µ‡∏Ñ‡∏∏‡∏°‡∏´‡∏ß‡∏≤‡∏ô</div></nav>
     <div style="padding: 20px; max-width: 500px; margin: 0 auto;">
         <form id="reg-form" onsubmit="submitRegistration(event)">
            <div class="reg-form-group" style="margin-bottom: 20px;">
                <label style="font-weight: bold; color: #5D4037; display: block; margin-bottom: 5px;">‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å</label>
                <input required type="text" id="reg-name" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏•‡∏∏‡∏á‡πÅ‡∏î‡∏á ‡∏õ‡πâ‡∏≤‡∏™‡πâ‡∏° ‡∏û‡∏µ‡πà‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß">
            </div>
            <div class="reg-form-group" style="margin-bottom: 20px;">
                <label style="font-weight: bold; color: #5D4037; display: block; margin-bottom: 5px;">‡πÄ‡∏•‡∏Ç‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢ ‡∏£‡∏û.‡∏™‡∏ß‡∏µ (HN)</label>
                <input required type="tel" id="reg-hn" pattern="\d{9}" maxlength="9" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏•‡∏Ç 9 ‡∏´‡∏•‡∏±‡∏Å" oninput="validateNumber(this)">
            </div>
            <div class="reg-form-group" style="margin-bottom: 20px;">
                <label style="font-weight: bold; color: #5D4037; display: block; margin-bottom: 5px;">‡∏≠‡∏≤‡∏ä‡∏µ‡∏û</label>
                <input required type="text" id="reg-job" placeholder="‡∏≠‡∏≤‡∏ä‡∏µ‡∏û‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì">
            </div>
            <div class="reg-form-group" style="margin-bottom: 20px;">
                <label style="font-weight: bold; color: #5D4037; display: block; margin-bottom: 5px;">‡πÄ‡∏û‡∏®</label>
                <div style="display:flex; gap:10px;">
                    <label style="flex:1; background:#FFF; border:2px solid #D7CCC8; padding:10px; border-radius:15px; text-align:center;"><input required type="radio" name="reg-gender" value="Male"> üë® ‡∏ä‡∏≤‡∏¢</label>
                    <label style="flex:1; background:#FFF; border:2px solid #D7CCC8; padding:10px; border-radius:15px; text-align:center;"><input required type="radio" name="reg-gender" value="Female"> üë© ‡∏´‡∏ç‡∏¥‡∏á</label>
                </div>
            </div>
            <div class="reg-form-group" style="margin-bottom: 20px;">
                <label style="font-weight: bold; color: #5D4037; display: block; margin-bottom: 5px;">‡∏≠‡∏≤‡∏¢‡∏∏ (‡∏õ‡∏µ)</label>
                <input required type="tel" id="reg-age" placeholder="‡∏≠‡∏≤‡∏¢‡∏∏" oninput="validateNumber(this)" maxlength="3">
            </div>
            <div class="reg-form-group" style="margin-bottom: 20px;">
                <label style="font-weight: bold; color: #5D4037; display: block; margin-bottom: 5px;">‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô (‡∏Å‡∏Å.)</label>
                <input required type="tel" id="reg-weight" placeholder="‡πÄ‡∏ä‡πà‡∏ô 65.5" inputmode="decimal" oninput="this.value = this.value.replace(/[^0-9.]/g, '')">
            </div>
            <label style="background: #FFF; border: 2px solid #FFE0B2; padding: 15px; border-radius: 15px; display: flex; gap: 10px; align-items: flex-start; cursor: pointer; margin-top: 20px;">
                <input required type="checkbox" id="reg-consent" style="width: 25px; height: 25px; margin-top: 5px;">
                <p style="margin: 0; font-size: 16px; color: #5D4037; line-height: 1.4;">‡∏¢‡∏¥‡∏ô‡∏¢‡∏≠‡∏°‡πÉ‡∏´‡πâ ‡∏Ñ‡∏•‡∏¥‡∏ô‡∏¥‡∏Å‡πÄ‡∏ö‡∏≤‡∏´‡∏ß‡∏≤‡∏ô‡∏£‡∏∞‡∏¢‡∏∞‡∏™‡∏á‡∏ö ‡∏£‡∏û.‡∏™‡∏ß‡∏µ ‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏Å‡∏©‡∏≤ ‡πÅ‡∏•‡∏∞‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡πÅ‡∏ä‡∏£‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (‡∏õ‡∏¥‡∏î‡∏ö‡∏±‡∏á‡∏ï‡∏±‡∏ß‡∏ï‡∏ô) ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ</p>
            </label>
            <button type="submit" class="btn" style="margin-top: 30px;">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ‚úÖ</button>
        </form>
     </div>
  </div>

  <!-- ========================================== -->
  <!-- UNIVERSAL MODAL SYSTEM                     -->
  <!-- ========================================== -->
  <div id="primary-modal" class="modal-overlay">
    <div class="modal-sheet">
      <div class="modal-header-row">
        <div class="modal-main-title" id="pri-title">‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠</div>
        <button class="btn-close" id="pri-close-btn" onclick="closeAllModals()">‚úñ ‡∏õ‡∏¥‡∏î</button>
      </div>
      <div class="modal-ai-ask" id="pri-ask">‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏Ñ‡∏∏‡∏ì <span class="name-pink">...</span> ... ‡πÑ‡∏î‡πâ‡∏Ñ‡πà‡∏≤‡πÄ‡∏ó‡πà‡∏≤‡πÑ‡∏´‡∏£‡πà‡∏Ñ‡∏∞?</div>
      <div id="pri-body"></div>
    </div>
  </div>

  <div id="secondary-modal" class="secondary-modal-overlay">
    <div class="modal-sheet" style="border-top-color: #FFB300;">
      <div class="modal-header-row">
        <div class="modal-main-title" style="color:#FFB300;">‡∏£‡∏∞‡∏ö‡∏∏‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏¥‡πà‡∏°</div>
        <button class="btn-close" onclick="$('#secondary-modal').style.display='none'">‚úñ ‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö</button>
      </div>
      <div class="modal-ai-ask" id="sec-ask">‡∏•‡∏∑‡∏°‡∏£‡∏∞‡∏ö‡∏∏‡∏≠‡∏∞‡πÑ‡∏£‡πÑ‡∏õ‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏õ‡∏•‡πà‡∏≤‡∏Ñ‡∏∞?</div>
      <div id="sec-body"></div>
    </div>
  </div>

  <div id="edit-profile-modal" class="modal-overlay">
    <div class="modal-sheet">
      <div class="modal-header-row">
        <div class="modal-main-title">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß</div>
        <button class="btn-close" onclick="closeAllModals()">‚úñ ‡∏õ‡∏¥‡∏î</button>
      </div>
      <form id="edit-form" onsubmit="submitEditProfile(event)">
          <div class="form-label">‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å</div>
          <input required type="text" id="edit-name" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô" class="main-input-anim">
          <div class="form-label">‡∏≠‡∏≤‡∏¢‡∏∏ (‡∏õ‡∏µ)</div>
          <input required type="tel" id="edit-age" placeholder="‡∏≠‡∏≤‡∏¢‡∏∏" oninput="validateNumber(this)">
          <div class="form-label">‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô (‡∏Å‡∏Å.)</div>
          <input required type="tel" id="edit-weight" placeholder="‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô" inputmode="decimal" oninput="this.value = this.value.replace(/[^0-9.]/g, '')">
          <div class="form-label">‡∏≠‡∏≤‡∏ä‡∏µ‡∏û</div>
          <input required type="text" id="edit-job" placeholder="‡∏≠‡∏≤‡∏ä‡∏µ‡∏û‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì">
          <button type="submit" class="btn" style="margin-top:20px;">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç ‚úÖ</button>
      </form>
    </div>
  </div>

  <!-- 4. Doctor Report Modal -->
  <div id="report-modal" class="modal-overlay">
    <div class="modal-sheet" style="background:#FFF8E1; color:#3E2723; border-top: 4px solid #1976D2;">
      <div class="modal-header-row">
        <div class="modal-main-title" style="color:#1976D2; text-shadow:none;">‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡πÅ‡∏û‡∏ó‡∏¢‡πå</div>
        <button class="btn-close" style="background:#FFF; color:#3E2723; border-color:#D7CCC8;" onclick="closeAllModals();">‚úñ ‡∏õ‡∏¥‡∏î</button>
      </div>
      <div style="max-height: 70vh; overflow-y: auto; padding-right: 5px;">
          <div style="text-align:center; margin-bottom:15px; font-size:18px; font-weight:700;">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ 14 ‡∏ß‡∏±‡∏ô‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î: <span id="report-status" class="status-badge status-waiting">Waiting</span></div>
          <div style="display:flex; gap:10px; margin-bottom:20px;">
              <div style="flex:1; background:#FFEBEE; padding:15px; border-radius:20px; text-align:center; border:2px solid #EF9A9A;"><div style="font-size:16px; color:#C62828; font-weight:700;">‡∏ô‡πâ‡∏≥‡∏ï‡∏≤‡∏•‡∏™‡∏π‡∏á (‡∏Ñ‡∏£‡∏±‡πâ‡∏á)</div><div id="rep-high" style="font-size:32px; color:#B71C1C; font-weight:800;">0</div></div>
              <div style="flex:1; background:#FFF3E0; padding:15px; border-radius:20px; text-align:center; border:2px solid #FFCC80;"><div style="font-size:16px; color:#E65100; font-weight:700;">‡∏ô‡πâ‡∏≥‡∏ï‡∏≤‡∏•‡∏ï‡πà‡∏≥ (‡∏Ñ‡∏£‡∏±‡πâ‡∏á)</div><div id="rep-low" style="font-size:32px; color:#E65100; font-weight:800;">0</div></div>
          </div>
          <h3 style="color:#1976D2; margin-bottom:5px;">‡∏Å‡∏£‡∏≤‡∏ü‡∏ô‡πâ‡∏≥‡∏ï‡∏≤‡∏•‡πÉ‡∏ô‡πÄ‡∏•‡∏∑‡∏≠‡∏î (mg/dL)</h3>
          <div style="background:#FFF; padding:10px; border-radius:20px; border:2px solid #D7CCC8; height: 250px; margin-bottom:20px;"><canvas id="sbgmChart"></canvas></div>
          <h3 style="color:#1976D2; margin-bottom:5px;">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡∏±‡∏ô‡πÇ‡∏•‡∏´‡∏¥‡∏ï (SYS / DIA)</h3>
          <div style="background:#FFF; padding:10px; border-radius:20px; border:2px solid #D7CCC8; height: 250px; margin-bottom:20px;"><canvas id="bpChart"></canvas></div>
          <h3 style="color:#1976D2; margin-bottom:5px;">‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å (‡∏Å‡∏Å.) & ‡∏£‡∏≠‡∏ö‡πÄ‡∏≠‡∏ß (‡∏ã‡∏°.)</h3>
          <div style="background:#FFF; padding:10px; border-radius:20px; border:2px solid #D7CCC8; height: 250px; margin-bottom:20px;"><canvas id="weightWaistChart"></canvas></div>
          <h3 style="color:#C62828; margin-bottom:5px;">‚ö†Ô∏è ‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡∏ú‡∏¥‡∏î‡∏õ‡∏Å‡∏ï‡∏¥ (14 ‡∏ß‡∏±‡∏ô‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î)</h3>
          <div id="rep-adverse-list" style="background:#FFF; padding:15px; border-radius:20px; border:2px solid #FFCDD2; min-height: 50px;"></div>
      </div>
    </div>
  </div>

  <input type="file" id="media-input" accept="image/*" style="display:none" onchange="uploadFoodImage(this)">
  <input type="file" id="profile-pic-input" accept="image/*" style="display:none" onchange="uploadProfilePic(this)">

<script>
    const GAS_URL = 'https://script.google.com/macros/s/AKfycbzvLY5kLKw2sUaSelEZcxka2CsdiRoGdA9jmHMoKs3oB04ypte7yDwStWo6cFwb2-Y8Sw/exec'; 
    let LIFF_ID = '2007840605-zKl7p3Aa'; // üî• ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÉ‡∏™‡πà LIFF ID ‡∏Ç‡∏≠‡∏á‡∏à‡∏£‡∏¥‡∏á
    const TEST_USER_ID = 'U4b2462c3ea87936a546558354070ef4d'; 

    let liffProfile = { userId: TEST_USER_ID, displayName: "‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô" }; 
    let userDisplayName = "‡∏Ñ‡∏∏‡∏ì";
    let currentAction = ''; let pendingFormData = {}; window.appEvents = []; window.currentProfile = null; window.currentNutritionProfile = null; 
    
    let sbgmChartInst = null; let bpChartInst = null; let wwChartInst = null; let plateChartInst = null; let calMonthOffset = 0;
    
    // Carousel Animation Handlers
    let animFrames = {};

    const $ = selector => document.querySelector(selector);
    
    const swalAlert = Swal.mixin({ customClass: { popup: 'swal-red-popup', confirmButton: 'btn', cancelButton: 'btn-white-round' }, buttonsStyling: false });
    const swalSuccess = Swal.mixin({ customClass: { popup: 'swal-green-popup', confirmButton: 'btn' }, buttonsStyling: false });
    const swalForm = Swal.mixin({ customClass: { popup: 'swal-brown-popup', confirmButton: 'btn', cancelButton: 'btn-close' }, buttonsStyling: false });

    function getImageUrl(url) {
        if (!url) return 'https://lh3.googleusercontent.com/d/1gJFmTXj6xpc_w8kfK-rL3HCqqgmnZp1H';
        if (url.includes('drive.google.com') && url.includes('id=')) { try { const id = new URLSearchParams(new URL(url).search).get('id'); if(id) return `https://lh3.googleusercontent.com/d/${id}`; } catch(e){} }
        return url;
    }

    function translateEventType(type, subtype) {
        const t = String(type).trim().toUpperCase();
        if(t==='SBGM') return `‡∏ô‡πâ‡∏≥‡∏ï‡∏≤‡∏•(${subtype||''})`; if(t==='BP') return `‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡∏±‡∏ô‡πÇ‡∏•‡∏´‡∏¥‡∏ï`; if(t==='WEIGHT') return `‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å`;
        if(t==='HBA1C') return `‡∏ô‡πâ‡∏≥‡∏ï‡∏≤‡∏•‡∏™‡∏∞‡∏™‡∏°`; if(t==='STRESS') return `‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏Ñ‡∏£‡∏µ‡∏¢‡∏î`; if(t==='SLEEP') return `‡∏Å‡∏≤‡∏£‡∏ô‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏ö`;
        if(t==='EXERCISE') return `‡∏≠‡∏≠‡∏Å‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Å‡∏≤‡∏¢`; if(t==='WAIST') return `‡∏£‡∏≠‡∏ö‡πÄ‡∏≠‡∏ß`; if(t==='ADVERSE') return `‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡∏ú‡∏¥‡∏î‡∏õ‡∏Å‡∏ï‡∏¥`;
        if(t==='BODYAGE') return `‡∏≠‡∏≤‡∏¢‡∏∏‡∏£‡πà‡∏≤‡∏á‡∏Å‡∏≤‡∏¢`; if(t==='RESTINGMET') return `‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡πÄ‡∏ú‡∏≤‡∏ú‡∏•‡∏≤‡∏ç`; if(t==='BMI') return `‡∏î‡∏±‡∏ä‡∏ô‡∏µ‡∏°‡∏ß‡∏•‡∏Å‡∏≤‡∏¢`;
        if(t==='MUSCLE') return `% ‡∏Å‡∏•‡πâ‡∏≤‡∏°‡πÄ‡∏ô‡∏∑‡πâ‡∏≠`; if(t==='VISCERALFAT') return `‡πÑ‡∏Ç‡∏°‡∏±‡∏ô‡∏ä‡πà‡∏≠‡∏á‡∏ó‡πâ‡∏≠‡∏á`; if(t==='%FAT') return `% ‡πÑ‡∏Ç‡∏°‡∏±‡∏ô‡∏£‡πà‡∏≤‡∏á‡∏Å‡∏≤‡∏¢`;
        if(t==='EGFR') return `‡∏Ñ‡πà‡∏≤‡πÑ‡∏ï (eGFR)`; if(t==='EYE') return `‡∏ï‡∏£‡∏ß‡∏à‡∏ï‡∏≤`; if(t==='FOOT') return `‡∏ï‡∏£‡∏ß‡∏à‡πÄ‡∏ó‡πâ‡∏≤`; return t;
    }

    async function main() {
      document.querySelectorAll('.note-item').forEach(el => { let rnd = (Math.random() * 4).toFixed(2); el.style.animationDelay = `${rnd}s`; });
      
      try {
        // üî• ‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô LIFF ‡∏Ç‡∏≠‡∏á‡∏à‡∏£‡∏¥‡∏á
        await liff.init({ liffId: LIFF_ID });
        if (liff.isLoggedIn()) {
            liffProfile = await liff.getProfile();
        } else {
            liff.login();
            return; // ‡∏´‡∏¢‡∏∏‡∏î‡∏£‡∏≠‡∏à‡∏ô‡∏Å‡∏ß‡πà‡∏≤‡∏à‡∏∞‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô‡πÄ‡∏™‡∏£‡πá‡∏à
        }
      } catch (err) { 
        console.error("LIFF Init Error:", err); 
        liffProfile.userId = TEST_USER_ID; // Fallback ‡πÄ‡∏ú‡∏∑‡πà‡∏≠‡∏£‡∏±‡∏ô‡∏ö‡∏ô‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå‡∏õ‡∏Å‡∏ï‡∏¥
      }
      
      await fetchUserProfile(); 
      
      const params = new URLSearchParams(window.location.search); let actionParam = params.get('action');
      if(actionParam) {
          const map = { 'sgbm': 'SBGM', 'hypertension': 'BP', 'food': 'FOOD', 'weight': 'WEIGHT', 'waist': 'WAIST', 'bodymass': 'BODYCOMP', 'hba1c': 'HBA1C', 'sleep': 'SLEEP', 'exercise': 'EXERCISE', 'medication': 'MED', 'sideeffect': 'ADVERSE', 'checkup': 'CHECKUP', 'history': 'HIST', 'doctor': 'DOC', 'nutrition': 'NUTRITION', 'community': 'COMMUNITY' };
          let mapped = map[actionParam.toLowerCase()];
          if (mapped === 'HIST') openHistory(); else if (mapped === 'DOC') openReport(); else if (mapped === 'COMMUNITY') openCommunity(); else if (mapped) openNoteForm(mapped);
      }
    }

    // --- CAROUSEL LOGIC ---
    function initAutoScroll(wrapperId) {
        const wrapper = document.getElementById(wrapperId);
        if(!wrapper) return;
        
        if(animFrames[wrapperId]) cancelAnimationFrame(animFrames[wrapperId]);
        
        let isDown = false; let startX; let scrollLeft; let isPaused = false;

        wrapper.onmousedown = (e) => { isDown = true; startX = e.pageX - wrapper.offsetLeft; scrollLeft = wrapper.scrollLeft; isPaused = true; };
        wrapper.onmouseleave = () => { isDown = false; isPaused = false; };
        wrapper.onmouseup = () => { isDown = false; isPaused = false; };
        wrapper.onmousemove = (e) => {
            if(!isDown) return; e.preventDefault(); const x = e.pageX - wrapper.offsetLeft; wrapper.scrollLeft = scrollLeft - (x - startX);
        };

        wrapper.ontouchstart = () => { isPaused = true; };
        wrapper.ontouchend = () => { isPaused = false; };

        function step() {
            if(!isPaused && !isDown) {
                wrapper.scrollLeft += 1;
                if(wrapper.scrollLeft >= wrapper.scrollWidth / 2) wrapper.scrollLeft = 0;
            }
            animFrames[wrapperId] = requestAnimationFrame(step);
        }
        animFrames[wrapperId] = requestAnimationFrame(step);
    }

    function toggleCommunityMode() {
        let btn = $('#nav-mode-btn');
        if (btn.innerText === '‡∏ä‡∏∏‡∏°‡∏ä‡∏ô‡∏Ñ‡∏ô‡∏Ñ‡∏∏‡∏°‡∏´‡∏ß‡∏≤‡∏ô') openCommunity(); else closeViews();
    }

    function closeViews() { 
        $('#history-view').style.display = 'none'; $('#calendar-view').style.display = 'none'; $('#register-view').style.display = 'none'; $('#community-view').style.display = 'none'; $('#edit-history-view').style.display = 'none';
        
        $('.navbar').style.display = 'flex';
        $('#shared-profile-container').style.display = 'block';
        $('#main-content').style.display = 'block'; 
        $('#main-grid').style.display = 'grid'; 
        
        window.scrollTo(0,0); 
        let btn = $('#nav-mode-btn'); btn.innerText = '‡∏ä‡∏∏‡∏°‡∏ä‡∏ô‡∏Ñ‡∏ô‡∏Ñ‡∏∏‡∏°‡∏´‡∏ß‡∏≤‡∏ô'; btn.className = 'nav-community-btn';
    }
    
    function closeAllModals() { 
        document.querySelectorAll('.modal-overlay, .secondary-modal-overlay').forEach(m => m.style.display = 'none'); 
        
        $('.navbar').style.display = 'flex';
        $('#shared-profile-container').style.display = 'block';
        
        let btn = $('#nav-mode-btn');
        if (btn && btn.innerText === '‡∏ä‡∏∏‡∏°‡∏ä‡∏ô‡∏Ñ‡∏ô‡∏Ñ‡∏∏‡∏°‡∏´‡∏ß‡∏≤‡∏ô') {
            $('#main-content').style.display = 'block'; 
            $('#main-grid').style.display = 'grid'; 
            $('#community-view').style.display = 'none';
        } else {
            $('#community-view').style.display = 'block';
            $('#main-content').style.display = 'none'; 
        }
        
        const askEl = $('#pri-ask');
        if(askEl) askEl.style.display = 'block';
    }
    
    async function showLoading(show) { $('#loading').style.display = show ? 'flex' : 'none'; if(show) await new Promise(r => setTimeout(r, 50)); }

    window.validateNumber = function(input) { input.value = input.value.replace(/[^0-9.]/g, ''); }

    function getChipsHTML(id, options, defaultVal='') {
        let html = `<div class="chip-container" id="${id}">`;
        options.forEach(o => { let active = o === defaultVal ? 'active' : ''; html += `<button class="chip-btn ${active}" onclick="selectChip('${id}', '${o}', this)">${o}</button>`; });
        html += `</div><input type="hidden" id="val-${id}" value="${defaultVal}">`; return html;
    }
    window.selectChip = function(groupId, value, btn) { $('#val-'+groupId).value = value; btn.parentElement.querySelectorAll('.chip-btn').forEach(b => b.classList.remove('active')); btn.classList.add('active'); }

    // --- COMMUNITY MODULE ---
    async function openCommunity() {
        $('.navbar').style.display = 'flex';
        $('#shared-profile-container').style.display = 'block';
        $('#main-content').style.display = 'none'; 
        $('#history-view').style.display = 'none'; 
        $('#community-view').style.display = 'block';
        
        let btn = $('#nav-mode-btn'); btn.innerText = 'üìù ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ú‡∏•'; btn.className = 'nav-return-btn';

        await showLoading(true);
        const res = await apiPost('getCommunityData', { userId: liffProfile.userId });
        showLoading(false);
        
        if (res && res.ok) {
            $('#comm-total-users').innerText = res.totalUsers;
            $('#comm-rem-users').innerText = res.remissionCount > 0 ? res.remissionCount : '0';
            
            if(res.myBadges && res.myBadges.length > 0) {
                let bHtml = res.myBadges.map(b => `${b.icon} ${b.name}`).join('<br>');
                let likeHtml = res.myLikes > 0 ? `<br><br>üíñ ‡∏°‡∏µ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡πÜ ‡πÉ‡∏´‡πâ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÉ‡∏à‡∏Ñ‡∏∏‡∏ì <b>${res.myLikes}</b> ‡∏Ñ‡∏£‡∏±‡πâ‡∏á!` : '';
                swalForm.fire({title: '‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏î‡πâ‡∏ß‡∏¢‡∏Ñ‡πà‡∏∞! üéâ', html: `‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡πÄ‡∏´‡∏£‡∏µ‡∏¢‡∏ç‡πÄ‡∏Å‡∏µ‡∏¢‡∏£‡∏ï‡∏¥‡∏¢‡∏®:<br><br><b style="color:#FFD600; font-size:26px;">${bHtml}</b>${likeHtml}<br><br>‡∏ó‡∏≥‡∏î‡∏µ‡∏ï‡πà‡∏≠‡πÑ‡∏õ‡∏ô‡∏∞‡∏Ñ‡∏∞!`, confirmButtonText: '‡∏£‡∏±‡∏ö‡∏ó‡∏£‡∏≤‡∏ö'});
            } else if (res.myLikes > 0) {
                swalForm.fire({title: '‡πÄ‡∏¢‡πâ! üíñ', html: `‡∏°‡∏µ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡πÜ ‡πÉ‡∏ô‡∏ä‡∏∏‡∏°‡∏ä‡∏ô‡πÉ‡∏´‡πâ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÉ‡∏à‡∏Ñ‡∏∏‡∏ì <b>${res.myLikes}</b> ‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏•‡πâ‡∏ß‡∏ô‡∏∞‡∏Ñ‡∏∞!`, confirmButtonText: '‡∏£‡∏±‡∏ö‡∏ó‡∏£‡∏≤‡∏ö'});
            }

            let roleHtml = '';
            if(res.roleModels && res.roleModels.length > 0) {
                let itemsHtml = res.roleModels.map(r => {
                    return `<div class="comm-card" style="border-color:${r.color}; min-width:320px; max-width:320px; align-items:center; text-align:center; display:inline-flex; flex-direction:column; margin-right:15px;">
                                <button class="like-btn" onclick="likeProfile(this, '${r.userId}')">üíñ ‡πÉ‡∏´‡πâ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÉ‡∏à <span class="like-count">${r.likes||0}</span></button>
                                <div class="comm-body" style="display:flex; flex-direction:column; align-items:center; width:100%; padding-top:40px;">
                                    <div class="medal-icon" style="background:${r.color}22; margin-bottom:10px; color:${r.color};">${r.icon}</div>
                                    <div style="font-weight:800; color:${r.color}; font-size:20px;">${r.title}</div>
                                    <div style="font-size:24px; color:#3E2723; font-weight:800; margin:5px 0;">${r.name}</div>
                                    <div style="font-size:14px; color:#FFF; background:#9E9E9E; padding:4px 12px; border-radius:15px; margin-bottom:10px;">${r.joined}</div>
                                    <div style="font-size:16px; color:#5D4037; line-height:1.3;">${r.desc}</div>
                                </div>
                            </div>`;
                }).join('');
                $('#comm-role-models').innerHTML = `<div id="comm-role-models-track" style="display:flex; width:max-content;">${itemsHtml + itemsHtml}</div>`;
                setTimeout(() => initAutoScroll('comm-role-models'), 100);
            } else { $('#comm-role-models').innerHTML = '<div style="color:#888; text-align:center; padding-left:15px;">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•‡∏ï‡πâ‡∏ô‡πÅ‡∏ö‡∏ö‡∏Ñ‡πà‡∏∞</div>'; }

            let carouselHtml = '';
            if (res.communityFoods && res.communityFoods.length > 0) {
                let itemsHtml = res.communityFoods.map(item => {
                    let d = new Date(item.ts); let sbgmHtml = item.sbgms ? `<div class="comm-sbgm">ü©∏ ‡∏ô‡πâ‡∏≥‡∏ï‡∏≤‡∏•: ${item.sbgms}</div>` : '';
                    let cleanAdvice = item.flag.replace(/'/g, "\\'").replace(/"/g, "&quot;");
                    return `<div class="comm-card" style="display:inline-flex; flex-direction:column; white-space:normal; vertical-align:top; margin-right:15px;">
                                <button class="like-btn" onclick="likeFood(this, ${item.rowIndex})">‚ù§Ô∏è ‡∏ô‡πà‡∏≤‡∏™‡∏ô‡πÉ‡∏à <span class="like-count">${item.likes||0}</span></button>
                                <img src="${getImageUrl(item.img)}" class="comm-img">
                                <div class="comm-body">
                                    <div class="comm-user">‡∏Ñ‡∏∏‡∏ì ${item.userName}</div>
                                    <div style="font-size:12px; color:#888;">${d.toLocaleDateString('th-TH')} ${item.subtype||''}</div>
                                    <div style="font-weight:800; color:#3E2723; font-size:18px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">${item.name} (${item.qty} ${item.unit})</div>
                                    <div style="font-size:16px; color:#5D4037; line-height:1.2; margin-top:5px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; cursor:pointer; background:#FFF9C4; padding:4px 8px; border-radius:10px;" onclick="showFoodDetail('${item.name}', '${item.qty}', '${item.unit}', '${cleanAdvice}')">üí¨ ${item.flag} (‡∏Ñ‡∏•‡∏¥‡∏Å‡∏≠‡πà‡∏≤‡∏ô)</div>
                                    ${sbgmHtml}
                                </div>
                            </div>`;
                }).join('');
                $('#comm-carousel').innerHTML = `<div id="comm-carousel-track" style="display:flex; width:max-content;">${itemsHtml + itemsHtml}</div>`;
                setTimeout(() => initAutoScroll('comm-carousel'), 100);
            } else { $('#comm-carousel').innerHTML = `<div style="padding:20px; color:#888;">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡πÉ‡∏ô‡∏ä‡∏∏‡∏°‡∏ä‡∏ô‡∏ä‡πà‡∏ß‡∏á 7 ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏Ñ‡πà‡∏∞</div>`; }

            let myHtml = '';
            if (res.myFoods && res.myFoods.length > 0) {
                res.myFoods.forEach(item => {
                    let d = new Date(item.ts); let imgHtml = item.img ? `<img src="${getImageUrl(item.img)}" style="width:60px; height:60px; border-radius:10px; object-fit:cover; margin-right:10px;">` : '';
                    myHtml += `<div style="background:#FFF; padding:10px; border-radius:15px; border:2px solid #EFEBE9; display:flex; align-items:center;">${imgHtml}<div><div style="font-size:12px; color:#888;">${d.toLocaleDateString('th-TH')} ${item.subtype||''}</div><div style="font-weight:800; color:#3E2723; font-size:16px;">${item.name} <span style="font-weight:400; font-size:14px;">(${item.qty} ${item.unit})</span></div><div style="font-size:12px; color:#5D4037;">${item.flag !== 'NORMAL' ? item.flag : ''}</div></div></div>`;
                });
            } else { myHtml = `<div style="padding:20px; color:#888;">‡∏Ñ‡∏∏‡∏ì‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡πÄ‡∏•‡∏¢‡∏Ñ‡πà‡∏∞</div>`; }
            $('#comm-my-foods').innerHTML = myHtml;
        }
    }

    window.showFoodDetail = function(name, qty, unit, advice) {
        swalForm.fire({
            title: '‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏à‡∏≤‡∏Å AI ü§ñ',
            html: `<div style="font-size:24px; text-align:left; line-height:1.4;"><b>‡πÄ‡∏°‡∏ô‡∏π:</b> ${name} (${qty} ${unit})<br><br><b>‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥:</b><br>${advice}</div>`,
            confirmButtonText: '‡∏õ‡∏¥‡∏î'
        });
    }

    window.likeFood = async function(btn, rowIndex) {
        let countSpan = btn.querySelector('.like-count'); let currentCount = parseInt(countSpan.innerText) || 0; countSpan.innerText = currentCount + 1;
        let floatAnim = document.createElement('div'); floatAnim.className = 'float-up'; floatAnim.innerText = '+1'; floatAnim.style.left = '10px'; floatAnim.style.top = '10px';
        btn.appendChild(floatAnim); setTimeout(() => floatAnim.remove(), 1000);
        await apiPost('likeFood', { rowIndex: rowIndex });
    }

    window.likeProfile = async function(btn, targetUserId) {
        let countSpan = btn.querySelector('.like-count'); let currentCount = parseInt(countSpan.innerText) || 0; countSpan.innerText = currentCount + 1;
        let floatAnim = document.createElement('div'); floatAnim.className = 'float-up'; floatAnim.innerText = '+1'; floatAnim.style.left = '10px'; floatAnim.style.top = '10px';
        btn.appendChild(floatAnim); setTimeout(() => floatAnim.remove(), 1000);
        await apiPost('likeProfile', { targetUserId: targetUserId });
    }

    // --- UNIVERSAL OPEN MODAL ---
    function openNoteForm(actionType) {
        currentAction = actionType; pendingFormData = {}; 
        
        $('.navbar').style.display = 'none';
        $('#shared-profile-container').style.display = 'none';
        $('#main-content').style.display = 'none'; 
        $('#community-view').style.display = 'none';
        $('#history-view').style.display = 'none';
        $('#calendar-view').style.display = 'none';
        
        const namePink = `<span class="name-pink">${userDisplayName}</span>`;
        let title = ''; let ask = ''; let bodyHTML = '';

        if(actionType === 'ADVERSE') $('#pri-close-btn').innerHTML = '‚úñ ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏≠‡∏≤‡∏Å‡∏≤‡∏£'; else $('#pri-close-btn').innerHTML = '‚úñ ‡∏õ‡∏¥‡∏î';

        if (actionType === 'SBGM') {
            title = '‡∏Ñ‡πà‡∏≤‡∏ô‡πâ‡∏≥‡∏ï‡∏≤‡∏•‡πÉ‡∏ô‡πÄ‡∏•‡∏∑‡∏≠‡∏î'; ask = `‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏Ñ‡∏∏‡∏ì ${namePink} ‡πÄ‡∏à‡∏≤‡∏∞‡∏ô‡πâ‡∏≥‡∏ï‡∏≤‡∏•‡∏õ‡∏•‡∏≤‡∏¢‡∏ô‡∏¥‡πâ‡∏ß ‡πÑ‡∏î‡πâ‡∏Ñ‡πà‡∏≤‡πÄ‡∏ó‡πà‡∏≤‡πÑ‡∏´‡∏£‡πà‡∏Ñ‡∏∞?`;
            let hr = new Date().getHours(); let defMeal = '‡πÄ‡∏ä‡πâ‡∏≤'; if(hr>=11&&hr<14)defMeal='‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏á'; else if(hr>=14)defMeal='‡πÄ‡∏¢‡πá‡∏ô';
            bodyHTML = `<input type="tel" id="inp-val1" class="main-input-anim" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç (mg/dL)" inputmode="numeric" oninput="validateNumber(this)"><div class="form-label">‡∏°‡∏∑‡πâ‡∏≠‡πÑ‡∏´‡∏ô‡∏Ñ‡∏∞?</div> ${getChipsHTML('period', ['‡πÄ‡∏ä‡πâ‡∏≤','‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏á','‡πÄ‡∏¢‡πá‡∏ô'], defMeal)}<div class="form-label">‡∏ß‡∏±‡∏î‡πÄ‡∏ß‡∏•‡∏≤‡πÑ‡∏´‡∏ô‡∏Ñ‡∏∞?</div> ${getChipsHTML('subtype', ['‡∏Å‡πà‡∏≠‡∏ô‡∏≠‡∏≤‡∏´‡∏≤‡∏£','‡∏´‡∏•‡∏±‡∏á‡∏≠‡∏≤‡∏´‡∏≤‡∏£','‡∏Å‡πà‡∏≠‡∏ô‡∏ô‡∏≠‡∏ô'], '')}<button class="btn" style="margin-top:20px;" onclick="processSBGM()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ‚úÖ</button>`;
        } else if (actionType === 'BP') {
            title = '‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡∏±‡∏ô‡πÇ‡∏•‡∏´‡∏¥‡∏ï'; ask = `‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏Ñ‡∏∏‡∏ì ${namePink} ‡∏ß‡∏±‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡∏±‡∏ô‡πÑ‡∏î‡πâ‡πÄ‡∏ó‡πà‡∏≤‡πÑ‡∏´‡∏£‡πà‡∏Ñ‡∏∞?`;
            bodyHTML = `<div style="display:flex; gap:10px;"><input type="tel" id="inp-val1" class="main-input-anim" placeholder="‡∏ï‡∏±‡∏ß‡∏ö‡∏ô" inputmode="numeric" oninput="validateNumber(this)"><input type="tel" id="inp-val2" placeholder="‡∏ï‡∏±‡∏ß‡∏•‡πà‡∏≤‡∏á" inputmode="numeric" oninput="validateNumber(this)"></div><button class="btn" style="margin-top:20px;" onclick="processGeneric('BP')">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ‚úÖ</button>`;
        } else if (actionType === 'WEIGHT') {
            title = '‡∏ä‡∏±‡πà‡∏á‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å'; ask = `‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏Ñ‡∏∏‡∏ì ${namePink} ‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡πÄ‡∏ó‡πà‡∏≤‡πÑ‡∏´‡∏£‡πà‡∏Ñ‡∏∞?`;
            bodyHTML = `<input type="tel" id="inp-val1" class="main-input-anim" placeholder="‡∏Å‡∏µ‡πà‡∏Å‡∏¥‡πÇ‡∏•‡∏Å‡∏£‡∏±‡∏°‡∏Ñ‡∏∞" inputmode="decimal" oninput="validateNumber(this)"><button class="btn" onclick="processGeneric('WEIGHT')">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ‚úÖ</button>`;
        } else if (actionType === 'WAIST') {
            title = '‡∏£‡∏≠‡∏ö‡πÄ‡∏≠‡∏ß'; ask = `‡∏Ñ‡∏∏‡∏ì ${namePink} ‡∏ß‡∏±‡∏î‡∏£‡∏≠‡∏ö‡πÄ‡∏≠‡∏ß‡πÑ‡∏î‡πâ‡∏Å‡∏µ‡πà‡πÄ‡∏ã‡∏ô‡∏ï‡∏¥‡πÄ‡∏°‡∏ï‡∏£‡∏Ñ‡∏∞?`;
            bodyHTML = `<input type="tel" id="inp-val1" class="main-input-anim" placeholder="‡πÄ‡∏ã‡∏ô‡∏ï‡∏¥‡πÄ‡∏°‡∏ï‡∏£ (cm)" inputmode="decimal" oninput="validateNumber(this)"><button class="btn" onclick="processWaist()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ‚úÖ</button>`;
        } else if (actionType === 'HBA1C') {
            title = '‡∏ô‡πâ‡∏≥‡∏ï‡∏≤‡∏•‡∏™‡∏∞‡∏™‡∏°'; ask = `‡∏ú‡∏•‡πÄ‡∏•‡∏∑‡∏≠‡∏î HbA1c ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì ${namePink} ‡∏Ñ‡∏∑‡∏≠‡πÄ‡∏ó‡πà‡∏≤‡πÑ‡∏´‡∏£‡πà‡∏Ñ‡∏∞?`;
            bodyHTML = `<input type="tel" id="inp-val1" class="main-input-anim" placeholder="‡πÄ‡∏õ‡∏≠‡∏£‡πå‡πÄ‡∏ã‡πá‡∏ô‡∏ï‡πå (%)" inputmode="decimal" oninput="validateNumber(this)"><button class="btn" onclick="processGeneric('HBA1C')">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ‚úÖ</button>`;
        } else if (actionType === 'EXERCISE') {
            title = '‡∏≠‡∏≠‡∏Å‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Å‡∏≤‡∏¢'; ask = `‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏Ñ‡∏∏‡∏ì ${namePink} ‡∏≠‡∏≠‡∏Å‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Å‡∏≤‡∏¢‡πÅ‡∏ö‡∏ö‡πÑ‡∏´‡∏ô‡∏Ñ‡∏∞?`;
            bodyHTML = `${getChipsHTML('activity', ['‡πÄ‡∏î‡∏¥‡∏ô‡πÄ‡∏£‡πá‡∏ß','‡∏ß‡∏¥‡πà‡∏á','‡πÅ‡∏Å‡∏ß‡πà‡∏á‡πÅ‡∏Ç‡∏ô','‡πÅ‡∏≠‡πÇ‡∏£‡∏ö‡∏¥‡∏Å','‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏ö‡πâ‡∏≤‡∏ô','‡∏õ‡∏±‡πà‡∏ô‡∏à‡∏±‡∏Å‡∏£‡∏¢‡∏≤‡∏ô'])}<div class="form-label">‡∏´‡∏£‡∏∑‡∏≠‡∏û‡∏¥‡∏°‡∏û‡πå‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏≠‡∏á</div><input type="text" id="inp-text" class="main-input-anim" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°..."><button class="btn" onclick="processExercise()">‡∏ñ‡∏±‡∏î‡πÑ‡∏õ ‚û°Ô∏è</button>`;
        } else if (actionType === 'ADVERSE') {
            title = '‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡∏ú‡∏¥‡∏î‡∏õ‡∏Å‡∏ï‡∏¥'; ask = `‡∏Ñ‡∏∏‡∏ì ${namePink} ‡∏°‡∏µ‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÑ‡∏£‡∏ö‡πâ‡∏≤‡∏á‡∏Ñ‡∏∞?`;
            bodyHTML = `<div class="chip-container" id="adv-chips">${['‡∏ï‡∏±‡∏ß‡∏™‡∏±‡πà‡∏ô','‡πÉ‡∏à‡∏™‡∏±‡πà‡∏ô','‡πÄ‡∏´‡∏á‡∏∑‡πà‡∏≠‡πÅ‡∏ï‡∏Å','‡∏´‡∏¥‡∏ß','‡∏´‡∏á‡∏∏‡∏î‡∏´‡∏á‡∏¥‡∏î','‡∏™‡∏±‡∏ö‡∏™‡∏ô','‡∏ã‡∏∂‡∏°','‡∏´‡∏°‡∏î‡∏™‡∏ï‡∏¥'].map(o=>`<button class="chip-btn" onclick="this.classList.toggle('active')">${o}</button>`).join('')}</div><textarea id="inp-text" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°..." rows="2"></textarea><button class="btn" onclick="processAdverse()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ‚úÖ</button>`;
        } else if (actionType === 'BODYCOMP') {
            title = '‡∏î‡∏±‡∏ä‡∏ô‡∏µ‡∏°‡∏ß‡∏•‡∏Å‡∏≤‡∏¢'; ask = `‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì ${namePink} ‡∏ó‡∏£‡∏≤‡∏ö‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢‡∏Ñ‡πà‡∏∞`;
            bodyHTML = `<div class="bodycomp-row"><label>% ‡πÑ‡∏Ç‡∏°‡∏±‡∏ô‡∏£‡πà‡∏≤‡∏á‡∏Å‡∏≤‡∏¢</label><input type="tel" id="bc-fat" class="main-input-anim" inputmode="decimal" oninput="validateNumber(this)"><span>%</span></div><div class="bodycomp-row"><label>‡πÑ‡∏Ç‡∏°‡∏±‡∏ô‡∏ä‡πà‡∏≠‡∏á‡∏ó‡πâ‡∏≠‡∏á</label><input type="tel" id="bc-visceral" inputmode="numeric" oninput="validateNumber(this)"><span>‡∏£‡∏∞‡∏î‡∏±‡∏ö</span></div><div class="bodycomp-row"><label>% ‡∏Å‡∏•‡πâ‡∏≤‡∏°‡πÄ‡∏ô‡∏∑‡πâ‡∏≠</label><input type="tel" id="bc-muscle" inputmode="decimal" oninput="validateNumber(this)"><span>%</span></div><div class="bodycomp-row"><label>BMI</label><input type="tel" id="bc-bmi" inputmode="decimal" oninput="validateNumber(this)"><span>kg/m¬≤</span></div><div class="bodycomp-row"><label>‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡πÄ‡∏ú‡∏≤‡∏ú‡∏•‡∏≤‡∏ç</label><input type="tel" id="bc-rm" inputmode="numeric" oninput="validateNumber(this)"><span>kcal</span></div><div class="bodycomp-row"><label>‡∏≠‡∏≤‡∏¢‡∏∏‡∏£‡πà‡∏≤‡∏á‡∏Å‡∏≤‡∏¢</label><input type="tel" id="bc-age" inputmode="numeric" oninput="validateNumber(this)"><span>‡∏õ‡∏µ</span></div><button class="btn" style="margin-top:15px;" onclick="processBodyComp()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ‚úÖ</button>`;
        } else if (actionType === 'CHECKUP') {
            title = '‡∏ï‡∏£‡∏ß‡∏à‡πÑ‡∏ï, ‡∏ï‡∏≤, ‡πÄ‡∏ó‡πâ‡∏≤'; ask = `‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏õ‡∏µ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì ${namePink} ‡∏Ñ‡πà‡∏∞`;
            bodyHTML = `<div class="form-label" style="text-align:left; font-size:18px;">‡∏Ñ‡πà‡∏≤‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á‡πÑ‡∏ï (eGFR)</div><input type="tel" id="chk-egfr" class="main-input-anim" placeholder="‡∏°‡∏•./‡∏ô‡∏≤‡∏ó‡∏µ/1.73 ‡∏ï‡∏£.‡∏°." inputmode="decimal" oninput="validateNumber(this)"><div class="form-label" style="text-align:left; font-size:18px;">‡∏ú‡∏•‡∏ï‡∏£‡∏ß‡∏à‡∏à‡∏≠‡∏ï‡∏≤</div>${getChipsHTML('chk-eye', ['‡∏õ‡∏Å‡∏ï‡∏¥','‡∏ú‡∏¥‡∏î‡∏õ‡∏Å‡∏ï‡∏¥'])}<div class="form-label" style="text-align:left; font-size:18px;">‡∏ú‡∏•‡∏ï‡∏£‡∏ß‡∏à‡πÄ‡∏ó‡πâ‡∏≤</div>${getChipsHTML('chk-foot', ['‡∏õ‡∏Å‡∏ï‡∏¥','‡∏ú‡∏¥‡∏î‡∏õ‡∏Å‡∏ï‡∏¥'])}<button class="btn" style="margin-top:15px;" onclick="processCheckup()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ‚úÖ</button>`;
        } else if (actionType === 'FOOD') {
            title = '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏≠‡∏≤‡∏´‡∏≤‡∏£'; ask = `‡∏Ñ‡∏∏‡∏ì ${namePink} ‡∏ó‡∏≤‡∏ô‡∏≠‡∏∞‡πÑ‡∏£‡πÑ‡∏õ‡∏ö‡πâ‡∏≤‡∏á‡∏Ñ‡∏∞?`;
            let greenBtn = !window.currentNutritionProfile ? `<button class="btn btn-metallic-green" onclick="openNoteForm('NUTRITION')">‚ú® ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏û‡∏•‡∏±‡∏á‡∏á‡∏≤‡∏ô‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏ï‡πà‡∏≠‡∏ß‡∏±‡∏ô (‡∏Ñ‡∏•‡∏¥‡∏Å!)</button>` : '';
            bodyHTML = `${greenBtn}<img id="food-preview" style="width:100%; border-radius:15px; margin-bottom:15px; max-height:200px; object-fit:cover; display:none;"><button class="btn" style="margin-bottom: 20px; font-size: 24px;" onclick="$('#media-input').click()">üì∏ ‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ / ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏≠‡∏≤‡∏´‡∏≤‡∏£</button><div class="form-label">--- ‡∏´‡∏£‡∏∑‡∏≠‡∏û‡∏¥‡∏°‡∏û‡πå‡πÄ‡∏≠‡∏á ---</div><div id="food-rows"><div class="food-row" style="display:flex; gap:5px; margin-bottom:15px;"><input type="text" class="food-n main-input-anim" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏≠‡∏≤‡∏´‡∏≤‡∏£" style="flex:2;"><input type="tel" class="food-q" placeholder="‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ì" inputmode="decimal" oninput="validateNumber(this)" style="flex:1;"><input type="text" class="food-u" placeholder="‡∏´‡∏ô‡πà‡∏ß‡∏¢" style="flex:1;"></div></div><button class="btn-white-round" onclick="addFoodRow(true)">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏≠‡∏µ‡∏Å</button><button class="btn" onclick="processFoodManual()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏≠‡∏≤‡∏´‡∏≤‡∏£ ‚úÖ</button>`;
        } else if (actionType === 'SLEEP') {
            title = '‡∏Å‡∏≤‡∏£‡∏ô‡∏≠‡∏ô/‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏Ñ‡∏£‡∏µ‡∏¢‡∏î'; ask = `‡∏ä‡πà‡∏ß‡∏á‡∏ô‡∏µ‡πâ‡∏Ñ‡∏∏‡∏ì ${namePink} ‡∏£‡∏π‡πâ‡∏™‡∏∂‡∏Å‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÑ‡∏£‡∏ö‡πâ‡∏≤‡∏á‡∏Ñ‡∏∞?`;
            bodyHTML = `${getChipsHTML('sleep', ['‡∏ô‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏ö‡∏î‡∏µ','‡∏ô‡∏≠‡∏ô‡πÑ‡∏°‡πà‡∏´‡∏•‡∏±‡∏ö','‡∏°‡∏µ‡∏™‡∏°‡∏≤‡∏ò‡∏¥‡∏ô‡πâ‡∏≠‡∏¢','‡∏´‡∏á‡∏∏‡∏î‡∏´‡∏á‡∏¥‡∏î','‡πÄ‡∏ö‡∏∑‡πà‡∏≠‡πÄ‡∏ã‡πá‡∏á','‡πÑ‡∏°‡πà‡∏≠‡∏¢‡∏≤‡∏Å‡∏û‡∏ö‡∏Ñ‡∏ô'], '')}<button class="btn" onclick="processSleep()">‡∏ñ‡∏±‡∏î‡πÑ‡∏õ ‚û°Ô∏è</button>`;
        } else if (actionType === 'MED') {
            title = '‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏¢‡∏≤'; ask = `‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏¢‡∏≤‡∏Ç‡∏≠‡∏á ${namePink} ‡∏´‡∏£‡∏∑‡∏≠‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏±‡∏ö‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏Ñ‡∏∞?`;
            let medsDisplay = '<div style="color:#888; font-size:14px; text-align:center;">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏¢‡∏≤‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏ß‡πâ</div>';
            if (window.currentMedList && window.currentMedList.length > 0) {
                medsDisplay = window.currentMedList.map(m => {
                    let badge = m.type === 'STOPPED' ? '<span style="background:#E65100; color:#FFF; font-size:10px; padding:2px 6px; border-radius:10px;">‡∏´‡∏¢‡∏∏‡∏î‡∏¢‡∏≤</span>' : '<span style="background:#00838F; color:#FFF; font-size:10px; padding:2px 6px; border-radius:10px;">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÉ‡∏ä‡πâ</span>';
                    return `<div style="border-bottom:1px dashed #D7CCC8; padding:5px 0;"><b style="color:#3E2723;">${m.name}</b> ${badge}<br><span style="font-size:14px; color:#5D4037;">${m.regimen || '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏∞‡∏ö‡∏∏‡∏ß‡∏¥‡∏ò‡∏µ‡πÉ‡∏ä‡πâ'}</span></div>`;
                }).join('');
            }
            bodyHTML = `<div style="background:#FFF; padding:15px; border-radius:20px; margin-bottom:20px; font-size:16px;"><b>‡∏¢‡∏≤‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì:</b><div style="margin-top:10px; max-height:100px; overflow-y:auto;">${medsDisplay}</div></div><div class="form-label" style="text-align:left;">‡πÄ‡∏û‡∏¥‡πà‡∏°/‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏±‡∏ö‡∏¢‡∏≤</div><select id="med-name" class="main-input-anim"><option value="" disabled selected>-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏¢‡∏≤‡πÄ‡∏ö‡∏≤‡∏´‡∏ß‡∏≤‡∏ô --</option><option value="Metformin">Metformin</option> <option value="Glipizide">Glipizide</option><option value="Pioglitazone">Pioglitazone</option> <option value="Insulin">Insulin</option></select>${getChipsHTML('med-change', ['‡∏•‡∏î‡∏¢‡∏≤','‡∏´‡∏¢‡∏∏‡∏î‡∏¢‡∏≤'])}<div class="form-label" style="text-align:left;">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏õ‡∏£‡∏±‡∏ö‡∏¢‡∏≤</div><input type="date" id="med-date" value="${new Date().toISOString().split('T')[0]}"><button class="btn" onclick="processMed1()">‡∏ñ‡∏±‡∏î‡πÑ‡∏õ ‚û°Ô∏è</button>`;
        } else if (actionType === 'NUTRITION') {
            title = '‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏û‡∏•‡∏±‡∏á‡∏á‡∏≤‡∏ô'; ask = `‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏û‡∏•‡∏±‡∏á‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡πâ ${namePink} ‡∏Ñ‡πà‡∏∞`;
            let p = window.currentNutritionProfile || {};
            let defW = p.weight_kg || (window.currentProfile ? window.currentProfile.Weight : '');
            let defH = p.height_cm || ''; let defFav = p.favorite_food || ''; let defDis = p.dislike_food || ''; let defAct = p.profile || '2';
            bodyHTML = `<div id="nutri-form-section"><div style="display:flex; gap:10px;"><input type="tel" id="nutri-w" class="main-input-anim" placeholder="‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å (‡∏Å‡∏Å.)" inputmode="decimal" value="${defW}" oninput="validateNumber(this)"><input type="tel" id="nutri-h" placeholder="‡∏™‡πà‡∏ß‡∏ô‡∏™‡∏π‡∏á (‡∏ã‡∏°.)" inputmode="decimal" value="${defH}" oninput="validateNumber(this)"></div><div class="form-label" style="text-align:left; font-size:16px;">‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏° (1=‡∏ô‡∏±‡πà‡∏á‡∏ó‡∏≥‡∏á‡∏≤‡∏ô, 5=‡πÉ‡∏ä‡πâ‡πÅ‡∏£‡∏á‡∏á‡∏≤‡∏ô‡∏´‡∏ô‡∏±‡∏Å)</div>${getChipsHTML('nutri-act', ['1','2','3','4','5'], String(defAct))}<input type="text" id="nutri-fav" placeholder="‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏ä‡∏≠‡∏ö (‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å)" value="${defFav}"><input type="text" id="nutri-dis" placeholder="‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏ä‡∏≠‡∏ö/‡πÅ‡∏û‡πâ (‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å)" value="${defDis}"><button class="btn" style="margin-top:20px;" onclick="processNutrition()">‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏û‡∏•‡∏±‡∏á‡∏á‡∏≤‡∏ô‡∏à‡∏≤‡∏Å‡∏≠‡∏≤‡∏´‡∏≤‡∏£ üßÆ</button></div><div id="nutri-result-section" style="display:none; padding-bottom:30px;"></div>`;
        }

        $('#pri-title').innerText = title; $('#pri-ask').innerHTML = ask; $('#pri-body').innerHTML = bodyHTML;
        $('#primary-modal').style.display = 'flex';
    }

    // --- PROCESSING LOGIC ---
    async function processGeneric(type) {
        let v1 = $('#inp-val1').value; let v2 = $('#inp-val2') ? $('#inp-val2').value : null;
        if(!v1) return showMissingModal('‡∏•‡∏∑‡∏°‡∏£‡∏∞‡∏ö‡∏∏‡∏Ñ‡πà‡∏≤‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏ô‡∏∞‡∏Ñ‡∏∞', `<input type="tel" id="sec-v1" class="main-input-anim" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç"><button class="btn" onclick="$('#inp-val1').value=$('#sec-v1').value; $('#secondary-modal').style.display='none'; processGeneric('${type}')">‡∏ï‡∏Å‡∏•‡∏á</button>`);
        if(type==='BP') {
            if(!v2) return showMissingModal('‡∏•‡∏∑‡∏°‡∏£‡∏∞‡∏ö‡∏∏‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡∏±‡∏ô‡∏ï‡∏±‡∏ß‡∏•‡πà‡∏≤‡∏á‡∏Ñ‡πà‡∏∞', `<input type="tel" id="sec-v2" class="main-input-anim" placeholder="‡∏ï‡∏±‡∏ß‡∏•‡πà‡∏≤‡∏á"><button class="btn" onclick="$('#inp-val2').value=$('#sec-v2').value; $('#secondary-modal').style.display='none'; processGeneric('BP')">‡∏ï‡∏Å‡∏•‡∏á</button>`);
            if(parseFloat(v1) < parseFloat(v2)) return swalAlert.fire('‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏¥‡∏î‡∏õ‡∏Å‡∏ï‡∏¥', '‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡∏±‡∏ô‡∏ï‡∏±‡∏ß‡∏ö‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤‡∏ï‡∏±‡∏ß‡∏•‡πà‡∏≤‡∏á‡∏ô‡∏∞‡∏Ñ‡∏∞', 'error');
            if(parseFloat(v1) > 500 || parseFloat(v2) > 500) { const cf = await swalAlert.fire({ title: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡∏±‡∏ô‡πÇ‡∏•‡∏´‡∏¥‡∏ï', text: `‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏Å‡∏£‡∏≠‡∏Å‡∏Ñ‡∏∑‡∏≠ ${v1}/${v2} ‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?`, showCancelButton: true, confirmButtonText: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô', cancelButtonText: '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç' }); if(!cf.isConfirmed) return; }
            let s = parseFloat(v1), d = parseFloat(v2);
            if(s > 140 || d > 90) { swalAlert.fire({ title: '‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡∏±‡∏ô‡πÇ‡∏•‡∏´‡∏¥‡∏ï‡∏™‡∏π‡∏á ‚ö†Ô∏è', html: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ô‡∏±‡πà‡∏á‡∏û‡∏±‡∏Å‡πÅ‡∏•‡πâ‡∏ß‡∏ß‡∏±‡∏î‡πÉ‡∏´‡∏°‡πà ‡∏î‡∏∑‡πà‡∏°‡∏ô‡πâ‡∏≥‡πÄ‡∏¢‡∏≠‡∏∞‡πÜ<br>‡πÅ‡∏•‡∏∞‡πÄ‡∏õ‡∏¥‡∏î‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡πÉ‡∏´‡πâ‡πÅ‡∏û‡∏ó‡∏¢‡πå‡∏î‡∏π‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÑ‡∏õ‡πÇ‡∏£‡∏á‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•‡∏ô‡∏∞‡∏Ñ‡∏∞<img src="https://lh3.googleusercontent.com/d/1gJFmTXj6xpc_w8kfK-rL3HCqqgmnZp1H" class="nurse-bg-img">' }).then(()=> doSave('BP', null, v1, v2)); return; } 
            else if (s < 100 || d < 60) { swalAlert.fire({ title: '‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡∏±‡∏ô‡πÇ‡∏•‡∏´‡∏¥‡∏ï‡∏ï‡πà‡∏≥ ‚ö†Ô∏è', html: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ô‡∏±‡πà‡∏á‡∏û‡∏±‡∏Å‡πÅ‡∏•‡πâ‡∏ß‡∏ß‡∏±‡∏î‡πÉ‡∏´‡∏°‡πà ‡∏î‡∏∑‡πà‡∏°‡∏ô‡πâ‡∏≥‡πÄ‡∏¢‡∏≠‡∏∞‡πÜ<br>‡πÅ‡∏•‡∏∞‡πÄ‡∏õ‡∏¥‡∏î‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡πÉ‡∏´‡πâ‡πÅ‡∏û‡∏ó‡∏¢‡πå‡∏î‡∏π‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÑ‡∏õ‡πÇ‡∏£‡∏á‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•‡∏ô‡∏∞‡∏Ñ‡∏∞<img src="https://lh3.googleusercontent.com/d/1gJFmTXj6xpc_w8kfK-rL3HCqqgmnZp1H" class="nurse-bg-img">' }).then(()=> { doSave('BP', null, v1, v2).then(()=> openNoteForm('ADVERSE')); }); return; }
        }
        doSave(type, null, v1, v2);
    }

    async function processWaist() {
        let v1 = $('#inp-val1').value; if(!v1) return;
        if(parseFloat(v1) < 35) { $('#secondary-modal').style.display = 'flex'; $('#sec-ask').innerHTML = `‡∏Ñ‡πà‡∏≤ ${v1} ‡∏î‡∏π‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡∏à‡∏∞‡πÄ‡∏õ‡πá‡∏ô "‡∏ô‡∏¥‡πâ‡∏ß" ‡∏ô‡∏∞‡∏Ñ‡∏∞<br>‡∏£‡∏∞‡∏ö‡∏ö‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏´‡∏ô‡πà‡∏ß‡∏¢‡πÄ‡∏õ‡πá‡∏ô "‡πÄ‡∏ã‡∏ô‡∏ï‡∏¥‡πÄ‡∏°‡∏ï‡∏£" ‡∏Ñ‡πà‡∏∞`; $('#sec-body').innerHTML = `<input type="tel" id="sec-v1" class="main-input-anim" placeholder="‡∏£‡∏∞‡∏ö‡∏∏ ‡∏ã‡∏°."><button class="btn" onclick="$('#inp-val1').value=$('#sec-v1').value; $('#secondary-modal').style.display='none'; processWaist();">‡∏ï‡∏Å‡∏•‡∏á</button>`; } 
        else doSave('WAIST', null, v1);
    }

    async function processCheckup() {
        let egfr = $('#chk-egfr').value; let eye = $('#val-chk-eye').value; let foot = $('#val-chk-foot').value;
        if(!egfr && !eye && !foot) return swalForm.fire('‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ß‡πà‡∏≤‡∏á', '‡∏£‡∏∞‡∏ö‡∏∏‡∏ú‡∏•‡∏ï‡∏£‡∏ß‡∏à‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏ä‡πà‡∏≠‡∏á‡∏ô‡∏∞‡∏Ñ‡∏∞', 'warning');
        if (egfr && parseFloat(egfr) < 30) { const cf = await swalAlert.fire({ title: '‡∏Ñ‡πà‡∏≤‡πÑ‡∏ï‡∏ï‡πà‡∏≥‡∏ú‡∏¥‡∏î‡∏õ‡∏Å‡∏ï‡∏¥ ‚ö†Ô∏è', html: `‡∏Ñ‡πà‡∏≤ eGFR = ${egfr} ‡∏ï‡πà‡∏≥‡∏Å‡∏ß‡πà‡∏≤ 30<br>‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏µ‡πâ‡∏Ñ‡πà‡∏∞`, showCancelButton: true, confirmButtonText: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô', cancelButtonText: '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç' }); if(!cf.isConfirmed) return; }
        await showLoading(true); let tasks = [];
        if(egfr) tasks.push(apiPost('logEvent', { userId: liffProfile.userId, type: 'EGFR', v1: egfr, unit: '‡∏°‡∏•./‡∏ô‡∏≤‡∏ó‡∏µ/1.73 ‡∏ï‡∏£.‡∏°.' }));
        if(eye) tasks.push(apiPost('logEvent', { userId: liffProfile.userId, type: 'EYE', vt: eye }));
        if(foot) tasks.push(apiPost('logEvent', { userId: liffProfile.userId, type: 'FOOT', vt: foot }));
        await Promise.all(tasks); showLoading(false); closeAllModals(); fetchUserProfile(); swalSuccess.fire({title:'‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ú‡∏•‡∏ï‡∏£‡∏ß‡∏à‡πÅ‡∏•‡πâ‡∏ß', timer:1500, showConfirmButton:false});
    }

    function processSBGM() {
        let v1 = $('#inp-val1').value; let period = $('#val-period').value; let subtype = $('#val-subtype').value;
        if(!v1) return showMissingModal('‡∏•‡∏∑‡∏°‡∏£‡∏∞‡∏ö‡∏∏‡∏Ñ‡πà‡∏≤‡∏ô‡πâ‡∏≥‡∏ï‡∏≤‡∏•‡∏Ñ‡πà‡∏∞', `<input type="tel" id="sec-v1" class="main-input-anim" placeholder="‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏ô‡πâ‡∏≥‡∏ï‡∏≤‡∏•"><button class="btn" onclick="$('#inp-val1').value=$('#sec-v1').value; $('#secondary-modal').style.display='none'; processSBGM();">‡∏ï‡∏Å‡∏•‡∏á</button>`);
        if(parseFloat(v1) < 20 || parseFloat(v1) > 600) { $('#inp-val1').value = ''; return swalAlert.fire('‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏õ‡∏•‡∏Å‡πÜ', '‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏î‡∏π‡πÑ‡∏°‡πà‡∏ô‡πà‡∏≤‡∏à‡∏∞‡πÉ‡∏ä‡πà‡∏Ñ‡πà‡∏≤‡∏ô‡πâ‡∏≥‡∏ï‡∏≤‡∏•‡πÉ‡∏ô‡πÄ‡∏•‡∏∑‡∏≠‡∏î ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏•‡πâ‡∏ß‡∏û‡∏¥‡∏°‡∏û‡πå‡πÉ‡∏´‡∏°‡πà‡∏ô‡∏∞‡∏Ñ‡∏∞', 'error'); }
        if(!subtype) return showMissingModal('‡∏ß‡∏±‡∏î‡∏ï‡∏≠‡∏ô‡πÑ‡∏´‡∏ô‡∏Ñ‡∏∞?', `${getChipsHTML('sec-subtype', ['‡∏Å‡πà‡∏≠‡∏ô‡∏≠‡∏≤‡∏´‡∏≤‡∏£','‡∏´‡∏•‡∏±‡∏á‡∏≠‡∏≤‡∏´‡∏≤‡∏£','‡∏Å‡πà‡∏≠‡∏ô‡∏ô‡∏≠‡∏ô'])}<button class="btn" style="margin-top:15px;" onclick="$('#val-subtype').value=$('#val-sec-subtype').value; $('#secondary-modal').style.display='none'; processSBGM();">‡∏ï‡∏Å‡∏•‡∏á</button>`);

        let val = parseFloat(v1); let highLimit = (subtype === '‡∏´‡∏•‡∏±‡∏á‡∏≠‡∏≤‡∏´‡∏≤‡∏£') ? 140 : 110; let limitText = subtype === '‡∏´‡∏•‡∏±‡∏á‡∏≠‡∏≤‡∏´‡∏≤‡∏£' ? '140' : '110';
        if (val < 70 || val > highLimit) {
            let msg = val < 70 ? '‡∏ô‡πâ‡∏≥‡∏ï‡∏≤‡∏•‡∏ï‡πà‡∏≥‡∏ú‡∏¥‡∏î‡∏õ‡∏Å‡∏ï‡∏¥' : '‡∏ô‡πâ‡∏≥‡∏ï‡∏≤‡∏•‡∏™‡∏π‡∏á‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ';
            let htmlMsg = val < 70 
                ? `<div style="text-align:left; font-size:18px; position:relative; z-index:1;"><b>‡∏Å‡∏£‡∏ì‡∏µ‡∏ô‡πâ‡∏≥‡∏ï‡∏≤‡∏•‡∏ï‡πà‡∏≥‡∏Å‡∏ß‡πà‡∏≤ 70 ‡πÉ‡∏´‡πâ‡∏õ‡∏ê‡∏°‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•‡∏î‡∏±‡∏á‡∏ô‡∏µ‡πâ‡∏Ñ‡πà‡∏≤:</b><br>1. ‡πÉ‡∏´‡πâ‡∏Ñ‡∏≤‡∏£‡πå‡πÇ‡∏ö‡πÑ‡∏Æ‡πÄ‡∏î‡∏£‡∏ï‡∏î‡∏π‡∏î‡∏ã‡∏∂‡∏°‡πÄ‡∏£‡πá‡∏ß 15 ‡∏Å‡∏£‡∏±‡∏° ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÉ‡∏î‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏´‡∏ô‡∏∂‡πà‡∏á:<br>&nbsp;&nbsp;‚ó¶ ‡∏ô‡πâ‡∏≥‡∏ú‡∏∂‡πâ‡∏á ‡∏´‡∏£‡∏∑‡∏≠ ‡∏ô‡πâ‡∏≥‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡πÄ‡∏Ç‡πâ‡∏°‡∏Ç‡πâ‡∏ô 3 ‡∏ä‡πâ‡∏≠‡∏ô‡∏ä‡∏≤<br>&nbsp;&nbsp;‚ó¶ ‡∏•‡∏π‡∏Å‡∏≠‡∏°‡πÅ‡∏ö‡∏ö‡∏°‡∏µ‡∏ô‡πâ‡∏≥‡∏ï‡∏≤‡∏• 3-4 ‡πÄ‡∏°‡πá‡∏î<br>&nbsp;&nbsp;‚ó¶ ‡∏ô‡πâ‡∏≥‡∏™‡πâ‡∏°‡∏Ñ‡∏±‡πâ‡∏ô ‡∏´‡∏£‡∏∑‡∏≠ ‡∏ô‡πâ‡∏≥‡∏≠‡∏±‡∏î‡∏•‡∏° (‡∏™‡∏π‡∏ï‡∏£‡∏õ‡∏Å‡∏ï‡∏¥) 180 ‡∏ã‡∏µ‡∏ã‡∏µ<br>&nbsp;&nbsp;‚ó¶ ‡∏Ç‡∏ô‡∏°‡∏õ‡∏±‡∏á 1 ‡πÅ‡∏ú‡πà‡∏ô ‡∏´‡∏£‡∏∑‡∏≠ ‡∏Å‡∏•‡πâ‡∏ß‡∏¢ 1 ‡∏•‡∏π‡∏Å<br><i style="color:#FFF59D; font-size:14px;">‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏£‡∏£‡∏∞‡∏ß‡∏±‡∏á: ‡∏´‡∏•‡∏µ‡∏Å‡πÄ‡∏•‡∏µ‡πà‡∏¢‡∏á‡∏ä‡πá‡∏≠‡∏Å‡πÇ‡∏Å‡πÅ‡∏•‡∏ï ‡∏´‡∏£‡∏∑‡∏≠ ‡∏ô‡∏° ‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡πÑ‡∏Ç‡∏°‡∏±‡∏ô‡∏à‡∏∞‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡∏î‡∏π‡∏î‡∏ã‡∏∂‡∏°‡∏ä‡πâ‡∏≤‡∏•‡∏á</i><br>2. ‡∏£‡∏≠ 15 ‡∏ô‡∏≤‡∏ó‡∏µ ‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏à‡∏≤‡∏∞‡∏ô‡πç‡πâ‡∏≤‡∏ï‡∏≤‡∏•‡∏ã‡πâ‡∏≥<br>3. ‡∏ñ‡πâ‡∏≤‡∏ô‡πâ‡∏≥‡∏ï‡∏≤‡∏•‡∏¢‡∏±‡∏á ‚â§ 70 ‡πÉ‡∏´‡πâ‡∏ó‡∏≤‡∏ô‡∏ã‡πâ‡∏≥‡∏≠‡∏µ‡∏Å 1 ‡∏£‡∏≠‡∏ö<br><br><b style="color:#FFCDD2;">üö® ‡∏´‡∏≤‡∏Å‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡∏ã‡∏∂‡∏° ‡∏ä‡∏±‡∏Å ‡∏´‡∏£‡∏∑‡∏≠‡∏´‡∏°‡∏î‡∏™‡∏ï‡∏¥ ‡πÇ‡∏ó‡∏£ 1669 ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‡∏Ñ‡πà‡∏∞!</b><img src="https://lh3.googleusercontent.com/d/1gJFmTXj6xpc_w8kfK-rL3HCqqgmnZp1H" class="nurse-bg-img"></div>`
                : `<div style="position:relative; z-index:1; text-align:left; font-size:20px;">(‡πÄ‡∏Å‡∏ì‡∏ë‡πå‡∏õ‡∏Å‡∏ï‡∏¥ ${subtype} ‡∏Ñ‡∏∑‡∏≠‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô ${limitText} ‡∏°‡∏Å./‡∏î‡∏•.)<br><br>üí° <b>‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏Å‡∏≤‡∏£‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏ï‡∏±‡∏ß:</b><br>‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏Ñ‡∏∏‡∏°‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡πÅ‡∏õ‡πâ‡∏á/‡∏ô‡πâ‡∏≥‡∏ï‡∏≤‡∏• ‡πÅ‡∏•‡∏∞‡∏î‡∏∑‡πà‡∏°‡∏ô‡πâ‡∏≥‡πÄ‡∏õ‡∏•‡πà‡∏≤‡πÄ‡∏¢‡∏≠‡∏∞‡πÜ ‡∏ô‡∏∞‡∏Ñ‡∏∞ üíß<img src="https://lh3.googleusercontent.com/d/1gJFmTXj6xpc_w8kfK-rL3HCqqgmnZp1H" class="nurse-bg-img"></div>`;
            swalAlert.fire({ title: '‚ö†Ô∏è ' + msg, html: htmlMsg, showCancelButton: true, confirmButtonText: '‡∏£‡∏±‡∏ö‡∏ó‡∏£‡∏≤‡∏ö‡πÅ‡∏•‡∏∞‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å', cancelButtonText: '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç' }).then((cf) => { if(cf.isConfirmed) { doSave('SBGM', subtype, v1, null, period).then(() => openNoteForm('ADVERSE')); } else $('#inp-val1').value = ''; });
        } else doSave('SBGM', subtype, v1, null, period).then(() => askAdverseAfterSave());
    }

    function processExercise() {
        let v1 = $('#inp-text').value || $('#val-activity').value;
        if(!v1) return showMissingModal('‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏≠‡∏∞‡πÑ‡∏£‡∏Ñ‡∏∞?', `<input type="text" id="sec-v1" class="main-input-anim" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°"><button class="btn" onclick="$('#inp-text').value=$('#sec-v1').value; $('#secondary-modal').style.display='none'; processExercise();">‡∏ï‡∏Å‡∏•‡∏á</button>`);
        pendingFormData.act = v1; showMissingModal(`‡∏ó‡∏≥ ${v1} ‡πÑ‡∏õ‡∏Å‡∏µ‡πà‡∏ô‡∏≤‡∏ó‡∏µ‡∏Ñ‡∏∞?`, `<input type="tel" id="sec-mins" class="main-input-anim" placeholder="‡∏ô‡∏≤‡∏ó‡∏µ"><button class="btn" onclick="doSave('EXERCISE', null, $('#sec-mins').value, null, pendingFormData.act);">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å ‚úÖ</button>`);
    }

    function processAdverse() {
        let sel = Array.from(document.querySelectorAll('#adv-chips .active')).map(b=>b.innerText);
        let txt = $('#inp-text').value; let final = sel.join(', ') + (sel.length && txt ? ', ' : '') + txt;
        if(!final) return closeAllModals(); doSave('ADVERSE', null, null, null, final);
    }

    async function processBodyComp() {
        let tasks = [];
        const f = $('#bc-fat').value, v = $('#bc-visceral').value, m = $('#bc-muscle').value, b = $('#bc-bmi').value, r = $('#bc-rm').value, a = $('#bc-age').value;
        if(!f && !v && !m && !b && !r && !a) return swalForm.fire('‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ß‡πà‡∏≤‡∏á', '‡∏£‡∏∞‡∏ö‡∏∏‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏ä‡πà‡∏≠‡∏á‡∏ô‡∏∞‡∏Ñ‡∏∞', 'warning');
        await showLoading(true);
        if(f) tasks.push(apiPost('logEvent', { userId: liffProfile.userId, type: '%FAT', v1: f, unit: '%' }));
        if(v) tasks.push(apiPost('logEvent', { userId: liffProfile.userId, type: 'VISCERALFAT', v1: v, unit: '‡∏£‡∏∞‡∏î‡∏±‡∏ö' }));
        if(m) tasks.push(apiPost('logEvent', { userId: liffProfile.userId, type: 'MUSCLE', v1: m, unit: '%' }));
        if(b) tasks.push(apiPost('logEvent', { userId: liffProfile.userId, type: 'BMI', v1: b, unit: 'kg/m¬≤' }));
        if(r) tasks.push(apiPost('logEvent', { userId: liffProfile.userId, type: 'RESTINGMET', v1: r, unit: 'kcal' }));
        if(a) tasks.push(apiPost('logEvent', { userId: liffProfile.userId, type: 'BODYAGE', v1: a, unit: '‡∏õ‡∏µ' }));
        Promise.all(tasks).then(() => { showLoading(false); closeAllModals(); fetchUserProfile(); swalSuccess.fire({title:'‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏î‡∏±‡∏ä‡∏ô‡∏µ‡∏°‡∏ß‡∏•‡∏Å‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß', timer:1500, showConfirmButton:false}); });
    }

    function processSleep() {
        let s = $('#val-sleep').value;
        if(!s) return showMissingModal('‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡∏´‡∏ô‡πà‡∏≠‡∏¢‡∏Ñ‡πà‡∏∞', '');
        if(s === '‡∏ô‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏ö‡∏î‡∏µ') showMissingModal('‡πÄ‡∏¢‡∏µ‡πà‡∏¢‡∏°‡πÄ‡∏•‡∏¢‡∏Ñ‡πà‡∏∞! ‡∏´‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏Å‡∏µ‡πà‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á‡∏Ñ‡∏∞?', `<input type="tel" id="sec-hrs" class="main-input-anim" placeholder="‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á"><button class="btn" onclick="doSave('SLEEP', null, $('#sec-hrs').value, null, '‡∏ô‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏ö‡∏î‡∏µ', '‡∏ä‡∏°.');">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å ‚úÖ</button>`);
        else {
            pendingFormData.stress = s;
            showMissingModal(`‡∏≠‡∏≤‡∏Å‡∏≤‡∏£ "${s}" ‡πÄ‡∏õ‡πá‡∏ô‡∏ö‡πà‡∏≠‡∏¢‡πÅ‡∏Ñ‡πà‡πÑ‡∏´‡∏ô?`, `<div style="display:flex; flex-direction:column; gap:8px;"><button class="btn" style="font-size:20px; padding:10px;" onclick="saveStress(1)">‡πÄ‡∏õ‡πá‡∏ô‡∏™‡πà‡∏ß‡∏ô‡∏ô‡πâ‡∏≠‡∏¢ (1)</button><button class="btn" style="font-size:20px; padding:10px;" onclick="saveStress(2)">‡∏õ‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á (2)</button><button class="btn" style="font-size:20px; padding:10px;" onclick="saveStress(3)">‡πÄ‡∏õ‡πá‡∏ô‡∏°‡∏≤‡∏Å (3)</button><button class="btn" style="font-size:20px; padding:10px; background:linear-gradient(135deg, #ef5350, #b71c1c); color:#FFF;" onclick="saveStress(4)">‡∏Å‡∏£‡∏∞‡∏ó‡∏ö‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ß‡∏±‡∏ô (4)</button></div>`);
        }
    }

    window.saveStress = async function(score) {
        $('#secondary-modal').style.display = 'none'; await showLoading(true);
        await apiPost('logEvent', { userId: liffProfile.userId, type: 'STRESS', vt: pendingFormData.stress, v1: score, unit: '‡∏£‡∏∞‡∏î‡∏±‡∏ö' });
        showLoading(false); closeAllModals(); fetchUserProfile();
        if (score >= 1) swalAlert.fire({ title: '‡∏û‡∏±‡∏Å‡∏ú‡πà‡∏≠‡∏ô‡πÅ‡∏•‡∏∞‡∏î‡∏π‡πÅ‡∏•‡πÉ‡∏à‡∏î‡πâ‡∏ß‡∏¢‡∏ô‡∏∞‡∏Ñ‡∏∞ üíñ', text: '‡∏°‡∏µ‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏≠‡∏∞‡πÑ‡∏£‡∏≠‡∏¢‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏≤‡∏¢‡∏Å‡∏±‡∏ö‡∏û‡∏µ‡πà‡∏´‡∏ß‡∏µ‡πÑ‡∏´‡∏°‡∏Ñ‡∏∞ ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏û‡∏¥‡∏°‡∏û‡πå‡πÅ‡∏à‡πâ‡∏á‡πÉ‡∏ô‡πÑ‡∏•‡∏ô‡πå‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢‡∏ô‡∏∞‡∏Ñ‡∏∞', icon: 'info' });
        else swalSuccess.fire({ title: '‡πÄ‡∏Å‡πà‡∏á‡∏°‡∏≤‡∏Å‡∏ó‡∏µ‡πà‡∏™‡∏±‡∏á‡πÄ‡∏Å‡∏ï‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á', timer: 1500, showConfirmButton: false });
    }

    function processMed1() {
        let m = $('#med-name').value; let c = $('#val-med-change').value; let d = $('#med-date').value;
        if(!m || !c || !d) return showMissingModal('‡∏£‡∏∞‡∏ö‡∏∏‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ô‡∏∞‡∏Ñ‡∏∞', `<button class="btn" onclick="$('#secondary-modal').style.display='none'">‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</button>`);
        pendingFormData.med = m; pendingFormData.change = c; pendingFormData.date = d;
        if (c === 'STOPPED') doSaveMed(m, c, '‡∏´‡∏¢‡∏∏‡∏î‡∏¢‡∏≤', d);
        else showMissingModal('‡∏•‡∏î‡∏¢‡∏≤‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÄ‡∏ó‡πà‡∏≤‡πÑ‡∏´‡∏£‡πà‡∏Ñ‡∏∞?', `<div style="display:flex; gap:5px;"><input type="tel" id="sec-p" placeholder="‡∏Å‡∏µ‡πà‡πÄ‡∏°‡πá‡∏î" class="main-input-anim"><input type="tel" id="sec-t" placeholder="‡∏Å‡∏µ‡πà‡∏Ñ‡∏£‡∏±‡πâ‡∏á/‡∏ß‡∏±‡∏ô"></div><button class="btn" onclick="doSaveMed(pendingFormData.med, pendingFormData.change, $('#sec-p').value + ' ‡πÄ‡∏°‡πá‡∏î ' + $('#sec-t').value + ' ‡∏Ñ‡∏£‡∏±‡πâ‡∏á', pendingFormData.date);">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å ‚úÖ</button>`);
    }

    // --- NUTRITION LOGIC ---
    async function processNutrition() {
        let w = $('#nutri-w').value; let h = $('#nutri-h').value;
        if(!w || !h) return swalForm.fire('‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡πÅ‡∏•‡∏∞‡∏™‡πà‡∏ß‡∏ô‡∏™‡∏π‡∏á‡∏Ñ‡πà‡∏∞', 'warning');
        let act = $('#val-nutri-act').value; let fav = $('#nutri-fav').value; let dis = $('#nutri-dis').value;

        await showLoading(true);
        const res = await apiPost('logNutrition', { userId: liffProfile.userId, weight: w, height: h, profile: act, favFood: fav, dislikeFood: dis });
        showLoading(false);

        if(res && res.ok) { window.currentNutritionProfile = res.data; renderNutritionSteps(res.data); } 
        else { swalAlert.fire('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡πÑ‡∏î‡πâ‡∏Ñ‡πà‡∏∞', 'error'); }
    }

    function renderNutritionSteps(data) {
        $('#nutri-form-section').style.display = 'none'; $('#nutri-result-section').style.display = 'block'; $('#pri-ask').style.display = 'none'; 
        
        let bmi = parseFloat(data.bmi);
        let bmiText = bmi < 18.5 ? '‡∏ú‡∏≠‡∏°' : bmi <= 22.9 ? '‡∏õ‡∏Å‡∏ï‡∏¥' : bmi <= 24.9 ? '‡∏ó‡πâ‡∏ß‡∏°' : bmi <= 29.9 ? '‡∏≠‡πâ‡∏ß‡∏ô‡∏£‡∏∞‡∏î‡∏±‡∏ö 1' : '‡∏≠‡πâ‡∏ß‡∏ô‡∏£‡∏∞‡∏î‡∏±‡∏ö 2';
        
        let step1 = `<div class="nutri-step active" id="n-step-1"><div style="font-size:60px; text-align:center; animation: pulse-jiggle 2s infinite;">üìä</div><h3 style="color:#FFD600; text-align:center;">‡∏î‡∏±‡∏ä‡∏ô‡∏µ‡∏°‡∏ß‡∏•‡∏Å‡∏≤‡∏¢ (BMI)</h3><div style="background:rgba(255,255,255,0.1); padding:20px; border-radius:20px; text-align:center; margin-bottom:20px;"><div style="font-size:50px; font-weight:800; color:#FFF; line-height:1;">${bmi}</div><div style="font-size:22px; color:#FFCC80; font-weight:700; margin-top:10px;">‡∏à‡∏±‡∏î‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏Å‡∏•‡∏∏‡πà‡∏°: ${bmiText}</div></div><div style="background:#FFF; color:#5D4037; padding:15px; border-radius:15px; font-size:16px; margin-bottom:20px; line-height:1.4;"><b>üí° ‡∏´‡∏•‡∏±‡∏Å‡∏Å‡∏≤‡∏£‡∏•‡∏î‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡πÅ‡∏ö‡∏ö‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢:</b><br>‡∏£‡∏∞‡∏ö‡∏ö‡πÑ‡∏î‡πâ‡∏™‡∏£‡πâ‡∏≤‡∏á <u>‡∏†‡∏≤‡∏ß‡∏∞‡∏Ç‡∏≤‡∏î‡∏î‡∏∏‡∏•‡∏û‡∏•‡∏±‡∏á‡∏á‡∏≤‡∏ô</u> ‡πÇ‡∏î‡∏¢‡∏•‡∏î‡∏û‡∏•‡∏±‡∏á‡∏á‡∏≤‡∏ô‡∏•‡∏á‡∏ß‡∏±‡∏ô‡∏•‡∏∞ 500 kcal ‡∏à‡∏≤‡∏Å‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏ú‡∏≤‡∏ú‡∏•‡∏≤‡∏ç‡πÑ‡∏î‡πâ‡∏õ‡∏Å‡∏ï‡∏¥<br>‡∏à‡∏∞‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡∏•‡∏î‡∏•‡∏á 0.5-1 ‡∏Å‡∏Å./‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢ ‡πÅ‡∏•‡∏∞‡∏ä‡πà‡∏ß‡∏¢‡πÉ‡∏´‡πâ‡πÄ‡∏ö‡∏≤‡∏´‡∏ß‡∏≤‡∏ô‡∏™‡∏á‡∏ö‡πÑ‡∏î‡πâ‡πÄ‡∏£‡πá‡∏ß‡∏Ç‡∏∂‡πâ‡∏ô‡∏Ñ‡πà‡∏∞</div><button class="btn" onclick="nextNutriStep(2)">‡∏î‡∏π‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏û‡∏•‡∏±‡∏á‡∏á‡∏≤‡∏ô ‚û°Ô∏è</button></div>`;

        let step2 = `<div class="nutri-step" id="n-step-2"><div style="font-size:60px; text-align:center; animation: pulse-jiggle 2s infinite;">üî•</div><h3 style="color:#FFD600; text-align:center;">‡∏û‡∏•‡∏±‡∏á‡∏á‡∏≤‡∏ô‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡∏ï‡πà‡∏≠‡∏ß‡∏±‡∏ô</h3><div style="font-size:55px; font-weight:800; color:#FFF; text-align:center; line-height:1; margin-bottom:10px;">${data.total_kcal} <span style="font-size:20px;">kcal</span></div><div style="background:rgba(255,255,255,0.1); padding:15px; border-radius:20px; margin:15px 0;"><div style="display:flex; justify-content:space-between; margin-bottom:10px; font-size:18px;"><span>üçö ‡∏Ñ‡∏≤‡∏£‡πå‡πÇ‡∏ö‡πÑ‡∏Æ‡πÄ‡∏î‡∏£‡∏ï (50%)</span> <b>${data.cho_kcal} kcal</b></div><div style="display:flex; justify-content:space-between; margin-bottom:10px; font-size:18px;"><span>ü•© ‡πÇ‡∏õ‡∏£‡∏ï‡∏µ‡∏ô (25%)</span> <b>${data.pro_kcal} kcal</b></div><div style="display:flex; justify-content:space-between; margin-bottom:5px; font-size:18px;"><span>ü•ë ‡πÑ‡∏Ç‡∏°‡∏±‡∏ô (25%)</span> <b>${data.fat_kcal} kcal</b></div></div><p style="font-size:14px; color:#FFCC80; text-align:center;">* ‡πÇ‡∏õ‡∏£‡∏ï‡∏µ‡∏ô‡∏ñ‡∏π‡∏Å‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏°‡∏≤‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏£‡∏±‡∏Å‡∏©‡∏≤‡∏°‡∏ß‡∏•‡∏Å‡∏•‡πâ‡∏≤‡∏°‡πÄ‡∏ô‡∏∑‡πâ‡∏≠ (‡πÑ‡∏°‡πà‡∏ï‡πà‡∏≥‡∏Å‡∏ß‡πà‡∏≤ 60g/‡∏ß‡∏±‡∏ô) ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏ú‡∏≤‡∏ú‡∏•‡∏≤‡∏ç‡∏û‡∏±‡∏á‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏•‡∏î‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡∏Ñ‡πà‡∏∞</p><div style="display:flex; gap:10px; margin-top:20px;"><button class="btn-close" onclick="nextNutriStep(1)" style="flex:1; justify-content:center;">‚óÄ ‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö</button><button class="btn" onclick="nextNutriStep(3)" style="flex:2;">‡∏î‡∏π‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏≠‡∏≤‡∏´‡∏≤‡∏£ ‚û°Ô∏è</button></div></div>`;

        let meatTotal = Number(data.srv_meat_verylean_35kcal) + Number(data.srv_meat_lean_55kcal);
        let oilTotal = Number(data.srv_oil_45kcal) + Number(data.srv_nuts_45kcal);
        let step3 = `<div class="nutri-step" id="n-step-3"><h3 style="color:#FFD600; text-align:center;">‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÅ‡∏•‡∏Å‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏≠‡∏≤‡∏´‡∏≤‡∏£/‡∏ß‡∏±‡∏ô</h3><table class="nutri-table"><tr><th style="width:40%;">‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</th><th style="width:20%;">‡∏™‡πà‡∏ß‡∏ô/‡∏ß‡∏±‡∏ô</th><th>‡∏Ç‡πâ‡∏≠‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥</th></tr><tr><td colspan="3" style="background:#FFF9C4; font-weight:800; text-align:left;">üçö ‡∏Ñ‡∏≤‡∏£‡πå‡πÇ‡∏ö‡πÑ‡∏Æ‡πÄ‡∏î‡∏£‡∏ï</td></tr><tr><td>- ‡∏Ç‡πâ‡∏≤‡∏ß/‡πÅ‡∏õ‡πâ‡∏á</td><td><b>${data.srv_grain_80kcal}</b> ‡∏ó‡∏±‡∏û‡∏û‡∏µ</td><td>‡πÄ‡∏ô‡πâ‡∏ô‡∏Ç‡πâ‡∏≤‡∏ß‡∏Å‡∏•‡πâ‡∏≠‡∏á ‡∏ò‡∏±‡∏ç‡∏û‡∏∑‡∏ä ‡∏Ç‡∏ô‡∏°‡∏õ‡∏±‡∏á‡πÇ‡∏Æ‡∏•‡∏ß‡∏µ‡∏ï</td></tr><tr><td>- ‡∏ú‡∏•‡πÑ‡∏°‡πâ</td><td><b>${data.srv_fruit_60kcal}</b> ‡∏™‡πà‡∏ß‡∏ô</td><td>‡πÄ‡∏ä‡πà‡∏ô ‡∏ù‡∏£‡∏±‡πà‡∏á 1 ‡∏ú‡∏•, ‡∏°‡∏∞‡∏•‡∏∞‡∏Å‡∏≠ 8 ‡∏Ñ‡∏≥</td></tr><tr><td>- ‡∏ú‡∏±‡∏Å ‡∏Å.</td><td><b>‡∏≠‡∏¥‡∏™‡∏£‡∏∞</b></td><td>‡∏ú‡∏±‡∏Å‡∏Å‡∏≤‡∏î‡∏Ç‡∏≤‡∏ß, ‡πÅ‡∏ï‡∏á‡∏Å‡∏ß‡∏≤, ‡∏ü‡∏±‡∏Å‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß (‡πÑ‡∏°‡πà‡∏Ñ‡∏¥‡∏î‡πÅ‡∏Ñ‡∏•‡∏≠‡∏£‡∏µ‡πà)</td></tr><tr><td>- ‡∏ú‡∏±‡∏Å ‡∏Ç.</td><td><b>${data.srv_vegB_25kcal}</b> ‡∏ó‡∏±‡∏û‡∏û‡∏µ</td><td>‡∏Ñ‡∏∞‡∏ô‡πâ‡∏≤, ‡∏Å‡∏ß‡∏≤‡∏á‡∏ï‡∏∏‡πâ‡∏á, ‡πÅ‡∏Ñ‡∏£‡∏≠‡∏ó</td></tr><tr><td>- ‡∏ô‡πâ‡∏≥‡∏ï‡∏≤‡∏•</td><td><b>${data.srv_sugar_16kcal}</b> ‡∏ä‡∏ä.</td><td>‡∏Ñ‡∏ß‡∏£‡∏´‡∏•‡∏µ‡∏Å‡πÄ‡∏•‡∏µ‡πà‡∏¢‡∏á ‡∏´‡∏£‡∏∑‡∏≠‡πÉ‡∏ä‡πâ‡∏ô‡πâ‡∏≥‡∏ï‡∏≤‡∏•‡πÄ‡∏ó‡∏µ‡∏¢‡∏°</td></tr><tr><td colspan="3" style="background:#E1F5FE; font-weight:800; text-align:left;">ü•© ‡πÇ‡∏õ‡∏£‡∏ï‡∏µ‡∏ô</td></tr><tr><td>- ‡∏ô‡∏°‡∏à‡∏∑‡∏î</td><td><b>${data.srv_milk_90kcal}</b> ‡πÅ‡∏Å‡πâ‡∏ß</td><td>‡πÅ‡∏ö‡∏ö‡∏û‡∏£‡πà‡∏≠‡∏á‡∏´‡∏£‡∏∑‡∏≠‡∏Ç‡∏≤‡∏î‡∏°‡∏±‡∏ô‡πÄ‡∏ô‡∏¢</td></tr><tr><td>- ‡πÄ‡∏ô‡∏∑‡πâ‡∏≠(‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÑ‡∏Ç‡∏°‡∏±‡∏ô)</td><td><b>${data.srv_meat_verylean_35kcal}</b> ‡∏ä‡∏ï.</td><td>‡∏≠‡∏Å‡πÑ‡∏Å‡πà‡∏•‡∏≠‡∏Å‡∏´‡∏ô‡∏±‡∏á, ‡∏õ‡∏•‡∏≤, ‡πÑ‡∏Ç‡πà‡∏Ç‡∏≤‡∏ß</td></tr><tr><td>- ‡πÄ‡∏ô‡∏∑‡πâ‡∏≠(‡πÑ‡∏Ç‡∏°‡∏±‡∏ô‡∏ï‡πà‡∏≥)</td><td><b>${data.srv_meat_lean_55kcal}</b> ‡∏ä‡∏ï.</td><td>‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏°‡∏π/‡∏ß‡∏±‡∏ß ‡πÑ‡∏°‡πà‡∏ï‡∏¥‡∏î‡∏°‡∏±‡∏ô, ‡πÄ‡∏ï‡πâ‡∏≤‡∏´‡∏π‡πâ‡∏Ç‡∏≤‡∏ß</td></tr><tr><td>- ‡πÄ‡∏ô‡∏∑‡πâ‡∏≠(‡πÑ‡∏Ç‡∏°‡∏±‡∏ô‡∏õ‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á)</td><td><b>${data.srv_meat_medium_75kcal}</b> ‡∏ä‡∏ï.</td><td>‡πÑ‡∏Ç‡πà‡πÑ‡∏Å‡πà‡∏ó‡∏±‡πâ‡∏á‡∏ü‡∏≠‡∏á (‡∏ó‡∏≤‡∏ô‡∏™‡∏•‡∏±‡∏ö‡πÑ‡∏î‡πâ)</td></tr><tr><td>- ‡πÄ‡∏ô‡∏∑‡πâ‡∏≠(‡πÑ‡∏Ç‡∏°‡∏±‡∏ô‡∏™‡∏π‡∏á)</td><td><b>‡∏á‡∏î</b></td><td>‡∏´‡∏°‡∏π‡∏Å‡∏£‡∏≠‡∏ö, ‡πÄ‡∏ö‡∏Ñ‡∏≠‡∏ô, ‡∏Å‡∏∏‡∏ô‡πÄ‡∏ä‡∏µ‡∏¢‡∏á</td></tr><tr><td colspan="3" style="background:#F1F8E9; font-weight:800; text-align:left;">ü•ë ‡πÑ‡∏Ç‡∏°‡∏±‡∏ô ‡πÅ‡∏•‡∏∞ ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏õ‡∏£‡∏∏‡∏á</td></tr><tr><td>- ‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô</td><td><b>${data.srv_oil_45kcal}</b> ‡∏ä‡∏ä.</td><td>‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô‡∏£‡∏≥‡∏Ç‡πâ‡∏≤‡∏ß, ‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô‡∏°‡∏∞‡∏Å‡∏≠‡∏Å (‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô 6 ‡∏ä‡∏ä./‡∏ß‡∏±‡∏ô)</td></tr><tr><td>- ‡∏ñ‡∏±‡πà‡∏ß‡πÄ‡∏õ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏Ç‡πá‡∏á</td><td><b>${data.srv_nuts_45kcal}</b> ‡∏™‡πà‡∏ß‡∏ô</td><td>‡∏≠‡∏±‡∏•‡∏°‡∏≠‡∏ô‡∏î‡πå, ‡πÄ‡∏°‡πá‡∏î‡∏°‡∏∞‡∏°‡πà‡∏ß‡∏á‡∏´‡∏¥‡∏°‡∏û‡∏≤‡∏ô‡∏ï‡πå</td></tr><tr><td>- ‡πÄ‡∏Å‡∏•‡∏∑‡∏≠/‡∏ô‡πâ‡∏≥‡∏õ‡∏•‡∏≤</td><td><b>‡∏à‡∏≥‡∏Å‡∏±‡∏î</b></td><td>‡πÄ‡∏Å‡∏•‡∏∑‡∏≠‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô 1 ‡∏ä‡∏ä. ‡∏´‡∏£‡∏∑‡∏≠‡∏ô‡πâ‡∏≥‡∏õ‡∏•‡∏≤‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô 3-4 ‡∏ä‡∏ä./‡∏ß‡∏±‡∏ô</td></tr></table><div style="display:flex; gap:10px; margin-top:20px;"><button class="btn-close" onclick="nextNutriStep(2)" style="flex:1; justify-content:center;">‚óÄ ‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö</button><button class="btn" onclick="nextNutriStep(4)" style="flex:2;">‡πÇ‡∏°‡πÄ‡∏î‡∏•‡∏à‡∏±‡∏î‡∏à‡∏≤‡∏ô ‚û°Ô∏è</button></div></div>`;

        let step4 = `<div class="nutri-step" id="n-step-4"><h3 style="color:#FFD600; text-align:center;">‡πÇ‡∏°‡πÄ‡∏î‡∏•‡∏à‡∏±‡∏î‡∏à‡∏≤‡∏ô 2:1:1 (‡∏Å‡∏∞‡∏î‡πâ‡∏ß‡∏¢‡∏™‡∏≤‡∏¢‡∏ï‡∏≤)</h3><div style="background:#FFF; padding:15px; border-radius:50%; width:200px; height:200px; margin:0 auto 20px; box-shadow:0 10px 20px rgba(0,0,0,0.3);"><canvas id="plateChart"></canvas></div><div style="background:rgba(255,255,255,0.1); padding:15px; border-radius:20px; font-size:18px; margin-bottom:20px; line-height:1.4;"><div style="margin-bottom:8px;"><b style="color:#81C784;">ü•¨ 2 ‡∏™‡πà‡∏ß‡∏ô (‡∏ú‡∏±‡∏Å):</b> ‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ô ${Math.max(1, Math.round(data.srv_vegB_25kcal/3))} ‡∏ó‡∏±‡∏û‡∏û‡∏µ/‡∏°‡∏∑‡πâ‡∏≠</div><div style="margin-bottom:8px;"><b style="color:#FFB74D;">ü•© 1 ‡∏™‡πà‡∏ß‡∏ô (‡πÄ‡∏ô‡∏∑‡πâ‡∏≠):</b> ‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ô ${Math.max(1, Math.round(meatTotal/3))} ‡∏ä‡πâ‡∏≠‡∏ô‡πÇ‡∏ï‡πä‡∏∞/‡∏°‡∏∑‡πâ‡∏≠</div><div><b style="color:#E0E0E0;">üçö 1 ‡∏™‡πà‡∏ß‡∏ô (‡∏Ç‡πâ‡∏≤‡∏ß):</b> ‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ô ${Math.max(1, Math.round(data.srv_grain_80kcal/3))} ‡∏ó‡∏±‡∏û‡∏û‡∏µ/‡∏°‡∏∑‡πâ‡∏≠</div></div><button class="btn" onclick="closeAllModals()">‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏à‡πÅ‡∏•‡∏∞‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô ‚úÖ</button></div>`;

        $('#nutri-result-section').innerHTML = step1 + step2 + step3 + step4;
    }

    window.nextNutriStep = function(step) {
        document.querySelectorAll('.nutri-step').forEach(el => el.classList.remove('active'));
        $('#n-step-'+step).classList.add('active');
        if(step === 4) {
            setTimeout(() => {
                if(plateChartInst) plateChartInst.destroy();
                plateChartInst = new Chart(document.getElementById('plateChart').getContext('2d'), { type: 'pie', data: { labels: ['‡∏ú‡∏±‡∏Å (50%)', '‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏™‡∏±‡∏ï‡∏ß‡πå (25%)', '‡∏Ç‡πâ‡∏≤‡∏ß/‡πÅ‡∏õ‡πâ‡∏á (25%)'], datasets: [{ data: [50, 25, 25], backgroundColor: ['#81C784', '#FFB74D', '#E0E0E0'], borderWidth: 3, borderColor: '#FFF' }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } } });
            }, 100);
        }
    }

    // --- FOOD SYSTEM WITH AI ---
    function addFoodRow(isInput=true, name='', qty='', unit='', index=0) {
        const div = document.createElement('div'); div.className = "food-row-wrapper";
        if (isInput) div.innerHTML = `<div class="food-row" style="display:flex; gap:5px; margin-bottom:15px;"><input type="text" class="food-n main-input-anim" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏≠‡∏≤‡∏´‡∏≤‡∏£" value="${name}" style="flex:2;"><input type="tel" class="food-q" placeholder="‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ì" value="${qty}" inputmode="decimal" oninput="validateNumber(this)" style="flex:1;"><input type="text" class="food-u" placeholder="‡∏´‡∏ô‡πà‡∏ß‡∏¢" value="${unit}" style="flex:1;"></div>`;
        else div.innerHTML = `<div class="food-card" style="background:rgba(255,255,255,0.1); border-radius:15px; padding:10px; margin-bottom:10px; display:flex; justify-content:space-between; align-items:center; border: 1px solid #D7CCC8;"><div style="text-align:left;"><div style="font-size:20px; font-weight:800; color:#FFF;">${name}</div><div style="font-size:16px; color:#FFE0B2;">${qty} ${unit}</div></div><button class="btn-white-round" style="margin:0; padding:5px 15px; font-size:16px;" onclick="switchToEdit(this, '${name}', '${qty}', '${unit}')">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button></div><div class="food-row" style="display:none;"><input type="text" class="food-n" value="${name}"><input type="tel" class="food-q" value="${qty}"><input type="text" class="food-u" value="${unit}"></div>`;
        $('#food-rows').appendChild(div);
    }
    window.switchToEdit = function(btn, name, qty, unit) { btn.closest('.food-row-wrapper').innerHTML = `<div class="food-row" style="display:flex; gap:5px; margin-bottom:15px;"><input type="text" class="food-n main-input-anim" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏≠‡∏≤‡∏´‡∏≤‡∏£" value="${name}" style="flex:2;"><input type="tel" class="food-q" placeholder="‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ì" value="${qty}" inputmode="decimal" oninput="validateNumber(this)" style="flex:1;"><input type="text" class="food-u" placeholder="‡∏´‡∏ô‡πà‡∏ß‡∏¢" value="${unit}" style="flex:1;"></div>`; }

    async function uploadFoodImage(input) {
      if (!input.files || !input.files[0]) return;
      $('#primary-modal').style.display = 'none'; await showLoading(true);
      try {
        const reader = new FileReader(); reader.readAsDataURL(input.files[0]);
        reader.onload = async (e) => {
            const img = new Image(); img.src = e.target.result;
            img.onload = async () => {
                const canvas = document.createElement('canvas'); let w = img.width, h = img.height, max = 512;
                if (w > h) { if (w > max) { h *= max / w; w = max; } } else { if (h > max) { w *= max / h; h = max; } }
                canvas.width = w; canvas.height = h; canvas.getContext('2d').drawImage(img, 0, 0, w, h);
                const base64 = canvas.toDataURL('image/jpeg', 0.6).split(',')[1];
                window.lastUploadedImageUrl = img.src; 
                
                let hr = new Date().getHours(); let currentMeal = '‡πÄ‡∏ä‡πâ‡∏≤'; if(hr>=11&&hr<14) currentMeal='‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏á'; else if(hr>=14) currentMeal='‡πÄ‡∏¢‡πá‡∏ô';
                const res = await apiPost('uploadFoodImage', { userId: liffProfile.userId, imageBase64: base64, nutritionCtx: window.currentNutritionProfile, mealType: currentMeal });
                showLoading(false); 
                
                if (res.notFood) swalAlert.fire({ title: '‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡∏Ç‡∏≠‡∏á‡∏Å‡∏¥‡∏ô‡πÅ‡∏ô‡πà‡πÄ‡∏•‡∏¢', text: res.message || 'AI ‡∏°‡∏≠‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏´‡πá‡∏ô‡∏≠‡∏≤‡∏´‡∏≤‡∏£ ‡∏•‡∏≠‡∏á‡∏ñ‡πà‡∏≤‡∏¢‡πÉ‡∏´‡∏°‡πà‡∏ô‡∏∞‡∏Ñ‡∏∞', confirmButtonText: '‡∏ï‡∏Å‡∏•‡∏á' }).then(()=> openNoteForm('FOOD'));
                else if(res.ok && res.items) {
                    openNoteForm('FOOD'); 
                    const isFallback = res.items.length === 1 && res.items[0].name.includes("‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏≠‡∏á");
                    if(isFallback) {
                        const foodPreview = document.getElementById('food-preview'); if (foodPreview) { foodPreview.style.display = 'block'; foodPreview.src = window.lastUploadedImageUrl; }
                        swalAlert.fire({ title: 'AI ‡∏Ç‡∏±‡∏î‡∏Ç‡πâ‡∏≠‡∏á üòÖ', text: `‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ä‡∏∑‡πà‡∏≠‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡πÄ‡∏≠‡∏á‡∏ô‡∏∞‡∏Ñ‡∏∞` });
                    } else {
                        const foodPreview = document.getElementById('food-preview'); if (foodPreview) { foodPreview.style.display = 'block'; foodPreview.src = window.lastUploadedImageUrl; }
                        $('#food-rows').innerHTML = ''; res.items.forEach((item, idx) => addFoodRow(false, item.name, item.qty, item.unit, idx));
                    }
                } else swalAlert.fire({title: '‡∏Ç‡∏≠‡∏≠‡∏†‡∏±‡∏¢', text: res.message }).then(()=> openNoteForm('FOOD'));
            };
        };
      } catch(err) { showLoading(false); swalAlert.fire({title: '‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', text: err.message }).then(()=> openNoteForm('FOOD')); }
      input.value = ''; 
    }

    async function processFoodManual() {
        let items = [];
        document.querySelectorAll('.food-row').forEach(row => { 
            let n = row.querySelector('.food-n').value.trim(); let q = row.querySelector('.food-q').value.trim(); let u = row.querySelector('.food-u').value.trim();
            if(n) items.push({name:n, qty:q||1, unit:u||'‡∏ó‡∏µ‡πà'});
        });
        if(items.length===0) return showMissingModal('‡∏£‡∏∞‡∏ö‡∏∏‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏Å‡πà‡∏≠‡∏ô‡∏ô‡∏∞‡∏Ñ‡∏∞', '<button class="btn" onclick="$(\'#secondary-modal\').style.display=\'none\'">‡∏ï‡∏Å‡∏•‡∏á</button>');
        
        let hr = new Date().getHours(); let defMeal = '‡πÄ‡∏ä‡πâ‡∏≤'; if(hr>=11&&hr<14)defMeal='‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏á'; else if(hr>=14)defMeal='‡πÄ‡∏¢‡πá‡∏ô';
        showMissingModal('‡∏ó‡∏≤‡∏ô‡∏°‡∏∑‡πâ‡∏≠‡πÑ‡∏´‡∏ô‡∏Ñ‡∏∞?', `${getChipsHTML('sec-meal', ['‡πÄ‡∏ä‡πâ‡∏≤','‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏á','‡πÄ‡∏¢‡πá‡∏ô','‡∏ß‡πà‡∏≤‡∏á'], defMeal)}<button class="btn" style="margin-top:15px;" onclick="finalizeFoodManual('${encodeURIComponent(JSON.stringify(items))}', $('#val-sec-meal').value)">‡πÉ‡∏´‡πâ AI ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå ü§ñ</button>`);
    }

    window.finalizeFoodManual = async function(encodedItems, meal) {
        $('#secondary-modal').style.display='none'; $('#primary-modal').style.display='none';
        let itemsArr = JSON.parse(decodeURIComponent(encodedItems));
        await showLoading(true);
        const res = await apiPost('evaluateFoodText', { items: itemsArr, nutritionCtx: window.currentNutritionProfile, mealType: meal });
        let aiResults = res.results || [];
        for (let i = 0; i < itemsArr.length; i++) {
            let item = itemsArr[i]; let evalData = aiResults[i] || { isValid: true, advice: '-' };
            if (evalData.isValid === false) { showLoading(false); return swalAlert.fire('‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö', evalData.reason, 'warning'); }
            const img = (i === 0) ? (window.lastUploadedImageUrl || '') : ''; 
            await apiPost('logEvent', { userId: liffProfile.userId, type: 'FOOD', subtype: `‡∏°‡∏∑‡πâ‡∏≠${meal}`, vt: item.name, v1: item.qty, unit: item.unit, img: img, predefinedFlag: evalData.advice });
        }
        showLoading(false); closeAllModals(); fetchUserProfile();
        
        let adviceHtml = aiResults.map((r, i) => `<div style="margin-bottom:10px; border-bottom:1px dashed #CCC; padding-bottom:5px;"><b>${itemsArr[i].name}</b>: <span style="font-weight:400;">${r.advice}</span></div>`).join('');
        let imgTag = window.lastUploadedImageUrl ? `<img src="${window.lastUploadedImageUrl}" style="width:100%; border-radius:15px; margin-bottom:15px; max-height:200px; object-fit:cover;">` : '';
        
        swalForm.fire({ title: '‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏≠‡∏≤‡∏´‡∏≤‡∏£ üç≤', html: `${imgTag}<div style="text-align:left; font-size:24px; font-weight:bold; line-height:1.4;">${adviceHtml}</div>`, confirmButtonText: '‡∏£‡∏±‡∏ö‡∏ó‡∏£‡∏≤‡∏ö ‚úÖ' });
        window.lastUploadedImageUrl = ''; 
    }

    function showMissingModal(askText, bodyHtml) { $('#sec-ask').innerHTML = askText; $('#sec-body').innerHTML = bodyHtml; $('#secondary-modal').style.display = 'flex'; }
    async function doSave(type, subtype, v1, v2, vt, unit) { await showLoading(true); await apiPost('logEvent', { userId: liffProfile.userId, type, subtype, v1, v2, vt, unit }); showLoading(false); closeAllModals(); fetchUserProfile(); swalSuccess.fire({ title: '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢', timer: 1500, showConfirmButton: false }); }
    async function doSaveMed(medName, changeType, currRegimen, dateStr) { await showLoading(true); await apiPost('logMedication', { userId: liffProfile.userId, medName: medName, changeType: changeType, actionDate: dateStr, currentRegimen: currRegimen }); showLoading(false); closeAllModals(); fetchUserProfile(); swalSuccess.fire({ title: '‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏¢‡∏≤‡πÅ‡∏•‡πâ‡∏ß', timer: 1500, showConfirmButton: false }); }
    async function askAdverseAfterSave() { const res = await swalForm.fire({ title: '‡∏°‡∏µ‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡∏ú‡∏¥‡∏î‡∏õ‡∏Å‡∏ï‡∏¥‡πÑ‡∏´‡∏°‡∏Ñ‡∏∞?', showCancelButton: true, confirmButtonText: '‡∏°‡∏µ‡∏≠‡∏≤‡∏Å‡∏≤‡∏£', cancelButtonText: '‡πÑ‡∏°‡πà‡∏°‡∏µ (‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô)' }); if(res.isConfirmed) openNoteForm('ADVERSE'); }

    // --- UPLOAD PROFILE PIC ---
    async function uploadProfilePic(input) {
      if (!input.files || !input.files[0]) return;
      await showLoading(true);
      try {
        const reader = new FileReader(); reader.readAsDataURL(input.files[0]);
        reader.onload = async (e) => {
            const img = new Image(); img.src = e.target.result;
            img.onload = async () => {
                const canvas = document.createElement('canvas'); let w = img.width, h = img.height, max = 256; 
                if (w > h) { if (w > max) { h *= max / w; w = max; } } else { if (h > max) { w *= max / h; h = max; } }
                canvas.width = w; canvas.height = h; canvas.getContext('2d').drawImage(img, 0, 0, w, h);
                const base64 = canvas.toDataURL('image/jpeg', 0.6).split(',')[1];
                const res = await apiPost('uploadProfileImage', { userId: liffProfile.userId, imageBase64: base64 });
                const headAvatar = $('#head-avatar'); if(res.ok && headAvatar) { headAvatar.src = getImageUrl(res.url); }
                showLoading(false);
            };
        };
      } catch(err) { showLoading(false); }
    }

    // --- EDIT PROFILE ---
    function openEditProfile() {
        if(window.currentProfile) { $('#edit-name').value = window.currentProfile.NameUse || ''; $('#edit-age').value = window.currentProfile.Age || ''; $('#edit-weight').value = window.currentProfile.Weight || ''; $('#edit-job').value = window.currentProfile.Job || ''; }
        $('#edit-profile-modal').style.display = 'flex';
    }
    async function submitEditProfile(e) { e.preventDefault(); await showLoading(true); const payload = { userId: liffProfile.userId, nameUse: $('#edit-name').value.trim(), age: $('#edit-age').value.trim(), weight: $('#edit-weight').value.trim(), job: $('#edit-job').value.trim() }; await apiPost('updateProfile', payload); showLoading(false); closeAllModals(); swalSuccess.fire({title: '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢', text: '‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÅ‡∏•‡πâ‡∏ß', timer: 1500, showConfirmButton: false}); fetchUserProfile(); }

    // --- HISTORY & CALENDAR ---
    function openHistory() { $('#main-content').style.display = 'none'; $('#history-view').style.display = 'block'; }
    function openCalendar() { $('#history-view').style.display = 'none'; $('#calendar-view').style.display = 'block'; calMonthOffset = 0; renderCalendar(); }
    function changeMonth(offset) { calMonthOffset += offset; renderCalendar(); }

    function renderCalendar() {
        let date = new Date(); date.setMonth(date.getMonth() + calMonthOffset); let month = date.getMonth(); let year = date.getFullYear();
        const monthNames = ["‡∏°‡∏Å‡∏£‡∏≤‡∏Ñ‡∏°","‡∏Å‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡πå","‡∏°‡∏µ‡∏ô‡∏≤‡∏Ñ‡∏°","‡πÄ‡∏°‡∏©‡∏≤‡∏¢‡∏ô","‡∏û‡∏§‡∏©‡∏†‡∏≤‡∏Ñ‡∏°","‡∏°‡∏¥‡∏ñ‡∏∏‡∏ô‡∏≤‡∏¢‡∏ô","‡∏Å‡∏£‡∏Å‡∏é‡∏≤‡∏Ñ‡∏°","‡∏™‡∏¥‡∏á‡∏´‡∏≤‡∏Ñ‡∏°","‡∏Å‡∏±‡∏ô‡∏¢‡∏≤‡∏¢‡∏ô","‡∏ï‡∏∏‡∏•‡∏≤‡∏Ñ‡∏°","‡∏û‡∏§‡∏®‡∏à‡∏¥‡∏Å‡∏≤‡∏¢‡∏ô","‡∏ò‡∏±‡∏ô‡∏ß‡∏≤‡∏Ñ‡∏°"];
        $('#cal-month-title').innerText = `${monthNames[month]} ${year+543}`;
        let firstDay = new Date(year, month, 1).getDay(); let daysInMonth = new Date(year, month+1, 0).getDate();
        let html = ''; for(let i=0; i<firstDay; i++) html += `<div></div>`;
        for(let d=1; d<=daysInMonth; d++) {
            let chkDate = new Date(year, month, d).toLocaleDateString('th-TH'); let hasData = false; let hasRisk = false;
            window.appEvents.forEach(e => { if(new Date(e.ts).toLocaleDateString('th-TH') === chkDate) { hasData = true; if(e.flag === 'HIGH' || e.flag === 'LOW') hasRisk = true; } });
            let cClass = 'cal-date'; if(hasRisk) cClass += ' has-risk'; else if(hasData) cClass += ' has-data';
            html += `<div class="${cClass}" onclick="if(${hasData}) showHistoryForDate('${chkDate}')">${d}</div>`;
        }
        $('#cal-grid-body').innerHTML = html;
    }
    window.showHistoryForDate = function(dateStr) { $('#calendar-view').style.display = 'none'; $('#history-view').style.display = 'block'; swalSuccess.fire({title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà', text: dateStr, timer:1500, showConfirmButton:false}); }

    // --- EDIT HISTORY ROW ---
    async function openEditHistoryView() {
        $('#history-view').style.display = 'none'; $('#edit-history-view').style.display = 'block';
        await showLoading(true);
        const res = await apiPost('getEventLog', { userId: liffProfile.userId });
        showLoading(false);
        if(res && res.ok && res.events) {
            let html = '';
            res.events.forEach(e => {
                let d = new Date(e.ts).toLocaleDateString('th-TH', {day:'numeric', month:'short', hour:'2-digit', minute:'2-digit'});
                html += `<div style="background:#FFF; padding:10px; border-radius:15px; border:1px solid #D7CCC8; display:flex; justify-content:space-between; align-items:center;">
                            <div><div style="font-size:12px; color:#888;">${d}</div><div style="font-weight:700; color:#3E2723;">${translateEventType(e.type, e.subtype)}</div><div style="font-size:14px; color:#5D4037;">${e.v1||''} ${e.v2 ? '/ '+e.v2 : ''} ${e.vt||''} ${e.unit||''}</div></div>
                            <button onclick="editEventRow(${e.rowIndex}, '${e.type}', '${e.subtype}', '${e.v1}', '${e.v2}', '${e.vt}', '${e.unit}')" style="background:#FF9100; color:#FFF; border:none; border-radius:10px; padding:5px 10px; font-weight:700; cursor:pointer;">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
                         </div>`;
            });
            $('#edit-history-list').innerHTML = html;
        }
    }

    async function editEventRow(rowIndex, type, subtype, v1, v2, vt, unit) {
        const { value: formValues } = await swalForm.fire({
            title: '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•',
            html: `
                <input id="swal-ev-v1" class="swal2-input main-input-anim" value="${v1 !== 'null' ? v1 : ''}" placeholder="‡∏Ñ‡πà‡∏≤‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç 1">
                <input id="swal-ev-v2" class="swal2-input" value="${v2 !== 'null' ? v2 : ''}" placeholder="‡∏Ñ‡πà‡∏≤‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç 2 (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)">
                <input id="swal-ev-vt" class="swal2-input" value="${vt !== 'null' ? vt : ''}" placeholder="‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)">
                <input id="swal-ev-unit" class="swal2-input" value="${unit !== 'null' ? unit : ''}" placeholder="‡∏´‡∏ô‡πà‡∏ß‡∏¢">
                <input id="swal-ev-sub" class="swal2-input" value="${subtype !== 'null' ? subtype : ''}" placeholder="‡∏ä‡∏ô‡∏¥‡∏î/‡πÄ‡∏ß‡∏•‡∏≤ (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)">
            `,
            focusConfirm: false,
            showCancelButton: true,
            confirmButtonText: '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å',
            preConfirm: () => {
                return {
                    v1: document.getElementById('swal-ev-v1').value,
                    v2: document.getElementById('swal-ev-v2').value,
                    vt: document.getElementById('swal-ev-vt').value,
                    unit: document.getElementById('swal-ev-unit').value,
                    subtype: document.getElementById('swal-ev-sub').value
                }
            }
        });

        if (formValues) {
            await showLoading(true);
            await apiPost('updateEventLog', { userId: liffProfile.userId, rowIndex: rowIndex, ...formValues });
            showLoading(false);
            swalSuccess.fire({title: '‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢', timer: 1500, showConfirmButton: false});
            openEditHistoryView(); // ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£
        }
    }

    function renderDashboard(eventsData) {
        const container = $('#history-container'); if(container) container.innerHTML = '';
        let allEvents = []; if(eventsData) Object.values(eventsData).flat().forEach(e => { if(e && e.event_type) allEvents.push(e); });
        window.appEvents = allEvents; 
        if (allEvents.length === 0) { if(container) container.innerHTML = '<div style="text-align:center; margin-top:50px;">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏∞</div>'; return; }
        allEvents.sort((a,b) => new Date(b.ts) - new Date(a.ts)); 

        const groups = {};
        allEvents.forEach(e => {
            const d = new Date(e.ts); const dateStr = d.toLocaleDateString('th-TH', {day:'numeric', month:'short', year:'2-digit'}); const hour = d.getHours();
            let period = '‡∏≠‡∏∑‡πà‡∏ô‡πÜ'; if(hour>=5 && hour<11) period='‡πÄ‡∏ä‡πâ‡∏≤'; else if(hour>=11 && hour<14) period='‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏á'; else if(hour>=14 && hour<22) period='‡πÄ‡∏¢‡πá‡∏ô';
            const key = `${dateStr} ${period}`; if(!groups[key]) groups[key] = []; groups[key].push(e);
        });

        if(container) {
            for(let key in groups) {
                let hasRisk = groups[key].some(e => e.flag === 'HIGH' || e.flag === 'LOW');
                let img = groups[key].find(e => e.img);
                let html = `<div class="hist-card-flex ${hasRisk ? 'risk' : ''}"><div class="hist-date-badge">${key}</div><div class="hist-left">${img ? `<img src="${getImageUrl(img.img)}">` : ''}</div><div class="hist-right">`;
                
                let lastType = '';
                groups[key].forEach(e => {
                    let alert = ''; if(e.flag==='HIGH') alert=`<span class="alert-badge high">‚ö†Ô∏è ‡∏™‡∏π‡∏á‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ</span>`; else if(e.flag==='LOW') alert=`<span class="alert-badge low">‚ö†Ô∏è ‡∏ï‡πà‡∏≥‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ</span>`;
                    if(e.event_type === 'FOOD') {
                        html += `<div class="hist-food-title">${e.vt} <span style="font-weight:400; font-size:16px;">${e.v1||''} ${e.unit||''}</span></div>`;
                        if(e.flag && e.flag !== 'NORMAL') html += `<div class="hist-food-advice">${e.flag}</div>`;
                    } else {
                        if(lastType && lastType !== e.event_type && lastType !== 'FOOD') html += `<div class="divider-dashed"></div>`;
                        let tText = translateEventType(e.event_type, e.subtype);
                        let vText = e.v1 ? `${e.v1} ${e.v2 ? '/ '+e.v2 : ''}` : '';
                        let extText = e.event_type !== 'SBGM' && e.event_type !== 'BP' && e.vt ? e.vt : '';
                        html += `<div class="hist-val-row">${tText} <span class="hist-val-bold">${vText}</span> <span style="font-size:14px;">${e.unit||''}</span> ${extText} ${alert}</div>`;
                    }
                    lastType = e.event_type;
                });
                html += `</div></div>`; container.innerHTML += html;
            }
        }
    }

    async function apiPost(action, payload) { try { const res = await fetch(GAS_URL, { method: 'POST', body: JSON.stringify({ action, payload }) }); const data = await res.json(); if (action === 'getDashboard') renderDashboard(data.events); return data; } catch(e) { return { ok: false }; } }

    async function fetchUserProfile() {
        const res = await apiPost('getDashboard', { userId: liffProfile.userId });
        const nutriRes = await apiPost('getNutritionProfile', { userId: liffProfile.userId });
        if(nutriRes && nutriRes.profile) { window.currentNutritionProfile = nutriRes.profile; }

        if (res && res.isRegistered === false) { const regView = $('#register-view'); const mainContent = $('#main-content'); if(regView) regView.style.display = 'block'; if(mainContent) mainContent.style.display = 'none'; return; } 
        
        if (res && res.profile) {
            window.currentProfile = res.profile; userDisplayName = res.profile.NameUse || liffProfile.displayName;
            window.currentMedList = res.meds || []; 

            const mainProfileHeader = $('#main-profile-header'); if(mainProfileHeader) mainProfileHeader.style.display = 'flex';
            const headAvatar = $('#head-avatar'); if(headAvatar) headAvatar.src = getImageUrl(res.profile.PicUrl || liffProfile.pictureUrl);
            const headName = $('#head-name'); if(headName) headName.innerText = `‡∏Ñ‡∏∏‡∏ì${userDisplayName}`;
            
            if(res.profile.StartDate && res.profile.EndDate) {
                const start = new Date(res.profile.StartDate); const end = new Date(res.profile.EndDate); const today = new Date();
                const diffTime = Math.abs(end - today); const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                const headStart = $('#head-start'); if(headStart) headStart.innerText = `‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÄ‡∏°‡∏∑‡πà‡∏≠ : ${start.toLocaleDateString('th-TH', {day:'numeric', month:'short', year:'2-digit'})}`;
                const headTarget = $('#head-target'); if(headTarget) headTarget.innerText = (today <= end) ? `‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏≠‡∏µ‡∏Å ${diffDays} ‡∏ß‡∏±‡∏ô‡∏à‡∏∞‡∏ñ‡∏∂‡∏á‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢` : 'üéâ ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡∏î‡πâ‡∏≤‡∏ô‡πÄ‡∏ß‡∏•‡∏≤‡πÅ‡∏•‡πâ‡∏ß!';
            }

            let initW = parseFloat(res.profile.Weight) || 0;
            if(initW > 0) {
                let latestW = res.events && res.events.find(e => e.event_type === 'WEIGHT') ? parseFloat(res.events.find(e => e.event_type === 'WEIGHT').v1) : initW;
                let remainingLoss = (initW * 0.10) - (initW - latestW);
                const headWeightTarget = $('#head-weight-target');
                if(headWeightTarget) { headWeightTarget.style.display = 'inline-block'; headWeightTarget.innerText = remainingLoss > 0 ? `‡∏ï‡πâ‡∏≠‡∏á‡∏•‡∏î‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡∏≠‡∏µ‡∏Å ${remainingLoss.toFixed(1)} ‡∏Å‡∏¥‡πÇ‡∏•‡∏Å‡∏£‡∏±‡∏° ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏û‡∏¥‡∏ä‡∏¥‡∏ï‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢` : `üéâ ‡∏•‡∏î‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡πÑ‡∏î‡πâ 10% ‡∏ï‡∏≤‡∏°‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß`; }
            }

            if(res.stats) {
                const statSbgm = $('#stat-sbgm'); if(statSbgm) statSbgm.innerText = res.stats.sbgmCount || 0;
                const statFood = $('#stat-food'); if(statFood) statFood.innerText = res.stats.foodCount || 0;
                const headMedStat = $('#head-med-stat');
                if(res.stats.activeMedsCount !== undefined && headMedStat) {
                    headMedStat.style.display = 'inline-block';
                    if(res.stats.activeMedsCount > 0) headMedStat.innerText = `‡∏¢‡∏≤‡πÄ‡∏ö‡∏≤‡∏´‡∏ß‡∏≤‡∏ô ${res.stats.activeMedsCount} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`; else headMedStat.innerText = `‡∏´‡∏¢‡∏∏‡∏î‡∏¢‡∏≤‡πÑ‡∏î‡πâ ${res.stats.stoppedDays || 0} ‡∏ß‡∏±‡∏ô`;
                }
            }
            
            if(res.events) {
                let totalEx = 0; res.events.forEach(e => { if(e.event_type === 'EXERCISE' && !isNaN(parseFloat(e.v1))) totalEx += parseFloat(e.v1); });
                const statEx = $('#stat-ex'); if(statEx) statEx.innerText = totalEx;
            }
            
            let st = res.profile.Status || 'Waiting'; const reportStatus = $('#report-status');
            if (reportStatus) { reportStatus.className = 'status-badge ' + (st==='Hypoglycemia Alert'?'status-hypo':st==='Hyperglycemia'?'status-hyper':st==='Monitor'?'status-monitor':st==='Stable'?'status-stable':'status-waiting'); reportStatus.innerText = st; }
        }
    }
    
    // Report Graph
    function openReport() {
        if (!window.appEvents || window.appEvents.length === 0) return swalForm.fire('‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•', '‡∏ï‡πâ‡∏≠‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡πà‡∏≠‡∏ô‡∏Ñ‡πà‡∏∞', 'info');
        $('#main-content').style.display = 'none';
        const reportModal = document.getElementById('report-modal'); if(reportModal) reportModal.style.display = 'flex';
        
        let sbgmEvents = window.appEvents.filter(e => e.event_type === 'SBGM').sort((a,b) => new Date(a.ts) - new Date(b.ts)); 
        const repHigh = $('#rep-high'); if(repHigh) repHigh.innerText = sbgmEvents.filter(e => e.flag === 'HIGH').length;
        const repLow = $('#rep-low'); if(repLow) repLow.innerText = sbgmEvents.filter(e => e.flag === 'LOW').length;
        
        let labels = []; let dataBefore = []; let dataAfter = []; let dataSys = []; let dataDia = []; let dataWeight = []; let dataWaist = [];
        window.appEvents.forEach(e => { let d = new Date(e.ts); let dateStr = `${d.getDate()}/${d.getMonth()+1}`; if (!labels.includes(dateStr)) labels.push(dateStr); });
        labels.sort((a,b) => { let [da, ma] = a.split('/'); let [db, mb] = b.split('/'); return new Date(2000, parseInt(ma)-1, parseInt(da)) - new Date(2000, parseInt(mb)-1, parseInt(db)); });

        labels.forEach(l => {
            let evs = window.appEvents.filter(e => `${new Date(e.ts).getDate()}/${new Date(e.ts).getMonth()+1}` === l);
            let bEvs = evs.filter(e => e.event_type === 'SBGM' && e.subtype === '‡∏Å‡πà‡∏≠‡∏ô‡∏≠‡∏≤‡∏´‡∏≤‡∏£'); let aEvs = evs.filter(e => e.event_type === 'SBGM' && e.subtype === '‡∏´‡∏•‡∏±‡∏á‡∏≠‡∏≤‡∏´‡∏≤‡∏£');
            dataBefore.push(bEvs.length > 0 ? parseFloat(bEvs[bEvs.length-1].v1) : null); dataAfter.push(aEvs.length > 0 ? parseFloat(aEvs[aEvs.length-1].v1) : null);

            let bpEvs = evs.filter(e => e.event_type === 'BP');
            dataSys.push(bpEvs.length > 0 ? parseFloat(bpEvs[bpEvs.length-1].v1) : null); dataDia.push(bpEvs.length > 0 ? parseFloat(bpEvs[bpEvs.length-1].v2) : null);

            let wEvs = evs.filter(e => e.event_type === 'WEIGHT'); let waEvs = evs.filter(e => e.event_type === 'WAIST');
            dataWeight.push(wEvs.length > 0 ? parseFloat(wEvs[wEvs.length-1].v1) : null); dataWaist.push(waEvs.length > 0 ? parseFloat(waEvs[waEvs.length-1].v1) : null);
        });

        let advEvents = window.appEvents.filter(e => e.event_type === 'ADVERSE').sort((a,b) => new Date(b.ts) - new Date(a.ts));
        let advHtml = advEvents.map(e => `<div style="background:#FFEBEE; padding:10px; border-radius:10px; margin-bottom:5px; border:1px solid #EF9A9A; color:#B71C1C; font-size:14px; text-align:left;"><b>${new Date(e.ts).toLocaleDateString('th-TH', {day:'numeric', month:'short'})}:</b> ${e.vt}</div>`).join('');
        const advListEl = $('#rep-adverse-list'); if(advListEl) advListEl.innerHTML = advHtml || '<div style="color:#888; font-size:14px; text-align:center;">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡∏ú‡∏¥‡∏î‡∏õ‡∏Å‡∏ï‡∏¥</div>';
        
        setTimeout(() => {
            const chartCanvas1 = document.getElementById('sbgmChart'); if (sbgmChartInst) sbgmChartInst.destroy();
            if (chartCanvas1) { sbgmChartInst = new Chart(chartCanvas1.getContext('2d'), { type: 'line', data: { labels: labels, datasets: [{label: '‡∏Å‡πà‡∏≠‡∏ô‡∏≠‡∏≤‡∏´‡∏≤‡∏£', data: dataBefore, borderColor: '#2E7D32', backgroundColor: '#2E7D32', spanGaps: true}, {label: '‡∏´‡∏•‡∏±‡∏á‡∏≠‡∏≤‡∏´‡∏≤‡∏£', data: dataAfter, borderColor: '#D84315', backgroundColor: '#D84315', spanGaps: true}] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'top', labels: {font:{family:'Mali'}} } } } }); }

            const chartCanvas2 = document.getElementById('bpChart'); if (bpChartInst) bpChartInst.destroy();
            if (chartCanvas2) { bpChartInst = new Chart(chartCanvas2.getContext('2d'), { type: 'line', data: { labels: labels, datasets: [{label: '‡∏ï‡∏±‡∏ß‡∏ö‡∏ô (SYS)', data: dataSys, borderColor: '#C62828', backgroundColor: '#C62828', spanGaps: true}, {label: '‡∏ï‡∏±‡∏ß‡∏•‡πà‡∏≤‡∏á (DIA)', data: dataDia, borderColor: '#1565C0', backgroundColor: '#1565C0', spanGaps: true}] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'top', labels: {font:{family:'Mali'}} } } } }); }

            const chartCanvas3 = document.getElementById('weightWaistChart'); if (wwChartInst) wwChartInst.destroy();
            if (chartCanvas3) { wwChartInst = new Chart(chartCanvas3.getContext('2d'), { type: 'line', data: { labels: labels, datasets: [{label: '‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å (‡∏Å‡∏Å.)', data: dataWeight, borderColor: '#6A1B9A', backgroundColor: '#6A1B9A', spanGaps: true}, {label: '‡∏£‡∏≠‡∏ö‡πÄ‡∏≠‡∏ß (‡∏ã‡∏°.)', data: dataWaist, borderColor: '#00838F', backgroundColor: '#00838F', spanGaps: true}] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'top', labels: {font:{family:'Mali'}} } } } }); }
        }, 100);
    }

    window.addEventListener('load', main);
</script>
</body>
</html>