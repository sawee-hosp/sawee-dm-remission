<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"/>
  <title>‡∏™‡∏ß‡∏µ‡∏Ñ‡∏∏‡∏°‡∏´‡∏ß‡∏≤‡∏ô ‚Ä¢ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ú‡∏•</title>

  <!-- Google Fonts: Mali (‡∏ô‡πà‡∏≤‡∏£‡∏±‡∏Å ‡∏≠‡πà‡∏≤‡∏ô‡∏á‡πà‡∏≤‡∏¢) -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Mali:wght@400;500;600;700&display=swap" rel="stylesheet">

  <!-- Libraries -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script> 

  <style>
    /* --- CORE VARIABLES --- */
    :root{
      --bg: #fffbf0; 
      --card: #ffffff; 
      --ink: #4E342E; 
      --muted: #8D6E63; 
      
      --brand: #f39c12; 
      --brand-dark: #d35400;

      /* Modal Theme */
      --modal-bg: #5D4037; 
      --modal-text: #FFFFFF;
      --modal-highlight: #FFD54F;
      
      --shadow: 0 8px 20px rgba(0,0,0,0.15);
      --radius: 24px;
      
      --font-main: 'Mali', cursive; 
    }

    /* --- GLOBAL STYLES --- */
    *{ box-sizing:border-box; }
    html,body { height:100%; scroll-behavior: smooth; }
    
    body, button, input, select, textarea, .swal2-popup, .swal2-title, .swal2-html-container { 
      margin:0; padding:0; 
      background:var(--bg); 
      font-family: var(--font-main) !important; 
      color:var(--ink); 
      font-size:18px; 
      -webkit-tap-highlight-color: transparent; 
    }
    
    h1, h2, h3, h4 { margin: 0 0 10px 0; font-weight: 700; }
    
    /* Inputs */
    input, select, textarea { 
      width: 100%; padding: 12px; font-size: 32px; 
      border: 3px solid #ddd; border-radius: 20px; background: #fff; 
      transition: 0.3s; color: #333; text-align: center;
      margin-bottom: 8px;
      font-weight: 600;
    }
    input::placeholder { color: #ccc; font-size: 24px; font-family: var(--font-main); }
    input:focus, textarea:focus { border-color: var(--brand); outline: none; box-shadow: 0 0 0 5px rgba(243, 156, 18, 0.2); }
    
    /* Buttons */
    .btn { 
      border: none; outline: none; background: linear-gradient(135deg, #f1c40f, #e67e22); 
      color: #fff; padding: 15px 24px; border-radius: 50px; font-size: 26px; font-weight: 700; 
      width: 100%; cursor: pointer; transition: 0.2s; box-shadow: 0 4px 10px rgba(0,0,0,0.15); 
      display: flex; align-items: center; justify-content: center; gap: 10px;
      text-shadow: 1px 1px 2px rgba(0,0,0,0.1);
    }
    .btn:active { transform: scale(0.96); box-shadow: none; }
    
    .btn-close { 
        background: #FFCDD2; color: #c62828; 
        width: auto; font-size: 20px; padding: 8px 20px; 
        border-radius: 30px; border:none; font-weight:700;
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    .btn-small { padding: 4px 12px; font-size: 16px; border-radius: 20px; width: auto; margin: 2px; border:none; color:white; cursor: pointer; background: #d32f2f;}
    
    /* Navbar */
    .navbar{ background: #fff; padding: 12px 16px; box-shadow: 0 4px 20px rgba(0,0,0,0.05); display: flex; align-items: center; justify-content: space-between; position: sticky; top: 0; z-index: 100; }
    .nav-brand{ display: flex; align-items: center; gap: 8px; font-weight: 700; font-size: 22px; color: var(--brand-dark); }
    
    /* Containers */
    .container{ max-width: 800px; margin: 0 auto; padding: 16px; padding-bottom: 100px; }
    .card { background: var(--card); border-radius: var(--radius); padding: 20px; margin-bottom: 20px; box-shadow: var(--shadow); border: 2px solid #fff; }
    
    /* --- NOTE GRID UI (Fixed Layout) --- */
    .note-grid { 
      display: grid; 
      grid-template-columns: repeat(3, 1fr); 
      gap: 12px; /* ‡∏ä‡πà‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏á‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏õ‡∏∏‡πà‡∏° */
      margin-top: 15px; 
    }
    
    .note-item { 
      background: #fff; 
      border-radius: 20px; 
      padding: 8px 4px; /* ‡∏•‡∏î padding ‡πÅ‡∏ô‡∏ß‡∏ô‡∏≠‡∏ô ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤ */
      aspect-ratio: 1 / 1.15; /* ‡∏õ‡∏£‡∏±‡∏ö‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô‡πÉ‡∏´‡πâ‡∏™‡∏π‡∏á‡∏Ç‡∏∂‡πâ‡∏ô‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏£‡∏±‡∏ö‡∏ï‡∏±‡∏ß‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠ */
      
      /* Flexbox ‡∏à‡∏±‡∏î‡∏£‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ö‡∏†‡∏≤‡∏¢‡πÉ‡∏ô */
      display: flex; 
      flex-direction: column; 
      justify-content: space-between; /* ‡∏î‡∏±‡∏ô‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô‡∏Ç‡∏∂‡πâ‡∏ô‡∏ö‡∏ô ‡∏ï‡∏±‡∏ß‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡∏•‡∏á‡∏•‡πà‡∏≤‡∏á */
      align-items: center;
      
      box-shadow: 0 6px 12px rgba(0,0,0,0.08); 
      border: 3px solid transparent; 
      cursor: pointer; 
      transition: 0.1s; 
      overflow: hidden;
    }
    
    .note-item:active { 
      transform: scale(0.95); 
      border-color: var(--brand); 
      background: #fff8e1; 
    }
    
    /* Icon Section */
    .note-icon { 
        font-size: 50px; /* ‡πÉ‡∏´‡∏ç‡πà‡πÅ‡∏ï‡πà‡πÑ‡∏°‡πà‡∏•‡πâ‡∏ô */
        line-height: 1; 
        filter: drop-shadow(0 3px 4px rgba(0,0,0,0.15)); 
        flex-grow: 1; /* ‡πÉ‡∏´‡πâ‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô‡∏Å‡∏¥‡∏ô‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏™‡πà‡∏ß‡∏ô‡πÉ‡∏´‡∏ç‡πà */
        display: flex;
        align-items: center; /* ‡∏à‡∏±‡∏î‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô‡∏Å‡∏∂‡πà‡∏á‡∏Å‡∏•‡∏≤‡∏á‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏Ç‡∏≠‡∏á‡∏°‡∏±‡∏ô */
        justify-content: center;
        margin-top: 5px;
    }
    
    /* Label Section */
    .note-label { 
        font-size: 19px; /* ‡πÉ‡∏´‡∏ç‡πà‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô */
        font-weight: 700; 
        line-height: 1.1; 
        color: var(--ink); 
        text-align: center; 
        width: 100%; 
        flex-shrink: 0; /* ‡∏´‡πâ‡∏≤‡∏°‡∏ï‡∏±‡∏ß‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡∏´‡∏î */
        padding-bottom: 5px;
    }
    
    /* Colors */
    .bg-sugar .note-icon { color: #e74c3c; } 
    .bg-bp .note-icon { color: #3498db; } 
    .bg-food .note-icon { color: #27ae60; }
    .bg-weight .note-icon { color: #9b59b6; }
    .bg-ex .note-icon { color: #e67e22; }
    .bg-alert .note-icon { color: #f1c40f; }
    .bg-waist .note-icon { color: #16a085; }
    .bg-hba1c .note-icon { color: #8e44ad; }

    /* Modals (Bottom Sheet) */
    .modal-overlay { 
      position: fixed; inset: 0; 
      background: rgba(0,0,0,0.6); 
      z-index: 2000; 
      display: none; 
      align-items: flex-end; 
      justify-content: center; 
      backdrop-filter: blur(2px);
    }
    
    .modal-sheet { 
      background: var(--modal-bg); 
      color: var(--modal-text); 
      width: 100%; max-width: 600px; 
      border-radius: 30px 30px 0 0; 
      padding: 25px 20px 40px 20px; 
      box-shadow: 0 -10px 40px rgba(0,0,0,0.3); 
      animation: slideUp 0.3s ease-out; 
      display: flex; flex-direction: column; 
      max-height: 85vh; 
      overflow-y: auto;
      
      /* Hide Scrollbar (‡∏•‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ï‡∏≤‡∏•‡∏≤‡∏¢) */
      -ms-overflow-style: none;  /* IE and Edge */
      scrollbar-width: none;  /* Firefox */
    }
    .modal-sheet::-webkit-scrollbar { display: none; /* Chrome, Safari, Opera */ }

    @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
    
    .form-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
    .form-title { 
      font-size: 28px; font-weight: 700; 
      color: var(--modal-highlight); 
      line-height: 1.2;
    }
    
    .form-group { margin-bottom: 25px; }
    .form-label { 
      display: block; font-size: 22px; font-weight: 600; margin-bottom: 10px; 
      color: #fff; text-align: center; text-shadow: 0 2px 4px rgba(0,0,0,0.3);
    }
    
    /* Chip Buttons */
    .chip-container { display: flex; flex-wrap: wrap; gap: 10px; justify-content: center; }
    .chip-btn {
      padding: 10px 18px; font-size: 18px; border-radius: 25px; 
      border: 2px solid #8D6E63; 
      background: #A1887F; 
      color: #fff; 
      font-weight: 600; cursor: pointer; transition: 0.2s;
      flex-grow: 1; text-align: center; max-width: 100%; box-shadow: 0 3px 5px rgba(0,0,0,0.1);
    }
    .chip-btn.active {
      border-color: var(--modal-highlight); 
      background: var(--modal-highlight); 
      color: #4E342E; 
      transform: scale(1.05);
      font-weight: 800;
      box-shadow: 0 0 15px rgba(255, 213, 79, 0.6);
    }

    /* Loading */
    #loading { position: fixed; inset: 0; background: rgba(255,255,255,0.95); display: none; place-items: center; z-index: 9999; flex-direction: column; justify-content: center; gap: 16px;}
    .spinner { width: 60px; height: 60px; border: 6px solid #f3f3f3; border-top: 6px solid var(--brand); border-radius: 50%; animation: spin 1s linear infinite; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

    /* Views */
    .view-section { display: none; }
    .view-section.active { display: block; animation: fadeIn 0.3s; }

    /* --- IMPORTANT: SweetAlert Red & Compact --- */
    div:where(.swal2-container) {
      z-index: 3000 !important; /* ‡∏≠‡∏¢‡∏π‡πà‡πÄ‡∏´‡∏ô‡∏∑‡∏≠‡∏™‡∏∏‡∏î */
    }
    div:where(.swal2-popup) {
      background: #fff !important;
      border-radius: 20px !important;
      padding: 1.5em !important;
      width: 90% !important; /* ‡πÄ‡∏•‡πá‡∏Å‡∏Å‡∏£‡∏∞‡∏£‡∏±‡∏î */
      max-width: 350px !important;
    }
    div:where(.swal2-title) {
      font-size: 26px !important;
      color: #c62828 !important; /* ‡∏™‡∏µ‡πÅ‡∏î‡∏á‡πÄ‡∏Ç‡πâ‡∏° */
      padding: 0 !important;
      margin-bottom: 10px !important;
    }
    div:where(.swal2-html-container) {
      font-size: 22px !important;
      font-weight: 600 !important;
      color: #d32f2f !important; /* ‡∏™‡∏µ‡πÅ‡∏î‡∏á */
      margin: 0 !important;
    }
    div:where(.swal2-actions) {
      margin-top: 20px !important;
    }
    div:where(.swal2-confirm) {
      background-color: #d32f2f !important; /* ‡∏õ‡∏∏‡πà‡∏°‡πÅ‡∏î‡∏á */
      font-size: 20px !important;
      padding: 10px 30px !important;
      border-radius: 30px !important;
    }
    
    /* Success Alert Override */
    .swal2-icon-success + .swal2-title, .swal2-icon-success + .swal2-html-container {
        color: #2e7d32 !important; /* ‡∏™‡∏µ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à */
    }

    /* Dashboard */
    .table-wrap { overflow-x: auto; border: 2px solid #eee; border-radius: 16px; margin-top: 15px; }
    table { width: 100%; border-collapse: collapse; }
    th, td { padding: 14px 10px; text-align: left; border-bottom: 1px solid #eee; font-size: 18px; }
    th { background: #f9f9f9; font-weight: 700; color: #555; }

    .status-bar { 
        background-color: #d32f2f; color: white; 
        text-align: center; padding: 8px; font-size: 14px; font-weight: bold;
        display: none; position: sticky; top:0; z-index: 101;
    }

  </style>
</head>
<body>

  <!-- Loading Screen -->
  <div id="loading">
    <div class="spinner"></div>
    <div style="color:var(--muted); font-weight:700; font-size:24px;">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...</div>
  </div>

  <div id="offline-bar" class="status-bar">‚ö†Ô∏è ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Server ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ (‡πÇ‡∏´‡∏°‡∏î‡∏à‡∏≥‡∏•‡∏≠‡∏á)</div>

  <!-- VIEW 1: Note (Main Menu) -->
  <div id="note-view" class="view-section">
    <nav class="navbar">
      <div class="nav-brand">
        <span>üè° ‡∏™‡∏ß‡∏µ‡∏Ñ‡∏∏‡∏°‡∏´‡∏ß‡∏≤‡∏ô</span>
      </div>
      <button class="btn-close" onclick="liff.closeWindow()">‡∏õ‡∏¥‡∏î</button>
    </nav>

    <div class="container">
      <!-- Greeting (Placeholder for Real Name) -->
      <h2 id="greeting-text" style="text-align:center; color:#5D4037; margin-bottom:20px; font-size: 24px; line-height: 1.4;">
        ‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ‡∏Ñ‡πà‡∏∞<br>‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡∏à‡∏î‡∏≠‡∏∞‡πÑ‡∏£‡∏î‡∏µ‡∏Ñ‡∏∞?
      </h2>
      
      <!-- Grid Buttons (Optimized Layout) -->
      <div class="note-grid">
        <div class="note-item" onclick="openNoteForm('SBGM')">
          <div class="note-icon bg-sugar">ü©∏</div><div class="note-label">‡∏Ñ‡πà‡∏≤‡∏ô‡πâ‡∏≥‡∏ï‡∏≤‡∏•<br>‡πÄ‡∏à‡∏≤‡∏∞‡∏õ‡∏•‡∏≤‡∏¢‡∏ô‡∏¥‡πâ‡∏ß</div>
        </div>
        <div class="note-item" onclick="openNoteForm('BP')">
          <div class="note-icon bg-bp">üíì</div><div class="note-label">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡∏±‡∏ô<br>‡πÇ‡∏•‡∏´‡∏¥‡∏ï</div>
        </div>
        <div class="note-item" onclick="openNoteForm('FOOD')">
          <div class="note-icon bg-food">üçΩÔ∏è</div><div class="note-label">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å<br>‡∏≠‡∏≤‡∏´‡∏≤‡∏£</div>
        </div>
        <div class="note-item" onclick="openNoteForm('WEIGHT')">
          <div class="note-icon bg-weight">‚öñÔ∏è</div><div class="note-label">‡∏ä‡∏±‡πà‡∏á<br>‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å</div>
        </div>
        <div class="note-item" onclick="openNoteForm('EXERCISE')">
          <div class="note-icon bg-ex">üèÉ‚Äç‚ôÄÔ∏è</div><div class="note-label">‡∏≠‡∏≠‡∏Å<br>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Å‡∏≤‡∏¢</div>
        </div>
        <div class="note-item" onclick="openNoteForm('ADVERSE')">
          <div class="note-icon bg-alert">‚ö†Ô∏è</div><div class="note-label">‡∏≠‡∏≤‡∏Å‡∏≤‡∏£<br>‡∏ú‡∏¥‡∏î‡∏õ‡∏Å‡∏ï‡∏¥</div>
        </div>
        <div class="note-item" onclick="openNoteForm('WAIST')">
          <div class="note-icon bg-waist">üìè</div><div class="note-label">‡∏ß‡∏±‡∏î<br>‡∏£‡∏≠‡∏ö‡πÄ‡∏≠‡∏ß</div>
        </div>
        <div class="note-item" onclick="openNoteForm('HBA1C')">
          <div class="note-icon bg-hba1c">üß™</div><div class="note-label">‡∏Ñ‡πà‡∏≤<br>HbA1C</div>
        </div>
      </div>

      <div style="text-align:center; margin-top:40px;">
        <button class="btn" style="background:#fff; border:3px solid #eee; color:#666; width:auto; font-weight:700; padding:12px 30px; box-shadow:none; font-size: 20px;" onclick="loadDashboardData()">
          ‡∏î‡∏π‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á üìà
        </button>
      </div>
    </div>
  </div>

  <!-- VIEW 2: Dashboard -->
  <div id="dashboard-view" class="view-section">
    <nav class="navbar">
      <div class="nav-brand">
        <span>üìà ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û</span>
      </div>
      <button class="btn-close" onclick="switchView('note')">‡∏Å‡∏•‡∏±‡∏ö</button>
    </nav>

    <div class="container">
      <div id="historyCard" class="card">
        <div class="form-header">
          <h2 style="font-size: 22px; color:#333;">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</h2>
        </div>
        
        <div class="filter-controls" id="history-filters">
           <!-- Populated by JS -->
        </div>

        <div class="table-wrap">
          <table id="history-table">
            <thead><tr><th>‡πÄ‡∏ß‡∏•‡∏≤</th><th>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</th><th>‡∏Ñ‡πà‡∏≤</th><th></th></tr></thead>
            <tbody></tbody>
          </table>
        </div>

        <div style="margin-top:30px;">
          <h3 style="font-size: 20px;">üìä ‡∏Å‡∏£‡∏≤‡∏ü‡πÅ‡∏ô‡∏ß‡πÇ‡∏ô‡πâ‡∏°</h3>
          <div id="chartsWrap" style="display: flex; flex-direction: column; gap: 20px;"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- VIEW 3: Registration -->
  <div id="reg-view" class="view-section" style="padding:20px;">
    <div class="card" style="margin-top: 40px; text-align: center;">
      <h2 style="font-size: 28px; color: var(--brand-dark);">‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö‡∏Ñ‡πà‡∏∞</h2>
      <p style="font-size: 20px; color: #666;">‡∏Ç‡∏≠‡∏ó‡∏£‡∏≤‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏¥‡∏î‡∏ô‡∏∂‡∏á‡∏ô‡∏∞‡∏Ñ‡∏∞</p>
      
      <div style="margin-top:20px; text-align: left;">
        <div class="form-group">
          <label class="form-label" style="color:#555; text-align:left;">‡πÄ‡∏•‡∏Ç HN (‡∏î‡∏π‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ï‡∏£ ‡∏£‡∏û.)</label>
          <input id="hn" type="text" placeholder="‡πÄ‡∏•‡∏Ç 9 ‡∏´‡∏•‡∏±‡∏Å">
        </div>
        <div class="form-group">
          <label class="form-label" style="color:#555; text-align:left;">‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô</label>
          <input id="nameuse" type="text" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏õ‡πâ‡∏≤‡πÅ‡∏°‡∏ß">
        </div>
      </div>
      
      <button id="btnSaveReg" class="btn" style="margin-top:20px;">‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô</button>
    </div>
  </div>

  <!-- MODAL: Input Form (Bottom Sheet Style) -->
  <div id="form-modal" class="modal-overlay">
    <div class="modal-sheet">
      <div class="form-header">
        <div class="form-title" id="modal-title">...</div>
        <button class="btn-close" onclick="closeNoteForm()" style="font-size:18px;">‡∏õ‡∏¥‡∏î</button>
      </div>

      <div id="modal-body">
        <!-- Dynamic Content -->
      </div>

      <div style="margin-top: auto; padding-top: 20px;">
        <button id="btn-save-form" class="btn" onclick="submitForm()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ‚úÖ</button>
      </div>
    </div>
  </div>

<script>
    const LIFF_ID = '2007840605-zKl7p3Aa';
    const GAS_URL = 'https://script.google.com/macros/s/AKfycbzvLY5kLKw2sUaSelEZcxka2CsdiRoGdA9jmHMoKs3oB04ypte7yDwStWo6cFwb2-Y8Sw/exec';

    const METRIC_CONFIG = {
      'SBGM': { 
        title: '‡∏Ñ‡πà‡∏≤‡∏ô‡πâ‡∏≥‡∏ï‡∏≤‡∏•‡πÄ‡∏à‡∏≤‡∏∞‡∏õ‡∏•‡∏≤‡∏¢‡∏ô‡∏¥‡πâ‡∏ß ü©∏', unit: 'mg/dL', 
        min: 20, max: 600, // Hard Limit
        soft_min: 60, soft_max: 400, // Soft Limit
        placeholder: '‡πÉ‡∏™‡πà‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç (‡πÄ‡∏ä‡πà‡∏ô 120)', 
        subtypes: ['‡∏Å‡πà‡∏≠‡∏ô‡∏≠‡∏≤‡∏´‡∏≤‡∏£', '‡∏´‡∏•‡∏±‡∏á‡∏≠‡∏≤‡∏´‡∏≤‡∏£', '‡∏Å‡πà‡∏≠‡∏ô‡∏ô‡∏≠‡∏ô'] // Edited list
      },
      'BP': { 
        title: '‡∏ß‡∏±‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡∏±‡∏ô‡πÇ‡∏•‡∏´‡∏¥‡∏ï üíì', unit: 'mmHg', 
        sys_min: 50, sys_max: 250, 
        dia_min: 30, dia_max: 150, 
        soft_sys: 180, soft_dia: 110,
        placeholder_sys: '‡∏ï‡∏±‡∏ß‡∏ö‡∏ô (‡πÄ‡∏ä‡πà‡∏ô 130)', placeholder_dia: '‡∏ï‡∏±‡∏ß‡∏•‡πà‡∏≤‡∏á (‡πÄ‡∏ä‡πà‡∏ô 80)'
      },
      'WEIGHT': { 
        title: '‡∏ä‡∏±‡πà‡∏á‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ ‚öñÔ∏è', unit: '‡∏Å‡∏Å.', 
        min: 20, max: 200, 
        placeholder: '‡∏´‡∏ô‡∏±‡∏Å‡∏Å‡∏µ‡πà‡∏Å‡∏¥‡πÇ‡∏•‡∏Ø ‡∏Ñ‡∏∞' 
      },
      'WAIST': { 
        title: '‡∏ß‡∏±‡∏î‡∏£‡∏≠‡∏ö‡πÄ‡∏≠‡∏ß üìè', unit: '‡∏ã‡∏°.', 
        min: 40, max: 200, 
        placeholder: '‡∏Å‡∏µ‡πà‡πÄ‡∏ã‡∏ô‡∏ï‡∏¥‡πÄ‡∏°‡∏ï‡∏£‡∏Ñ‡∏∞' 
      },
      'EXERCISE': { 
        title: '‡∏≠‡∏≠‡∏Å‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Å‡∏≤‡∏¢ üèÉ‚Äç‚ôÄÔ∏è', unit: '‡∏ô‡∏≤‡∏ó‡∏µ', 
        min: 5, max: 300, 
        placeholder: '‡∏ó‡∏≥‡πÑ‡∏õ‡∏Å‡∏µ‡πà‡∏ô‡∏≤‡∏ó‡∏µ‡∏Ñ‡∏∞',
        subtypes: ['‡πÄ‡∏î‡∏¥‡∏ô‡πÄ‡∏£‡πá‡∏ß', '‡πÅ‡∏Å‡∏ß‡πà‡∏á‡πÅ‡∏Ç‡∏ô', '‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏ö‡πâ‡∏≤‡∏ô', '‡∏õ‡∏±‡πà‡∏ô‡∏à‡∏±‡∏Å‡∏£‡∏¢‡∏≤‡∏ô', '‡πÇ‡∏¢‡∏Ñ‡∏∞/‡∏¢‡∏∑‡∏î‡πÄ‡∏´‡∏¢‡∏µ‡∏¢‡∏î']
      },
      'FOOD': { 
        title: '‡∏à‡∏î‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏≤‡∏´‡∏≤‡∏£ üçΩÔ∏è', unit: '', 
        placeholder: '‡πÄ‡∏ä‡πà‡∏ô ‡∏Ç‡πâ‡∏≤‡∏ß‡∏ï‡πâ‡∏°‡∏õ‡∏•‡∏≤, ‡∏ô‡∏°‡∏à‡∏∑‡∏î 1 ‡∏Å‡∏•‡πà‡∏≠‡∏á',
        subtypes: ['‡∏°‡∏∑‡πâ‡∏≠‡πÄ‡∏ä‡πâ‡∏≤', '‡∏°‡∏∑‡πâ‡∏≠‡∏Å‡∏•‡∏≤‡∏á‡∏ß‡∏±‡∏ô', '‡∏°‡∏∑‡πâ‡∏≠‡πÄ‡∏¢‡πá‡∏ô', '‡∏Ç‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏á']
      },
      'HBA1C': { 
        title: '‡∏Ñ‡πà‡∏≤‡∏ô‡πâ‡∏≥‡∏ï‡∏≤‡∏•‡∏™‡∏∞‡∏™‡∏° (HbA1c) üß™', unit: '%', 
        min: 3, max: 20, 
        placeholder: '‡πÄ‡∏ä‡πà‡∏ô 6.5' 
      },
      'ADVERSE': { 
        title: '‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡∏ú‡∏¥‡∏î‡∏õ‡∏Å‡∏ï‡∏¥ ‚ö†Ô∏è', 
        type: 'select', 
        options: ['‡πÄ‡∏ß‡∏µ‡∏¢‡∏ô‡∏´‡∏±‡∏ß/‡∏´‡∏ô‡πâ‡∏≤‡∏°‡∏∑‡∏î', '‡πÉ‡∏à‡∏™‡∏±‡πà‡∏ô', '‡πÄ‡∏´‡∏á‡∏∑‡πà‡∏≠‡∏≠‡∏≠‡∏Å‡∏ï‡∏±‡∏ß‡πÄ‡∏¢‡πá‡∏ô', '‡∏°‡∏∑‡∏≠‡∏™‡∏±‡πà‡∏ô', '‡∏´‡∏¥‡∏ß‡∏à‡∏±‡∏î', '‡∏Ñ‡∏•‡∏∑‡πà‡∏ô‡πÑ‡∏™‡πâ'] 
      }
    };

    let liffProfile = { userId: "U_GUEST", displayName: "Guest", pictureUrl: "" }; 
    let allEventsData = [];
    let currentMetric = '';
    
    const $ = selector => document.querySelector(selector);
    const fmtDate = (d) => {
        try {
            const date = new Date(d);
            return date.toLocaleDateString('th-TH', { day: 'numeric', month: 'short' }) + ' ' + date.toLocaleTimeString('th-TH', { hour: '2-digit', minute:'2-digit'}) + ' ‡∏ô.';
        } catch(e) { return d; }
    };

    async function main() {
      const loadingEl = $('#loading');
      if(loadingEl) loadingEl.style.display = 'flex';

      try {
        await liff.init({ liffId: LIFF_ID });
        
        if (!liff.isLoggedIn()) {
            liff.login();
            return;
        }

        liffProfile = await liff.getProfile();
        console.log("LIFF Profile:", liffProfile);

        setupGlobalListeners();
        fetchUserProfile();

        const params = new URLSearchParams(window.location.search);
        if (params.get('view') === 'reg') switchView('reg');
        else if (params.get('view') === 'dashboard') await loadDashboardData();
        else switchView('note');

      } catch (err) {
        console.warn("LIFF Init Failed (Offline/Canvas Mode):", err);
        // Fallback for dev mode
        liffProfile = { userId: "U4b2462c3ea87936a546558354070ef4d", displayName: "Dev User", pictureUrl: "" };
        setupGlobalListeners();
        fetchUserProfile();
        switchView('note'); 
      } finally {
        if(loadingEl) loadingEl.style.display = 'none';
      }
    }

    async function fetchUserProfile() {
        try {
            const res = await apiPost('getDashboard', { userId: liffProfile.userId });
            const nameEl = $('#greeting-text');
            if (res && res.profile && res.profile.NameUse) {
                nameEl.innerHTML = `‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ‡∏Ñ‡πà‡∏∞ ‡∏Ñ‡∏∏‡∏ì${res.profile.NameUse}<br>‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡∏à‡∏î‡∏≠‡∏∞‡πÑ‡∏£‡∏î‡∏µ‡∏Ñ‡∏∞?`;
            } else {
                // If no name, keep neutral.
                nameEl.innerHTML = `‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ‡∏Ñ‡πà‡∏∞<br>‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡∏à‡∏î‡∏≠‡∏∞‡πÑ‡∏£‡∏î‡∏µ‡∏Ñ‡∏∞?`;
            }
        } catch (e) { console.log("Profile fetch failed"); }
    }

    function switchView(viewName) {
      document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
      if (viewName === 'note') $('#note-view').classList.add('active');
      else if (viewName === 'dashboard') $('#dashboard-view').classList.add('active');
      else if (viewName === 'reg') $('#reg-view').classList.add('active');
      window.scrollTo(0,0);
    }

    function openNoteForm(metric) {
      currentMetric = metric;
      const conf = METRIC_CONFIG[metric];
      const modalBody = $('#modal-body');
      
      $('#modal-title').innerText = conf.title;

      let html = '';

      if (conf.subtypes) {
        html += `<div class="form-group"><label class="form-label">${metric === 'FOOD' ? '‡∏ó‡∏≤‡∏ô‡∏°‡∏∑‡πâ‡∏≠‡πÑ‡∏´‡∏ô‡∏Ñ‡∏∞?' : '‡∏ß‡∏±‡∏î‡∏ï‡∏≠‡∏ô‡πÑ‡∏´‡∏ô‡∏Ñ‡∏∞?'}</label><div class="chip-container" id="chip-subtype">`;
        conf.subtypes.forEach(s => {
            html += `<button class="chip-btn" onclick="selectOption('subtype', '${s}', this)">${s}</button>`;
        });
        html += `</div><input type="hidden" id="inp-subtype"></div>`;
      }

      if (conf.type === 'select') {
        html += `<div class="form-group"><label class="form-label">‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡πá‡∏ô‡πÅ‡∏ö‡∏ö‡πÑ‡∏´‡∏ô‡∏Ñ‡∏∞?</label><div class="chip-container" id="chip-val1">`;
        conf.options.forEach(o => {
            html += `<button class="chip-btn" onclick="selectOption('val1', '${o}', this)">${o}</button>`;
        });
        html += `</div><input type="hidden" id="inp-val1"></div>`;
      } else if (metric === 'BP') {
        html += `
          <div class="form-group"><label class="form-label">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡∏±‡∏ô‡∏ï‡∏±‡∏ß‡∏ö‡∏ô</label><input type="number" id="inp-val1" placeholder="${conf.placeholder_sys}" inputmode="numeric"></div>
          <div class="form-group"><label class="form-label">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡∏±‡∏ô‡∏ï‡∏±‡∏ß‡∏•‡πà‡∏≤‡∏á</label><input type="number" id="inp-val2" placeholder="${conf.placeholder_dia}" inputmode="numeric"></div>
        `;
      } else if (metric === 'FOOD') {
        html += `<div class="form-group"><label class="form-label">‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ä‡∏∑‡πà‡∏≠‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡πÄ‡∏•‡∏¢‡∏Ñ‡πà‡∏∞</label><textarea id="inp-val1" rows="3" placeholder="${conf.placeholder}"></textarea></div>`;
      } else {
        html += `<div class="form-group"><label class="form-label">‡∏Ñ‡πà‡∏≤‡πÄ‡∏ó‡πà‡∏≤‡πÑ‡∏´‡∏£‡πà‡∏Ñ‡∏∞? (${conf.unit})</label><input type="number" id="inp-val1" placeholder="${conf.placeholder}" inputmode="decimal"></div>`;
      }

      modalBody.innerHTML = html;
      $('#form-modal').style.display = 'flex'; 
    }

    window.selectOption = function(type, value, btn) {
        $(`#inp-${type}`).value = value;
        const container = btn.parentElement;
        container.querySelectorAll('.chip-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
    }

    function closeNoteForm() { $('#form-modal').style.display = 'none'; }

    // Alert Function (Red Text, Compact)
    function alertModal(msg, type = 'warning') {
        Swal.fire({
            icon: type,
            html: msg, 
            confirmButtonText: '‡∏ï‡∏Å‡∏•‡∏á',
            confirmButtonColor: '#d32f2f'
        });
    }

    async function submitForm() {
      const metric = currentMetric;
      const conf = METRIC_CONFIG[metric];
      const elSubtype = $('#inp-subtype');
      const elVal1 = $('#inp-val1');
      const elVal2 = $('#inp-val2');

      // 1. Validation: Subtype
      if (conf.subtypes && (!elSubtype.value)) {
         alertModal(metric === 'FOOD' ? "‡∏•‡∏∑‡∏°‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏°‡∏∑‡πâ‡∏≠‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏Ñ‡πà‡∏∞" : "‡∏ß‡∏±‡∏î‡∏ï‡∏≠‡∏ô‡πÑ‡∏´‡∏ô‡∏Ñ‡∏∞? ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡∏ô‡∏∞");
         return;
      }

      let v1 = elVal1 ? elVal1.value.trim() : null;
      let v2 = elVal2 ? elVal2.value.trim() : null;

      // 2. Validation: Empty
      if (metric === 'BP') {
          if(!v1 || !v2) { alertModal("‡πÉ‡∏™‡πà‡πÄ‡∏•‡∏Ç‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡∏±‡∏ô‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö 2 ‡∏ä‡πà‡∏≠‡∏á‡∏ô‡∏∞‡∏Ñ‡∏∞"); return; }
      } else if (metric === 'FOOD') {
          if(!v1 || v1.length < 2) { alertModal("‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ä‡∏∑‡πà‡∏≠‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡πÉ‡∏´‡πâ‡∏´‡∏ô‡πà‡∏≠‡∏¢‡∏ô‡∏∞‡∏Ñ‡∏∞"); return; }
      } else if (conf.type !== 'select') {
          if(!v1) { alertModal("‡∏•‡∏∑‡∏°‡πÉ‡∏™‡πà‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏õ‡∏•‡πà‡∏≤‡∏Ñ‡∏∞?"); return; }
      } else {
          v1 = $('#inp-val1').value;
          if(!v1) { alertModal("‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡∏Å‡πà‡∏≠‡∏ô‡∏ô‡∏∞‡∏Ñ‡∏∞"); return; }
      }

      // 3. Validation: Range (Friendly Error)
      if (metric === 'SBGM') {
          const val = parseFloat(v1);
          if (val < 20 || val > 900) { alertModal("‡∏Ñ‡πà‡∏≤‡∏™‡∏π‡∏á‡∏´‡∏£‡∏∑‡∏≠‡∏ï‡πà‡∏≥‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ‡∏Ñ‡πà‡∏∞ ‡∏•‡∏≠‡∏á‡πÄ‡∏ä‡πá‡∏Ñ‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏≠‡∏µ‡∏Å‡∏ó‡∏µ‡∏ô‡∏∞‡∏Ñ‡∏∞", 'error'); return; }
      }
      if (metric === 'BP') {
          const s = parseFloat(v1); const d = parseFloat(v2);
          if (s < 50 || s > 300 || d < 30 || d > 200) { alertModal("‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡∏±‡∏ô‡∏î‡∏π‡πÅ‡∏õ‡∏•‡∏Å‡πÜ ‡∏•‡∏≠‡∏á‡πÄ‡∏ä‡πá‡∏Ñ‡∏≠‡∏µ‡∏Å‡∏ó‡∏µ‡∏ô‡∏∞‡∏Ñ‡∏∞", 'error'); return; }
      }

      // 4. Send Data
      const btn = $('#btn-save-form');
      const originalText = btn.innerText;
      btn.innerText = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á...';
      btn.disabled = true;
      
      const payload = {
        userId: liffProfile.userId,
        type: metric,
        timestamp: new Date().toISOString(),
        subtype: elSubtype ? elSubtype.value : '',
        v1: v1, v2: v2
      };

      try {
        await apiPost('logEvent', payload);
        
        closeNoteForm(); 
        
        let successTitle = '';
        if(metric === 'SBGM') successTitle = `‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡πà‡∏≤‡∏ô‡πâ‡∏≥‡∏ï‡∏≤‡∏• ${v1} ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡πà‡∏∞`;
        else if(metric === 'BP') successTitle = `‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡∏±‡∏ô ${v1}/${v2} ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡πà‡∏∞`;
        else successTitle = `‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡πà‡∏∞`;

        await Swal.fire({
          title: '‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‚úÖ',
          text: successTitle,
          icon: 'success',
          confirmButtonText: '‡∏ï‡∏Å‡∏•‡∏á',
          confirmButtonColor: '#2e7d32',
          allowOutsideClick: false
        });

        switchView('note'); 

      } catch (err) {
        alertModal('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏ó‡∏µ‡∏ô‡∏∞‡∏Ñ‡∏∞', 'error');
      } finally {
        btn.innerText = originalText;
        btn.disabled = false;
      }
    }

    async function loadDashboardData() {
      $('#loading').style.display = 'flex';
      try {
        const res = await apiPost('getDashboard', { userId: liffProfile.userId });
        if (!res || !res.profile) { switchView('reg'); return; }
        
        allEventsData = [];
        if (res.events) {
            Object.keys(res.events).forEach(key => {
                res.events[key].forEach(e => { allEventsData.push({ ...e, type: key }); });
            });
        }
        allEventsData.sort((a,b) => new Date(b.timestamp) - new Date(a.timestamp));
        renderHistoryTable();
        switchView('dashboard');
      } catch (e) { alertModal('‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ ‡∏•‡∏≠‡∏á‡πÄ‡∏ä‡πá‡∏Ñ‡πÄ‡∏ô‡πá‡∏ï‡∏ô‡∏∞‡∏Ñ‡∏∞', 'error'); } 
      finally { $('#loading').style.display = 'none'; }
    }

    function renderHistoryTable() {
        const tableBody = $('#history-table tbody');
        const data = allEventsData;
        if (data.length === 0) { 
            tableBody.innerHTML = `<tr><td colspan="4" style="text-align:center; padding:30px; color:#888;">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏∞</td></tr>`; return; 
        }
        tableBody.innerHTML = data.map(e => {
            let valDisplay = e.value_numeric_1;
            if (e.type === 'BP') valDisplay = `${e.value_numeric_1}/${e.value_numeric_2}`;
            if (e.type === 'FOOD') valDisplay = e.value_text;
            const title = METRIC_CONFIG[e.type]?.title.split(' ')[0] || e.type;
            return `<tr>
                    <td style="font-size:16px;">${fmtDate(e.timestamp).split(' ')[0]}<br>${fmtDate(e.timestamp).split(' ')[1]}</td>
                    <td><strong>${title}</strong><br><span style="font-size:14px; color:#666;">${e.event_subtype || ''}</span></td>
                    <td style="font-size:22px; color:#d35400; font-weight:700;">${valDisplay}</td>
                    <td><button class="btn-small danger" onclick="deleteEvent('${e.timestamp}', '${e.type}')">‡∏•‡∏ö</button></td>
                </tr>`;
        }).join('');
    }

    async function deleteEvent(ts, type) {
        const result = await Swal.fire({
            title: '‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ?',
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#d33',
            confirmButtonText: '‡∏•‡∏ö‡πÄ‡∏•‡∏¢',
            cancelButtonText: '‡πÑ‡∏°‡πà‡∏•‡∏ö'
        });
        if (result.isConfirmed) {
            $('#loading').style.display = 'flex';
            try { await apiPost('deleteEvent', { userId: liffProfile.userId, timestamp: ts }); await loadDashboardData(); } 
            catch(e) { alertModal('‡∏•‡∏ö‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏Ñ‡πà‡∏∞', 'error'); }
        }
    }

    async function apiPost(action, payload) {
        const body = JSON.stringify({ action, payload });
        const response = await fetch(GAS_URL, {
            method: 'POST', body: body,
            mode: 'cors', credentials: 'omit', redirect: 'follow',
            headers: { 'Content-Type': 'text/plain;charset=utf-8' }
        });
        if (!response.ok) throw new Error('Server Error');
        const data = await response.json();
        if (data.status === 'error') throw new Error(data.message);
        return data;
    }

    function setupGlobalListeners() {
        $('#btnSaveReg').onclick = async () => {
            const hn = $('#hn').value;
            if(!hn) return alertModal('‡∏•‡∏∑‡∏°‡πÉ‡∏™‡πà‡πÄ‡∏•‡∏Ç HN ‡∏à‡πâ‡∏≤');
            $('#loading').style.display = 'flex';
            await apiPost('registerUser', { userId: liffProfile.userId, hn: hn, name_use: $('#nameuse').value });
            location.reload();
        };
    }

    window.addEventListener('load', main);

</script>
</body>
</html>