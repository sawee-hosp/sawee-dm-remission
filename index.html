<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
  <title>‡∏™‡∏ß‡∏µ‡∏Ñ‡∏∏‡∏°‡∏´‡∏ß‡∏≤‡∏ô ‚Ä¢ DM Remission Dashboard</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Mali:ital,wght@0,200;0,300;0,400;0,500;0,600;0,700;1,200;1,300;1,400;1,500;1,600;1,700&display=swap" rel="stylesheet">

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

  <style>
    :root{
      --bg: #fff7e0; --card: #ffffff; --ink: #3c2e17; --muted: #6f5b2e; --brand: #d59f00;
      --brand2:#f3c200; --ok: #0a9d67; --warn:#d98324; --line:#ead9ad; --shadow: 0 10px 24px rgba(60,46,23,.08);
      --radius-lg: 18px; --radius-md: 14px; --radius-sm: 10px; --gap: 16px; --fs-body: 18px;
      --fs-h1: 28px; --fs-h2: 24px; --fs-h3: 20px; --fs-small: 16px;
    }
    *{box-sizing:border-box}
    html,body{height:100%; scroll-behavior: smooth;}
    body{ margin:0; padding:0; background:var(--bg); font-family:'Mali', system-ui, -apple-system, Segoe UI, Roboto, sans-serif; color:var(--ink); font-size:var(--fs-body); line-height:1.5; }
    button,input,select{font-family:'Mali', system-ui, -apple-system, Segoe UI, Roboto, sans-serif;}
    .navbar{ width:100%; background: linear-gradient(180deg, #fff2c6, #ffeab0); border-bottom: 1px solid #f2dfab; box-shadow: 0 4px 16px rgba(213,159,0,.08); }
    .nav-inner{max-width:1100px;margin:0 auto;padding:14px 16px;display:flex;align-items:center;gap:12px}
    .brand-logo{ width: 100px; height: 100px; border-radius: 0; object-fit: contain; flex: 0 0 auto; }
    .brand-title{font-weight:700;font-size:var(--fs-h1);letter-spacing:.2px}
    .brand-sub{font-size:var(--fs-small);color:var(--muted);margin-top:-4px}
    .container{max-width:1100px;margin:0 auto;padding:16px}
    .card{ background:var(--card);border:1px solid var(--line);border-radius:var(--radius-lg); padding:16px;margin:12px 0;box-shadow:var(--shadow) }
    .card h2{font-size:var(--fs-h2);margin:0 0 12px;display:flex;align-items:center;gap:10px}
    .pill{ display:inline-block;padding:6px 10px;border-radius:999px;background:#fff8d8; border:1px solid #f2dfab;color:#4b3a1a;font-weight:600;font-size:17px }
    .row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
    .muted{color:var(--muted);font-size:var(--fs-small)}
    .btn{ padding:12px 16px;border-radius:12px;border:1px solid #f2dfab; background:linear-gradient(180deg,#ffe38b,#ffd45e); color:#4b3a1a;font-weight:700;font-size:18px;cursor:pointer; box-shadow:0 6px 16px rgba(213,159,0,.18) }
    .btn.danger{ background: linear-gradient(180deg, #ff8b8b, #ff5e5e); color: #fff; border-color: #f2abab; }
    .btn:disabled{opacity:.6;cursor:not-allowed}
    #loading{position:fixed;inset:0;background:rgba(0,0,0,.25);display:grid;place-items:center;z-index:1500}
    #loading .box{background:#fff9e6;border:1px solid #f2dfab;padding:16px 20px;border-radius:14px;box-shadow:var(--shadow)}
    .profile-grid{ display:grid; grid-template-columns: 40% 60%; gap:14px; align-items:center; }
    @media (max-width:700px){ .profile-grid{ grid-template-columns: 1fr; } }
    .profile-left{ display:flex; justify-content:center; align-items:center; }
    .profile-left .avatar{ width: 150px; height: 150px; border-radius: 50%; object-fit: cover; border: 3px solid #f6e3a6; background: #fff; box-shadow: var(--shadow); }
    .carousel{display:flex;gap:14px;overflow-x:auto;padding-bottom:6px;scroll-snap-type:x mandatory}
    .c-item{ flex:0 0 86%;max-width:520px;min-width:320px;scroll-snap-align:start; background:#fff;border:1px solid #f2dfab;border-radius:14px;padding:14px;box-shadow:var(--shadow) }
    table{width:100%;border-collapse:collapse;font-size:17px}
    th,td{border-bottom:1px solid #f2dfab;padding:10px 8px;text-align:left;vertical-align:top}
    th{background:#fff7d2}
    .table-wrap.max5{ max-height:320px; overflow:auto; }
    label{font-size:18px;font-weight:600;display:block;margin:10px 0 6px}
    input, select{ width:100%;padding:14px 16px;border:1px solid #e8d494;border-radius:12px;background:#fff; font-size:18px;color:var(--ink) }
    .grid{display:grid;gap:14px;grid-template-columns:repeat(2,minmax(0,1fr))}
    @media (max-width:820px){.grid{grid-template-columns:1fr}}
    
    /* --- NEW UI --- */
    .menu-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 14px; margin: 16px 0; }
    .menu-btn { display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 8px; padding: 20px 10px; background: #fff; border: 1px solid var(--line); border-radius: var(--radius-lg); box-shadow: var(--shadow); cursor: pointer; text-align: center; font-size: 17px; font-weight: 600; color: var(--ink); }
    .menu-btn svg { width: 40px; height: 40px; color: var(--brand); }
    .content-card { display: none; }
    .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
    .btn-close { font-size: 16px; padding: 8px 12px; background: #f0f0f0; border-color: #ddd; color: #555; box-shadow: none; }

    /* --- SINGLE EVENT VIEW --- */
    #single-event-view .card { border: 2px solid var(--brand); }
    #single-event-view .data-point { margin: 8px 0; font-size: 18px; }
    #single-event-view .data-point .label { font-weight: 600; color: var(--muted); min-width: 100px; display: inline-block; }
    #confirm-dialog { position: fixed; inset: 0; background: rgba(0,0,0,.5); display: none; place-items: center; z-index: 2000; padding: 16px; }
    #confirm-dialog .panel { background: var(--card); padding: 20px; border-radius: var(--radius-lg); text-align: center; max-width: 400px; }
    #notification { display:none; position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background-color: #333; color: white; padding: 12px 20px; border-radius: 8px; z-index: 2100; }
  </style>
</head>
<body>

  <nav class="navbar">
    <div class="nav-inner">
      <img class="brand-logo" src="https://img2.pic.in.th/pic/ChatGPT-Image-10-..-2568-12_48_07.png" alt="‡πÇ‡∏•‡πÇ‡∏Å‡πâ">
      <div>
        <div class="brand-title">‡∏™‡∏ß‡∏µ‡∏Ñ‡∏∏‡∏°‡∏´‡∏ß‡∏≤‡∏ô</div>
        <div class="brand-sub">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß ‚Ä¢ ‡∏Ñ‡∏•‡∏¥‡∏ô‡∏¥‡∏Å‡∏•‡∏î‡∏¢‡∏≤‡πÄ‡∏ö‡∏≤‡∏´‡∏ß‡∏≤‡∏ô (DM Remission) ‡∏£‡∏û.‡∏™‡∏ß‡∏µ</div>
      </div>
    </div>
  </nav>

  <div id="loading"><div class="box">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‚Ä¶</div></div>
  <div id="notification"></div>

  <div class="container">
    <!-- View ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô/‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç -->
    <div id="reg-view" class="card" style="display:none">
      <h2>‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢</h2>
      <p class="hint">‡∏Ñ‡∏•‡∏¥‡∏ô‡∏¥‡∏Å‡∏•‡∏î‡∏¢‡∏≤‡πÄ‡∏ö‡∏≤‡∏´‡∏ß‡∏≤‡∏ô (DM Remission) ‡∏£‡∏û.‡∏™‡∏ß‡∏µ ‡∏à‡∏∞‡∏ô‡∏≥‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏ó‡πà‡∏≤‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å ‡∏°‡∏≤‡πÉ‡∏ä‡πâ‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏Å‡∏©‡∏≤ ‡πÇ‡∏õ‡∏£‡∏î‡πÉ‡∏´‡πâ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏ó‡πà‡∏≤‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</p>
      <div class="grid">
        <div><label>HN</label><input id="hn" type="text" placeholder="‡πÄ‡∏•‡∏Ç‡∏£‡∏û. 9 ‡∏´‡∏•‡∏±‡∏Å"></div>
        <div><label>‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏≤‡∏Å‡πÉ‡∏´‡πâ LINE ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å</label><input id="nameuse" type="text" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏ô‡πâ‡∏≠‡∏á‡∏™‡πâ‡∏°, ‡∏û‡∏µ‡πà‡πÅ‡∏î‡∏á"></div>
      </div>
      <div class="grid">
        <div><label>‡πÄ‡∏û‡∏®</label><select id="gender"><option value="">‚Äî ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏û‡∏® ‚Äî</option><option value="Male">‡∏ä‡∏≤‡∏¢</option><option value="Female">‡∏´‡∏ç‡∏¥‡∏á</option><option value="Other">‡∏≠‡∏∑‡πà‡∏ô ‡πÜ</option></select></div>
        <div><label>‡∏≠‡∏≤‡∏¢‡∏∏</label><input id="age" type="number" min="1" max="120" placeholder="‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á 45"></div>
      </div>
      <div class="row" style="margin:12px 0"><input id="consent" type="checkbox" style="transform: scale(1.2); margin-right:8px"><span class="muted">‡∏â‡∏±‡∏ô‡∏¢‡∏¥‡∏ô‡∏¢‡∏≠‡∏°‡πÉ‡∏´‡πâ‡∏Ñ‡∏•‡∏¥‡∏ô‡∏¥‡∏Å‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏µ‡πâ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Å‡∏≤‡∏£‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏±‡∏Å‡∏©‡∏≤</span></div>
      <button id="btnSave" class="btn">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
    </div>

    <!-- View ‡∏´‡∏•‡∏±‡∏Å‡∏Ç‡∏≠‡∏á Dashboard -->
    <div id="dashboard-view" style="display:none">
      <div class="card">
        <div class="card-header">
          <h2 style="margin:0">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß</h2>
          <button id="btnEditProfile" class="btn" style="padding:8px 12px; font-size:16px">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
        </div>
        <div class="profile-grid">
          <div class="profile-left"><img id="avatar" class="avatar" src="" alt="avatar"></div>
          <div class="profile-right">
            <div><span class="pill">‡∏ä‡∏∑‡πà‡∏≠</span> <span id="p_name" class="value">-</span></div>
            <div style="margin-top:6px"><span class="pill">HN</span> <span id="p_hn" class="value">-</span></div>
          </div>
        </div>
      </div>

      <!-- ‡πÄ‡∏°‡∏ô‡∏π‡∏´‡∏•‡∏±‡∏Å -->
      <div id="main-menu">
        <div class="menu-grid">
          <button class="menu-btn" data-target="goalsCard">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><circle cx="12" cy="12" r="6"></circle><circle cx="12" cy="12" r="2"></circle></svg>
            <span>‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô</span>
          </button>
          <button class="menu-btn" data-target="adviceCard">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2a10 10 0 1 0 10 10c0-4.42-2.87-8.17-6.84-9.5c.51-1 .43-2.26-.31-3s-1.87-.85-2.85-.51c-.83.29-1.5.89-1.86 1.66c-.37.77-.37 1.66 0 2.42C9.43 3.93 9.17 6 9 8.5c-2.33 1-4 3.39-4 6.5a8 8 0 0 0 16 0c0-3.11-1.67-5.5-4-6.5c-.17-2.5-.43-4.57-1.16-5.66Z"></path><path d="M12 16h.01"></path></svg>
            <span>‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÇ‡∏î‡∏¢ AI</span>
          </button>
          <button class="menu-btn" data-target="foodCard">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 2v6h6"></path><path d="M21 12A9 9 0 0 0 6 5.3L3 8"></path><path d="M21 22v-6h-6"></path><path d="M3 12a9 9 0 0 0 15 6.7l3-2.7"></path></svg>
            <span>‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏≠‡∏≤‡∏´‡∏≤‡∏£</span>
          </button>
          <button class="menu-btn" data-target="historyCard">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 3v18h18"></path><path d="m19 9-5 5-4-4-3 3"></path></svg>
            <span>‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ú‡∏•</span>
          </button>
        </div>
      </div>
      
      <!-- ‡∏Å‡∏≤‡∏£‡πå‡∏î‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏• (‡∏ã‡πà‡∏≠‡∏ô‡πÑ‡∏ß‡πâ) -->
      <div id="goalsCard" class="content-card card"></div>
      <div id="adviceCard" class="content-card card"></div>
      <div id="foodCard" class="content-card card"></div>
      <div id="historyCard" class="content-card card"></div>
    </div>
    
    <!-- View ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç/‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏î‡∏µ‡∏¢‡∏ß -->
    <div id="single-event-view" style="display:none;" class="container">
      <div class="card">
        <h2 id="single-event-title">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</h2>
        <div id="single-event-details"></div>
        <div id="edit-form" style="display:none; margin-top: 16px;">
          <label id="edit-label">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ñ‡πà‡∏≤</label>
          <input id="edit-value-input" type="number" step="any">
        </div>
        <div class="row" style="margin-top: 20px; justify-content: flex-end;">
          <button id="btn-cancel-single" class="btn btn-close">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
          <button id="btn-action-single" class="btn">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô</button>
        </div>
      </div>
    </div>

    <!-- Dialog ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö -->
    <div id="confirm-dialog">
      <div class="panel">
        <h3>‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö</h3>
        <p>‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà? ‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏∞‡∏ó‡∏≥‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏î‡πâ</p>
        <div class="row" style="justify-content: center; margin-top: 16px;">
          <button id="btn-confirm-cancel" class="btn btn-close">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
          <button id="btn-confirm-delete" class="btn danger">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö</button>
        </div>
      </div>
    </div>
  </div>

<script>
    // ====== CONFIG ======
    const LIFF_ID = '2007840605-zKl7p3Aa';
    const GAS_WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbwDi08IqlCBBESqXYkQgvA1EdvCjLchwZdBYAtobMr83NEWkvtgwVdTnzts5T9tvbM0/exec';

    // ====== State & Helpers ======
    let liffProfile = {};
    let currentEventData = {};
    const $  = s => document.querySelector(s);
    const $$ = s => document.querySelectorAll(s);
    const showLoading = v => { $('#loading').style.display = v ? 'grid' : 'none'; };
    const fmtDate = d => { const t=new Date(d); if(isNaN(+t)) return '-'; const dd=String(t.getDate()).padStart(2,'0'); const mm=String(t.getMonth()+1).padStart(2,'0'); const yy=t.getFullYear(); const hh=String(t.getHours()).padStart(2,'0'); const mi=String(t.getMinutes()).padStart(2,'0'); return `${dd}/${mm}/${yy} ${hh}:${mi}`; };
    const thaiGender = g => g==='Male'?'‡∏ä‡∏≤‡∏¢':g==='Female'?'‡∏´‡∏ç‡∏¥‡∏á':g? '‡∏≠‡∏∑‡πà‡∏ô ‡πÜ':'-';
    
    const EVENT_TYPE_THAI = {
      FOOD: 'üçΩÔ∏è ‡∏≠‡∏≤‡∏´‡∏≤‡∏£', EXERCISE: 'üí™ ‡∏≠‡∏≠‡∏Å‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Å‡∏≤‡∏¢', ADVERSE: '‚ö†Ô∏è ‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≤‡∏á‡πÄ‡∏Ñ‡∏µ‡∏¢‡∏á', DEPRESSION: 'üòü ‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏Ñ‡∏£‡∏µ‡∏¢‡∏î',
      WEIGHT:'‚öñÔ∏è ‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å', BP:'ü©∏ ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡∏±‡∏ô', WAIST:'üìè ‡∏£‡∏≠‡∏ö‡πÄ‡∏≠‡∏ß', SBGM:'ü©∏ ‡∏ô‡πâ‡∏≥‡∏ï‡∏≤‡∏•', HBA1C:' HbA1c', BODY_FAT:'‡πÑ‡∏Ç‡∏°‡∏±‡∏ô'
    };
    const thaiMealSubtype = s => ({'BREAKFAST':'üç≥ ‡πÄ‡∏ä‡πâ‡∏≤','LUNCH':'üçõ ‡∏Å‡∏•‡∏≤‡∏á‡∏ß‡∏±‡∏ô','DINNER':'üç≤ ‡πÄ‡∏¢‡πá‡∏ô','SNACK':'ü•§ ‡∏ß‡πà‡∏≤‡∏á'})[String(s || '').toUpperCase()] || '‡∏≠‡∏∑‡πà‡∏ô‡πÜ';

    function showNotification(message, duration = 3000) {
        const notif = $('#notification');
        notif.textContent = message;
        notif.style.display = 'block';
        setTimeout(() => { notif.style.display = 'none'; }, duration);
    }

    // ====== API Calls ======
    async function apiFetch(action, params = {}) {
        const url = new URL(GAS_WEB_APP_URL);
        url.searchParams.set('action', action);
        for(const key in params) { url.searchParams.set(key, params[key]); }
        const res = await fetch(url);
        if(!res.ok) throw new Error('Network error: ' + res.status);
        return await res.json();
    }

    async function apiPost(action, payload) {
        await fetch(GAS_WEB_APP_URL, {
            method: 'POST',
            mode: 'no-cors',
            headers: {'Content-Type': 'text/plain;charset=utf-8'},
            body: JSON.stringify({ action, payload })
        });
        return { ok: true };
    }


    // ====== UI Navigation ======
    function showCard(cardId) {
        $('#main-menu').style.display = 'none';
        $$('.content-card').forEach(c => c.style.display = 'none');
        $(`#${cardId}`).style.display = 'block';
    }
    function showMainMenu() {
        $$('.content-card').forEach(c => c.style.display = 'none');
        $('#main-menu').style.display = 'block';
    }
    function setupMenu() {
        $$('.menu-btn').forEach(btn => {
            btn.onclick = () => showCard(btn.dataset.target);
        });
    }

    // ====== Renderers ======
    function renderProfile(bundle){
      const p = bundle.profile || {};
      $('#avatar').src = p.PictureURL || liffProfile.pictureUrl || '';
      $('#p_name').textContent   = p.NameUse || p.DisplayName || '-';
      $('#p_hn').textContent     = p.HN || '-';
    }

    function renderGoals(bundle) {
        const list = bundle.goals || [];
        const card = $('#goalsCard');
        let html = `<div class="card-header"><h2>‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô (${list.length})</h2><button class="btn-close-card btn btn-close">‡∏õ‡∏¥‡∏î</button></div>`;
        if (list.length === 0) {
            html += `<div class="muted">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢</div>`;
        } else {
            html += `<div class="carousel">${list.map(g => `<div class="c-item"><h3>${g.goal_specific || '-'}</h3></div>`).join('')}</div>`;
        }
        card.innerHTML = html;
        card.querySelector('.btn-close-card').onclick = showMainMenu;
    }
    
    function renderAdvice(bundle) {
        const items = bundle.ai_analysis || [];
        const card = $('#adviceCard');
        let html = `<div class="card-header"><h2>‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÇ‡∏î‡∏¢ AI</h2><button class="btn-close-card btn btn-close">‡∏õ‡∏¥‡∏î</button></div>`;
        if (items.length === 0) {
            html += `<div class="muted">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥</div>`;
        } else {
            html += `<div class="carousel">${items.map(item => `<div class="c-item"><h3>‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</h3><div class="muted">${fmtDate(item.timestamp)}</div><p style="white-space:pre-wrap;margin-top:6px">${item.advice_text || '-'}</p></div>`).join('')}</div>`;
        }
        card.innerHTML = html;
        card.querySelector('.btn-close-card').onclick = showMainMenu;
    }
    
    function renderFood(bundle) {
        const items = bundle.food_exchange || [];
        const card = $('#foodCard');
        let html = `<div class="card-header"><h2>‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏≠‡∏≤‡∏´‡∏≤‡∏£</h2><button class="btn-close-card btn btn-close">‡∏õ‡∏¥‡∏î</button></div>`;
        if (items.length === 0) {
            html += `<div class="muted">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</div>`;
        } else {
            const latest = items.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp))[0];
            html += `<div class="muted">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡πÄ‡∏°‡∏∑‡πà‡∏≠ ${fmtDate(latest.timestamp)}</div> ...`; // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏ï‡∏≤‡∏°‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£
        }
        card.innerHTML = html;
        card.querySelector('.btn-close-card').onclick = showMainMenu;
    }

    function renderHistory(bundle) {
        const events = bundle.events || {};
        const card = $('#historyCard');
        let html = `<div class="card-header"><h2>‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ú‡∏•</h2><button class="btn-close-card btn btn-close">‡∏õ‡∏¥‡∏î</button></div>`;
        html += `<h3>‡∏Å‡∏£‡∏≤‡∏ü‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û</h3><div id="chartsWrap" class="charts-grid"></div>`;
        
        const allEvents = [];
        for(const type in events) { events[type].forEach(e => allEvents.push({...e, type})); }
        
        const sortedEvents = allEvents.sort((a,b) => new Date(b.ts) - new Date(a.ts));
        const nonChartEvents = sortedEvents.filter(e => ['FOOD', 'EXERCISE', 'ADVERSE', 'DEPRESSION'].includes(e.type));

        html += `<h3 style="margin-top: 20px;">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏≠‡∏∑‡πà‡∏ô‡πÜ</h3>`;
        if (nonChartEvents.length === 0) {
            html += `<div class="muted">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏≠‡∏≤‡∏´‡∏≤‡∏£, ‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡∏Å‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Å‡∏≤‡∏¢ ‡∏´‡∏£‡∏∑‡∏≠‡∏≠‡∏∑‡πà‡∏ô‡πÜ</div>`;
        } else {
            html += `<div class="table-wrap max5"><table>
                <thead><tr><th>‡πÄ‡∏ß‡∏•‡∏≤</th><th>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</th><th>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</th><th>‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ì</th></tr></thead>
                <tbody>
                    ${nonChartEvents.map(e => {
                        let detail = e.value_text || '-';
                        let value = e.value_numeric_1 ? `${e.value_numeric_1} ${e.value_unit || ''}`.trim() : '-';
                        if(e.type === 'FOOD') detail = `${thaiMealSubtype(e.event_subtype)}: ${detail}`;
                        return `<tr><td>${fmtDate(e.ts)}</td><td>${EVENT_TYPE_THAI[e.type] || e.type}</td><td>${detail}</td><td>${value}</td></tr>`
                    }).join('')}
                </tbody>
            </table></div>`;
        }

        card.innerHTML = html;
        card.querySelector('.btn-close-card').onclick = showMainMenu;

        const metricKeys = Object.keys(events).filter(k => ['WEIGHT','BP','WAIST','SBGM','HBA1C','BODY_FAT'].includes(k));
        if (metricKeys.length > 0) {
            metricKeys.forEach(k => {
                const chartContainer = document.createElement('div');
                chartContainer.className = 'chart-card';
                chartContainer.innerHTML = `<h3>${EVENT_TYPE_THAI[k]}</h3><div class="chart-box" style="height:220px"><canvas></canvas></div>`;
                $('#chartsWrap').appendChild(chartContainer);
                const ctx = chartContainer.querySelector('canvas').getContext('2d');
                new Chart(ctx, { /* ... chart config ... */ });
            });
        } else {
            $('#chartsWrap').innerHTML = `<div class="muted">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏£‡∏≤‡∏ü</div>`;
        }
    }

    // ====== Main Logic Flow ======
    
    function renderRegister() {
        $('#reg-view').style.display = 'block';
        $('#dashboard-view').style.display = 'none';
        $('#btnSave').onclick = async () => {
            const payload = {
                userId: liffProfile.userId,
                displayName: liffProfile.displayName,
                pictureUrl: liffProfile.pictureUrl,
                hn: $('#hn').value.trim(),
                name_use: $('#nameuse').value.trim() || liffProfile.displayName,
                gender: $('#gender').value,
                age: $('#age').value.trim(),
                consent: $('#consent').checked
            };
            if (!payload.consent) {
                showNotification('‡πÇ‡∏õ‡∏£‡∏î‡∏¢‡∏≠‡∏°‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Å‡∏≤‡∏£‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏±‡∏Å‡∏©‡∏≤');
                return;
            }
            const btn = $('#btnSave');
            btn.disabled = true;
            showLoading(true);
            await apiPost('registerUser', payload);
            showLoading(false);
            btn.disabled = false;
            showNotification('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß');
            setTimeout(() => location.reload(), 1500);
        };
    }

    function startEditProfile(profile) {
        $('#reg-view').style.display = 'block';
        $('#dashboard-view').style.display = 'none';
        $('#reg-view h2').textContent = '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß';
        $('#btnSave').textContent = '‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•';
        $('#hn').value = profile?.HN || '';
        $('#nameuse').value = profile?.NameUse || profile?.DisplayName || liffProfile.displayName || '';
        $('#gender').value = profile?.Gender || '';
        $('#age').value = profile?.Age || '';
        $('#consent').checked = String(profile?.Consent).toUpperCase() === 'TRUE' || profile?.Consent === true;

        $('#btnSave').onclick = async () => {
            const payload = {
                userId: liffProfile.userId,
                displayName: liffProfile.displayName,
                pictureUrl: liffProfile.pictureUrl,
                hn: $('#hn').value.trim(),
                name_use: $('#nameuse').value.trim() || liffProfile.displayName,
                gender: $('#gender').value,
                age: $('#age').value.trim(),
                consent: $('#consent').checked
            };
            if (!payload.consent) {
                showNotification('‡πÇ‡∏õ‡∏£‡∏î‡∏¢‡∏≠‡∏°‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Å‡∏≤‡∏£‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏±‡∏Å‡∏©‡∏≤');
                return;
            }
            const btn = $('#btnSave');
            btn.disabled = true;
            showLoading(true);
            await apiPost('registerUser', payload);
            showLoading(false);
            btn.disabled = false;
            showNotification('‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß');
            setTimeout(() => location.reload(), 1500);
        };
    }
    
    async function loadDashboardMode() {
        $('#dashboard-view').style.display = 'block';
        setupMenu();
        const bundle = await apiFetch('getDashboard', { userId: liffProfile.userId });
        if (!bundle || !bundle.ok || !bundle.profile) {
            renderRegister();
        } else {
            $('#btnEditProfile').onclick = () => startEditProfile(bundle.profile);
            renderProfile(bundle);
            renderGoals(bundle);
            renderAdvice(bundle);
            renderFood(bundle);
            renderHistory(bundle);
        }
    }

    async function loadSingleEventMode(action, ts) {
        $('#dashboard-view').style.display = 'none';
        $('#single-event-view').style.display = 'block';

        const result = await apiFetch('getEvent', { userId: liffProfile.userId, ts });
        if (!result.ok || !result.data) {
            $('#single-event-details').innerHTML = '<p>‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ‡∏´‡∏£‡∏∑‡∏≠‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á</p>';
            return;
        }
        
        currentEventData = result.data;
        const { event_type, event_subtype, value_numeric_1, value_unit, value_text } = currentEventData;
        const title = (action === 'edit' ? '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç' : '‡∏•‡∏ö') + `‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•: ${EVENT_TYPE_THAI[event_type] || event_type}`;
        $('#single-event-title').textContent = title;
        
        let detailsHtml = `
            <div class="data-point"><span class="label">‡πÄ‡∏ß‡∏•‡∏≤:</span> ${fmtDate(ts)}</div>
            <div class="data-point"><span class="label">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó:</span> ${EVENT_TYPE_THAI[event_type] || event_type}</div>`;
        if (event_type === 'FOOD') detailsHtml += `<div class="data-point"><span class="label">‡∏°‡∏∑‡πâ‡∏≠:</span> ${thaiMealSubtype(event_subtype)} (${value_text})</div>`;
        else detailsHtml += `<div class="data-point"><span class="label">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î:</span> ${value_text || '-'}</div>`;
        detailsHtml += `<div class="data-point"><span class="label">‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å:</span> ${value_numeric_1 || '-'} ${value_unit || ''}</div>`;
        $('#single-event-details').innerHTML = detailsHtml;

        $('#btn-cancel-single').onclick = () => liff.closeWindow();

        if (action === 'edit') {
            $('#edit-form').style.display = 'block';
            $('#edit-label').textContent = `‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ñ‡πà‡∏≤ (${value_unit || '‡∏Ñ‡πà‡∏≤'})`;
            $('#edit-value-input').value = value_numeric_1;
            $('#btn-action-single').textContent = '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç';
            $('#btn-action-single').onclick = handleUpdateEvent;
        } else { // 'delete'
            $('#edit-form').style.display = 'none';
            $('#btn-action-single').textContent = '‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö';
            $('#btn-action-single').classList.add('danger');
            $('#btn-action-single').onclick = () => $('#confirm-dialog').style.display = 'grid';
        }
    }
    
    async function handleUpdateEvent() {
        showLoading(true);
        const payload = {
            userId: liffProfile.userId,
            ts: new Date(currentEventData.timestamp).toISOString(),
            newValue: $('#edit-value-input').value
        };
        await apiPost('updateEvent', payload);
        showLoading(false);
        showNotification('‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß');
        setTimeout(() => liff.closeWindow(), 1500);
    }

    async function handleDeleteEvent() {
        showLoading(true);
        const payload = {
            userId: liffProfile.userId,
            ts: new Date(currentEventData.timestamp).toISOString()
        };
        await apiPost('deleteEvent', payload);
        showLoading(false);
        showNotification('‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß');
        setTimeout(() => liff.closeWindow(), 1500);
    }
    
    // ====== Init Function ======
    async function main() {
      showLoading(true);
      try {
        await liff.init({ liffId: LIFF_ID });
        if (!liff.isLoggedIn()) { liff.login(); return; }
        
        liffProfile = await liff.getProfile();
        
        $('#btn-confirm-cancel').onclick = () => $('#confirm-dialog').style.display = 'none';
        $('#btn-confirm-delete').onclick = () => {
            $('#confirm-dialog').style.display = 'none';
            handleDeleteEvent();
        };

        const urlParams = new URLSearchParams(window.location.search);
        const action = urlParams.get('action');
        const ts = urlParams.get('ts');

        if ((action === 'edit' || action === 'delete') && ts) {
          await loadSingleEventMode(action, ts);
        } else {
          await loadDashboardMode();
        }

      } catch(e) {
        console.error('Initialization Error:', e);
        $('.container').innerHTML = `<div class="card"><h2>‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î</h2><p>‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ ‡∏≠‡∏≤‡∏à‡∏°‡∏µ‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ ‡∏´‡∏£‡∏∑‡∏≠ CORS</p><p style="font-size:14px; color: #999;">${e.message}</p></div>`;
      } finally {
        showLoading(false);
      }
    }

    window.addEventListener('load', main);
  </script>
</body>
</html>

