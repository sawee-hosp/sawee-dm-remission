<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"/>
  <title>‡∏™‡∏ß‡∏µ‡∏Ñ‡∏∏‡∏°‡∏´‡∏ß‡∏≤‡∏ô ‚Ä¢ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ú‡∏•</title>

  <!-- Fonts & Icons -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Mali:wght@400;500;600;700&display=swap" rel="stylesheet">
  
  <!-- Libraries -->
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script> 
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    /* --- MASTER THEME: Cream, Brown, Yellow, Orange --- */
    :root{
      --bg: #FFFFFF;           
      --card: #FFF8E1;         
      --ink: #3E2723;          
      
      --modal-bg: #5D4037;     
      --modal-title: #FFD600;  
      
      --shadow: 0 8px 25px rgba(0,0,0,0.1);
      --font-main: 'Mali', cursive; 
    }
    
    * { box-sizing: border-box; font-family: var(--font-main) !important; }
    html, body { 
      height: 100%; margin: 0; padding: 0; 
      background: var(--bg); color: var(--ink); 
      font-size: 20px; -webkit-tap-highlight-color: transparent; 
    }
    
    /* Enforce Font globally */
    input, button, select, textarea, .swal2-popup, .swal2-title, .swal2-content, .swal2-html-container, .swal2-confirm, .swal2-cancel, .swal2-deny {
       font-family: var(--font-main) !important;
    }
    
    h1, h2, h3 { margin: 0 0 15px 0; font-weight: 700; }
    
    /* --- BUTTONS --- */
    .btn { 
      border: 3px solid #FFFFFF; outline: none; 
      background: linear-gradient(135deg, #FFEA00 0%, #FF9100 100%);
      color: #3E2723; padding: 18px 30px; 
      border-radius: 50px; font-size: 26px; font-weight: 800; 
      width: 100%; cursor: pointer; 
      box-shadow: 0 8px 20px rgba(255, 145, 0, 0.4); 
      display: flex; align-items: center; justify-content: center; gap: 10px; 
      transition: transform 0.1s; 
    }
    .btn:active { transform: scale(0.96); box-shadow: 0 4px 10px rgba(255, 145, 0, 0.4); }

    .btn-add { 
      background: #FFF9C4; color: #5D4037; border: 3px solid #FBC02D;
      font-size: 22px; padding: 12px; margin-top: 15px; border-radius: 50px;
      width: 100%; font-weight: 700; cursor: pointer;
    }
    
    .btn-close { 
      background: #FFCDD2; color: #C62828; 
      width: auto; font-size: 20px; padding: 8px 24px; 
      border-radius: 50px; border:none; font-weight:700; cursor: pointer;
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }

    /* --- ADD SHINE ANIMATION --- */
    @keyframes shineSweep {
        0% { left: -100%; }
        20% { left: 100%; }
        100% { left: 100%; }
    }
    .btn, div:where(button.swal2-confirm), div:where(button.swal2-cancel), div:where(button.swal2-deny) {
        position: relative;
        overflow: hidden;
    }
    .btn::after, div:where(button.swal2-confirm)::after, div:where(button.swal2-cancel)::after, div:where(button.swal2-deny)::after {
        content: ''; position: absolute; top: 0; left: -100%;
        width: 50px; height: 100%;
        background: rgba(255, 255, 255, 0.6);
        transform: skewX(-20deg);
        animation: shineSweep 3s infinite ease-in-out;
        pointer-events: none;
    }

    /* --- INPUTS --- */
    input, select, textarea { 
      width: 100%; padding: 20px; font-size: 28px; 
      border: 3px solid #D7CCC8; border-radius: 30px; 
      background: #fff; color: #333; text-align: center; 
      margin-bottom: 20px; font-weight: 700; 
      box-shadow: inset 0 2px 5px rgba(0,0,0,0.05);
    }
    input:focus { border-color: #FF9100; outline: none; box-shadow: 0 0 10px rgba(255, 145, 0, 0.4); }
    input::placeholder { color: #CFD8DC; font-weight: 400; font-size: 24px; }
    
    /* --- LAYOUT --- */
    .navbar { 
      background: #fff; padding: 15px 20px; 
      box-shadow: 0 4px 20px rgba(0,0,0,0.05); 
      display: flex; align-items: center; justify-content: space-between; 
      position: sticky; top: 0; z-index: 100; border-bottom: 1px solid #eee;
    }
    .nav-brand { font-weight: 800; font-size: 26px; color: var(--ink); }
    .container { max-width: 600px; margin: 0 auto; padding: 20px; padding-bottom: 120px; }
    
    /* --- NEW HEADER PROFILE --- */
    .profile-header {
        background: linear-gradient(145deg, #FFD600, #FF9100);
        border-radius: 30px; padding: 20px; margin-bottom: 25px;
        display: flex; align-items: center; gap: 15px;
        box-shadow: 0 10px 25px rgba(255, 145, 0, 0.3);
        border: 4px solid #FFF;
        flex-wrap: wrap;
    }
    .profile-header img {
        width: 80px; height: 80px; border-radius: 50%; object-fit: cover;
        border: 4px solid #FFF; background: #EEE; flex-shrink: 0;
    }
    .profile-info { flex: 1; color: #3E2723; min-width: 60%; }
    .profile-name { font-size: 28px; font-weight: 800; line-height: 1.1; margin-bottom: 5px; }
    .profile-stats { font-size: 16px; font-weight: 600; background: rgba(255,255,255,0.4); padding: 5px 12px; border-radius: 15px; display: inline-block; line-height: 1.3;}
    .profile-target { display: block; font-size: 20px; color: #D84315; font-weight: 800; margin-top: 5px;}

    /* --- GRID MENU --- */
    .note-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; }
    .note-item { 
      background: linear-gradient(145deg, #EFEBE9, #FFF3E0);
      border-radius: 30px; padding: 15px 5px; aspect-ratio: 1 / 1.15; 
      display: flex; flex-direction: column; justify-content: center; align-items: center;
      box-shadow: 0 8px 16px rgba(0,0,0,0.1); border: 2px solid #D7CCC8; 
      cursor: pointer; transition: 0.1s; 
    }
    .note-item:active { transform: scale(0.95); background: #D7CCC8; }
    .note-icon { font-size: 48px; line-height: 1; margin-bottom: 8px; }
    .note-label { font-size: 22px; font-weight: 700; line-height: 1.2; color: var(--ink); text-align: center; }
    
    .bg-sugar .note-icon { color: #C62828; } 
    .bg-bp .note-icon { color: #1565C0; } 
    .bg-food .note-icon { color: #2E7D32; }
    .bg-weight .note-icon { color: #455A64; } 
    .bg-ex .note-icon { color: #EF6C00; } 
    .bg-alert .note-icon { color: #F9A825; }

    /* --- MODALS --- */
    .modal-overlay { 
      position: fixed; inset: 0; background: #FFFFFF !important; 
      z-index: 2000; display: none; align-items: flex-end; justify-content: center; 
    }
    .modal-overlay.centered { align-items: center; background: rgba(255,255,255,0.95) !important; }

    .modal-sheet { 
      background: var(--modal-bg); color: var(--modal-text); 
      width: 100%; max-width: 600px; 
      border-radius: 40px 40px 0 0; padding: 40px 25px 60px 25px; 
      box-shadow: 0 -10px 50px rgba(0,0,0,0.5); 
      animation: slideUp 0.3s; display: flex; flex-direction: column; 
      max-height: 95vh; overflow-y: auto;
    }
    
    .modal-card-center {
        background: var(--modal-bg); color: var(--modal-text);
        width: 95%; max-width: 500px; border-radius: 40px; padding: 40px 30px;
        box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        animation: popIn 0.3s; display: flex; flex-direction: column; max-height: 90vh; overflow-y: auto;
    }

    @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
    @keyframes popIn { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }
    
    .form-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; }
    .form-title { font-size: 36px; font-weight: 800; color: #FFD600; text-shadow: 2px 2px 0px rgba(0,0,0,0.2); }
    .form-label { display: block; font-size: 26px; font-weight: 600; margin-bottom: 20px; color: #FFF59D; text-align: center; }
    
    /* --- DASHBOARD CARD --- */
    .hist-card {
        background: #FFF8E1; border-radius: 20px; margin-bottom: 30px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1); border: 2px solid #FFE0B2;
        overflow: visible; position: relative; display: flex; flex-direction: column;
        padding-top: 35px;
    }
    .hist-header-badge {
        position: absolute; top: -12px; left: 20px;
        background: #5D4037; color: #FFF;
        padding: 6px 20px; border-radius: 20px;
        font-size: 18px; font-weight: 700;
        box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        z-index: 10;
    }
    .hist-body {
        display: flex; flex-direction: row; padding: 15px 20px; gap: 15px;
        align-items: flex-start;
    }
    .hist-img-container {
        width: 110px; height: 110px; flex-shrink: 0;
        border-radius: 15px; overflow: hidden; border: 3px solid #D7CCC8;
        background: #EEE; display: flex; align-items: center; justify-content: center;
        cursor: pointer; box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    .hist-img-container img { width: 100%; height: 100%; object-fit: cover; }
    .hist-data { flex: 1; display: flex; flex-direction: column; gap: 10px; width: 100%; }
    
    .data-row { margin-bottom: 5px; display: flex; align-items: baseline; flex-wrap: wrap; }
    .data-label { font-size: 18px; color: #8D6E63; font-weight: 600; margin-right: 8px; }
    .data-value-big { font-size: 34px; color: #3E2723; font-weight: 800; line-height: 1; }
    .unit { font-size: 16px; color: #8D6E63; font-weight: 500; margin-left: 2px; }
    .food-list-item { font-size: 20px; color: #3E2723; margin-bottom: 6px; padding-bottom: 4px; border-bottom: 1px dashed #E0E0E0; width: 100%; display: block; }
    .food-flag { font-size: 14px; font-weight: bold; background: #E8F5E9; color: #2E7D32; padding: 4px 8px; border-radius: 10px; margin-top: 5px; display: inline-block; line-height: 1.2; border: 1px solid #C8E6C9;}
    
    /* ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏õ‡πâ‡∏≤‡∏¢ High/Low ‡πÉ‡∏´‡πâ‡πÅ‡∏î‡∏á‡πÄ‡∏Ç‡πâ‡∏°‡∏™‡∏∞‡πÉ‡∏à */
    .alert-badge.high { 
        background: #D32F2F !important; color: white !important; border: 2px solid #B71C1C;
        padding: 4px 12px; border-radius: 20px; font-size: 16px; font-weight: 800; margin-left: 8px;
        box-shadow: 0 2px 5px rgba(211, 47, 47, 0.4);
    }
    .alert-badge.low { 
        background: #E65100 !important; color: white !important; border: 2px solid #BF360C;
        padding: 4px 12px; border-radius: 20px; font-size: 16px; font-weight: 800; margin-left: 8px;
        box-shadow: 0 2px 5px rgba(230, 81, 0, 0.4);
    }
    .divider { height: 2px; background: #D7CCC8; margin: 10px 0; width: 100%; border-radius: 2px; opacity: 0.5; }

    /* --- LOADING --- */
    #loading { 
      position: fixed; inset: 0; background: rgba(255,255,255,1); 
      display: none; flex-direction: column; justify-content: center; align-items: center; 
      z-index: 9999; 
    }
    .spinner { width: 80px; height: 80px; border: 10px solid #f3f3f3; border-top: 10px solid #FF9100; border-radius: 50%; animation: spin 1s linear infinite; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

    /* --- VIEWS --- */
    .view-section { display: none; }
    .view-section.active { display: block; }

    /* --- SWEETALERT OVERRIDES --- */
    div:where(.swal2-container) { z-index: 10000 !important; }
    div:where(.swal2-popup) { 
        border-radius: 40px !important; background: #FFF9C4 !important; 
        color: #3E2723 !important; border: 4px solid #FBC02D !important;
    }
    div:where(.swal2-title) { color: #5D4037 !important; font-size: 30px !important; font-weight: 800 !important; }
    div:where(.swal2-html-container) { color: #5D4037 !important; font-size: 22px !important; }
    
    div:where(button.swal2-confirm), div:where(button.swal2-cancel), div:where(button.swal2-deny) { 
        background: linear-gradient(135deg, #FFEA00 0%, #FF9100 100%) !important; 
        color: #3E2723 !important; border: 3px solid #FFF !important; border-radius: 50px !important; 
        font-size: 24px !important; padding: 15px 30px !important;
        box-shadow: 0 5px 15px rgba(255,145,0,0.4) !important; outline: none !important; margin: 8px !important;
        font-weight: 800 !important;
    }
    
    div:where(.swal2-popup.swal2-show) input, div:where(.swal2-popup.swal2-show) select, div:where(.swal2-popup.swal2-show) textarea { 
        background: #FFFFFF !important; border-radius: 20px !important; color: #3E2723 !important; 
        border: 3px solid #D7CCC8 !important; outline: none !important; padding: 15px !important;
    }
    
    /* Options, Meal Selector, Chips */
    .chip-container, .custom-selector-container { 
        display: flex; flex-wrap: wrap; gap: 12px; justify-content: center; width: 100%; margin: 20px 0; 
    }
    .chip-btn, .custom-selector-btn, .symptom-btn, .score-btn {
        background: #FFFFFF; border: 3px solid #D7CCC8; border-radius: 50px; 
        padding: 16px 20px; font-size: 24px; color: #5D4037; font-weight: 700; 
        cursor: pointer; transition: all 0.2s ease; box-shadow: 0 4px 10px rgba(0,0,0,0.05); 
        text-align: center; flex: 1 1 auto; min-width: 120px; white-space: nowrap;
    }
    .chip-btn.active, .custom-selector-btn.active, .symptom-btn.active, .score-btn.active {
        background: #FFD600; color: #3E2723; border-color: #FFB300;
        transform: scale(1.05); box-shadow: 0 8px 20px rgba(255, 214, 0, 0.5);
    }

    /* Body Comp Mini Inputs */
    .bodycomp-row { display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px; background: #FFF; border-radius: 20px; padding: 10px 15px; }
    .bodycomp-row label { font-size: 22px; font-weight: 700; color: #5D4037; width: 50%; text-align: left;}
    .bodycomp-row input { width: 30%; padding: 10px; font-size: 24px; margin-bottom: 0; border-radius: 15px; }
    .bodycomp-row span { font-size: 18px; color: #8D6E63; width: 20%; text-align: left; padding-left: 10px;}

    /* =========================================================
       REGISTRATION UI STYLES
       ========================================================= */
    #register-view { background-color: var(--card); min-height: 100vh; padding-bottom: 40px; }
    
    .anim-slide-up {
        opacity: 0; transform: translateY(40px);
        animation: slideUpFade 0.7s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
    }
    @keyframes slideUpFade { to { opacity: 1; transform: translateY(0); } }
    .d-100 { animation-delay: 0.1s; } .d-200 { animation-delay: 0.2s; } 
    .d-300 { animation-delay: 0.3s; } .d-400 { animation-delay: 0.4s; }

    .reg-step { display: none; padding: 20px; max-width: 600px; margin: 0 auto; }
    .reg-step.active { display: block; }

    .reg-title { font-size: 32px; color: var(--ink); text-align: center; font-weight: 800; margin-bottom: 10px; line-height: 1.3; }
    .reg-desc { font-size: 22px; color: #5D4037; text-align: center; line-height: 1.4; margin-bottom: 30px; }
    
    .reg-card-btn {
        background: #FFFFFF; border: 3px solid #D7CCC8; border-radius: 30px; 
        padding: 20px; margin-bottom: 15px; display: flex; align-items: center; gap: 15px; 
        cursor: pointer; transition: 0.2s; box-shadow: 0 8px 15px rgba(0,0,0,0.05);
    }
    .reg-card-btn:active { transform: scale(0.96); background: #FFF3E0; border-color: #FFB300; }
    .reg-card-btn .r-icon { font-size: 36px; line-height: 1; flex-shrink: 0; }
    .reg-card-btn .r-text { font-size: 24px; font-weight: 700; color: var(--ink); line-height: 1.2; text-align: left; }

    .reg-cond-box { 
        background: #FFFFFF; border: 4px solid #FFE0B2; border-radius: 30px; 
        padding: 25px 20px; margin-bottom: 30px; box-shadow: 0 8px 20px rgba(0,0,0,0.05); 
    }
    .reg-cond-item { display: flex; align-items: flex-start; gap: 15px; margin-bottom: 20px; font-size: 22px; color: var(--ink); font-weight: 600; line-height: 1.3; }
    .reg-cond-item:last-child { margin-bottom: 0; }
    .reg-cond-num { 
        background: #FF9100; color: white; width: 36px; height: 36px; 
        border-radius: 50%; display: flex; align-items: center; justify-content: center; 
        font-size: 20px; font-weight: 800; flex-shrink: 0; box-shadow: 0 4px 8px rgba(255, 145, 0, 0.3);
    }

    .reg-form-group { margin-bottom: 25px; }
    .reg-label { font-size: 24px; font-weight: 700; color: #5D4037; margin-bottom: 10px; display: block; text-align: left; }
    
    .reg-radio-container { display: flex; gap: 15px; }
    .reg-radio-label { 
      flex: 1; border: 3px solid #D7CCC8; border-radius: 50px; padding: 15px; 
      text-align: center; font-size: 26px; font-weight: 700; color: #5D4037; 
      cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 10px; background: #FFFFFF;
      transition: all 0.2s; box-shadow: 0 4px 10px rgba(0,0,0,0.05);
    }
    .reg-radio-label.active { background: #FFD600; border-color: #FFB300; color: #3E2723; transform: scale(1.05); box-shadow: 0 8px 20px rgba(255, 214, 0, 0.4); }
    .reg-radio-label input { display: none; }

    .reg-consent-box { 
        background: #FFFFFF; border: 3px solid #FFE0B2; padding: 20px; border-radius: 25px; 
        margin-top: 30px; display: flex; gap: 15px; align-items: flex-start; cursor: pointer;
    }
    .reg-consent-box input { width: 30px; height: 30px; margin-top: 5px !important; flex-shrink: 0; accent-color: #FF9100; cursor: pointer; }
    .reg-consent-box p { margin: 0; font-size: 20px; color: #5D4037; line-height: 1.4; font-weight: 500; }

    .reg-btn-row { display: flex; gap: 15px; margin-top: 35px; }
    .reg-btn-secondary { 
        background: #FFFFFF; color: #5D4037; border: 3px solid #D7CCC8; 
        padding: 16px; border-radius: 50px; font-size: 24px; font-weight: 700; 
        width: 100%; cursor: pointer; flex: 1; box-shadow: 0 4px 10px rgba(0,0,0,0.05); transition: 0.1s;
    }
    .reg-btn-secondary:active { transform: scale(0.96); background: #EFEBE9; }

    .reg-profile-pic { width: 120px; height: 120px; border-radius: 50%; border: 5px solid #FFD600; object-fit: cover; margin: 0 auto 15px; display: block; box-shadow: 0 8px 20px rgba(0,0,0,0.1); }
    .reg-profile-name { font-size: 28px; font-weight: 800; text-align: center; color: var(--ink); margin-bottom: 5px; }
    .reg-profile-group { display: inline-block; background: #5D4037; color: #FFF; padding: 6px 20px; border-radius: 50px; font-size: 20px; font-weight: 600; margin-bottom: 25px; }

  </style>
</head>
<body>

  <div id="loading" style="display: flex;"><div class="spinner"></div><div style="margin-top:20px; font-size:24px; color:#5D4037; font-weight:700;">‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà...</div></div>

  <!-- VIEW: Main Menu -->
  <div id="note-view" class="view-section">
    <nav class="navbar"><div class="nav-brand">üè° ‡∏™‡∏ß‡∏µ‡∏Ñ‡∏∏‡∏°‡∏´‡∏ß‡∏≤‡∏ô</div></nav>
    <div class="container" style="padding-top: 15px;">
      
      <!-- Profile Header Block -->
      <div class="profile-header" id="main-profile-header" style="display: none;">
          <img id="head-avatar" src="" alt="Avatar">
          <div class="profile-info">
              <div class="profile-name" id="head-name">‡∏Ñ‡∏∏‡∏ì...</div>
              <div class="profile-stats">‡πÄ‡∏£‡∏¥‡πà‡∏°: <span id="head-start">-</span></div>
              <div class="profile-target" id="head-target">‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏•‡∏∑‡∏≠: - ‡∏ß‡∏±‡∏ô</div>
              <!-- ‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏ï‡πà‡∏≠‡∏ó‡πâ‡∏≤‡∏¢‡πÉ‡∏ô JS -->
          </div>
      </div>

      <div class="note-grid">
        <div class="note-item" onclick="openNoteForm('SBGM')"><div class="note-icon bg-sugar">ü©∏</div><div class="note-label">‡∏ô‡πâ‡∏≥‡∏ï‡∏≤‡∏•<br>‡∏õ‡∏•‡∏≤‡∏¢‡∏ô‡∏¥‡πâ‡∏ß</div></div>
        <div class="note-item" onclick="openNoteForm('BP')"><div class="note-icon bg-bp">üíì</div><div class="note-label">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡∏±‡∏ô<br>‡πÇ‡∏•‡∏´‡∏¥‡∏ï</div></div>
        <div class="note-item" onclick="openFoodModal()"><div class="note-icon bg-food">üç≤</div><div class="note-label">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å<br>‡∏≠‡∏≤‡∏´‡∏≤‡∏£</div></div>
        <div class="note-item" onclick="openNoteForm('WEIGHT')"><div class="note-icon bg-weight">‚öñÔ∏è</div><div class="note-label">‡∏ä‡∏±‡πà‡∏á<br>‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å</div></div>
        <div class="note-item" onclick="openBodyCompModal()"><div class="note-icon" style="color: #6D4C41;">üë§</div><div class="note-label">‡∏î‡∏±‡∏ä‡∏ô‡∏µ<br>‡∏°‡∏ß‡∏•‡∏Å‡∏≤‡∏¢</div></div>
        <div class="note-item" onclick="openNoteForm('EXERCISE')"><div class="note-icon bg-ex">üèÉ‚Äç‚ôÄÔ∏è</div><div class="note-label">‡∏≠‡∏≠‡∏Å<br>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Å‡∏≤‡∏¢</div></div>
        <div class="note-item" onclick="openSleepStressModal()"><div class="note-icon" style="color: #7E57C2;">üò¥</div><div class="note-label">‡∏Å‡∏≤‡∏£‡∏ô‡∏≠‡∏ô/<br>‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏Ñ‡∏£‡∏µ‡∏¢‡∏î</div></div>
        <div class="note-item" onclick="openMedicationModal()"><div class="note-icon" style="color: #00838F;">üíä</div><div class="note-label">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏¢‡∏≤</div></div>
        <div class="note-item" onclick="loadDashboardData()"><div class="note-icon" style="color:#333;">üìà</div><div class="note-label">‡∏î‡∏π‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥</div></div>
      </div>
    </div>
  </div>

  <!-- VIEW: Dashboard -->
  <div id="dashboard-view" class="view-section">
    <nav class="navbar"><div class="nav-brand">üìà ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û</div><button class="btn-close" onclick="switchView('note')">‡∏Å‡∏•‡∏±‡∏ö</button></nav>
    <div class="container">
      <div id="history-container"></div> 
    </div>
  </div>

  <!-- VIEW: Register -->
  <div id="register-view" class="view-section">
    <nav class="navbar"><div class="nav-brand" style="margin: 0 auto;">üìù ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏™‡∏ß‡∏µ‡∏Ñ‡∏∏‡∏°‡∏´‡∏ß‡∏≤‡∏ô</div></nav>

    <!-- Step 1: ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏•‡∏∏‡πà‡∏° -->
    <div id="reg-step-1" class="reg-step active">
        <div class="anim-slide-up" style="font-size: 60px; text-align: center; margin-bottom: 10px;">üëã</div>
        <h2 class="reg-title anim-slide-up d-100">‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà<br>‡πÇ‡∏õ‡∏£‡πÅ‡∏Å‡∏£‡∏°‡∏™‡∏ß‡∏µ‡∏Ñ‡∏∏‡∏°‡∏´‡∏ß‡∏≤‡∏ô</h2>
        <p class="reg-desc anim-slide-up d-200">‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏±‡∏ö‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏û‡∏§‡∏ï‡∏¥‡∏Å‡∏£‡∏£‡∏°‡∏Å‡∏≤‡∏£‡∏Å‡∏¥‡∏ô ‡πÅ‡∏•‡∏∞‡∏≠‡∏≠‡∏Å‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Å‡∏≤‡∏¢‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å ‡πÅ‡∏•‡∏∞‡∏•‡∏î‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ô‡πâ‡∏≥‡∏ï‡∏≤‡∏•‡πÉ‡∏ô‡πÄ‡∏•‡∏∑‡∏≠‡∏î</p>
        
        <div class="anim-slide-up d-300">
            <p style="text-align: center; font-weight: 800; color: #5D4037; font-size: 24px; margin: 30px 0 15px 0;">‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡πÇ‡∏õ‡∏£‡πÅ‡∏Å‡∏£‡∏°‡πÉ‡∏î?</p>
            
            <div class="reg-card-btn" onclick="selectRegGroup('DM')">
                <div class="r-icon">ü•ó</div>
                <div class="r-text">‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡πÄ‡∏ö‡∏≤‡∏´‡∏ß‡∏≤‡∏ô<br><span style="font-size:20px; color:#5D4037; font-weight:500;">‡∏õ‡∏£‡∏±‡∏ö‡∏û‡∏§‡∏ï‡∏¥‡∏Å‡∏£‡∏£‡∏°‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û</span></div>
            </div>

            <div class="reg-card-btn" onclick="selectRegGroup('DM Remission')">
                <div class="r-icon">üìâ</div>
                <div class="r-text">‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ñ‡∏•‡∏¥‡∏ô‡∏¥‡∏Å‡πÄ‡∏ö‡∏≤‡∏´‡∏ß‡∏≤‡∏ô‡∏£‡∏∞‡∏¢‡∏∞‡∏™‡∏á‡∏ö<br><span style="font-size:20px; color:#5D4037; font-weight:500;">‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏•‡∏î‡∏¢‡∏≤‡πÄ‡∏ö‡∏≤‡∏´‡∏ß‡∏≤‡∏ô</span></div>
            </div>

            <div class="reg-card-btn" onclick="selectRegGroup('Not DM')">
                <div class="r-icon">üõ°Ô∏è</div>
                <div class="r-text">‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡∏û‡∏§‡∏ï‡∏¥‡∏Å‡∏£‡∏£‡∏°<br><span style="font-size:20px; color:#5D4037; font-weight:500;">‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡πÄ‡∏ö‡∏≤‡∏´‡∏ß‡∏≤‡∏ô (‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏õ‡πá‡∏ô)</span></div>
            </div>
        </div>
    </div>

    <!-- Step 2: ‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç DM Remission -->
    <div id="reg-step-2" class="reg-step">
        <div class="anim-slide-up" style="font-size: 60px; text-align: center; margin-bottom: 10px;">üìã</div>
        <h2 class="reg-title anim-slide-up d-100">‡∏Ñ‡∏∏‡∏ì‡∏™‡∏°‡∏ö‡∏±‡∏ï‡∏¥‡∏ú‡∏π‡πâ‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏´‡∏¢‡∏∏‡∏î‡∏¢‡∏≤‡πÄ‡∏ö‡∏≤‡∏´‡∏ß‡∏≤‡∏ô</h2>
        <p class="reg-desc anim-slide-up d-200">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏î‡∏±‡∏á‡∏ï‡πà‡∏≠‡πÑ‡∏õ‡∏ô‡∏µ‡πâ</p>

        <div class="reg-cond-box anim-slide-up d-300">
            <div class="reg-cond-item">
                <div class="reg-cond-num">1</div>
                <div>‡∏°‡∏µ‡∏ô‡πâ‡∏≥‡∏ï‡∏≤‡∏•‡∏™‡∏∞‡∏™‡∏° HbA1c <strong style="color:#D84315;">‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô 6.5%</strong></div>
            </div>
            <div class="reg-cond-item">
                <div class="reg-cond-num">2</div>
                <div>‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏ö‡∏≤‡∏´‡∏ß‡∏≤‡∏ô‡∏°‡∏≤ <strong style="color:#D84315;">‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô 5 ‡∏õ‡∏µ</strong></div>
            </div>
            <div class="reg-cond-item">
                <div class="reg-cond-num">3</div>
                <div>‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô <strong style="color:#D84315;">100 ‡∏Å‡∏Å. ‡∏Ç‡∏∂‡πâ‡∏ô‡πÑ‡∏õ</strong></div>
            </div>
            <div class="reg-cond-item">
                <div class="reg-cond-num">4</div>
                <div>‡∏°‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ï‡∏±‡πâ‡∏á‡πÉ‡∏à‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡∏≠‡∏≤‡∏´‡∏≤‡∏£ ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏•‡∏î‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡πÉ‡∏´‡πâ <strong style="color:#D84315;">‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤ 10%</strong></div>
            </div>
        </div>

        <div class="reg-btn-row anim-slide-up d-400">
            <button class="reg-btn-secondary" onclick="goToRegStep(1)">‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö</button>
            <button class="btn" style="flex:2;" onclick="setupRegForm(); goToRegStep(3);">‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÅ‡∏•‡πâ‡∏ß !</button>
        </div>
    </div>

    <!-- Step 3: ‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß -->
    <div id="reg-step-3" class="reg-step">
        <div class="anim-slide-up" style="text-align: center; margin-bottom: 20px;">
            <img id="reg-prof-img" src="" class="reg-profile-pic" alt="Profile">
            <div id="reg-prof-name" class="reg-profile-name">‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</div>
            <div id="reg-prof-group" class="reg-profile-group">‡∏Å‡∏•‡∏∏‡πà‡∏°: -</div>
            <p class="reg-desc" style="font-weight:700;">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß‡∏Ç‡πâ‡∏≤‡∏á‡∏•‡πà‡∏≤‡∏á</p>
        </div>

        <form id="reg-form" onsubmit="submitRegistration(event)" class="anim-slide-up d-100">
            
            <div class="reg-form-group">
                <label class="reg-label">‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å (Name)</label>
                <input required type="text" id="reg-name" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏•‡∏∏‡∏á‡πÅ‡∏î‡∏á ‡∏õ‡πâ‡∏≤‡∏™‡πâ‡∏° ‡∏û‡∏µ‡πà‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß">
            </div>

            <div class="reg-form-group">
                <label class="reg-label">‡πÄ‡∏•‡∏Ç‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢ ‡∏£‡∏û.‡∏™‡∏ß‡∏µ (HN)</label>
                <input required type="tel" id="reg-hn" pattern="\d{9}" maxlength="9" title="‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç 9 ‡∏´‡∏•‡∏±‡∏Å" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏•‡∏Ç 9 ‡∏´‡∏•‡∏±‡∏Å" oninput="validateNumber(this)">
            </div>

            <div class="reg-form-group">
                <label class="reg-label">‡πÄ‡∏û‡∏® (Gender)</label>
                <div class="reg-radio-container">
                    <label class="reg-radio-label" onclick="selectGender(this, 'Male')">
                        <input required type="radio" name="reg-gender" value="Male"> üë® ‡∏ä‡∏≤‡∏¢
                    </label>
                    <label class="reg-radio-label" onclick="selectGender(this, 'Female')">
                        <input required type="radio" name="reg-gender" value="Female"> üë© ‡∏´‡∏ç‡∏¥‡∏á
                    </label>
                </div>
            </div>

            <div class="reg-form-group">
                <label class="reg-label">‡∏≠‡∏≤‡∏¢‡∏∏ (‡∏õ‡∏µ)</label>
                <input required type="tel" id="reg-age" placeholder="‡∏≠‡∏≤‡∏¢‡∏∏‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì" oninput="validateNumber(this)" maxlength="3">
            </div>

            <div class="reg-form-group">
                <label class="reg-label">‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô (‡∏Å‡∏Å.)</label>
                <input required type="tel" id="reg-weight" placeholder="‡πÄ‡∏ä‡πà‡∏ô 65.5" inputmode="decimal" oninput="this.value = this.value.replace(/[^0-9.]/g, '')">
                <div id="reg-weight-target-msg" class="reg-consent-box" style="display:none; background:#FFF3E0; border-color:#FFB300; text-align:center; flex-direction:column; padding:15px; margin-top:10px;"></div>
            </div>

            <label class="reg-consent-box">
                <input required type="checkbox" id="reg-consent">
                <p>‡∏¢‡∏¥‡∏ô‡∏¢‡∏≠‡∏°‡πÉ‡∏´‡πâ ‡∏Ñ‡∏•‡∏¥‡∏ô‡∏¥‡∏Å‡πÄ‡∏ö‡∏≤‡∏´‡∏ß‡∏≤‡∏ô‡∏£‡∏∞‡∏¢‡∏∞‡∏™‡∏á‡∏ö ‡∏£‡∏û.‡∏™‡∏ß‡∏µ ‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡∏≠‡∏á‡∏ó‡πà‡∏≤‡∏ô‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏ä‡πâ‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏Å‡∏©‡∏≤ ‡πÅ‡∏•‡∏∞‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡πÅ‡∏ä‡∏£‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡∏≠‡∏á‡∏ó‡πà‡∏≤‡∏ô (‡∏¢‡∏Å‡πÄ‡∏ß‡πâ‡∏ô‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡∏µ‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏ï‡∏±‡∏ß‡∏ï‡∏ô) ‡∏Å‡∏±‡∏ö‡∏Ñ‡∏ô‡∏≠‡∏∑‡πà‡∏ô‡πÉ‡∏ô‡∏Ñ‡∏•‡∏¥‡∏ô‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡∏£‡∏∞‡∏™‡∏ö‡∏Å‡∏≤‡∏£‡∏ì‡πå‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ‡∏û‡∏§‡∏ï‡∏¥‡∏Å‡∏£‡∏£‡∏°‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û</p>
            </label>

            <div class="reg-btn-row">
                <button type="button" class="reg-btn-secondary" onclick="goToRegStep(1)">‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö</button>
                <button type="submit" class="btn" style="flex:2;">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ‚úÖ</button>
            </div>
        </form>
    </div>

    <!-- Step 4: ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à -->
    <div id="reg-step-4" class="reg-step">
        <div style="text-align: center; padding: 60px 0;">
            <div class="anim-slide-up" style="background: #4CAF50; color: white; width: 120px; height: 120px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 70px; margin: 0 auto 30px; box-shadow: 0 10px 30px rgba(76, 175, 80, 0.4);">‚úì</div>
            <h2 class="reg-title anim-slide-up d-100">‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</h2>
            <p class="reg-desc anim-slide-up d-200">‡∏£‡∏∞‡∏ö‡∏ö‡πÑ‡∏î‡πâ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß<br>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏û‡∏≤‡∏ó‡πà‡∏≤‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å...</p>
        </div>
    </div>
  </div>


  <!-- MODAL: Body Comp (‡∏î‡∏±‡∏ä‡∏ô‡∏µ‡∏°‡∏ß‡∏•‡∏Å‡∏≤‡∏¢) -->
  <div id="bodycomp-modal" class="modal-overlay">
    <div class="modal-sheet">
      <div class="form-header">
        <div class="form-title">‡∏î‡∏±‡∏ä‡∏ô‡∏µ‡∏°‡∏ß‡∏•‡∏Å‡∏≤‡∏¢</div><button class="btn-close" onclick="closeAllModals()">‡∏õ‡∏¥‡∏î</button>
      </div>
      <div style="background:#FFF9C4; padding: 15px; border-radius: 20px; margin-bottom: 20px;">
        <p style="text-align:center; color:#5D4037; font-weight:700; margin:0;">‡πÉ‡∏™‡πà‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏∞‡∏Ñ‡∏∞</p>
      </div>
      <div id="bc-container">
          <div class="bodycomp-row"><label>% ‡πÑ‡∏Ç‡∏°‡∏±‡∏ô‡∏£‡πà‡∏≤‡∏á‡∏Å‡∏≤‡∏¢</label><input type="tel" id="bc-fat" inputmode="decimal" oninput="validateNumber(this)"><span>%</span></div>
          <div class="bodycomp-row"><label>‡πÑ‡∏Ç‡∏°‡∏±‡∏ô‡∏ä‡πà‡∏≠‡∏á‡∏ó‡πâ‡∏≠‡∏á</label><input type="tel" id="bc-visceral" inputmode="numeric" oninput="validateNumber(this)"><span>‡∏£‡∏∞‡∏î‡∏±‡∏ö</span></div>
          <div class="bodycomp-row"><label>% ‡∏Å‡∏•‡πâ‡∏≤‡∏°‡πÄ‡∏ô‡∏∑‡πâ‡∏≠</label><input type="tel" id="bc-muscle" inputmode="decimal" oninput="validateNumber(this)"><span>%</span></div>
          <div class="bodycomp-row"><label>BMI</label><input type="tel" id="bc-bmi" inputmode="decimal" oninput="validateNumber(this)"><span>kg/m¬≤</span></div>
          <div class="bodycomp-row"><label>‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏Å‡∏≤‡∏£‡πÄ‡∏ú‡∏≤‡∏ú‡∏•‡∏≤‡∏ç</label><input type="tel" id="bc-rm" inputmode="numeric" oninput="validateNumber(this)"><span>kcal</span></div>
          <div class="bodycomp-row"><label>‡∏≠‡∏≤‡∏¢‡∏∏‡∏£‡πà‡∏≤‡∏á‡∏Å‡∏≤‡∏¢</label><input type="tel" id="bc-age" inputmode="numeric" oninput="validateNumber(this)"><span>‡∏õ‡∏µ</span></div>
      </div>
      <div style="margin-top:25px;"><button class="btn" onclick="saveBodyComp()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ‚úÖ</button></div>
    </div>
  </div>

  <!-- MODAL: Medications (‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏¢‡∏≤) -->
  <div id="med-modal" class="modal-overlay">
    <div class="modal-sheet">
      <div class="form-header">
        <div class="form-title">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏¢‡∏≤</div><button class="btn-close" onclick="closeAllModals()">‡∏õ‡∏¥‡∏î</button>
      </div>
      
      <div style="margin-bottom:20px;">
          <label class="form-label">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏¢‡∏≤‡πÄ‡∏ö‡∏≤‡∏´‡∏ß‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</label>
          <select id="med-name" style="width:100%; border-radius:20px; padding:15px; font-size:24px; font-weight:700; color:#3E2723; border:3px solid #D7CCC8;">
              <option value="" disabled selected>-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏¢‡∏≤‡πÄ‡∏ö‡∏≤‡∏´‡∏ß‡∏≤‡∏ô --</option>
              <option value="Metformin">Metformin</option>
              <option value="Glipizide">Glipizide</option>
              <option value="Pioglitazone">Pioglitazone</option>
              <option value="Insulin">Insulin</option>
          </select>
      </div>

      <div style="margin-bottom:20px;">
          <label class="form-label">‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á</label>
          <div class="chip-container">
              <button class="chip-btn" onclick="selectMedChange('REDUCED', this)">‡∏•‡∏î‡∏¢‡∏≤</button>
              <button class="chip-btn" onclick="selectMedChange('STOPPED', this)">‡∏´‡∏¢‡∏∏‡∏î‡∏¢‡∏≤</button>
          </div>
          <input type="hidden" id="inp-medChange">
      </div>

      <div style="margin-bottom:20px;">
          <label class="form-label">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏¢‡∏≤</label>
          <input type="date" id="med-date" style="width:100%; border-radius:20px; padding:15px; font-size:24px; font-weight:700; color:#3E2723; border:3px solid #D7CCC8;">
      </div>

      <div style="margin-bottom:20px;">
          <label class="form-label">‡∏ß‡∏¥‡∏ò‡∏µ‡πÉ‡∏ä‡πâ‡πÄ‡∏î‡∏¥‡∏° (‡∏ñ‡πâ‡∏≤‡∏à‡∏≥‡πÑ‡∏î‡πâ)</label>
          <input type="text" id="med-prev" placeholder="‡πÄ‡∏ä‡πà‡∏ô 1 ‡πÄ‡∏°‡πá‡∏î 2 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á ‡∏´‡∏•‡∏±‡∏á‡∏≠‡∏≤‡∏´‡∏≤‡∏£" style="font-size:20px;">
      </div>
      
      <div id="med-curr-container" style="display:none; background:#FFF3E0; padding:15px; border-radius:20px; margin-bottom:20px;">
          <label class="form-label" style="color:#D84315;">‡∏ß‡∏¥‡∏ò‡∏µ‡πÉ‡∏ä‡πâ‡πÉ‡∏´‡∏°‡πà (‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏•‡∏î‡∏¢‡∏≤)</label>
          <div style="display:flex; gap:10px;">
              <input type="tel" id="med-pill" placeholder="‡πÄ‡∏°‡πá‡∏î" inputmode="decimal" style="flex:1; font-size:20px;" oninput="this.value = this.value.replace(/[^0-9.]/g, '')">
              <input type="tel" id="med-time" placeholder="‡∏Ñ‡∏£‡∏±‡πâ‡∏á/‡∏ß‡∏±‡∏ô" inputmode="numeric" style="flex:1; font-size:20px;" oninput="validateNumber(this)">
          </div>
          <select id="med-meal" style="width:100%; border-radius:20px; padding:15px; font-size:20px; font-weight:700; color:#3E2723; margin-top:10px; border:3px solid #D7CCC8;">
              <option value="‡∏Å‡πà‡∏≠‡∏ô‡∏≠‡∏≤‡∏´‡∏≤‡∏£">‡∏Å‡πà‡∏≠‡∏ô‡∏≠‡∏≤‡∏´‡∏≤‡∏£</option>
              <option value="‡∏´‡∏•‡∏±‡∏á‡∏≠‡∏≤‡∏´‡∏≤‡∏£">‡∏´‡∏•‡∏±‡∏á‡∏≠‡∏≤‡∏´‡∏≤‡∏£</option>
          </select>
      </div>

      <div style="margin-top:25px;"><button class="btn" onclick="saveMedication()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏¢‡∏≤ ‚úÖ</button></div>
    </div>
  </div>

  <!-- MODAL: Food (Bottom Sheet) -->
  <div id="food-modal" class="modal-overlay">
    <div class="modal-sheet">
      <div class="form-header">
        <div class="form-title">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏≠‡∏≤‡∏´‡∏≤‡∏£</div><button class="btn-close" onclick="closeAllModals()">‡∏õ‡∏¥‡∏î</button>
      </div>
      
      <div id="food-upload-zone" style="text-align:center;">
          <div style="display: flex; gap: 10px; margin-bottom: 20px;">
             <button class="btn" style="flex: 1; padding: 15px 10px; font-size: 22px;" onclick="$('#camera-input').click()">üì∏ ‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ</button>
             <button class="btn" style="flex: 1; padding: 15px 10px; font-size: 22px; background: #FFF9C4; color: #5D4037; border-color: #FBC02D;" onclick="$('#gallery-input').click()">üñºÔ∏è ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î</button>
          </div>
          <div style="text-align:center; color:#FFF59D; font-size:22px;">--- ‡∏´‡∏£‡∏∑‡∏≠‡∏û‡∏¥‡∏°‡∏û‡πå‡πÄ‡∏≠‡∏á ---</div>
      </div>

      <img id="food-preview" style="width:100%; border-radius:20px; margin-bottom:20px; display:none; border:4px solid #FFF;">

      <div id="food-loader" style="display:none; text-align:center; padding:20px; color:#FFF;">
          <div class="spinner" style="margin:0 auto; border-color: rgba(255,255,255,0.3); border-top-color: #FFF;"></div>
          <div style="margin-top:10px; font-size:20px;">AI ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•...</div>
      </div>
      
      <div id="food-rows-container"></div>
      
      <button id="btn-add-food" class="btn btn-add" onclick="addFoodRow(true)">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</button>
      
      <div style="margin-top:30px;">
        <button class="btn" onclick="saveFoodManual()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ‚úÖ</button>
      </div>
    </div>
  </div>

  <!-- MODAL: General Form (Bottom Sheet) -->
  <div id="form-modal" class="modal-overlay">
    <div class="modal-sheet">
      <div class="form-header"><div class="form-title" id="modal-title">...</div><button class="btn-close" onclick="closeAllModals()">‡∏õ‡∏¥‡∏î</button></div>
      <div id="modal-body"></div>
      <div style="margin-top:auto; padding-top:20px;"><button id="btn-save-form" class="btn" onclick="submitForm()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ‚úÖ</button></div>
    </div>
  </div>

  <!-- MODAL: Adverse (Centered) -->
  <div id="center-modal" class="modal-overlay centered">
    <div class="modal-card-center">
        <div class="form-header"><div class="form-title">‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡∏ú‡∏¥‡∏î‡∏õ‡∏Å‡∏ï‡∏¥</div><button class="btn-close" onclick="closeAllModals()">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏≠‡∏≤‡∏Å‡∏≤‡∏£</button></div>
        <div class="symptom-grid" id="symptom-options" style="display:grid; grid-template-columns:1fr 1fr; gap:15px;"></div>
        <textarea id="symptom-text" rows="3" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°..."></textarea>
        <button class="btn" onclick="submitSymptoms()" style="margin-top:25px;">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å üì®</button>
    </div>
  </div>

  <input type="file" id="camera-input" accept="image/*" capture="environment" style="display:none" onchange="uploadFoodImage(this)">
  <input type="file" id="gallery-input" accept="image/*" style="display:none" onchange="uploadFoodImage(this)">

<script>
    const GAS_URL = 'https://script.google.com/macros/s/AKfycbzvLY5kLKw2sUaSelEZcxka2CsdiRoGdA9jmHMoKs3oB04ypte7yDwStWo6cFwb2-Y8Sw/exec'; 
    // ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£ LIFF_ID ‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏î‡∏∂‡∏á‡∏°‡∏≤‡∏à‡∏≤‡∏Å Script Properties ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
    let LIFF_ID = ''; 
    const TEST_USER_ID = 'U4b2462c3ea87936a546558354070ef4d'; 

    const METRIC_CONFIG = {
      'SBGM': { title: '‡∏Ñ‡πà‡∏≤‡∏ô‡πâ‡∏≥‡∏ï‡∏≤‡∏•', unit: 'mg/dL', subtypes: ['‡∏Å‡πà‡∏≠‡∏ô‡∏≠‡∏≤‡∏´‡∏≤‡∏£', '‡∏´‡∏•‡∏±‡∏á‡∏≠‡∏≤‡∏´‡∏≤‡∏£', '‡∏Å‡πà‡∏≠‡∏ô‡∏ô‡∏≠‡∏ô'], placeholder: '‡∏£‡∏∞‡∏ö‡∏∏‡∏Ñ‡πà‡∏≤‡∏ô‡πâ‡∏≥‡∏ï‡∏≤‡∏•...' },
      'BP': { title: '‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡∏±‡∏ô‡πÇ‡∏•‡∏´‡∏¥‡∏ï', unit: 'mmHg', placeholder_sys: '‡∏ï‡∏±‡∏ß‡∏ö‡∏ô (130)', placeholder_dia: '‡∏ï‡∏±‡∏ß‡∏•‡πà‡∏≤‡∏á (80)' },
      'WEIGHT': { title: '‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å', unit: '‡∏Å‡∏Å.', placeholder: '‡∏Å‡∏µ‡πà‡∏Å‡∏¥‡πÇ‡∏•‡∏Ø ‡∏Ñ‡∏∞' },
      'EXERCISE': { title: '‡∏≠‡∏≠‡∏Å‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Å‡∏≤‡∏¢', activityList: ['‡πÄ‡∏î‡∏¥‡∏ô‡πÄ‡∏£‡πá‡∏ß', '‡∏ß‡∏¥‡πà‡∏á', '‡πÅ‡∏Å‡∏ß‡πà‡∏á‡πÅ‡∏Ç‡∏ô', '‡πÅ‡∏≠‡πÇ‡∏£‡∏ö‡∏¥‡∏Å', '‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏ö‡πâ‡∏≤‡∏ô', '‡∏õ‡∏±‡πà‡∏ô‡∏à‡∏±‡∏Å‡∏£‡∏¢‡∏≤‡∏ô'] }
    };

    let liffProfile = { userId: TEST_USER_ID, displayName: "‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô" }; 
    let userDisplayName = "‡∏Ñ‡∏∏‡∏ì";
    let currentMetric = '';
    const $ = selector => document.querySelector(selector);
    
    // --- MAIN ---
    async function main() {
      $('#loading').style.display = 'flex';
      try {
        // 1. ‡∏î‡∏∂‡∏á‡∏Ñ‡πà‡∏≤ LIFF ID ‡∏à‡∏≤‡∏Å Backend Script Properties
        const configRes = await apiPost('getConfig', {});
        if (configRes && configRes.liffId) {
            LIFF_ID = configRes.liffId;
        } else {
            console.warn("‡πÑ‡∏°‡πà‡∏û‡∏ö LIFF ID ‡∏à‡∏≤‡∏Å Backend ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏£‡∏±‡∏ô‡πÉ‡∏ô‡πÇ‡∏´‡∏°‡∏î‡∏ó‡∏î‡∏™‡∏≠‡∏ö");
        }

        // 2. ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ LIFF ID ‡πÉ‡∏´‡πâ‡∏ó‡∏≥‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö LINE
        if (LIFF_ID) {
            await liff.init({ liffId: LIFF_ID });
            if (liff.isLoggedIn()) {
                liffProfile = await liff.getProfile();
            } else {
                liff.login();
                return; 
            }
        } else {
            // ‡πÇ‡∏´‡∏°‡∏î‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡∏°‡∏µ LIFF ID
            liffProfile.userId = TEST_USER_ID; 
        }
      } catch (err) { 
          console.error("LIFF Init Error:", err);
          liffProfile.userId = TEST_USER_ID; 
      }
      
      const params = new URLSearchParams(window.location.search);
      if(params.get('action') === 'food') openFoodModal();

      fetchUserProfile().then(() => $('#loading').style.display = 'none');
    }

    function switchView(viewName) {
      document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
      if (viewName === 'note') $('#note-view').classList.add('active');
      else if (viewName === 'dashboard') $('#dashboard-view').classList.add('active');
      else if (viewName === 'register') {
          $('#register-view').classList.add('active');
          goToRegStep(1); 
      }
      window.scrollTo(0,0);
    }

    window.validateNumber = function(input) { input.value = input.value.replace(/[^0-9.]/g, ''); }

    // =========================================================
    // REGISTRATION LOGIC
    // =========================================================
    let regData = { group: '', nameUse: '', hn: '', gender: '', age: '', weight: '', consent: false };

    // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡∏™‡∏î‡πÜ ‡∏´‡∏ô‡πâ‡∏≤‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô
    const regWeightInput = document.getElementById('reg-weight');
    if(regWeightInput) {
        regWeightInput.addEventListener('input', function() {
            const w = parseFloat(this.value);
            const msgBox = document.getElementById('reg-weight-target-msg');
            if(w && w > 0) {
                const target = (w * 0.1).toFixed(1);
                msgBox.innerHTML = `‡πÇ‡∏≠‡∏Å‡∏≤‡∏™‡∏õ‡∏£‡∏∞‡∏™‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏´‡∏¢‡∏∏‡∏î‡∏¢‡∏≤ ‡∏ï‡πâ‡∏≠‡∏á‡∏•‡∏î‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡∏•‡∏á <b style="font-size:24px;">${target}</b> ‡∏Å‡∏¥‡πÇ‡∏•‡∏Å‡∏£‡∏±‡∏°<br>‡∏†‡∏≤‡∏¢‡πÉ‡∏ô 6 ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô üî• ‡∏™‡∏π‡πâ‡πÑ‡∏´‡∏° ‡πÄ‡∏£‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏ó‡∏≥‡πÑ‡∏î‡πâ!`;
                msgBox.style.display = 'flex';
            } else {
                msgBox.style.display = 'none';
            }
        });
    }

    function goToRegStep(step) {
        document.querySelectorAll('.reg-step').forEach(el => el.classList.remove('active'));
        const stepEl = $('#reg-step-' + step);
        stepEl.classList.remove('active');
        void stepEl.offsetWidth; 
        stepEl.classList.add('active');
        window.scrollTo(0,0);
    }

    function selectRegGroup(group) {
        regData.group = group;
        if (group === 'DM Remission') {
            goToRegStep(2);
        } else {
            setupRegForm();
            goToRegStep(3);
        }
    }

    function selectGender(labelEl, value) {
        document.querySelectorAll('.reg-radio-label').forEach(el => el.classList.remove('active'));
        labelEl.classList.add('active');
        labelEl.querySelector('input').checked = true;
        regData.gender = value;
    }

    function setupRegForm() {
        $('#reg-prof-img').src = liffProfile.pictureUrl || 'https://cdn-icons-png.flaticon.com/512/3135/3135715.png';
        $('#reg-prof-name').innerText = liffProfile.displayName;
        $('#reg-prof-group').innerText = '‡∏Å‡∏•‡∏∏‡πà‡∏°: ' + regData.group;
        // set default date field to today if exist
    }

    async function submitRegistration(e) {
        e.preventDefault();
        regData.nameUse = $('#reg-name').value.trim();
        regData.hn = $('#reg-hn').value.trim();
        regData.gender = document.querySelector('input[name="reg-gender"]:checked')?.value;
        regData.age = $('#reg-age').value.trim();
        regData.weight = $('#reg-weight').value.trim();
        regData.consent = $('#reg-consent').checked;

        if(!regData.gender) return Swal.fire({ title: '‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô', text: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏û‡∏®‡∏î‡πâ‡∏ß‡∏¢‡∏ô‡∏∞‡∏Ñ‡∏∞', icon: 'warning' });
        if(regData.hn.length !== 9) return Swal.fire({ title: '‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô', text: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏ HN ‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö 9 ‡∏´‡∏•‡∏±‡∏Å', icon: 'warning' });

        $('#loading').style.display = 'flex';
        const payload = { userId: liffProfile.userId, displayName: liffProfile.displayName, pictureUrl: liffProfile.pictureUrl || '', ...regData };
        const res = await apiPost('registerUser', payload);
        
        if(res && res.ok) {
            goToRegStep(4);
            setTimeout(() => { fetchUserProfile(); }, 2500); 
        } else {
            $('#loading').style.display = 'none';
            Swal.fire('‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÑ‡∏î‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà', 'error');
        }
    }

    // --- HELPER ---
    function getSelectorHTML(options) {
        let html = `<div class="custom-selector-container">`;
        options.forEach(opt => { html += `<button class="custom-selector-btn" onclick="selectCustom(this)">${opt}</button>`; });
        html += `</div>`; return html;
    }
    window.selectCustom = function(btn) {
        const container = btn.parentElement;
        container.querySelectorAll('.custom-selector-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
    }

    function closeAllModals() {
        document.querySelectorAll('.modal-overlay').forEach(m => m.style.display = 'none');
    }

    // --- NEW: BODY COMPOSITION ---
    function openBodyCompModal() {
        ['bc-fat', 'bc-visceral', 'bc-muscle', 'bc-bmi', 'bc-rm', 'bc-age'].forEach(id => $('#'+id).value = '');
        $('#bodycomp-modal').style.display = 'flex';
    }
    async function saveBodyComp() {
        const d = {
            '%FAT': { v: $('#bc-fat').value, u: '%' },
            'VISCERALFAT': { v: $('#bc-visceral').value, u: '‡∏£‡∏∞‡∏î‡∏±‡∏ö' },
            'MUSCLE': { v: $('#bc-muscle').value, u: '%' },
            'BMI': { v: $('#bc-bmi').value, u: 'kg/m¬≤' },
            'RESTINGMET': { v: $('#bc-rm').value, u: 'kcal' },
            'BODYAGE': { v: $('#bc-age').value, u: '‡∏õ‡∏µ' }
        };
        let tasks = [];
        for (const [type, data] of Object.entries(d)) {
            if (data.v) {
                tasks.push(apiPost('logEvent', { userId: liffProfile.userId, type: type, v1: parseFloat(data.v), unit: data.u }));
            }
        }
        if (tasks.length === 0) return Swal.fire('‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ß‡πà‡∏≤‡∏á', '‡∏£‡∏∞‡∏ö‡∏∏‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏ä‡πà‡∏≠‡∏á‡∏ô‡∏∞‡∏Ñ‡∏∞', 'warning');
        
        $('#loading').style.display = 'flex';
        await Promise.all(tasks);
        $('#loading').style.display = 'none';
        closeAllModals();
        Swal.fire({ title:'‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡πâ‡∏ß', icon:'success', timer:1500, showConfirmButton:false });
    }

    // --- NEW: MEDICATIONS ---
    function openMedicationModal() {
        $('#med-name').value = '';
        $('#inp-medChange').value = '';
        $('#med-date').value = new Date().toISOString().split('T')[0];
        $('#med-prev').value = '';
        $('#med-pill').value = '';
        $('#med-time').value = '';
        document.querySelectorAll('#med-modal .chip-btn').forEach(b => b.classList.remove('active'));
        $('#med-curr-container').style.display = 'none';
        $('#med-modal').style.display = 'flex';
    }
    
    function selectMedChange(value, btn) {
        $('#inp-medChange').value = value;
        btn.parentElement.querySelectorAll('.chip-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        if (value === 'REDUCED') {
            $('#med-curr-container').style.display = 'block';
        } else {
            $('#med-curr-container').style.display = 'none';
        }
    }

    async function saveMedication() {
        const medName = $('#med-name').value;
        const changeType = $('#inp-medChange').value;
        const actionDate = $('#med-date').value;
        const prev = $('#med-prev').value.trim();
        
        if(!medName || !changeType || !actionDate) return Swal.fire('‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏¢‡∏≤, ‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô ‡πÅ‡∏•‡∏∞‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡πà‡∏∞', 'warning');
        
        let curr = '';
        if(changeType === 'REDUCED') {
            const p = $('#med-pill').value;
            const t = $('#med-time').value;
            const m = $('#med-meal').value;
            if(!p || !t) return Swal.fire('‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏°‡πá‡∏î‡πÅ‡∏•‡∏∞‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ß‡∏¥‡∏ò‡∏µ‡πÉ‡∏ä‡πâ‡πÉ‡∏´‡∏°‡πà‡∏Ñ‡πà‡∏∞', 'warning');
            curr = `${p} ‡πÄ‡∏°‡πá‡∏î ‡∏ß‡∏±‡∏ô‡∏•‡∏∞ ${t} ‡∏Ñ‡∏£‡∏±‡πâ‡∏á ${m}`;
        } else {
            curr = '‡∏´‡∏¢‡∏∏‡∏î‡∏¢‡∏≤';
        }

        $('#loading').style.display = 'flex';
        await apiPost('logMedication', {
            userId: liffProfile.userId,
            medName: medName,
            changeType: changeType,
            actionDate: actionDate,
            previousRegimen: prev,
            currentRegimen: curr
        });
        $('#loading').style.display = 'none';
        closeAllModals();
        Swal.fire({ title:'‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏¢‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢', icon:'success', timer:2000, showConfirmButton:false });
    }

    // --- NEW: SLEEP / STRESS ---
    function openSleepStressModal() {
        const opts = ['‡∏ô‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏ö‡∏î‡∏µ', '‡∏ô‡∏≠‡∏ô‡πÑ‡∏°‡πà‡∏´‡∏•‡∏±‡∏ö', '‡∏°‡∏µ‡∏™‡∏°‡∏≤‡∏ò‡∏¥‡∏ô‡πâ‡∏≠‡∏¢', '‡∏´‡∏á‡∏∏‡∏î‡∏´‡∏á‡∏¥‡∏î', '‡πÄ‡∏ö‡∏∑‡πà‡∏≠‡πÄ‡∏ã‡πá‡∏á', '‡πÑ‡∏°‡πà‡∏≠‡∏¢‡∏≤‡∏Å‡∏û‡∏ö‡∏Ñ‡∏ô', '‡∏≠‡∏∑‡πà‡∏ô‡πÜ (‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏≠‡∏á)'];
        let html = `<div class="chip-container">`;
        opts.forEach(o => html += `<button class="chip-btn" style="min-width:45%;" onclick="processSleepChoice('${o}')">${o}</button>`);
        html += `</div>`;

        Swal.fire({
            title: '‡∏Å‡∏≤‡∏£‡∏ô‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏ö‡πÅ‡∏•‡∏∞‡∏à‡∏¥‡∏ï‡πÉ‡∏à',
            html: html,
            showConfirmButton: false, showCloseButton: true
        });
    }

    window.processSleepChoice = async function(choice) {
        Swal.close();
        if (choice === '‡∏ô‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏ö‡∏î‡∏µ') {
            const { value: hrs } = await Swal.fire({ 
                title: '‡πÄ‡∏¢‡∏µ‡πà‡∏¢‡∏°‡πÄ‡∏•‡∏¢‡∏Ñ‡πà‡∏∞!', text: '‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Ñ‡∏∑‡∏ô‡∏ô‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏Å‡∏µ‡πà‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á‡∏Ñ‡∏∞?', input: 'tel',
                confirmButtonText: '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å', showCancelButton: true, cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å',
                inputAttributes: { oninput: "this.value = this.value.replace(/[^0-9.]/g, '')" }
            });
            if (hrs) {
                $('#loading').style.display = 'flex';
                await apiPost('logEvent', { userId: liffProfile.userId, type: 'SLEEP', vt: '‡∏ô‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏ö‡∏î‡∏µ', v1: hrs, unit: '‡∏ä‡∏°.' });
                $('#loading').style.display = 'none';
                Swal.fire({ title:'‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡πâ‡∏ß', text:'‡∏Ç‡∏≠‡πÉ‡∏´‡πâ‡∏Ñ‡∏∑‡∏ô‡∏ô‡∏µ‡πâ‡∏ô‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏ö‡∏ù‡∏±‡∏ô‡∏î‡∏µ‡∏≠‡∏µ‡∏Å‡∏ô‡∏∞‡∏Ñ‡∏∞ üíñ', icon:'success', timer:2000, showConfirmButton:false });
            }
        } else {
            let actualChoice = choice;
            if (choice === '‡∏≠‡∏∑‡πà‡∏ô‡πÜ (‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏≠‡∏á)') {
                const { value: customText } = await Swal.fire({ title: '‡∏£‡∏π‡πâ‡∏™‡∏∂‡∏Å‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÑ‡∏£‡∏Ñ‡∏∞?', input: 'text', confirmButtonText: '‡∏ñ‡∏±‡∏î‡πÑ‡∏õ', showCancelButton: true });
                if (!customText) return;
                actualChoice = customText;
            }

            const scaleHTML = `
                <p style="margin-bottom:15px;">‡∏≠‡∏≤‡∏Å‡∏≤‡∏£ "${actualChoice}" ‡∏°‡∏µ‡∏°‡∏≤‡∏Å‡πÅ‡∏Ñ‡πà‡πÑ‡∏´‡∏ô?</p>
                <div style="display:grid; grid-template-columns:1fr; gap:10px;">
                    <button class="score-btn" onclick="saveStress('${actualChoice}', 0)">0 - ‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏•‡∏¢</button>
                    <button class="score-btn" onclick="saveStress('${actualChoice}', 1)">1 - ‡πÄ‡∏õ‡πá‡∏ô‡∏™‡πà‡∏ß‡∏ô‡∏ô‡πâ‡∏≠‡∏¢</button>
                    <button class="score-btn" onclick="saveStress('${actualChoice}', 2)">2 - ‡∏õ‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á</button>
                    <button class="score-btn" onclick="saveStress('${actualChoice}', 3)">3 - ‡πÄ‡∏õ‡πá‡∏ô‡∏°‡∏≤‡∏Å</button>
                    <button class="score-btn" onclick="saveStress('${actualChoice}', 4)">4 - ‡πÄ‡∏õ‡πá‡∏ô‡∏õ‡∏£‡∏∞‡∏à‡∏≥ (‡∏Å‡∏£‡∏∞‡∏ó‡∏ö‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï)</button>
                </div>
            `;
            Swal.fire({ title: '‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏≠‡∏≤‡∏Å‡∏≤‡∏£', html: scaleHTML, showConfirmButton: false, showCancelButton: true, cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å' });
        }
    }

    window.saveStress = async function(symptom, score) {
        Swal.close();
        $('#loading').style.display = 'flex';
        await apiPost('logEvent', { userId: liffProfile.userId, type: 'STRESS', vt: symptom, v1: score, unit: '‡∏£‡∏∞‡∏î‡∏±‡∏ö' });
        $('#loading').style.display = 'none';
        Swal.fire({ title: '‡πÄ‡∏Å‡πà‡∏á‡∏°‡∏≤‡∏Å‡∏ó‡∏µ‡πà‡∏™‡∏±‡∏á‡πÄ‡∏Å‡∏ï‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á', text: '‡∏û‡∏±‡∏Å‡∏ú‡πà‡∏≠‡∏ô‡πÅ‡∏•‡∏∞‡∏î‡∏π‡πÅ‡∏•‡πÉ‡∏à‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á‡∏î‡πâ‡∏ß‡∏¢‡∏ô‡∏∞‡∏Ñ‡∏∞ üíñ', icon: 'info', confirmButtonText: '‡∏£‡∏±‡∏ö‡∏ó‡∏£‡∏≤‡∏ö' });
    }

    // --- FOOD SYSTEM ---
    function openFoodModal() {
        $('#food-modal').style.display = 'flex';
        $('#food-rows-container').innerHTML = ''; 
        $('#food-preview').style.display = 'none';
        $('#food-upload-zone').style.display = 'block';
        addFoodRow(true);
    }

    function addFoodRow(isInput = false, name='', qty='', unit='') {
        const div = document.createElement('div');
        div.className = 'food-row-wrapper'; 
        if (isInput) div.innerHTML = `
            <div class="food-row" style="grid-template-columns: 2fr 1fr 1fr; display:grid; gap:10px; margin-bottom:15px;">
                <input type="text" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏≠‡∏≤‡∏´‡∏≤‡∏£" value="${name}" class="food-name">
                <input type="tel" placeholder="‡∏à‡∏≥‡∏ô‡∏ß‡∏ô" value="${qty}" class="food-qty" inputmode="decimal" oninput="this.value = this.value.replace(/[^0-9.]/g, '')">
                <input type="text" placeholder="‡∏´‡∏ô‡πà‡∏ß‡∏¢" value="${unit}" class="food-unit">
            </div>`;
        else div.innerHTML = `
            <div class="food-card" style="background:#FFF; border-radius:25px; padding:15px; margin-bottom:10px; display:flex; justify-content:space-between; align-items:center;">
                <div style="text-align:left;">
                    <div style="font-size:24px; font-weight:800; color:#5D4037;">${name}</div><div style="font-size:20px; color:#8D6E63;">${qty} ${unit}</div>
                </div>
                <button onclick="switchToEdit(this, '${name}', '${qty}', '${unit}')" style="background:#FFF59D; color:#5D4037; border:none; border-radius:50%; width:40px; height:40px; font-size:20px;">‚úèÔ∏è</button>
            </div>
            <div class="food-row hidden-inputs" style="display:none;"><input type="text" value="${name}" class="food-name"><input type="tel" value="${qty}" class="food-qty"><input type="text" value="${unit}" class="food-unit"></div>`;
        $('#food-rows-container').appendChild(div);
    }

    window.switchToEdit = function(btn, name, qty, unit) {
        btn.closest('.food-row-wrapper').innerHTML = `
            <div class="food-row" style="grid-template-columns: 2fr 1fr 1fr; display:grid; gap:10px; margin-bottom:15px;">
                <input type="text" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏≠‡∏≤‡∏´‡∏≤‡∏£" value="${name}" class="food-name">
                <input type="tel" placeholder="‡∏à‡∏≥‡∏ô‡∏ß‡∏ô" value="${qty}" class="food-qty" inputmode="decimal" oninput="this.value = this.value.replace(/[^0-9.]/g, '')">
                <input type="text" placeholder="‡∏´‡∏ô‡πà‡∏ß‡∏¢" value="${unit}" class="food-unit">
            </div>`;
    }

    async function uploadFoodImage(input) {
      if (!input.files || !input.files[0]) return;
      $('#food-upload-zone').style.display = 'none';
      $('#food-loader').style.display = 'block';
      try {
        const reader = new FileReader();
        reader.readAsDataURL(input.files[0]);
        reader.onload = async (e) => {
            const img = new Image(); img.src = e.target.result;
            img.onload = async () => {
                const canvas = document.createElement('canvas');
                let w = img.width, h = img.height, max = 512;
                if (w > h) { if (w > max) { h *= max / w; w = max; } } else { if (h > max) { w *= max / h; h = max; } }
                canvas.width = w; canvas.height = h;
                canvas.getContext('2d').drawImage(img, 0, 0, w, h);
                const base64 = canvas.toDataURL('image/jpeg', 0.6).split(',')[1];
                
                $('#food-preview').src = img.src; $('#food-preview').style.display = 'block';
                const res = await apiPost('uploadFoodImage', { userId: liffProfile.userId, imageBase64: base64 });
                $('#food-loader').style.display = 'none'; 
                
                console.log("AI Debug:", res.debug); // ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÉ‡∏ô Console
                
                if (res.notFood) {
                    let debugMsg = (res.debug && res.debug.length > 0) ? res.debug.join('<br>') : '';
                    let htmlMsg = res.message;
                    if (debugMsg) htmlMsg += `<br><br><div style="font-size:12px; color:#D32F2F; text-align:left; background:#FFEBEE; padding:10px; border-radius:10px; max-height:150px; overflow-y:auto; border: 1px solid #EF9A9A;"><b>Debug Info:</b><br>${debugMsg}</div>`;
                    
                    Swal.fire({ title: '‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡∏Ç‡∏≠‡∏á‡∏Å‡∏¥‡∏ô‡πÅ‡∏ô‡πà‡πÄ‡∏•‡∏¢', html: htmlMsg, icon: 'warning', confirmButtonText: '‡∏ñ‡πà‡∏≤‡∏¢‡πÉ‡∏´‡∏°‡πà' });
                    $('#food-upload-zone').style.display = 'block'; $('#food-preview').style.display = 'none';
                } else if(res.ok && res.items) {
                    $('#food-rows-container').innerHTML = ''; 
                    const isFallback = res.items.length === 1 && res.items[0].name.includes("‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏≠‡∏á");
                    if (isFallback) {
                        let debugMsg = (res.debug && res.debug.length > 0) ? res.debug.join('<br>') : '‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏';
                        Swal.fire({ 
                            title: 'AI ‡∏Ç‡∏±‡∏î‡∏Ç‡πâ‡∏≠‡∏á üòÖ', 
                            html: `‡∏£‡∏∞‡∏ö‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏£‡∏π‡∏õ‡πÑ‡∏î‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ä‡∏∑‡πà‡∏≠‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡πÄ‡∏≠‡∏á‡∏ô‡∏∞‡∏Ñ‡∏∞<br><br><div style="font-size:12px; color:#D32F2F; text-align:left; background:#FFEBEE; padding:10px; border-radius:10px; max-height:150px; overflow-y:auto; border: 1px solid #EF9A9A;"><b>Debug Info:</b><br>${debugMsg}</div>`, 
                            icon: 'warning', 
                            confirmButtonText: '‡∏û‡∏¥‡∏°‡∏û‡πå‡πÄ‡∏≠‡∏á' 
                        });
                    } else {
                        Swal.fire({ title: 'AI ‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß!', text: '‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏•‡∏¢‡∏Ñ‡πà‡∏∞', icon: 'success', confirmButtonText: '‡∏ï‡∏Å‡∏•‡∏á' });
                    }
                    res.items.forEach(item => addFoodRow(false, item.name, item.qty, item.unit));
                } else {
                    let debugMsg = (res.debug && res.debug.length > 0) ? res.debug.join('<br>') : '';
                    let htmlMsg = res.message || '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î';
                    if (debugMsg) htmlMsg += `<br><br><div style="font-size:12px; color:#D32F2F; text-align:left; background:#FFEBEE; padding:10px; border-radius:10px; max-height:150px; overflow-y:auto; border: 1px solid #EF9A9A;"><b>Debug Info:</b><br>${debugMsg}</div>`;
                    
                    $('#food-upload-zone').style.display = 'block'; 
                    Swal.fire({title: '‡∏Ç‡∏≠‡∏≠‡∏†‡∏±‡∏¢', html: htmlMsg, icon: 'error'});
                }
            };
        };
      } catch(err) { 
        $('#food-loader').style.display='none'; 
        $('#food-upload-zone').style.display='block'; 
        Swal.fire({title: '‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', text: err.message, icon: 'error'}); 
      }
      input.value = ''; 
    }

    async function saveFoodManual() {
        const rows = document.querySelectorAll('.food-row-wrapper'); 
        let items = [];
        for (let wrapper of rows) {
            let n, q, u;
            if(wrapper.querySelector('input.food-name')) {
                n = wrapper.querySelector('.food-name').value.trim();
                q = wrapper.querySelector('.food-qty').value.trim();
                u = wrapper.querySelector('.food-unit').value.trim();
            }
            if (n) {
                if (!q || !u) {
                    const { value: v } = await Swal.fire({
                        title: `${n} ‡∏ó‡∏≤‡∏ô‡πÄ‡∏ó‡πà‡∏≤‡πÑ‡∏´‡∏£‡πà‡∏Ñ‡∏∞?`,
                        html: `<div style="margin-bottom:10px;">‡∏£‡∏∞‡∏ö‡∏∏‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÅ‡∏•‡∏∞‡∏´‡∏ô‡πà‡∏ß‡∏¢</div><input id="swal-qty" class="swal2-input" type="tel"><input id="swal-unit" class="swal2-input">`,
                        preConfirm: () => [$('#swal-qty').value, $('#swal-unit').value]
                    });
                    if (v && v[0] && v[1]) { q = v[0]; u = v[1]; } else return;
                }
                items.push({ name: n, qty: q, unit: u });
            }
        }

        if (items.length === 0) return Swal.fire('‡∏ß‡πà‡∏≤‡∏á‡πÄ‡∏õ‡∏•‡πà‡∏≤', '‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡∏∞‡∏Ñ‡∏∞', 'warning');
        const hr = new Date().getHours();
        let def = '‡∏ß‡πà‡∏≤‡∏á'; if(hr>=6 && hr<11) def='‡πÄ‡∏ä‡πâ‡∏≤'; else if(hr>=11 && hr<14) def='‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏á'; else if(hr>=14 && hr<24) def='‡πÄ‡∏¢‡πá‡∏ô';
        const { value: mealVal } = await Swal.fire({
            title: '‡∏ó‡∏≤‡∏ô‡∏°‡∏∑‡πâ‡∏≠‡πÑ‡∏´‡∏ô‡∏Ñ‡∏∞?', html: getSelectorHTML(['‡πÄ‡∏ä‡πâ‡∏≤', '‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏á', '‡πÄ‡∏¢‡πá‡∏ô', '‡∏ß‡πà‡∏≤‡∏á']), showCancelButton: true,
            preConfirm: () => { const s = document.querySelector('.custom-selector-btn.active'); return s ? s.innerText : null; }
        });
        if (!mealVal) return;

        $('#loading').style.display = 'flex';
        const evalRes = await apiPost('evaluateFoodText', { items: items });
        if (evalRes && evalRes.isValid === false) {
            $('#loading').style.display = 'none'; return Swal.fire('‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•', evalRes.reason, 'warning');
        }

        const adviceFlag = (evalRes && evalRes.advice) ? evalRes.advice : '-';
        const img = window.lastUploadedImageUrl || ''; 
        for (let i of items) await apiPost('logEvent', { userId: liffProfile.userId, type: 'FOOD', subtype: `‡∏°‡∏∑‡πâ‡∏≠${mealVal}`, vt: i.name, v1: i.qty, unit: i.unit, img: img, predefinedFlag: adviceFlag });
        
        $('#loading').style.display = 'none'; closeAllModals();
        Swal.fire({ title: '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡πâ‡∏ß', text: adviceFlag !== '-' ? adviceFlag : '‡∏ó‡∏≤‡∏ô‡πÉ‡∏´‡πâ‡∏≠‡∏£‡πà‡∏≠‡∏¢‡∏ô‡∏∞‡∏Ñ‡∏∞', icon: 'success', timer: 3000 });
    }

    // --- FORM LOGIC (SBGM & OTHERS) ---
    function openNoteForm(metric) {
      currentMetric = metric;
      const conf = METRIC_CONFIG[metric];
      $('#modal-title').innerText = metric === 'EXERCISE' ? `‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏Ñ‡∏∏‡∏ì ${userDisplayName} ‡∏≠‡∏≠‡∏Å‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Å‡∏≤‡∏¢‡∏≠‡∏∞‡πÑ‡∏£‡∏Ñ‡∏∞` : conf.title;
      
      let html = '';
      if (metric === 'EXERCISE') {
          html += `<div class="chip-container" id="chip-activity">`;
          conf.activityList.forEach(s => html += `<button class="chip-btn" onclick="selectOption('subtype', '${s}', this)">${s}</button>`);
          html += `</div><div class="form-label" style="margin-top:10px;">‡∏´‡∏£‡∏∑‡∏≠‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏≠‡∏∑‡πà‡∏ô‡πÜ</div>
                   <input type="text" id="inp-val1" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°..." style="margin-bottom:0;"><input type="hidden" id="inp-subtype">`;
      } else {
          if (conf.subtypes) {
             html += `<div class="form-label">‡∏ß‡∏±‡∏î‡∏ï‡∏≠‡∏ô‡πÑ‡∏´‡∏ô‡∏Ñ‡∏∞?</div><div class="chip-container" id="chip-subtype">`;
             conf.subtypes.forEach(s => html += `<button class="chip-btn" onclick="selectOption('subtype', '${s}', this)">${s}</button>`);
             html += `</div><input type="hidden" id="inp-subtype">`;
          }
          if (metric === 'BP') {
             html += `<input type="tel" id="inp-val1" placeholder="‡∏ï‡∏±‡∏ß‡∏ö‡∏ô" inputmode="numeric" oninput="validateNumber(this)"><input type="tel" id="inp-val2" placeholder="‡∏ï‡∏±‡∏ß‡∏•‡πà‡∏≤‡∏á" inputmode="numeric" oninput="validateNumber(this)">`;
          } else {
             html += `<input type="tel" id="inp-val1" placeholder="${conf.placeholder}" inputmode="decimal" oninput="validateNumber(this)">`;
          }
      }
      $('#modal-body').innerHTML = html;
      $('#form-modal').style.display = 'flex'; 
    }

    window.selectOption = function(type, value, btn) {
      if(type === 'subtype') $('#inp-subtype').value = value;
      if(currentMetric === 'EXERCISE') $('#inp-val1').value = value;
      btn.parentElement.querySelectorAll('.chip-btn').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
    }

    async function submitForm() {
      const metric = currentMetric;
      const elSubtype = $('#inp-subtype');
      const v1 = $('#inp-val1') ? $('#inp-val1').value : null;
      const v2 = $('#inp-val2') ? $('#inp-val2').value : null;
      let subtype = elSubtype ? elSubtype.value : null;

      if (metric === 'BP') {
          if (!v1 || !v2) return Swal.fire('‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏ï‡∏±‡∏ß‡∏ö‡∏ô ‡πÅ‡∏•‡∏∞‡∏ï‡∏±‡∏ß‡∏•‡πà‡∏≤‡∏á‡∏ô‡∏∞‡∏Ñ‡∏∞', 'warning');
          const sys = parseFloat(v1); const dia = parseFloat(v2);
          if (sys > 300 || dia > 200) return Swal.fire('‡∏Ñ‡πà‡∏≤‡∏ú‡∏¥‡∏î‡∏õ‡∏Å‡∏ï‡∏¥', '‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡∏±‡∏ô‡πÑ‡∏°‡πà‡∏ô‡πà‡∏≤‡∏à‡∏∞‡∏™‡∏π‡∏á‡∏Ç‡∏ô‡∏≤‡∏î‡∏ô‡∏µ‡πâ ‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ú‡∏¥‡∏î‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏õ‡∏•‡πà‡∏≤‡∏Ñ‡∏∞', 'error');
          if (sys > 130 || dia > 80) {
              const cf = await Swal.fire({ title: '‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡∏±‡∏ô‡∏™‡∏π‡∏á', html: '‡πÄ‡∏Å‡∏ì‡∏ë‡πå‡∏õ‡∏Å‡∏ï‡∏¥‡∏Ñ‡∏∑‡∏≠ 130/80<br>‡∏ô‡∏±‡πà‡∏á‡∏û‡∏±‡∏Å‡πÅ‡∏•‡πâ‡∏ß‡∏ß‡∏±‡∏î‡πÉ‡∏´‡∏°‡πà‡∏ô‡∏∞', icon: 'warning', showCancelButton: true, confirmButtonText: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô', cancelButtonText: '‡∏ß‡∏±‡∏î‡πÉ‡∏´‡∏°‡πà' });
              if (!cf.isConfirmed) return;
          }
      } else if (metric !== 'EXERCISE' && !v1) {
          return Swal.fire('‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ß‡πà‡∏≤‡∏á‡πÄ‡∏õ‡∏•‡πà‡∏≤', '‡∏£‡∏∞‡∏ö‡∏∏‡∏Ñ‡πà‡∏≤‡∏Å‡πà‡∏≠‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ô‡∏∞‡∏Ñ‡∏∞', 'warning');
      }

      if (metric === 'EXERCISE') {
          if (!v1) return Swal.fire('‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö', '‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏Å‡πà‡∏≠‡∏ô‡∏ô‡∏∞‡∏Ñ‡∏∞', 'warning');
          const { value: mins } = await Swal.fire({ title: `${v1} ‡πÑ‡∏õ‡∏Å‡∏µ‡πà‡∏ô‡∏≤‡∏ó‡∏µ‡∏Ñ‡∏∞?`, input: 'tel', showCancelButton: true, inputAttributes: { oninput: "validateNumber(this)" } });
          if (!mins) return;
          $('#loading').style.display = 'flex';
          await apiPost('logEvent', { userId: liffProfile.userId, type: metric, vt: v1, v1: parseInt(mins) });
          $('#loading').style.display = 'none'; closeAllModals();
          return Swal.fire({ title:'‡πÄ‡∏Å‡πà‡∏á‡∏°‡∏≤‡∏Å‡∏Ñ‡πà‡∏∞', icon:'success', timer:1500, showConfirmButton:false });
      }

      if (metric === 'SBGM') {
          if (!subtype) {
             const { value: tVal } = await Swal.fire({ title: '‡∏ß‡∏±‡∏î‡∏ï‡∏≠‡∏ô‡πÑ‡∏´‡∏ô‡∏Ñ‡∏∞?', html: getSelectorHTML(['‡∏Å‡πà‡∏≠‡∏ô‡∏≠‡∏≤‡∏´‡∏≤‡∏£', '‡∏´‡∏•‡∏±‡∏á‡∏≠‡∏≤‡∏´‡∏≤‡∏£', '‡∏Å‡πà‡∏≠‡∏ô‡∏ô‡∏≠‡∏ô']), showCancelButton: true, preConfirm: () => { const s = document.querySelector('.custom-selector-btn.active'); return s ? s.innerText : null; } });
             if (tVal) subtype = tVal; else return;
          }
          const val = parseFloat(v1);
          
          if (val < 20 || val > 600) return Swal.fire('‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏õ‡∏•‡∏Å‡πÜ', '‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÉ‡∏™‡πà‡∏°‡∏≤‡∏î‡∏π‡πÑ‡∏°‡πà‡∏ô‡πà‡∏≤‡∏à‡∏∞‡πÉ‡∏ä‡πà‡∏Ñ‡πà‡∏≤‡∏ô‡πâ‡∏≥‡∏ï‡∏≤‡∏•‡πÉ‡∏ô‡πÄ‡∏•‡∏∑‡∏≠‡∏î ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏•‡πâ‡∏ß‡∏û‡∏¥‡∏°‡∏û‡πå‡πÉ‡∏´‡∏°‡πà‡∏ô‡∏∞‡∏Ñ‡∏∞', 'error');

          const highLimit = (subtype === '‡∏´‡∏•‡∏±‡∏á‡∏≠‡∏≤‡∏´‡∏≤‡∏£') ? 140 : 110;
          
          if (val < 70 || val > highLimit) {
               const msg = val < 70 ? '‡∏ô‡πâ‡∏≥‡∏ï‡∏≤‡∏•‡∏ï‡πà‡∏≥‡∏ú‡∏¥‡∏î‡∏õ‡∏Å‡∏ï‡∏¥' : '‡∏ô‡πâ‡∏≥‡∏ï‡∏≤‡∏•‡∏™‡∏π‡∏á‡πÄ‡∏Å‡∏¥‡∏ô‡πÄ‡∏Å‡∏ì‡∏ë‡πå';
               const confirm = await Swal.fire({ title: msg, html: `‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏ß‡∏±‡∏î‡πÑ‡∏î‡πâ‡∏Ñ‡∏∑‡∏≠ <b>${val}</b> ‡∏°‡∏Å./‡∏î‡∏•.<br>‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?`, icon: 'warning', confirmButtonText: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô (‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á)', showCancelButton: true, cancelButtonText: '‡∏û‡∏¥‡∏°‡∏û‡πå‡πÉ‡∏´‡∏°‡πà' });
               if (!confirm.isConfirmed) return;
               
               let advice = val < 70 ? '‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥: ‡∏£‡∏µ‡∏ö‡∏à‡∏¥‡∏ö‡∏ô‡πâ‡∏≥‡∏´‡∏ß‡∏≤‡∏ô 3 ‡∏ä‡πâ‡∏≠‡∏ô‡∏ä‡∏≤ ‡πÅ‡∏•‡πâ‡∏ß‡∏ô‡∏±‡πà‡∏á‡∏û‡∏±‡∏Å 15 ‡∏ô‡∏≤‡∏ó‡∏µ‡∏ô‡∏∞‡∏Ñ‡∏∞ ‡∏ñ‡πâ‡∏≤‡∏£‡∏π‡πâ‡∏™‡∏∂‡∏Å‡∏´‡∏ô‡πâ‡∏≤‡∏°‡∏∑‡∏î‡∏£‡∏µ‡∏ö‡∏ï‡∏≤‡∏°‡∏Ñ‡∏ô‡∏°‡∏≤‡∏ä‡πà‡∏ß‡∏¢‡∏Ñ‡πà‡∏∞' : '‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥: ‡∏Ñ‡∏∏‡∏°‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡πÅ‡∏õ‡πâ‡∏á/‡∏ô‡πâ‡∏≥‡∏ï‡∏≤‡∏• ‡πÅ‡∏•‡∏∞‡∏î‡∏∑‡πà‡∏°‡∏ô‡πâ‡∏≥‡πÄ‡∏õ‡∏•‡πà‡∏≤‡πÄ‡∏¢‡∏≠‡∏∞‡πÜ ‡∏ô‡∏∞‡∏Ñ‡∏∞';
               await Swal.fire({ title: '‡∏Å‡∏≤‡∏£‡∏õ‡∏ê‡∏°‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•', text: advice, icon: 'info', confirmButtonText: '‡∏£‡∏±‡∏ö‡∏ó‡∏£‡∏≤‡∏ö' });
               
               $('#loading').style.display = 'flex';
               await apiPost('logEvent', { userId: liffProfile.userId, type: metric, subtype, v1, v2 });
               $('#loading').style.display = 'none'; closeAllModals();
               openAdverseModal(); 
               return;
          }
      }

      $('#loading').style.display = 'flex';
      await apiPost('logEvent', { userId: liffProfile.userId, type: metric, subtype, v1, v2 });
      $('#loading').style.display = 'none'; closeAllModals();

      const afterSave = await Swal.fire({
          title: '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢', icon: 'success',
          showCancelButton: true,
          confirmButtonText: '‡πÄ‡∏™‡∏£‡πá‡∏à‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢',
          cancelButtonText: '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≤‡∏á‡πÄ‡∏Ñ‡∏µ‡∏¢‡∏á', cancelButtonColor: '#FF9100'
      });
      if (afterSave.dismiss === Swal.DismissReason.cancel) {
          openAdverseModal();
      }
    }

    // --- ADVERSE ---
    function openAdverseModal() {
        const opts = ['‡∏ï‡∏±‡∏ß‡∏™‡∏±‡πà‡∏ô', '‡πÉ‡∏à‡∏™‡∏±‡πà‡∏ô', '‡πÄ‡∏´‡∏á‡∏∑‡πà‡∏≠‡πÅ‡∏ï‡∏Å', '‡∏´‡∏¥‡∏ß', '‡∏´‡∏á‡∏∏‡∏î‡∏´‡∏á‡∏¥‡∏î', '‡∏™‡∏±‡∏ö‡∏™‡∏ô', '‡∏ã‡∏∂‡∏°', '‡∏´‡∏°‡∏î‡∏™‡∏ï‡∏¥'];
        $('#symptom-options').innerHTML = opts.map(o => `<button class="symptom-btn chip-btn" onclick="this.classList.toggle('active')">${o}</button>`).join('');
        $('#center-modal').style.display = 'flex';
    }
    async function submitSymptoms() {
        const sel = Array.from(document.querySelectorAll('.symptom-btn.active')).map(b => b.innerText);
        const txt = $('#symptom-text').value;
        const final = sel.join(', ') + (sel.length && txt ? ', ' : '') + txt;
        if(!final.trim()) return;
        $('#loading').style.display = 'flex';
        await apiPost('logEvent', { userId: liffProfile.userId, type: 'ADVERSE', vt: final }); 
        $('#loading').style.display = 'none'; closeAllModals();
        Swal.fire({ title:'‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡πâ‡∏ß', text:'‡∏î‡∏π‡πÅ‡∏•‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û‡∏î‡πâ‡∏ß‡∏¢‡∏ô‡∏∞‡∏Ñ‡∏∞', icon:'success', timer:1500, showConfirmButton:false });
    }

    // --- API ---
    async function apiPost(action, payload) {
       try {
         const res = await fetch(GAS_URL, { method: 'POST', body: JSON.stringify({ action, payload }) });
         const data = await res.json();
         if(data.imageUrl) window.lastUploadedImageUrl = data.imageUrl; 
         if (action === 'getDashboard') renderDashboard(data.events);
         return data;
       } catch(e) { console.error(e); return { ok: false }; }
    }

    // --- DASHBOARD RENDER LOGIC ---
    const LABELS = {
        'SBGM': 'ü©∏ ‡∏Ñ‡πà‡∏≤‡∏ô‡πâ‡∏≥‡∏ï‡∏≤‡∏•‡πÉ‡∏ô‡πÄ‡∏•‡∏∑‡∏≠‡∏î', 'BP': 'üíì ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡∏±‡∏ô‡πÇ‡∏•‡∏´‡∏¥‡∏ï',
        '%FAT': 'üë§ % ‡πÑ‡∏Ç‡∏°‡∏±‡∏ô‡∏£‡πà‡∏≤‡∏á‡∏Å‡∏≤‡∏¢', 'VISCERALFAT': 'üë§ ‡πÑ‡∏Ç‡∏°‡∏±‡∏ô‡∏ä‡πà‡∏≠‡∏á‡∏ó‡πâ‡∏≠‡∏á', 'MUSCLE': 'üë§ % ‡∏Å‡∏•‡πâ‡∏≤‡∏°‡πÄ‡∏ô‡∏∑‡πâ‡∏≠',
        'BMI': 'üë§ ‡∏î‡∏±‡∏ä‡∏ô‡∏µ‡∏°‡∏ß‡∏•‡∏Å‡∏≤‡∏¢', 'RESTINGMET': 'üë§ ‡πÄ‡∏ú‡∏≤‡∏ú‡∏•‡∏≤‡∏ç', 'BODYAGE': 'üë§ ‡∏≠‡∏≤‡∏¢‡∏∏‡∏£‡πà‡∏≤‡∏á‡∏Å‡∏≤‡∏¢',
        'SLEEP': 'üò¥ ‡∏Å‡∏≤‡∏£‡∏ô‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏ö', 'STRESS': 'ü§Ø ‡∏≠‡∏≤‡∏Å‡∏≤‡∏£/‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏Ñ‡∏£‡∏µ‡∏¢‡∏î'
    };

    function renderDashboard(eventsData) {
        const container = $('#history-container'); container.innerHTML = '';
        let allEvents = [];
        if(eventsData) Object.values(eventsData).flat().forEach(e => { if(e && e.event_type) allEvents.push(e); });
        if (allEvents.length === 0) { container.innerHTML = '<div style="text-align:center; color:#AAA; margin-top:50px;">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏∞</div>'; return; }
        allEvents.sort((a,b) => new Date(b.ts) - new Date(a.ts)); 

        const groups = {};
        allEvents.forEach(e => {
            const d = new Date(e.ts);
            const dateStr = d.toLocaleDateString('th-TH', {day:'numeric', month:'short', year:'2-digit'});
            const hour = d.getHours();
            let period = '‡∏≠‡∏∑‡πà‡∏ô‡πÜ'; if(hour>=6 && hour<11) period='‡πÄ‡∏ä‡πâ‡∏≤'; else if(hour>=11 && hour<16) period='‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏á/‡∏ö‡πà‡∏≤‡∏¢'; else if(hour>=16 && hour<24) period='‡πÄ‡∏¢‡πá‡∏ô/‡∏Ñ‡πà‡∏≥';
            
            const key = `${dateStr}_${period}`;
            if(!groups[key]) groups[key] = { date: dateStr, period: period, sugar: [], bp: [], food: [], other: [], img: null };
            if(e.img && !groups[key].img) groups[key].img = e.img;

            const t = String(e.event_type).trim().toUpperCase();
            if(t === 'SBGM') groups[key].sugar.push(e);
            else if(t === 'BP') groups[key].bp.push(e);
            else if(t === 'FOOD') groups[key].food.push(e);
            else groups[key].other.push(e); 
        });

        const orderedKeys = [];
        allEvents.forEach(e => {
            const k = `${new Date(e.ts).toLocaleDateString('th-TH', {day:'numeric', month:'short', year:'2-digit'})}_${(new Date(e.ts).getHours()>=6 && new Date(e.ts).getHours()<11)?'‡πÄ‡∏ä‡πâ‡∏≤':(new Date(e.ts).getHours()>=11 && new Date(e.ts).getHours()<16)?'‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏á/‡∏ö‡πà‡∏≤‡∏¢':(new Date(e.ts).getHours()>=16)?'‡πÄ‡∏¢‡πá‡∏ô/‡∏Ñ‡πà‡∏≥':'‡∏≠‡∏∑‡πà‡∏ô‡πÜ'}`;
            if(!orderedKeys.includes(k)) orderedKeys.push(k);
        });

        orderedKeys.forEach(k => {
            const g = groups[k]; let sections = [];

            if (g.sugar.length > 0) {
                let html = '';
                g.sugar.forEach(s => {
                    if (s.v1 && !isNaN(parseFloat(s.v1))) {
                        let alert = ''; if(s.flag === 'LOW') alert = `<span class="alert-badge low">‚ö†Ô∏è ‡∏ï‡πà‡∏≥‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ</span>`; else if(s.flag === 'HIGH') alert = `<span class="alert-badge high">‚ö†Ô∏è ‡∏™‡∏π‡∏á‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ</span>`;
                        html += `<div class="data-row"><span class="data-label">${LABELS['SBGM']} (${s.subtype||''}):</span><span class="data-value-big">${s.v1}</span> <span class="unit">‡∏°‡∏Å./‡∏î‡∏•.</span> ${alert}</div>`;
                    }
                });
                if(html) sections.push(html);
            }

            if (g.bp.length > 0) {
                let html = '';
                g.bp.forEach(b => {
                    if (b.v1 && b.v2 && !isNaN(parseFloat(b.v1))) {
                        let alert = ''; if(b.flag === 'HIGH') alert = `<span class="alert-badge high">‚ö†Ô∏è ‡∏™‡∏π‡∏á‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ</span>`;
                        html += `<div class="data-row"><span class="data-label">${LABELS['BP']}:</span><span class="data-value-big">${b.v1} / ${b.v2}</span> <span class="unit">‡∏°‡∏°.‡∏õ‡∏£‡∏≠‡∏ó</span> ${alert}</div>`;
                    }
                });
                if(html) sections.push(html);
            }

            if (g.food.length > 0) {
                let html = `<div class="data-section"><div class="data-label">üç≤ ‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏ó‡∏≤‡∏ô</div>`;
                let hasFood = false;
                g.food.forEach(f => {
                    if (f.vt && String(f.vt) !== '#NUM!' && isNaN(f.vt)) { 
                        let qtyUnit = (f.v1 && !isNaN(parseFloat(f.v1)) && f.unit) ? `<span class="highlight">${f.v1} ${f.unit}</span>` : '';
                        let flagDisplay = ''; if(f.flag && String(f.flag).trim() !== '-' && String(f.flag).trim() !== 'NORMAL') flagDisplay = `<div class="food-flag">ü§ñ ${f.flag}</div>`;
                        html += `<div class="food-list-item">- ${f.vt} ${qtyUnit} ${flagDisplay}</div>`; hasFood = true;
                    }
                });
                html += `</div>`; if(hasFood) sections.push(html);
            }
            
            if (g.other.length > 0) {
                 let html = `<div class="data-section"><div class="data-label">üìù ‡∏≠‡∏∑‡πà‡∏ô‡πÜ</div>`;
                 let hasOther = false;
                 g.other.forEach(o => {
                     let t = o.event_type;
                     let valText = '';
                     let alert = ''; 
                     if(o.flag === 'LOW') alert = `<span class="alert-badge low">‚ö†Ô∏è ‡∏ï‡πà‡∏≥‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ</span>`;
                     else if(o.flag === 'HIGH') alert = `<span class="alert-badge high">‚ö†Ô∏è ‡∏™‡∏π‡∏á‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ</span>`;

                     if(LABELS[t]) {
                         valText = `${LABELS[t]}: ${o.v1||''} ${o.vt||''} ${o.unit||''}`.trim();
                     } else if (t === 'EXERCISE') {
                         valText = `üèÉ‚Äç‚ôÄÔ∏è ‡∏≠‡∏≠‡∏Å‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Å‡∏≤‡∏¢: ${o.vt || ''} (${o.v1} ‡∏ô‡∏≤‡∏ó‡∏µ)`;
                     } else if (t === 'WEIGHT') {
                         valText = `‚öñÔ∏è ‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å: ${o.v1} ‡∏Å‡∏Å.`;
                     } else if (t === 'ADVERSE') {
                         valText = `‚ö†Ô∏è ‡∏≠‡∏≤‡∏Å‡∏≤‡∏£: ${o.vt}`; alert = `<span class="alert-badge high">‚ö†Ô∏è ‡∏°‡∏µ‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡∏ú‡∏¥‡∏î‡∏õ‡∏Å‡∏ï‡∏¥</span>`;
                     } else {
                         valText = `${t}: ${o.vt||o.v1||''}`;
                     }

                     if (valText && String(valText) !== '#NUM!') {
                         html += `<div class="food-list-item">${valText} ${alert}</div>`; hasOther = true;
                     }
                 });
                 html += `</div>`; if(hasOther) sections.push(html);
            }

            if (sections.length > 0) {
                let imgHtml = '';
                if (g.img) {
                    let displayUrl = g.img;
                    if(displayUrl.includes('drive.google.com') && displayUrl.includes('id=')) {
                        try { const id = new URLSearchParams(new URL(displayUrl).search).get('id'); if(id) displayUrl = `https://lh3.googleusercontent.com/d/${id}`; } catch(e){}
                    }
                    imgHtml = `<div class="hist-img-container" onclick="window.open('${g.img}')"><img src="${displayUrl}" onerror="this.style.display='none'"></div>`;
                }

                let cardAlertStyle = '';
                const combinedSections = sections.join('');
                if (combinedSections.includes('alert-badge high') || combinedSections.includes('alert-badge low') || combinedSections.includes('food-flag')) {
                    cardAlertStyle = 'background: #FFEBEE; border-color: #EF9A9A;';
                }

                container.innerHTML += `<div class="hist-card" style="${cardAlertStyle}"><div class="hist-header-badge">${g.date} ‚Ä¢ ${g.period}</div><div class="hist-body">${imgHtml}<div class="hist-data">${sections.join('<div class="divider"></div>')}</div></div></div>`;
            }
        });
    }

    async function fetchUserProfile() {
        const res = await apiPost('getDashboard', { userId: liffProfile.userId });
        if (res.isRegistered === false) {
            switchView('register');
        } else {
            if (res.profile) {
                userDisplayName = res.profile.NameUse || liffProfile.displayName;
                const greetingText = $('#greeting-text');
                if (greetingText) greetingText.style.display = 'none'; 
                
                // Show new profile header
                $('#main-profile-header').style.display = 'flex';
                $('#head-avatar').src = res.profile.PicUrl || liffProfile.pictureUrl || 'https://cdn-icons-png.flaticon.com/512/3135/3135715.png';
                $('#head-name').innerText = `‡∏Ñ‡∏∏‡∏ì${userDisplayName}`;
                
                // Clear old target element to prevent duplicates
                const oldWeightTarget = document.getElementById('head-weight-target');
                if(oldWeightTarget) oldWeightTarget.remove();

                if(res.profile.StartDate && res.profile.EndDate) {
                    const start = new Date(res.profile.StartDate);
                    const end = new Date(res.profile.EndDate);
                    const today = new Date();
                    const diffTime = Math.abs(end - today);
                    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                    
                    $('#head-start').innerText = start.toLocaleDateString('th-TH', {day:'numeric', month:'short', year:'2-digit'});
                    if(today <= end) $('#head-target').innerText = `‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏•‡∏∑‡∏≠: ${diffDays} ‡∏ß‡∏±‡∏ô`;
                    else $('#head-target').innerText = `‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡∏î‡πâ‡∏≤‡∏ô‡πÄ‡∏ß‡∏•‡∏≤‡πÅ‡∏•‡πâ‡∏ß! üéâ`;
                }

                // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏•‡∏î 10%
                let initW = res.profile.Weight ? parseFloat(res.profile.Weight) : 0;
                if(initW > 0) {
                    let latestW = initW;
                    // ‡∏´‡∏≤‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏à‡∏≤‡∏Å events
                    let wEvents = res.events ? res.events.filter(e => e.event_type === 'WEIGHT') : [];
                    if(wEvents.length > 0) {
                        latestW = parseFloat(wEvents[0].v1);
                    }
                    
                    let targetLoss = initW * 0.10;
                    let currentLoss = initW - latestW;
                    let remainingLoss = targetLoss - currentLoss;
                    
                    let wHtml = '';
                    if(remainingLoss > 0) {
                        wHtml = `<div id="head-weight-target" style="margin-top:8px; font-size:16px; color:#D84315; background:#FFE0B2; padding:6px 12px; border-radius:15px; display:inline-block; font-weight:700;">üéØ ‡∏ï‡πâ‡∏≠‡∏á‡∏•‡∏î‡∏≠‡∏µ‡∏Å ${remainingLoss.toFixed(1)} ‡∏Å‡∏Å. ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏û‡∏¥‡∏ä‡∏¥‡∏ï‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢!</div>`;
                    } else {
                        wHtml = `<div id="head-weight-target" style="margin-top:8px; font-size:16px; color:#2E7D32; background:#C8E6C9; padding:6px 12px; border-radius:15px; display:inline-block; font-weight:700;">üéâ ‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏î‡πâ‡∏ß‡∏¢! ‡∏•‡∏î‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡πÑ‡∏î‡πâ 10% ‡∏ï‡∏≤‡∏°‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß</div>`;
                    }
                    $('#main-profile-header .profile-info').insertAdjacentHTML('beforeend', wHtml);
                }
            }
            switchView('note'); 
        }
    }
    
    function loadDashboardData() { switchView('dashboard'); apiPost('getDashboard', { userId: liffProfile.userId }); }

    window.addEventListener('load', main);
</script>
</body>
</html>