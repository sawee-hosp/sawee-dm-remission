<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>สวีคุมหวาน • ลงทะเบียน/แดชบอร์ด</title>
<link rel="preconnect" href="https://fonts.googleapis.com"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<style>
  :root{
    --bg:#0b1020; --card:#121832; --muted:#bcd0ff; --text:#f8faff; --accent:#6aa5ff; --accent2:#8d84ff; --ok:#00d38f; --warn:#ffd166;
  }
  *{box-sizing:border-box}
  body{margin:0;padding:18px;background:linear-gradient(135deg,#0b1020,#121832);color:var(--text);font-family:'Prompt',system-ui,-apple-system,Segoe UI,Roboto}
  .container{max-width:980px;margin:0 auto}
  header{display:flex;align-items:center;gap:14px;margin:6px 0 16px}
  .avatar{width:64px;height:64px;border-radius:50%;object-fit:cover;border:2px solid rgba(255,255,255,.2)}
  h1{font-size:22px;margin:0;line-height:1.2}
  .sub{color:var(--muted);font-size:14px}
  .card{background:linear-gradient(180deg,rgba(255,255,255,.05),rgba(255,255,255,.03));border:1px solid rgba(255,255,255,.08);border-radius:18px;padding:16px;margin:12px 0;box-shadow:0 10px 30px rgba(0,0,0,.25)}
  .card h2{font-size:18px;margin:0 0 10px;color:#dfe6ff}
  label{display:block;margin:8px 0 8px;font-weight:600}
  input[type="text"],input[type="number"]{width:100%;padding:14px;border-radius:12px;border:1px solid rgba(255,255,255,.12);background:#0e1430;color:#f2f4ff;font-size:16px}
  .row{display:flex;gap:14px;align-items:center;flex-wrap:wrap}
  .grid{display:grid;grid-template-columns:1fr 1fr;gap:14px}
  .btn{padding:14px 16px;border-radius:12px;border:1px solid rgba(255,255,255,.12);background:linear-gradient(90deg,var(--accent),var(--accent2));color:white;font-weight:700;cursor:pointer;font-size:16px}
  .btn:disabled{opacity:.6;cursor:not-allowed}
  .muted{color:var(--muted);font-size:14px}
  .pill{padding:6px 10px;border-radius:999px;background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.08);font-size:12px;color:#dfe6ff}
  .goal{padding:12px;border-radius:14px;background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.06)}
  .goal-title{font-weight:600;margin-bottom:6px}
  canvas{background:rgba(255,255,255,.02);border-radius:12px;padding:8px}
  a{color:#8ecbff;text-decoration:underline}
  .radio-group label{display:inline-flex;align-items:center;gap:8px;margin-right:14px;font-weight:500}
  .big{font-size:16px}
</style>
</head>
<body>
<div class="container">
  <header>
    <img id="avatar" class="avatar" src="">
    <div>
      <h1 id="uname">กำลังโหลด…</h1>
      <div id="sub" class="sub">กำลังเตรียมระบบ</div>
    </div>
  </header>

  <!-- Registration Card -->
  <div id="reg" class="card" style="display:none">
    <h2>ลงทะเบียนผู้ใช้</h2>
    <div class="grid">
      <div>
        <label class="big" for="hn">รหัสโรงพยาบาล (HN)</label>
        <input id="hn" type="text" placeholder="เช่น HN 55000123" />
      </div>
      <div>
        <label class="big" for="nameuse">ชื่อที่อยากให้เรียก</label>
        <input id="nameuse" type="text" placeholder="เช่น น้องส้ม / คุณส้ม" />
      </div>
    </div>
    <div class="row">
      <div class="radio-group big">
        <label><input type="radio" name="gender" value="Male">ชาย</label>
        <label><input type="radio" name="gender" value="Female">หญิง</label>
        <label><input type="radio" name="gender" value="Other">อื่น ๆ</label>
      </div>
      <div>
        <label class="big" for="age">อายุ</label>
        <input id="age" type="number" min="1" max="120" placeholder="เช่น 67" />
      </div>
    </div>
    <div class="row" style="margin-top:6px">
      <label class="big"><input id="consent" type="checkbox" checked> ฉันยินยอม (PDPA) ให้คลินิกใช้ข้อมูลเพื่อดูแลรักษา</label>
      <a href="https://example.com/pdpa" target="_blank" rel="noopener">รายละเอียด PDPA</a>
    </div>
    <div class="row" style="margin-top:12px">
      <button id="btnSave" class="btn">บันทึกข้อมูล</button>
    </div>
  </div>

  <!-- Dashboard Card -->
  <div id="dash" style="display:none">
    <div class="card">
      <h2>ข้อมูลส่วนตัว</h2>
      <div class="grid">
        <div><div class="pill">ชื่อ</div><div id="p_name" style="margin-top:6px">-</div></div>
        <div><div class="pill">HN</div><div id="p_hn" style="margin-top:6px">-</div></div>
        <div><div class="pill">เพศ</div><div id="p_gender" style="margin-top:6px">-</div></div>
        <div><div class="pill">อายุ</div><div id="p_age" style="margin-top:6px">-</div></div>
      </div>
      <div class="muted" style="margin-top:6px">ลงทะเบียนเมื่อ <span id="p_reg">-</span></div>
    </div>

    <div class="card">
      <h2>เป้าหมายของฉัน</h2>
      <div id="goalsWrap" class="grid"></div>
    </div>

    <div class="card">
      <h2>ประวัติการบันทึก</h2>
      <div id="chartsWrap" class="grid"></div>
    </div>

    <div class="card">
      <h2>คำแนะนำ (โดยพี่จุ๋ม พยาบาล AI)</h2>
      <div id="adviceWrap" class="grid"></div>
    </div>
  </div>
</div>

<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  // ====== CONFIG ======
  const GAS_WEB_APP_URL = "YOUR_GAS_WEB_APP_URL"; // e.g. https://script.google.com/macros/s/AKfyc.../exec
  const LIFF_ID = "YOUR_LIFF_ID";

  // ====== Helpers ======
  const $ = sel => document.querySelector(sel);
  function fmtDate(d){
    const t = new Date(d);
    return t.toLocaleString('th-TH', { year:'numeric', month:'2-digit', day:'2-digit', hour:'2-digit', minute:'2-digit' });
  }

  // ====== Init ======
  async function main(){
    try{
      await liff.init({ liffId: LIFF_ID });
    }catch(e){
      console.error('LIFF init fail', e); alert('ไม่สามารถเริ่ม LIFF ได้'); return;
    }
    if (!liff.isLoggedIn()) { liff.login(); return; }

    const ctx = liff.getContext?.() || {};
    const token = liff.getDecodedIDToken?.() || {};
    const prof = await liff.getProfile();
    const userId = ctx.userId || token.sub || prof.userId || '';
    const displayName = prof.displayName || '';
    const pictureUrl = prof.pictureUrl || '';

    $('#avatar').src = pictureUrl || 'https://placehold.co/120x120/121832/FFF?text=LINE';
    $('#uname').textContent = displayName || 'เพื่อนใหม่ของพี่หวี';
    $('#sub').textContent = 'กำลังโหลดข้อมูลจากคลินิก…';

    // Load dashboard (GET with CORS)
    try{
      const url = GAS_WEB_APP_URL + '?action=getDashboard&userId=' + encodeURIComponent(userId);
      const res = await fetch(url, { method:'GET' });
      const json = await res.json();
      if (!json.ok) throw new Error(json.error || 'unknown error');

      if (!json.registered) {
        // show register
        $('#reg').style.display = 'block';
        $('#dash').style.display = 'none';

        // Save handler (POST no-cors)
        $('#btnSave').onclick = async ()=>{
          const gender = document.querySelector('input[name="gender"]:checked')?.value || '';
          const payload = {
            action: 'registerUser',
            userId,
            displayName,
            pictureUrl,
            hn: $('#hn').value.trim(),
            name_use: $('#nameuse').value.trim() || displayName,
            gender: gender,
            age: $('#age').value.trim(),
            consent: $('#consent').checked
          };
          $('#btnSave').disabled = true;
          try{
            await fetch(GAS_WEB_APP_URL, {
              method:'POST',
              headers:{ 'Content-Type': 'application/json' },
              body: JSON.stringify(payload),
              mode:'no-cors'
            });
            alert('ลงทะเบียนสำเร็จแล้วค่ะ');
            location.reload();
          }catch(err){
            console.error(err);
            alert('บันทึกไม่สำเร็จ: ' + err.message);
            $('#btnSave').disabled = false;
          }
        };

        return;
      }

      // Render dashboard
      $('#reg').style.display='none';
      $('#dash').style.display='block';
      $('#sub').textContent = 'แดชบอร์ดสุขภาพของคุณ';

      const p = json.profile || {};
      $('#avatar').src = p.PictureURL || pictureUrl || '';
      $('#uname').textContent = p.NameUse || p.DisplayName || displayName || 'เพื่อนใหม่ของพี่หวี';

      $('#p_name').textContent = p.NameUse || p.DisplayName || '-';
      $('#p_hn').textContent = p.HN || '-';
      $('#p_gender').textContent = p.Gender || '-';
      $('#p_age').textContent = p.Age || '-';
      $('#p_reg').textContent = p.Timestamp ? fmtDate(p.Timestamp) : '-';

      // Goals
      const gwrap = $('#goalsWrap'); gwrap.innerHTML='';
      (json.goals||[]).forEach(g=>{
        const div = document.createElement('div'); div.className='goal';
        div.innerHTML = `
          <div class="goal-title">${g.goal_category} • ${g.goal_specific}</div>
          <div class="muted">วิธีวัดผล: ${g.goal_measurable || '-'}</div>
          <div class="muted">กรอบเวลา: ${g.goal_timebound || '-'}</div>
        `;
        gwrap.appendChild(div);
      });
      if ((json.goals||[]).length===0) {
        const div = document.createElement('div'); div.className='muted'; div.textContent='ยังไม่มีเป้าหมาย';
        gwrap.appendChild(div);
      }

      // Charts
      const chartsWrap = $('#chartsWrap'); chartsWrap.innerHTML='';
      const series = json.logsByType || {};
      Object.keys(series).forEach(k=>{
        const card = document.createElement('div'); card.className='card';
        card.innerHTML = `<h2>ประวัติ ${k}</h2><canvas height="140"></canvas>`;
        chartsWrap.appendChild(card);
        const ctx2d = card.querySelector('canvas').getContext('2d');
        const rows = series[k];
        const labels = rows.map(r => fmtDate(r.ts));
        if (k==='BP') {
          const sbp = rows.map(r => r.v1 || null);
          const dbp = rows.map(r => r.v2 || null);
          new Chart(ctx2d, { type:'line', data:{ labels, datasets:[
            { label:'SBP', data: sbp }, { label:'DBP', data: dbp }
          ]}});
        } else {
          const v = rows.map(r=> (typeof r.v1==='number'? r.v1 : (parseFloat(r.v1)||null)) );
          new Chart(ctx2d, { type:'line', data:{ labels, datasets:[{ label:k, data:v }]}});
        }
      });
      if (Object.keys(series).length===0) {
        const div = document.createElement('div'); div.className='muted'; div.textContent='ยังไม่มีประวัติการบันทึก';
        chartsWrap.appendChild(div);
      }

      // Advice
      const advWrap = $('#adviceWrap'); advWrap.innerHTML='';
      const adv = json.adviceLatest || {}; const keys = Object.keys(adv);
      if (keys.length===0) {
        const div = document.createElement('div'); div.className='muted'; div.textContent='ยังไม่มีคำแนะนำ';
        advWrap.appendChild(div);
      } else {
        keys.forEach(m=>{
          const a = adv[m]; const card = document.createElement('div'); card.className='goal';
          card.innerHTML = `
            <div class="goal-title">คำแนะนำล่าสุด: ${m}</div>
            <div class="muted">${fmtDate(a.ts)}</div>
            <div style="margin-top:8px;white-space:pre-wrap">${a.advice_text || '-'}</div>`;
          advWrap.appendChild(card);
        });
      }

    }catch(err){
      console.error(err);
      $('#sub').textContent = 'โหลดข้อมูลไม่สำเร็จ';
    }
  }
  main();
</script>
</body>
</html>
