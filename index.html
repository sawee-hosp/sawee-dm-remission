<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ลงทะเบียน "สวีคุมหวาน"</title>
  <style>
    :root {
      --brand:#06C755;
      --text:#1d2733;
      --muted:#58677a;
      --bg:#F3F6F9;
      --card:#ffffff;
      --border:#E6ECF2;
    }
    *{box-sizing:border-box}
    body{
      margin:0; padding:24px;
      font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Helvetica,Arial,sans-serif;
      background:var(--bg); color:var(--text);
    }
    .container{
      max-width:560px; margin:0 auto;
      background:var(--card);
      border:1px solid var(--border);
      border-radius:16px;
      box-shadow:0 10px 30px rgba(0,0,0,.06);
      padding:28px;
    }
    h1{
      margin:0 0 6px; text-align:center;
      font-size:28px; font-weight:800; color:var(--brand);
      letter-spacing:.2px;
    }
    .sub{
      text-align:center; color:var(--muted);
      margin-bottom:22px; font-size:15px;
    }
    .form-group{ margin-bottom:18px; }
    label{
      display:block; margin-bottom:8px;
      font-weight:700; font-size:15px;
    }
    input[type="text"], input[type="tel"], input[type="number"]{
      width:100%; padding:14px 16px; font-size:16px;
      border:1px solid var(--border); border-radius:12px;
      outline:none; transition:.15s;
      background:#FBFDFF;
    }
    input[type="text"]:focus, input[type="tel"]:focus, input[type="number"]:focus{
      border-color:#b9d8c6; box-shadow:0 0 0 4px rgba(6,199,85,.12);
    }
    .gender-row{ display:flex; gap:14px; flex-wrap:wrap; }
    .gender-item{
      display:flex; align-items:center; gap:10px;
      padding:10px 12px; border:1px solid var(--border);
      border-radius:12px; background:#FBFDFF; cursor:pointer;
      font-size:16px;
    }
    .consent{
      display:flex; align-items:flex-start; gap:10px;
      background:#FBFDFF; border:1px solid var(--border);
      padding:12px; border-radius:12px; margin-top:6px;
      font-size:15px;
    }
    .consent a{ color:#0a7cff; text-decoration:none; }
    .consent a:hover{ text-decoration:underline; }
    button{
      width:100%; padding:16px; margin-top:6px;
      background:var(--brand); color:#fff; border:0; border-radius:12px;
      font-size:18px; font-weight:800; cursor:pointer;
      box-shadow:0 6px 14px rgba(6,199,85,.25);
      transition:.15s;
    }
    button:disabled{ opacity:.6; cursor:not-allowed; box-shadow:none; }
    #status{ text-align:center; margin-top:14px; font-weight:700; color:var(--muted); }
    .hidden{ display:none; }
  </style>
</head>
<body>
  <div class="container">
    <h1>ลงทะเบียน</h1>
    <div class="sub">กรุณากรอกข้อมูลเบื้องต้นเพื่อใช้งาน “สวีคุมหวาน”</div>

    <form id="registrationForm">
      <div class="form-group">
        <label for="hn">รหัสโรงพยาบาล (HN)</label>
        <input type="tel" id="hn" name="hn" required placeholder="เช่น 55000123" inputmode="numeric" />
      </div>

      <div class="form-group">
        <label for="name_use">ชื่อที่อยากให้เรียก</label>
        <input type="text" id="name_use" name="name_use" required placeholder="เช่น น้องส้ม / คุณสมชาย" />
      </div>

      <div class="form-group">
        <label>เพศ</label>
        <div class="gender-row" role="radiogroup" aria-label="gender">
          <label class="gender-item">
            <input type="radio" name="gender" value="Male" /> ชาย
          </label>
          <label class="gender-item">
            <input type="radio" name="gender" value="Female" /> หญิง
          </label>
          <label class="gender-item">
            <input type="radio" name="gender" value="Other" /> อื่น ๆ
          </label>
        </div>
      </div>

      <div class="form-group">
        <label for="age">อายุ</label>
        <input type="number" id="age" name="age" min="1" max="120" placeholder="เช่น 45" />
      </div>

      <div class="form-group">
        <label>ข้อตกลง PDPA</label>
        <div class="consent">
          <input type="checkbox" id="pdpa" name="pdpa" checked />
          <label for="pdpa">
            ฉันยินยอมให้คลินิกเก็บและประมวลผลข้อมูลสุขภาพของฉันเพื่อการดูแลรักษา
            (<a href="https://linecorp.com/en/privacy" target="_blank" rel="noopener">อ่านรายละเอียด</a>)
          </label>
        </div>
      </div>

      <button type="submit" id="submitBtn">ลงทะเบียน</button>
      <div id="status" class="hidden">กำลังส่งข้อมูล…</div>
    </form>
  </div>

  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <script>
    // ====== ของเดิม (ใส่ให้ครบแล้ว) ======
    const GAS_WEB_APP_URL = "https://script.google.com/macros/s/AKfycbyUmJKG7zE0WC7yL4XB4M9qFUYWgQPiUjzuc4WuYGasTy9FotqubfegZOJIpeFeT9gP3w/exec";
    const LIFF_ID = "2007840605-zKl7p3Aa";

    const $ = (sel) => document.querySelector(sel);

    async function initLiff() {
      try {
        await liff.init({ liffId: LIFF_ID });
        if (!liff.isLoggedIn()) {
          liff.login();
          return false; // จะรีไดเรกต์ไปล็อกอิน
        }
        return true;
      } catch (e) {
        console.error("[LIFF] init failed:", e.code, e.message, e);
        alert("ไม่สามารถเริ่ม LIFF ได้: " + (e.code || "") + " " + (e.message || ""));
        return false;
      }
    }

    function getSelectedGender() {
      const el = document.querySelector('input[name="gender"]:checked');
      return el ? el.value : "";
    }

    async function main() {
      const ok = await initLiff();
      if (!ok) return;

      // Autofill ชื่อเล่นจากโปรไฟล์ (ช่วยให้กรอกเร็ว)
      try {
        const profile = await liff.getProfile();
        if (profile?.displayName && !$("#name_use").value) {
          $("#name_use").value = profile.displayName;
        }
      } catch (e) {
        console.log("getProfile failed (not critical)", e);
      }

      // HANDLE SUBMIT
      $("#registrationForm").addEventListener("submit", async (e) => {
        e.preventDefault();
        $("#submitBtn").disabled = true;
        $("#status").classList.remove("hidden");
        $("#status").textContent = "กำลังลงทะเบียน…";

        try {
          const profile = await liff.getProfile();
          const userId = profile.userId;
          const displayName = profile.displayName || "";
          const pictureUrl = profile.pictureUrl || "";

          const dataToSend = {
            action: "registerUser", // สำคัญ! ให้ GAS รู้ว่าจะทำอะไร
            userId,
            displayName,
            pictureUrl,
            hn: $("#hn").value.trim(),
            name_use: $("#name_use").value.trim(),
            gender: getSelectedGender(),
            age: $("#age").value.trim(),
            consent: $("#pdpa").checked
          };

          // ใช้ no-cors แบบ “ของเดิม” เพื่อกัน CORS error
          await fetch(GAS_WEB_APP_URL, {
            method: "POST",
            body: JSON.stringify(dataToSend),
            headers: { "Content-Type": "application/json" },
            mode: "no-cors"
          });

          alert("ลงทะเบียนสำเร็จแล้วค่ะ! ระบบกำลังบันทึกข้อมูล");
          try { liff.closeWindow(); } catch (_) {
            // เผื่อเปิดนอกแอป ให้รีเฟรชแทน
            location.reload();
          }
        } catch (error) {
          console.error("Submission failed", error);
          alert("เกิดข้อผิดพลาดในการส่งข้อมูล: " + (error.message || error));
          $("#submitBtn").disabled = false;
          $("#status").classList.add("hidden");
        }
      });
    }

    main();
  </script>
</body>
</html>
