<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>สวีคุมหวาน • โปรไฟล์ & เป้าหมาย</title>

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <!-- ใช้ Mali ทุกน้ำหนัก -->
  <link href="https://fonts.googleapis.com/css2?family=Mali:ital,wght@0,200;0,300;0,400;0,500;0,600;0,700;1,200;1,300;1,400;1,500;1,600;1,700&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg:#FFF9E6;            /* ครีมอ่อน */
      --bg-soft:#FFF3CC;       /* โทนอุ่นอีกเฉด */
      --text:#2A2A2A;
      --muted:#6b7280;
      --primary:#F59E0B;       /* อำพัน */
      --primary-deep:#D97706;
      --card:#FFFFFF;
      --border:#EADFB6;
      --ok:#10B981;
      --warn:#F59E0B;
      --chip:#FFF1B3;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      background:var(--bg);
      color:var(--text);
      font-family:'Mali', system-ui, -apple-system, Segoe UI, Roboto;
      -webkit-font-smoothing:antialiased;
      text-rendering: optimizeLegibility;
    }
    /* Navbar */
    .navbar{
      position:sticky; top:0; z-index:100;
      background:linear-gradient(180deg,var(--bg-soft),rgba(255,255,255,0.8));
      backdrop-filter:saturate(1.2) blur(8px);
      border-bottom:1px solid var(--border);
    }
    .nav-inner{
      max-width:980px; margin:0 auto;
      display:flex; align-items:center; gap:12px;
      padding:10px 16px;
    }
    .nav-title{
      font-size:20px; font-weight:700; line-height:1.2;
    }
    .nav-sub{
      font-size:12px; color:var(--muted);
    }

    .container{max-width:980px;margin:0 auto;padding:16px}

    /* Cards */
    .card{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:18px;
      padding:16px;
      margin:14px 0;
      box-shadow:0 8px 20px rgba(0,0,0,.05);
    }
    .card h2{
      font-size:18px;margin:0 0 12px;display:flex;align-items:center;gap:10px;
    }
    .muted{color:var(--muted)}
    .btn{
      font-family:'Mali', system-ui;
      padding:12px 16px;border-radius:12px;border:1px solid var(--border);
      background:linear-gradient(180deg,#FFD166,#FFC04D);
      color:#583B06;font-weight:700;cursor:pointer;box-shadow:0 4px 10px rgba(0,0,0,.05);
    }
    .btn:active{transform:translateY(1px)}
    .btn-outline{
      background:#fff; color:#7a5809; border-color:#f0d99b;
    }
    .tag{
      display:inline-block;font-size:12px;color:#7a5809;background:var(--chip);
      padding:4px 10px;border-radius:999px;border:1px solid var(--border)
    }

    /* Loading overlay (ต่ำกว่า modal) */
    #loading{
      position:fixed;inset:0;background:rgba(0,0,0,.15);
      display:none;place-items:center;z-index:9000;
    }
    #loading .box{
      background:#fff7da;border:1px solid var(--border);
      padding:16px 20px;border-radius:14px;font-weight:600
    }

    /* Modal (เหนือทุกอย่าง + สูงไม่เกินจอ เลื่อนในเนื้อหาได้) */
    .modal{
      position:fixed;inset:0;display:none;place-items:center;z-index:9999;
      background:rgba(0,0,0,.4); padding:16px;
    }
    .modal.show{display:grid}
    .modal-panel{
      width:100%; max-width:720px; max-height:90vh;
      background:#fff; border:1px solid var(--border); border-radius:16px;
      display:flex; flex-direction:column; overflow:hidden;
      box-shadow:0 12px 30px rgba(0,0,0,.2);
    }
    .modal-header{
      display:flex; align-items:center; gap:12px;
      padding:14px 16px; background:var(--bg-soft); border-bottom:1px solid var(--border)
    }
    .modal-header img{ width:44px; height:44px; border-radius:50%; object-fit:cover; border:2px solid #fff7da }
    .modal-title{ font-weight:800; font-size:18px }
    .modal-body{
      padding:16px; overflow:auto; line-height:1.8; font-size:16px;
    }
    .modal-actions{
      padding:12px 16px; border-top:1px solid var(--border); display:flex; justify-content:flex-end; gap:8px; background:#fff
    }

    /* Profile block */
    .profile-row{ display:flex; gap:14px; align-items:center; flex-wrap:wrap }
    .avatar{ flex:0 0 auto; width:76px;height:76px;border-radius:50%;object-fit:cover;border:3px solid #FFE8A3; background:#fff }
    .p-lines{ display:flex; flex-direction:column; gap:6px; min-width:260px }
    .line{ display:flex; flex-wrap:wrap; gap:12px; align-items:center; font-size:16px }
    .line strong{ font-weight:800 }
    .line .sep{ opacity:.4 }

    /* Horizontal carousel (scroll-snap) */
    .hscroll{
      display:flex; gap:12px; overflow:auto; padding-bottom:6px; scroll-snap-type:x mandatory;
    }
    .hscroll::-webkit-scrollbar{ height:8px }
    .hscroll::-webkit-scrollbar-thumb{ background:#e8d494; border-radius:999px }

    .mini-card{
      scroll-snap-align:start;
      min-width:260px; max-width:320px;
      background:#fff; border:1px solid var(--border); border-radius:14px; padding:12px;
      box-shadow:0 6px 14px rgba(0,0,0,.05)
    }
    .mini-card .title{ font-weight:800; margin-bottom:6px }
    .mini-card .small{ font-size:12px; color:var(--muted) }

    /* Charts responsive grid */
    .charts-grid{
      display:grid; grid-template-columns: repeat(auto-fit, minmax(280px,1fr)); gap:14px;
    }
    canvas{ background:#fffaf0; border-radius:12px; padding:8px; border:1px solid var(--border) }

    /* Table (FOOD) */
    table{ width:100%; border-collapse: collapse; font-size:15px }
    th,td{ border-bottom:1px solid var(--border); padding:10px 8px; text-align:left }
    th{ background:#FFF1B3; position:sticky; top:0; z-index:1 }

    /* Section header with count & action */
    .section-header{
      display:flex; align-items:center; justify-content:space-between; flex-wrap:wrap; gap:8px; margin-bottom:8px
    }
    .count-badge{
      background:#FFF1B3; border:1px solid var(--border); color:#7a5809;
      padding:4px 10px; border-radius:999px; font-size:12px; font-weight:700;
    }

    /* Hidden blocks at start */
    #reg{ display:none }
    #dash{ display:none }
  </style>
</head>
<body>
  <!-- Navbar -->
  <div class="navbar">
    <div class="nav-inner">
      <div>
        <div class="nav-title">ข้อมูลส่วนตัว สวีคุมหวาน</div>
        <div class="nav-sub">คลินิกลดยาเบาหวาน (DM Remission) • โรงพยาบาลสวี</div>
      </div>
    </div>
  </div>

  <!-- Disclaimer Modal (บนสุด เหนือ loading) -->
  <div id="disclaimerModal" class="modal">
    <div class="modal-panel">
      <div class="modal-header">
        <img src="https://img2.pic.in.th/pic/ChatGPT-Image-10-..-2568-12_14_20.png" alt="พยาบาลพี่หวี" />
        <div class="modal-title">ข้อมูลสำคัญก่อนใช้งาน</div>
      </div>
      <div class="modal-body">
        <p><strong>LINE นี้จัดทำโดย คลินิกลดยาเบาหวาน (DM Remission) โรงพยาบาลสวี</strong> เพื่อช่วยให้ผู้ป่วยบันทึกข้อมูลสุขภาพและติดตามผลอย่างต่อเนื่อง ข้อมูลที่ท่านบันทึกจะถูกประมวลผลโดยระบบปัญญาประดิษฐ์ (AI) เพื่อสร้างคำแนะนำเบื้องต้น</p>
        <p>โปรดพิจารณาความน่าเชื่อถือของคำแนะนำ ใช้วิจารณญาณส่วนบุคคล และ <strong>หากมีข้อสงสัยให้ปรึกษาแพทย์/พยาบาลประจำคลินิก</strong> ข้อมูลที่บันทึกอาจถูกใช้ร่วมกับทีมดูแลของ <strong>โรงพยาบาลสวี</strong> เพื่อปรับแผนการรักษา</p>
        <p><strong>เป้าหมายของคลินิก:</strong> สนับสนุนให้ผู้ป่วย <em>ลดยาเบาหวาน</em> และควบคุมค่าน้ำตาลสะสม <strong>HbA1c &lt; 6.5%</strong> ภายใน ~3 เดือน ผ่านการคุมอาหาร ออกกำลังกาย ติดตามค่าความดัน/น้ำตาลสม่ำเสมอ และทำตามคำแนะนำทีมรักษา</p>
        <p><strong>วิธีใช้งาน:</strong> เมื่อมีการเจาะน้ำตาลก่อน/หลังอาหาร หรือวัดความดันโลหิต ให้เลือกเมนู “บันทึกค่า” ในห้องแชตและกรอกข้อมูลเป็นประจำ ระบบจะสรุปผลและช่วยประเมินความคืบหน้าการควบคุมเบาหวาน</p>
      </div>
      <div class="modal-actions">
        <button class="btn" id="btnAck">รับทราบ</button>
      </div>
    </div>
  </div>

  <!-- Loading (อยู่ใต้ modal) -->
  <div id="loading"><div class="box">กำลังโหลดข้อมูล…</div></div>

  <div class="container">
    <!-- Header: avatar + ชื่อ HN / เพศ อายุ -->
    <header class="card" id="headerCard">
      <div class="profile-row">
        <img id="avatar" class="avatar" src="" alt="avatar">
        <div class="p-lines">
          <div class="line">
            <strong>ชื่อ:</strong> <span id="p_name">-</span>
            <span class="sep">•</span>
            <strong>HN:</strong> <span id="p_hn">-</span>
          </div>
          <div class="line">
            <strong>เพศ:</strong> <span id="p_gender">-</span>
            <span class="sep">•</span>
            <strong>อายุ:</strong> <span id="p_age">-</span>
          </div>
          <div class="line muted" style="font-size:13px">
            ลงทะเบียนเมื่อ <span id="p_reg">-</span>
          </div>
        </div>
      </div>
    </header>

    <!-- Register form -->
    <div id="reg" class="card">
      <h2>ลงทะเบียนผู้ป่วย</h2>
      <div class="line" style="margin-bottom:8px; font-size:15px;">
        คลินิกลดยาเบาหวาน (DM Remission) รพ.สวี จะนำข้อมูลที่ท่านบันทึกมาใช้ประมวลผลเพื่อติดตามผลการรักษา
        โปรดให้ความอนุญาตใช้ข้อมูลที่ท่านบันทึก
      </div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
        <div>
          <div class="muted" style="font-size:13px;margin-bottom:6px">HN (เลขรพ. 9 หลัก)</div>
          <input id="hn" type="text" placeholder="เลขรพ. 9 หลัก ดูได้จากสมุดประจำตัว" style="width:100%;padding:12px 14px;border-radius:12px;border:1px solid var(--border);font-family:'Mali'">
        </div>
        <div>
          <div class="muted" style="font-size:13px;margin-bottom:6px">ชื่อที่อยากให้เรียก</div>
          <input id="nameuse" type="text" placeholder="เช่น น้องส้ม พี่แดง ลุงดำ หรือชื่อจริง" style="width:100%;padding:12px 14px;border-radius:12px;border:1px solid var(--border);font-family:'Mali'">
        </div>
        <div>
          <div class="muted" style="font-size:13px;margin-bottom:6px">เพศ</div>
          <select id="gender" style="width:100%;padding:12px 14px;border-radius:12px;border:1px solid var(--border);font-family:'Mali'">
            <option value="">— เลือกเพศ —</option>
            <option value="Male">ชาย</option>
            <option value="Female">หญิง</option>
            <option value="Other">อื่น ๆ</option>
          </select>
        </div>
        <div>
          <div class="muted" style="font-size:13px;margin-bottom:6px">อายุ</div>
          <input id="age" type="number" min="1" max="120" placeholder="เช่น 45" style="width:100%;padding:12px 14px;border-radius:12px;border:1px solid var(--border);font-family:'Mali'">
        </div>
      </div>
      <div class="line" style="margin:12px 0">
        <input id="consent" type="checkbox" style="transform:scale(1.2);margin-right:8px">
        <span class="muted">ฉันยินยอม (PDPA) ให้คลินิกใช้ข้อมูลเพื่อดูแลรักษา</span>
      </div>
      <button id="btnSave" class="btn">บันทึกข้อมูล</button>
    </div>

    <!-- Advice (carousel) -->
    <section class="card" id="adviceSection">
      <div class="section-header">
        <h2 style="margin:0">คำแนะนำโดยพี่หวี (AI)</h2>
        <button class="btn btn-outline" id="btnAskNurse">ขอคำแนะนำพยาบาลพี่หวี</button>
      </div>
      <div class="hscroll" id="adviceWrap">
        <!-- Intro card -->
        <div class="mini-card">
          <div style="display:flex; gap:10px; align-items:center; margin-bottom:6px">
            <img src="https://img2.pic.in.th/pic/ChatGPT-Image-10-..-2568-12_18_09.png" alt="พี่หวี AI" style="width:56px;height:56px;border-radius:12px;object-fit:cover;border:2px solid #FFE8A3">
            <div>
              <div class="title">พี่หวี พยาบาล AI</div>
              <div class="small">ใจดี • กระชับ • เน้นปลอดภัย</div>
            </div>
          </div>
          <div style="white-space:pre-wrap; font-size:14px; line-height:1.8">
พี่หวีเป็นผู้ช่วย AI ของคลินิกลดยาเบาหวาน ช่วยสรุปแนวโน้มและให้คำแนะนำรายวัน
คำแนะนำเป็นเชิงการดูแลตนเองเบื้องต้น โปรดพิจารณาร่วมกับทีมแพทย์/พยาบาล
          </div>
        </div>
        <!-- การ์ดคำแนะนำล่าสุดจะถูกเติมด้วย JS -->
      </div>
      <div class="muted" style="font-size:12px;margin-top:6px">
        *หมายเหตุ: คำแนะนำสร้างโดย AI เพื่อการส่งเสริมสุขภาพ ไม่ใช้แทนคำสั่งแพทย์
      </div>
    </section>

    <!-- Goals (carousel) -->
    <section class="card" id="goalsSection">
      <div class="section-header">
        <h2 style="margin:0">เป้าหมายของฉัน</h2>
        <div class="count-badge" id="goalsCount">0 เป้าหมาย</div>
      </div>
      <div class="hscroll" id="goalsWrap">
        <!-- การ์ดเป้าหมายจะถูกเติมด้วย JS -->
      </div>
    </section>

    <!-- History -->
    <section class="card">
      <h2>ประวัติการบันทึกผล</h2>
      <div class="charts-grid" id="chartsWrap"></div>
      <div id="foodTableWrap" style="margin-top:12px"></div>
    </section>
  </div>

  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    // ====== CONFIG ======
    const LIFF_ID  = '2007840605-zKl7p3Aa';
    const GAS_BASE = 'https://script.google.com/macros/s/AKfycbzP533st24BckpABeSBxDE9d47-ZfBEApKB3xkcgY0u55SGcHX1l9AX3zZ8ZJfNhiQdZA/exec';

    // ====== Helpers ======
    const el = (s)=>document.querySelector(s);
    function fmtDate(d){
      const t = new Date(d);
      if (isNaN(+t)) return '-';
      const dd = t.getDate().toString().padStart(2,'0');
      const mm = (t.getMonth()+1).toString().padStart(2,'0');
      const yy = t.getFullYear();
      const hh = t.getHours().toString().padStart(2,'0');
      const mi = t.getMinutes().toString().padStart(2,'0');
      return dd+'/'+mm+'/'+yy+' '+hh+':'+mi;
    }
    function showLoading(v){ el('#loading').style.display = v ? 'grid' : 'none'; }
    const GENDER_THAI = (g)=> g==='Male'?'ชาย':(g==='Female'?'หญิง':(g?'อื่น ๆ':'-'));
    const METRIC_TH = { WEIGHT:'น้ำหนักตัว', BP:'ความดันโลหิต', WAIST:'รอบเอว', SBGM:'ค่าน้ำตาลปลายนิ้ว', HBA1C:'น้ำตาลสะสม (HbA1c)', BODY_FAT:'เปอร์เซ็นต์ไขมัน' };
    const NUMERIC_TYPES = ['WEIGHT','BP','WAIST','SBGM','HBA1C','BODY_FAT'];

    // ====== JSONP fallback ======
    function jsonp(url, timeout = 8000) {
      return new Promise((resolve, reject) => {
        const cbName='__jsonp_'+Date.now()+'_'+Math.floor(Math.random()*1e6);
        const s=document.createElement('script');
        const clean=()=>{ try{ delete window[cbName]; }catch(_){} s.remove(); clearTimeout(t); };
        const t=setTimeout(()=>{ clean(); reject(new Error('JSONP timeout')); }, timeout);
        window[cbName]=(data)=>{ clean(); resolve(data); };
        s.onerror=()=>{ clean(); reject(new Error('JSONP load error')); };
        s.src=url+(url.includes('?')?'&':'?')+'callback='+cbName;
        document.head.appendChild(s);
      });
    }

    // ====== Fetch bundle (CORS then JSONP) ======
    async function fetchDashboard(userId) {
      const url = GAS_BASE + '?action=getDashboard&userId=' + encodeURIComponent(userId) + '&_=' + Date.now();
      try {
        const res = await fetch(url, { method:'GET', mode:'cors', credentials:'omit' });
        if (!res.ok) throw new Error('HTTP '+res.status);
        return await res.json();
      } catch (e) {
        console.warn('CORS failed, fallback to JSONP', e);
        return await jsonp(url, 10000);
      }
    }

    // ====== Register (POST no-cors ถ้าไม่ต้องอ่านผล) ======
    async function submitRegistration(payload) {
      // ต้องอ่านผล → ใช้ CORS และ GAS ตอบ JSON พร้อม CORS แล้ว (เราใช้ doPost(action=registerUser) ฝั่ง GAS)
      const res = await fetch(GAS_BASE, {
        method:'POST', mode:'cors', credentials:'omit',
        headers:{ 'Content-Type':'application/json' },
        body: JSON.stringify({ action:'registerUser', ...payload })
      });
      if (!res.ok) throw new Error('HTTP '+res.status);
      const json = await res.json();
      if (!json || json.ok !== true) throw new Error(json && json.error ? json.error : 'register failed');
      return true;
    }

    // ====== UI renderers ======
    function renderProfile(bundle, userId, displayName, pictureUrl){
      const p = bundle.profile || {};
      el('#avatar').src = p.PictureURL || pictureUrl || 'https://placehold.co/120x120/fef3c7/111?text=LINE';
      el('#p_name').textContent = p.NameUse || p.DisplayName || displayName || '-';
      el('#p_hn').textContent = p.HN || '-';
      el('#p_gender').textContent = GENDER_THAI(p.Gender || '');
      el('#p_age').textContent = p.Age || '-';
      el('#p_reg').textContent = p.Timestamp ? fmtDate(p.Timestamp) : '-';
    }

    function renderAdvice(bundle){
      const wrap = el('#adviceWrap');
      // ลบการ์ดคำแนะนำเดิม (เว้น intro ใบแรก)
      wrap.querySelectorAll('.mini-card[data-type="advice"]').forEach(n=>n.remove());
      const adv = bundle.ai_latest || {};
      const keys = Object.keys(adv)
        .map(k=>({ k, ts: adv[k]?.ts ? new Date(adv[k].ts).getTime() : 0 }))
        .sort((a,b)=>b.ts-a.ts)
        .map(o=>o.k);

      if (keys.length === 0) {
        const c = document.createElement('div');
        c.className='mini-card';
        c.dataset.type='advice';
        c.innerHTML = `<div class="title">ยังไม่มีคำแนะนำ</div><div class="small">ระบบยังไม่พบประวัติการบันทึกเพียงพอ</div>`;
        wrap.appendChild(c);
        return;
      }
      keys.forEach(k=>{
        const a = adv[k];
        const card = document.createElement('div');
        card.className='mini-card';
        card.dataset.type='advice';
        card.innerHTML = `
          <div class="title">${METRIC_TH[k] || k}</div>
          <div class="small" style="margin-bottom:6px">${fmtDate(a.ts || '')}</div>
          <div style="white-space:pre-wrap;font-size:14px;line-height:1.8">${a.advice_text || '-'}</div>`;
        wrap.appendChild(card);
      });
    }

    function daysLeft(deadline) {
      if (!deadline) return '';
      const d = new Date(deadline);
      if (isNaN(+d)) return '';
      const diff = Math.ceil( (d.getTime() - Date.now()) / 86400000 );
      return diff;
    }

    function renderGoals(bundle){
      const list = (bundle.goals || []).slice().sort((a,b)=>{
        const at = new Date(a.created_timestamp || 0).getTime();
        const bt = new Date(b.created_timestamp || 0).getTime();
        return bt - at; // ใหม่ก่อน
      });
      el('#goalsCount').textContent = `${list.length} เป้าหมาย`;

      const wrap = el('#goalsWrap');
      wrap.innerHTML = '';
      if (list.length === 0) {
        const c = document.createElement('div');
        c.className='mini-card';
        c.innerHTML = `<div class="title">ยังไม่มีเป้าหมาย</div><div class="small">เริ่มตั้ง SMART Goal ผ่านแชตได้เลย</div>`;
        wrap.appendChild(c);
        return;
      }
      list.forEach(g=>{
        const dleft = daysLeft(g.deadline_date);
        const status = (g.status || '').trim() || (dleft!=='' && dleft<=0 ? 'สำเร็จ/ครบกำหนด' : 'กำลังดำเนินการ');
        const chip = dleft!=='' ? `<span class="tag">เหลือ ${dleft} วัน</span>` : `<span class="tag">ไม่มีเส้นตาย</span>`;
        const card = document.createElement('div');
        card.className='mini-card';
        card.innerHTML = `
          <div class="title">${g.goal_category || '-'} • ${g.goal_specific || '-'}</div>
          <div class="small" style="margin-bottom:6px">${g.goal_timebound || ''}</div>
          <div style="display:flex; gap:8px; flex-wrap:wrap; margin-bottom:8px">
            ${chip}
            <span class="tag">สถานะ: ${status}</span>
            ${g.target_value ? `<span class="tag">เป้า: ${g.target_value} ${g.target_unit||''}</span>`:''}
          </div>
          ${g.patient_baseline ? `<div class="small">ค่าปัจจุบันตอนตั้งเป้า: ${g.patient_baseline}</div>`:''}
        `;
        wrap.appendChild(card);
      });
    }

    function renderHistory(bundle){
      const chartsWrap = el('#chartsWrap');
      chartsWrap.innerHTML='';
      const events = bundle.events || {};
      // Charts เฉพาะ metric ตัวเลข
      NUMERIC_TYPES.forEach(type=>{
        if (!events[type] || !events[type].length) return;
        const card = document.createElement('div');
        card.className='mini-card';
        card.innerHTML = `<div class="title" style="margin-bottom:8px">${METRIC_TH[type] || type}</div><canvas height="150"></canvas>`;
        chartsWrap.appendChild(card);
        const ctx = card.querySelector('canvas').getContext('2d');
        const rows = events[type];
        const labels = rows.map(r=>fmtDate(r.ts));
        if(type==='BP'){
          const sbp = rows.map(r=> (r.v1!=null? +r.v1 : null) );
          const dbp = rows.map(r=> (r.v2!=null? +r.v2 : null) );
          new Chart(ctx, {
            type:'line',
            data:{ labels, datasets:[
              { label:'ตัวบน (SBP)', data: sbp },
              { label:'ตัวล่าง (DBP)', data: dbp }
            ]},
            options:{ responsive:true, plugins:{legend:{labels:{font:{family:'Mali'}}}}, scales:{x:{ticks:{font:{family:'Mali'}}}, y:{ticks:{font:{family:'Mali'}}}} }
          });
        }else{
          const v = rows.map(r=> (typeof r.v1==='number'? r.v1 : (parseFloat(r.v1)||null)) );
          new Chart(ctx, {
            type:'line',
            data:{ labels, datasets:[{ label: METRIC_TH[type] || type, data:v }]},
            options:{ responsive:true, plugins:{legend:{labels:{font:{family:'Mali'}}}}, scales:{x:{ticks:{font:{family:'Mali'}}}, y:{ticks:{font:{family:'Mali'}}}} }
          });
        }
      });

      // FOOD table
      const food = events['FOOD'] || [];
      const foodWrap = el('#foodTableWrap');
      foodWrap.innerHTML = '';
      if (food.length){
        const tbl = document.createElement('div');
        tbl.className='card';
        tbl.innerHTML = `
          <div class="section-header" style="margin:0 0 8px">
            <h3 style="margin:0;font-size:16px">บันทึกอาหาร (ล่าสุด)</h3>
          </div>
          <div style="max-height:340px; overflow:auto; border:1px solid var(--border); border-radius:12px">
            <table>
              <thead><tr><th>วันที่</th><th>รายละเอียด</th></tr></thead>
              <tbody id="foodRows"></tbody>
            </table>
          </div>`;
        foodWrap.appendChild(tbl);
        const tbody = tbl.querySelector('#foodRows');
        food.slice().reverse().forEach(r=>{
          const tr = document.createElement('tr');
          tr.innerHTML = `<td>${fmtDate(r.ts)}</td><td>${(r.vt||'').toString()}</td>`;
          tbody.appendChild(tr);
        });
      }
    }

    function renderRegister(userId, displayName, pictureUrl){
      el('#reg').style.display='block';
      el('#headerCard').style.display='none';

      el('#avatar').src = pictureUrl || 'https://placehold.co/120x120/fef3c7/111?text=LINE';

      el('#btnSave').onclick = async ()=>{
        const payload = {
          userId,
          displayName,
          pictureUrl,
          hn: el('#hn').value.trim(),
          name_use: el('#nameuse').value.trim() || displayName,
          gender: el('#gender').value,
          age: el('#age').value.trim(),
          consent: el('#consent').checked
        };
        el('#btnSave').disabled = true;
        showLoading(true);
        try{
          await submitRegistration(payload);
          location.reload();
        }catch(err){
          alert('บันทึกไม่สำเร็จ: '+err.message);
          el('#btnSave').disabled=false;
        }finally{
          showLoading(false);
        }
      };
    }

    function renderDashboard(bundle, userId, displayName, pictureUrl){
      el('#reg').style.display='none';
      el('#dash').style.display='block';
      el('#headerCard').style.display='block';

      renderProfile(bundle, userId, displayName, pictureUrl);
      renderAdvice(bundle);
      renderGoals(bundle);
      renderHistory(bundle);
    }

    // ====== Actions ======
    async function askNurseAdvice(){
      try{
        // ส่งข้อความไปยังแชต แล้วปิด LIFF window
        await liff.sendMessages([{ type:'text', text:'วิเคราะห์ด้วยAI' }]);
      }catch(e){
        console.warn('sendMessages failed', e);
        alert('กรุณากลับไปยังห้องแชตแล้วพิมพ์: วิเคราะห์ด้วยAI');
      }finally{
        try{ liff.closeWindow(); }catch(_){}
      }
    }

    // ====== Boot ======
    function showDisclaimer(){ el('#disclaimerModal').classList.add('show'); }
    function hideDisclaimer(){ el('#disclaimerModal').classList.remove('show'); }

    async function init(){
      // เปิด modal ก่อน (อยู่เหนือ loading)
      showDisclaimer();
      el('#btnAck').onclick = hideDisclaimer;

      showLoading(true);
      try{
        await liff.init({ liffId: LIFF_ID });
        if(!liff.isLoggedIn()) { liff.login(); return; }

        const ctx = liff.getContext?.() || {};
        const tok = liff.getDecodedIDToken?.() || {};
        const prof = await liff.getProfile();
        const userId = ctx.userId || tok.sub || prof.userId || '';
        const displayName = prof.displayName || '';
        const pictureUrl = prof.pictureUrl || '';

        const bundle = await fetchDashboard(userId);
        if (!bundle || bundle.ok === false || !bundle.profile) {
          renderRegister(userId, displayName, pictureUrl);
        } else {
          renderDashboard(bundle, userId, displayName, pictureUrl);
        }

        // ปุ่ม “ขอคำแนะนำพยาบาลพี่หวี”
        el('#btnAskNurse').onclick = askNurseAdvice;

      }catch(e){
        console.error('init error', e);
        alert('มีปัญหาในการเชื่อมต่อ LIFF');
      } finally {
        showLoading(false);
      }
    }

    window.addEventListener('load', init);
  </script>
</body>
</html>
