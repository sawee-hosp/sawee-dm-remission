<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
  <title>สวีคุมหวาน • DM Remission Dashboard</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Mali:ital,wght@0,200;0,300;0,400;0,500;0,600;0,700;1,200;1,300;1,400;1,500;1,600;1,700&display=swap" rel="stylesheet">

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

  <style>
    :root{
      --bg: #fff7e0; --card: #ffffff; --ink: #3c2e17; --muted: #6f5b2e; --brand: #d59f00;
      --shadow: 0 10px 24px rgba(60,46,23,.08);
      --radius-lg: 18px; --fs-body: 18px;
    }
    *{box-sizing:border-box}
    html,body{height:100%; scroll-behavior: smooth;}
    body{ margin:0; padding:0; background:var(--bg); font-family:'Mali', system-ui, -apple-system, Segoe UI, Roboto, sans-serif; color:var(--ink); font-size:var(--fs-body); line-height:1.5; }
    button,input,select{font-family:'Mali', system-ui, -apple-system, Segoe UI, Roboto, sans-serif;}
    .navbar{ width:100%; background: linear-gradient(180deg, #fff2c6, #ffeab0); border-bottom: 1px solid #f2dfab; box-shadow: 0 4px 16px rgba(213,159,0,.08); }
    .nav-inner{max-width:1100px;margin:0 auto;padding:14px 16px;display:flex;align-items:center;gap:12px}
    .brand-logo{ width: 100px; height: 100px; border-radius: 0; object-fit: contain; flex: 0 0 auto; }
    .brand-title{font-weight:700;font-size:28px;letter-spacing:.2px}
    .brand-sub{font-size:16px;color:var(--muted);margin-top:-4px}
    .container{max-width:1100px;margin:0 auto;padding:16px}
    .card{ background:var(--card);border:1px solid #f2dfab;border-radius:var(--radius-lg); padding:16px;margin:12px 0;box-shadow:var(--shadow) }
    .card h2{font-size:24px;margin:0 0 12px;display:flex;align-items:center;gap:10px}
    .pill{ display:inline-block;padding:6px 12px;border-radius:999px;background:#fff8d8; border:1px solid #f2dfab;color:#4b3a1a;font-weight:600;font-size:17px }
    .row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
    .muted{color:var(--muted);font-size:16px}
    .btn{ padding:12px 16px;border-radius:12px;border:1px solid #f2dfab; background:linear-gradient(180deg,#ffe38b,#ffd45e); color:#4b3a1a;font-weight:700;font-size:18px;cursor:pointer; box-shadow:0 6px 16px rgba(213,159,0,.18) }
    .btn.danger{ background: linear-gradient(180deg, #ff8b8b, #ff5e5e); color: #fff; border-color: #f2abab; }
    .btn:disabled{opacity:.6;cursor:not-allowed}
    #loading{position:fixed;inset:0;background:rgba(0,0,0,.25);display:grid;place-items:center;z-index:1500}
    #loading .box{background:#fff9e6;border:1px solid #f2dfab;padding:16px 20px;border-radius:14px;box-shadow:var(--shadow)}
    .profile-grid{ display:grid; grid-template-columns: 150px 1fr; gap:16px; align-items:center; }
    @media (max-width:700px){ .profile-grid{ grid-template-columns: 1fr; text-align: center;} }
    .profile-left .avatar{ width: 150px; height: 150px; border-radius: 50%; object-fit: cover; border: 3px solid #f6e3a6; background: #fff; box-shadow: var(--shadow); }
    .carousel{display:flex;gap:14px;overflow-x:auto;padding-bottom:6px;scroll-snap-type:x mandatory}
    .c-item{ flex:0 0 86%;max-width:520px;min-width:320px;scroll-snap-align:start; background:#fff;border:1px solid #f2dfab;border-radius:14px;padding:14px;box-shadow:var(--shadow) }
    table{width:100%;border-collapse:collapse;font-size:16px}
    th,td{border-bottom:1px solid #f2dfab;padding:10px 8px;text-align:left;vertical-align:top}
    th{background:#fff7d2}
    .table-wrap{ max-height:400px; overflow:auto; border: 1px solid #f2dfab; border-radius: 12px; }
    label{font-size:18px;font-weight:600;display:block;margin:10px 0 6px}
    input, select{ width:100%;padding:14px 16px;border:1px solid #e8d494;border-radius:12px;background:#fff; font-size:18px;color:var(--ink) }
    .grid{display:grid;gap:14px;grid-template-columns:repeat(2,minmax(0,1fr))}
    @media (max-width:820px){.grid{grid-template-columns:1fr}}
    
    .charts-grid{display:grid;gap:14px;grid-template-columns:repeat(auto-fit,minmax(280px,1fr))}
    .chart-card{padding:12px;border:1px solid #f2dfab;border-radius:14px;background:#fff;box-shadow:var(--shadow)}
    .chart-card h3{font-size:20px;margin:0 0 8px}
    .chart-box{width:100%;height:220px}
    .chart-box canvas{width:100%!important;height:100%!important}
    
    .menu-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 14px; margin: 16px 0; }
    .menu-btn { display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 8px; padding: 16px 10px; background: #fff; border: 1px solid var(--line); border-radius: var(--radius-lg); box-shadow: var(--shadow); cursor: pointer; text-align: center; font-size: 17px; font-weight: 600; color: var(--ink); }
    .menu-btn .emoji { font-size: 40px; line-height: 1; }
    .content-card { display: none; }
    .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
    .btn-close { font-size: 16px; padding: 8px 12px; background: #f0f0f0; border-color: #ddd; color: #555; box-shadow: none; }

    .filter-controls { margin-bottom: 12px; flex-wrap: wrap; gap: 8px; }
    .filter-btn { padding: 6px 12px; font-size: 15px; border-radius: 999px; cursor: pointer; background: #fff; border: 1px solid var(--line); color: var(--muted); }
    .filter-btn.active { background: #d59f00; color: #fff; font-weight: 700; border-color: var(--brand); }
    
    .btn-small { padding: 4px 8px; font-size: 14px; border-radius: 8px; text-decoration: none; display: inline-block; margin-top: 2px; border: 1px solid transparent; }
    .btn-small.edit { background: #e3f2fd; border-color: #bbdefb; color: #1565c0; }
    .btn-small.delete { background: #ffebee; border-color: #ffcdd2; color: #c62828; }
    td .row { gap: 6px; }

    .fx-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
    @media (max-width: 500px) { .fx-grid { grid-template-columns: 1fr; } }
    .fx-item { padding: 8px; border-radius: 12px; background: #fffde7; }
    .fx-item .label { font-size: 16px; color: var(--muted); }
    .fx-item .value { font-size: 22px; font-weight: 600; }

    #single-event-view .card { border: 2px solid var(--brand); }
    #single-event-view .data-point { margin: 8px 0; font-size: 18px; }
    #single-event-view .data-point .label { font-weight: 600; color: var(--muted); min-width: 100px; display: inline-block; }
    #confirm-dialog { position: fixed; inset: 0; background: rgba(0,0,0,.5); display: none; place-items: center; z-index: 2000; padding: 16px; }
    #confirm-dialog .panel { background: var(--card); padding: 20px; border-radius: var(--radius-lg); text-align: center; max-width: 400px; }
    #notification { display:none; position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background-color: #333; color: white; padding: 12px 20px; border-radius: 8px; z-index: 2100; }

    /* ✅✅✅ [NEW] CSS for History-Only View ✅✅✅ */
    body.history-only .navbar,
    body.history-only #profile-card,
    body.history-only #main-menu,
    body.history-only .content-card:not(#historyCard),
    body.history-only #historyCard .card-header,
    body.history-only #historyCard h3,
    body.history-only #historyCard .filter-controls,
    body.history-only #chartsWrap {
      display: none !important;
    }
    body.history-only #dashboard-view,
    body.history-only #historyCard {
      display: block !important;
    }
    body.history-only #historyCard {
      padding: 0;
      margin: 0;
      border: none;
      box-shadow: none;
      background-color: transparent;
    }
    body.history-only .container {
      padding: 8px; /* Reduce padding for table-only view */
    }
    body.history-only .table-wrap {
        max-height: none; /* Show full table */
    }
  </style>
</head>
<body>

  <nav class="navbar">
    <div class="nav-inner">
      <img class="brand-logo" src="https://img2.pic.in.th/pic/ChatGPT-Image-10-..-2568-12_48_07.png" alt="โลโก้">
      <div>
        <div class="brand-title">สวีคุมหวาน</div>
        <div class="brand-sub">ข้อมูลส่วนตัว • คลินิกลดยาเบาหวาน (DM Remission) รพ.สวี</div>
      </div>
    </div>
  </nav>

  <div id="loading"><div class="box">กำลังโหลดข้อมูล…</div></div>
  <div id="notification"></div>

  <div class="container">
    <div id="reg-view" class="card" style="display:none">
      <h2>ลงทะเบียนผู้ป่วย</h2>
      <p class="muted">คลินิกลดยาเบาหวาน (DM Remission) รพ.สวี จะนำข้อมูลที่ท่านบันทึก มาใช้ประมวลผลเพื่อติดตามผลการรักษา โปรดให้ความอนุญาตใช้ข้อมูลที่ท่านบันทึก</p>
      <div class="grid">
        <div><label>HN</label><input id="hn" type="text" placeholder="เลขรพ. 9 หลัก"></div>
        <div><label>ชื่อที่อยากให้ LINE เรียก</label><input id="nameuse" type="text" placeholder="เช่น น้องส้ม, พี่แดง"></div>
      </div>
      <div class="grid">
        <div><label>เพศ</label><select id="gender"><option value="">— เลือกเพศ —</option><option value="Male">ชาย</option><option value="Female">หญิง</option><option value="Other">อื่น ๆ</option></select></div>
        <div><label>อายุ</label><input id="age" type="number" min="1" max="120" placeholder="ตัวอย่าง 45"></div>
      </div>
      <div class="row" style="margin:12px 0"><input id="consent" type="checkbox" style="transform: scale(1.2); margin-right:8px"><span class="muted">ฉันยินยอมให้คลินิกใช้ข้อมูลนี้เพื่อการดูแลรักษา</span></div>
      <button id="btnSave" class="btn">บันทึกข้อมูล</button>
    </div>

    <div id="dashboard-view" style="display:none">
      <div id="profile-card" class="card">
        <div class="card-header">
          <h2 style="margin:0">ข้อมูลส่วนตัว</h2>
          <button id="btnEditProfile" class="btn" style="padding:8px 12px; font-size:16px">แก้ไขข้อมูล</button>
        </div>
        <div class="profile-grid">
          <div class="profile-left"><img id="avatar" class="avatar" src="" alt="avatar"></div>
          <div class="profile-right">
            <div class="row" style="justify-content: center;"><span class="pill">ชื่อ</span> <span id="p_name" class="value" style="font-size: 22px;">-</span></div>
            <div class="row" style="margin-top:8px; justify-content: center;"><span class="pill">HN</span> <span id="p_hn" class="value">-</span></div>
            <div class="row" style="margin-top:8px; justify-content: center;">
              <span class="pill">เพศ</span><span id="p_gender" class="value">-</span>
              <span class="pill" style="margin-left:10px">อายุ</span><span id="p_age" class="value">-</span>
            </div>
          </div>
        </div>
      </div>

      <div id="main-menu">
        <div class="menu-grid">
          <button class="menu-btn" data-target="historyCard"><span class="emoji">📈</span><span>ประวัติการบันทึกผล</span></button>
          <button class="menu-btn" data-target="goalsCard"><span class="emoji">🎯</span><span>เป้าหมายของฉัน</span></button>
          <button class="menu-btn" data-target="foodCard"><span class="emoji">🥗</span><span>การจัดการอาหาร</span></button>
          <button class="menu-btn" data-target="adviceCard"><span class="emoji">🤖</span><span>คำแนะนำโดย AI</span></button>
        </div>
      </div>
      
      <div id="goalsCard" class="content-card card"></div>
      <div id="adviceCard" class="content-card card"></div>
      <div id="foodCard" class="content-card card"></div>
      <div id="historyCard" class="content-card card"></div>
    </div>
    
    <div id="single-event-view" style="display:none;" class="container">
      <div class="card">
        <h2 id="single-event-title">จัดการข้อมูล</h2>
        <div id="single-event-details"></div>
        <div id="edit-form" style="display:none; margin-top: 16px;">
          <label id="edit-label">แก้ไขค่า</label>
          <input id="edit-value-input" type="number" step="any">
        </div>
        <div class="row" style="margin-top: 20px; justify-content: flex-end;">
          <button id="btn-cancel-single" class="btn btn-close">ยกเลิก</button>
          <button id="btn-action-single" class="btn">ยืนยัน</button>
        </div>
      </div>
    </div>

    <div id="confirm-dialog">
      <div class="panel">
        <h3>ยืนยันการลบ</h3>
        <p>คุณต้องการลบรายการนี้ใช่หรือไม่? การกระทำนี้ไม่สามารถย้อนกลับได้</p>
        <div class="row" style="justify-content: center; margin-top: 16px;">
          <button id="btn-confirm-cancel" class="btn btn-close">ยกเลิก</button>
          <button id="btn-confirm-delete" class="btn danger">ยืนยันการลบ</button>
        </div>
      </div>
    </div>
  </div>

<script>
    // ====== CONFIG ======
    const LIFF_ID = '2007840605-zKl7p3Aa';
    const GAS_WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbwDi08IqlCBBESqXYkQgvA1EdvCjLchwZdBYAtobMr83NEWkvtgwVdTnzts5T9tvbM0/exec';

    // ====== State & Helpers ======
    let liffProfile = {};
    let currentEventData = {};
    let allEventsData = []; // Store all events for filtering
    let currentHistoryFilter = 'ALL';

    const $  = s => document.querySelector(s);
    const $$ = s => document.querySelectorAll(s);
    const showLoading = v => { $('#loading').style.display = v ? 'grid' : 'none'; };
    const fmtDate = d => { const t=new Date(d); if(isNaN(+t)) return '-'; const dd=String(t.getDate()).padStart(2,'0'); const mm=String(t.getMonth()+1).padStart(2,'0'); const yy=t.getFullYear(); const hh=String(t.getHours()).padStart(2,'0'); const mi=String(t.getMinutes()).padStart(2,'0'); return `${dd}/${mm}/${yy} ${hh}:${mi}`; };
    const thaiGender = g => g==='Male'?'ชาย':g==='Female'?'หญิง':g? 'อื่น ๆ':'-';
    
    const EVENT_TYPE_THAI = {
      'ALL': '🗒️ ทั้งหมด', 'FOOD': '🍽️ อาหาร', 'EXERCISE': '💪 ออกกำลังกาย', 'ADVERSE': '⚠️ อาการ', 'DEPRESSION': '😟 ความเครียด',
      'WEIGHT':'⚖️ น้ำหนัก', 'BP':'🩸 ความดัน', 'WAIST':'📏 รอบเอว', 'SBGM':'🩸 น้ำตาล', 'HBA1C':'🧪 HbA1c', 'BODY_FAT':'🧍‍♀️ไขมัน'
    };
    const thaiMealSubtype = s => ({'BREAKFAST':'🍳 เช้า','LUNCH':'🍛 กลางวัน','DINNER':'🍲 เย็น','SNACK':'🥤 ว่าง'})[String(s || '').toUpperCase()] || 'อื่นๆ';

    function showNotification(message, duration = 3000) {
        const notif = $('#notification');
        notif.textContent = message;
        notif.style.display = 'block';
        setTimeout(() => { notif.style.display = 'none'; }, duration);
    }

    // ====== API Calls ======
    async function apiFetch(action, params = {}) {
        const url = new URL(GAS_WEB_APP_URL);
        url.searchParams.set('action', action);
        for(const key in params) { url.searchParams.set(key, params[key]); }
        const res = await fetch(url);
        if(!res.ok) throw new Error(`Network error: ${res.status} ${res.statusText}`);
        const json = await res.json();
        if(json.ok === false) throw new Error(json.error || 'API returned an error');
        return json;
    }

    async function apiPost(action, payload) {
        await fetch(GAS_WEB_APP_URL, {
            method: 'POST',
            mode: 'no-cors', 
            headers: {'Content-Type': 'text/plain;charset=utf-8'},
            body: JSON.stringify({ action, payload })
        });
        return { ok: true };
    }

    // ====== UI Navigation ======
    function showCard(cardId) {
        $('#main-menu').style.display = 'none';
        $$('.content-card').forEach(c => c.style.display = 'none');
        $(`#${cardId}`).style.display = 'block';
    }
    function showMainMenu() {
        $$('.content-card').forEach(c => c.style.display = 'none');
        $('#main-menu').style.display = 'block';
    }
    function setupMenu() {
        $$('.menu-btn').forEach(btn => {
            btn.onclick = () => showCard(btn.dataset.target);
        });
    }

    // ====== Renderers ======
    function renderProfile(bundle){
      const p = bundle.profile || {};
      $('#avatar').src = p.PictureURL || liffProfile.pictureUrl || '';
      $('#p_name').textContent   = p.NameUse || p.DisplayName || '-';
      $('#p_hn').textContent     = p.HN || '-';
      $('#p_gender').textContent = thaiGender(p.Gender);
      $('#p_age').textContent    = p.Age || '-';
    }

    function renderGoals(bundle) {
        const list = bundle.goals || [];
        const card = $('#goalsCard');
        let html = `<div class="card-header"><h2>🎯 เป้าหมายของฉัน (${list.length})</h2><button class="btn-close-card btn btn-close">ปิด</button></div>`;
        if (list.length === 0) {
            html += `<div class="muted">ยังไม่มีเป้าหมาย</div>`;
        } else {
            html += `<div class="carousel">${list.map(g => `<div class="c-item"><h3>${g.goal_specific || '-'}</h3><p class="muted">${g.target_value || ''} ${g.target_unit || ''}</p></div>`).join('')}</div>`;
        }
        card.innerHTML = html;
        card.querySelector('.btn-close-card').onclick = showMainMenu;
    }
    
    function renderAdvice(bundle) {
        const items = bundle.ai_analysis || [];
        const card = $('#adviceCard');
        let html = `<div class="card-header"><h2>🤖 คำแนะนำโดย AI</h2><button class="btn-close-card btn btn-close">ปิด</button></div>`;
        if (items.length === 0) {
            html += `<div class="muted">ยังไม่มีคำแนะนำ</div>`;
        } else {
            html += `<div class="carousel">${items.map(item => `<div class="c-item"><h3>คำแนะนำล่าสุด</h3><div class="muted">${fmtDate(item.timestamp)}</div><p style="white-space:pre-wrap;margin-top:6px">${item.advice_text || '-'}</p></div>`).join('')}</div>`;
        }
        card.innerHTML = html;
        card.querySelector('.btn-close-card').onclick = showMainMenu;
    }
    
    function renderFood(bundle) {
        const items = bundle.food_exchange || [];
        const card = $('#foodCard');
        let html = `<div class="card-header"><h2>🥗 การจัดการอาหาร</h2><button class="btn-close-card btn btn-close">ปิด</button></div>`;

        if (items.length === 0) {
            html += `<div class="muted">ยังไม่มีข้อมูล</div>`;
        } else {
            const latest = items.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp))[0];
            html += `
                <div class="muted" style="margin-bottom: 12px;">ข้อมูลล่าสุดเมื่อ ${fmtDate(latest.timestamp)}</div>
                <div class="fx-grid">
                    <div class="fx-item"><div class="label">น้ำหนัก</div><div class="value">${latest.weight_kg || '-'} kg</div></div>
                    <div class="fx-item"><div class="label">พลังงานที่ต้องการ</div><div class="value">${latest.total_kcal || '-'} kcal</div></div>
                </div>
                <div style="margin: 16px 0;"><h4>สัดส่วนพลังงาน (CHO:PRO:FAT)</h4><p>${latest.macro_cho_ratio||'-'}:${latest.macro_pro_ratio||'-'}:${latest.macro_fat_ratio||'-'}</p></div>
                <h4>ส่วนอาหารแลกเปลี่ยนต่อวัน</h4>
                <div class="table-wrap">
                    <table>
                        <thead><tr><th>หมวดอาหาร</th><th>จำนวนส่วน</th></tr></thead>
                        <tbody>
                            <tr><td>🍚 ข้าว/แป้ง</td><td>${latest.srv_grain_80kcal || '-'}</td></tr>
                            <tr><td>🍓 ผลไม้</td><td>${latest.srv_fruit_60kcal || '-'}</td></tr>
                            <tr><td>🥦 ผัก</td><td>${latest.srv_vegB_25kcal || '-'}</td></tr>
                            <tr><td>🥛 นม</td><td>${latest.srv_milk_90kcal || '-'}</td></tr>
                            <tr><td>🥩 เนื้อสัตว์ไขมันต่ำ-ปานกลาง</td><td>${(Number(latest.srv_meat_lean_35kcal) || 0) + (Number(latest.srv_meat_lowfat_55kcal) || 0)}</td></tr>
                            <tr><td>🥓 เนื้อสัตว์ไขมันสูง</td><td>${latest.srv_meat_highfat_100kcal || '-'}</td></tr>
                            <tr><td>🥑 ไขมัน/ถั่ว</td><td>${(Number(latest.srv_oil_45kcal) || 0) + (Number(latest.srv_nuts_45kcal) || 0)}</td></tr>
                        </tbody>
                    </table>
                </div>
            `;
        }
        card.innerHTML = html;
        card.querySelector('.btn-close-card').onclick = showMainMenu;
    }

    function renderHistory(bundle) {
        const card = $('#historyCard');
        const headerHtml = `<div class="card-header"><h2>📈 ประวัติการบันทึกผล</h2><button class="btn-close-card btn btn-close">ปิด</button></div>`;

        const filterOptions = ['ALL', 'BP', 'WEIGHT', 'SBGM', 'WAIST', 'FOOD', 'EXERCISE', 'ADVERSE', 'DEPRESSION'];
        const filterHtml = `<div class="row filter-controls">${filterOptions.map(f => `<button class="filter-btn ${f === 'ALL' ? 'active' : ''}" data-filter="${f}">${EVENT_TYPE_THAI[f]}</button>`).join('')}</div>`;
        
        const contentHtml = `
            <h3 style="margin-top: 20px;">บันทึกทั้งหมด</h3>
            ${filterHtml}
            <div class="table-wrap"><table id="history-table"></table></div>
            <h3 style="margin-top: 20px;">กราฟสุขภาพ</h3>
            <div id="chartsWrap" class="charts-grid"></div>
        `;
        
        card.innerHTML = headerHtml + contentHtml;
        card.querySelector('.btn-close-card').onclick = showMainMenu;
        
        $$('.filter-btn').forEach(btn => {
            btn.onclick = () => {
                $$('.filter-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                currentHistoryFilter = btn.dataset.filter;
                renderHistoryTable();
            };
        });
        
        renderHistoryTable();
        renderHistoryCharts(bundle.events || {});
    }
    
    function renderHistoryTable() {
        const table = $('#history-table');
        const filteredEvents = (currentHistoryFilter === 'ALL')
            ? allEventsData
            : allEventsData.filter(e => e.type === currentHistoryFilter);

        if (filteredEvents.length === 0) {
            table.innerHTML = `<tbody><tr><td colspan="5" style="text-align:center;" class="muted">ไม่พบข้อมูลสำหรับหมวดหมู่นี้</td></tr></tbody>`;
            return;
        }

        const tableHeader = `<thead><tr><th>เวลา</th><th>ประเภท</th><th>รายละเอียด</th><th>ค่า/ปริมาณ</th><th>จัดการ</th></tr></thead>`;
        const tableBody = `<tbody>
            ${filteredEvents.map(e => {
                let detail = e.value_text || '-';
                let value = '-';
                if (e.type === 'BP') {
                    value = `${e.v1 || e.value_numeric_1 || '-'}/${e.v2 || e.value_numeric_2 || '-'}`;
                } else if (e.v1 || e.value_numeric_1) {
                    value = `${e.v1 || e.value_numeric_1} ${e.unit || e.value_unit || ''}`.trim();
                }

                if(e.type === 'FOOD') detail = `${thaiMealSubtype(e.subtype || e.event_subtype)}: ${detail}`;
                
                const isoTs = new Date(e.ts).toISOString();

                return `<tr>
                    <td>${fmtDate(e.ts)}</td>
                    <td>${EVENT_TYPE_THAI[e.type] || e.type}</td>
                    <td>${detail}</td>
                    <td>${value}</td>
                    <td>
                        <div class="row">
                            <a href="?action=edit&ts=${isoTs}" target="_self" class="btn-small edit">แก้ไข</a>
                            <a href="?action=delete&ts=${isoTs}" target="_self" class="btn-small delete">ลบ</a>
                        </div>
                    </td>
                </tr>`
            }).join('')}
        </tbody>`;
        table.innerHTML = tableHeader + tableBody;
    }
    
    function renderHistoryCharts(events) {
        const chartsWrap = $('#chartsWrap');
        chartsWrap.innerHTML = '';
        const metricKeys = Object.keys(events).filter(k => ['WEIGHT','BP','WAIST','SBGM','HBA1C','BODY_FAT'].includes(k));
        
        if (metricKeys.length === 0) {
            chartsWrap.innerHTML = `<div class="muted">ยังไม่มีข้อมูลสำหรับสร้างกราฟ</div>`;
            return;
        }

        metricKeys.forEach(k => {
            const chartContainer = document.createElement('div');
            chartContainer.className = 'chart-card';
            chartContainer.innerHTML = `<h3>${EVENT_TYPE_THAI[k]}</h3><div class="chart-box"><canvas></canvas></div>`;
            chartsWrap.appendChild(chartContainer);
            
            const ctx = chartContainer.querySelector('canvas').getContext('2d');
            const rows = (events[k]||[]).map(r=>({...r, ts:new Date(r.ts)})).sort((a,b)=>a.ts-b.ts);
            const labels = rows.map(r=>fmtDate(r.ts));
            const chartLabel = EVENT_TYPE_THAI[k] || k;

            if (k === 'BP') {
                const sbpData = rows.map(r => parseFloat(r.v1 || r.value_numeric_1) || null);
                const dbpData = rows.map(r => parseFloat(r.v2 || r.value_numeric_2) || null);
                new Chart(ctx, {
                    type: 'line', data: { labels: labels, datasets: [ { label: 'ตัวบน (SBP)', data: sbpData, borderColor: 'rgba(255, 99, 132, 1)', tension: 0.1, fill: false }, { label: 'ตัวล่าง (DBP)', data: dbpData, borderColor: 'rgba(54, 162, 235, 1)', tension: 0.1, fill: false } ] },
                    options: { responsive: true, maintainAspectRatio: false, interaction: { mode: 'index', intersect: false } }
                });
            } else {
                const dataPoints = rows.map(r => parseFloat(r.v1 || r.value_numeric_1) || null);
                new Chart(ctx, {
                    type: 'line', data: { labels: labels, datasets: [{ label: chartLabel, data: dataPoints, borderColor: 'rgba(75, 192, 192, 1)', tension: 0.1, fill: false }] },
                    options: { responsive: true, maintainAspectRatio: false, interaction: { mode: 'index', intersect: false } }
                });
            }
        });
    }

    // ====== Main Logic Flow ======
    
    function renderRegister() {
        $('#reg-view').style.display = 'block';
        $('#dashboard-view').style.display = 'none';
        $('#btnSave').onclick = async () => {
            const payload = { userId: liffProfile.userId, displayName: liffProfile.displayName, pictureUrl: liffProfile.pictureUrl, hn: $('#hn').value.trim(), name_use: $('#nameuse').value.trim() || liffProfile.displayName, gender: $('#gender').value, age: $('#age').value.trim(), consent: $('#consent').checked };
            if (!payload.consent) { showNotification('โปรดยอมรับการใช้งานข้อมูลเพื่อการดูแลรักษา'); return; }
            const btn = $('#btnSave');
            btn.disabled = true; showLoading(true);
            await apiPost('registerUser', payload);
            showLoading(false); btn.disabled = false;
            showNotification('บันทึกข้อมูลเรียบร้อยแล้ว');
            setTimeout(() => location.reload(), 1500);
        };
    }

    function startEditProfile(profile) {
        $('#reg-view').style.display = 'block';
        $('#dashboard-view').style.display = 'none';
        $('#reg-view h2').textContent = 'แก้ไขข้อมูลส่วนตัว';
        $('#btnSave').textContent = 'อัปเดตข้อมูล';
        $('#hn').value = profile?.HN || '';
        $('#nameuse').value = profile?.NameUse || profile?.DisplayName || liffProfile.displayName || '';
        $('#gender').value = profile?.Gender || '';
        $('#age').value = profile?.Age || '';
        $('#consent').checked = String(profile?.Consent).toUpperCase() === 'TRUE' || profile?.Consent === true;
        $('#btnSave').onclick = async () => {
            const payload = { userId: liffProfile.userId, displayName: liffProfile.displayName, pictureUrl: liffProfile.pictureUrl, hn: $('#hn').value.trim(), name_use: $('#nameuse').value.trim() || liffProfile.displayName, gender: $('#gender').value, age: $('#age').value.trim(), consent: $('#consent').checked };
            if (!payload.consent) { showNotification('โปรดยอมรับการใช้งานข้อมูล'); return; }
            const btn = $('#btnSave');
            btn.disabled = true; showLoading(true);
            await apiPost('registerUser', payload);
            showLoading(false); btn.disabled = false;
            showNotification('อัปเดตข้อมูลเรียบร้อยแล้ว');
            setTimeout(() => location.reload(), 1500);
        };
    }
    
    async function loadDashboardMode(initialView) {
        $('#dashboard-view').style.display = 'block';
        setupMenu();
        const bundle = await apiFetch('getDashboard', { userId: liffProfile.userId });
        
        if (!bundle.profile) {
            renderRegister();
            return;
        }
        
        allEventsData = [];
        Object.keys(bundle.events).forEach(type => {
            bundle.events[type].forEach(e => {
                const normalizedEvent = { ts: e.ts, type: type, event_subtype: e.event_subtype || e.subtype, value_numeric_1: e.value_numeric_1 || e.v1, value_numeric_2: e.value_numeric_2 || e.v2, value_text: e.value_text || e.vt, value_unit: e.value_unit || e.unit };
                allEventsData.push(normalizedEvent);
            });
        });
        allEventsData.sort((a, b) => new Date(b.ts) - new Date(a.ts));
        
        $('#btnEditProfile').onclick = () => startEditProfile(bundle.profile);
        renderProfile(bundle);
        renderGoals(bundle);
        renderAdvice(bundle);
        renderFood(bundle);
        renderHistory(bundle);
        
        if (initialView) {
            showCard(`${initialView}Card`);
            // ✅✅✅ [FIXED] Hide profile and menu if a specific view is requested ✅✅✅
            if ($('#profile-card')) $('#profile-card').style.display = 'none';
            if ($('#main-menu')) $('#main-menu').style.display = 'none';
        }
    }

    async function loadSingleEventMode(action, ts) {
        $('#dashboard-view').style.display = 'none';
        $('#reg-view').style.display = 'none';
        $('#single-event-view').style.display = 'block';
        const result = await apiFetch('getEvent', { userId: liffProfile.userId, ts });
        if (!result.ok || !result.data) {
            $('#single-event-details').innerHTML = '<h2>ไม่พบข้อมูล</h2><p>อาจเป็นข้อมูลที่ถูกลบไปแล้ว หรือคุณไม่มีสิทธิ์เข้าถึง</p>';
            return;
        }
        currentEventData = result.data;
        const { event_type, event_subtype, value_numeric_1, value_numeric_2, value_unit, value_text, timestamp } = currentEventData;
        const title = (action === 'edit' ? 'แก้ไข' : 'ลบ') + `ข้อมูล: ${EVENT_TYPE_THAI[event_type] || event_type}`;
        $('#single-event-title').textContent = title;
        let valueDisplay = '-';
        if (event_type === 'BP') {
          valueDisplay = `${value_numeric_1 || '-'}/${value_numeric_2 || '-'}`;
        } else if (value_numeric_1) {
          valueDisplay = `${value_numeric_1} ${value_unit || ''}`.trim();
        }
        let detailsHtml = `
            <div class="data-point"><span class="label">เวลา:</span> ${fmtDate(timestamp)}</div>
            <div class="data-point"><span class="label">ประเภท:</span> ${EVENT_TYPE_THAI[event_type] || event_type}</div>`;
        if (event_type === 'FOOD') detailsHtml += `<div class="data-point"><span class="label">มื้อ:</span> ${thaiMealSubtype(event_subtype)} (${value_text || '-'})</div>`;
        else detailsHtml += `<div class="data-point"><span class="label">รายละเอียด:</span> ${value_text || '-'}</div>`;
        detailsHtml += `<div class="data-point"><span class="label">ค่าที่บันทึก:</span> ${valueDisplay}</div>`;
        $('#single-event-details').innerHTML = detailsHtml;
        $('#btn-cancel-single').onclick = () => { window.location.href = window.location.pathname; };
        if (action === 'edit') {
            $('#edit-form').style.display = 'block';
            $('#edit-label').textContent = `แก้ไขค่า (${value_unit || 'ค่า'})`;
            $('#edit-value-input').value = value_numeric_1;
            $('#btn-action-single').textContent = 'บันทึกการแก้ไข';
            $('#btn-action-single').onclick = handleUpdateEvent;
        } else {
            $('#edit-form').style.display = 'none';
            $('#btn-action-single').textContent = 'ดำเนินการลบ';
            $('#btn-action-single').classList.add('danger');
            $('#btn-action-single').onclick = () => $('#confirm-dialog').style.display = 'grid';
        }
    }
    
    async function handleUpdateEvent() {
        showLoading(true);
        const payload = { userId: liffProfile.userId, ts: new Date(currentEventData.timestamp).toISOString(), newValue: $('#edit-value-input').value };
        await apiPost('updateEvent', payload);
        showLoading(false);
        showNotification('แก้ไขข้อมูลเรียบร้อยแล้ว');
        setTimeout(() => { window.location.href = window.location.pathname + '?view=history'; }, 1500);
    }

    async function handleDeleteEvent() {
        showLoading(true);
        const payload = { userId: liffProfile.userId, ts: new Date(currentEventData.timestamp).toISOString() };
        await apiPost('deleteEvent', payload);
        showLoading(false);
        showNotification('ลบข้อมูลเรียบร้อยแล้ว');
        setTimeout(() => { window.location.href = window.location.pathname + '?view=history'; }, 1500);
    }
    
    // ✅✅✅ [FIXED] This function is now updated to handle the `view` parameter ✅✅✅
    async function main() {
      showLoading(true);
      try {
        await liff.init({ liffId: LIFF_ID });
        if (!liff.isLoggedIn()) { liff.login(); return; }
        liffProfile = await liff.getProfile();
        
        $('#btn-confirm-cancel').onclick = () => $('#confirm-dialog').style.display = 'none';
        $('#btn-confirm-delete').onclick = () => { $('#confirm-dialog').style.display = 'none'; handleDeleteEvent(); };
        
        const urlParams = new URLSearchParams(window.location.search);
        const action = urlParams.get('action');
        const ts = urlParams.get('ts');
        const view = urlParams.get('view');

        // This router determines what to show on the page
        if ((action === 'edit' || action === 'delete') && ts) {
          // If editing/deleting, show only that view
          await loadSingleEventMode(action, ts);
        } else {
          // Otherwise, load the main dashboard and handle the 'view' parameter inside
          await loadDashboardMode(view);
        }

      } catch(e) {
        console.error('Initialization Error:', e);
        $('.container').innerHTML = `<div class="card"><h2>เกิดข้อผิดพลาด</h2><p>${e.message}</p></div>`;
      } finally {
        showLoading(false);
      }
    }

    window.addEventListener('load', main);
</script>
</body>
</html>