<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
  <title>สวีคุมหวาน • DM Remission Dashboard</title>

  <!-- Fonts: Mali (ตัวใหญ่ อ่านง่ายสำหรับผู้สูงอายุ) -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Mali:ital,wght@0,200;0,300;0,400;0,500;0,600;0,700;1,200;1,300;1,400;1,500;1,600;1,700&display=swap" rel="stylesheet">

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- LIFF -->
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

  <style>
    :root{
      --bg: #fff7e0;               /* ครีมเหลืองอ่อน */
      --card: #ffffff;
      --ink: #3c2e17;              /* น้ำตาลเข้ม อ่านง่าย */
      --muted: #6f5b2e;            /* น้ำตาลอ่อน */
      --brand: #d59f00;            /* เหลืองทอง */
      --brand2:#f3c200;
      --ok: #0a9d67;
      --warn:#d98324;
      --line:#ead9ad;
      --shadow: 0 10px 24px rgba(60,46,23,.08);
      --radius-lg: 18px;
      --radius-md: 14px;
      --radius-sm: 10px;
      --gap: 16px;
      --fs-body: 18px;             /* ตัวใหญ่ */
      --fs-h1: 28px;
      --fs-h2: 24px;
      --fs-h3: 20px;
      --fs-small: 16px;
    }

    * { box-sizing: border-box }
    html, body { height: 100% }
    body{
      margin:0; padding:0;
      background: var(--bg);
      font-family: 'Mali', system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      color: var(--ink);
      font-size: var(--fs-body);
      line-height: 1.5;
    }

    /* Navbar */
    .navbar{
      position: sticky; top:0; z-index: 100;
      width:100%;
      background: linear-gradient(180deg, #fff2c6, #ffeab0);
      border-bottom: 1px solid #f2dfab;
      box-shadow: 0 4px 16px rgba(213,159,0,.08);
    }
    .nav-inner{
      max-width: 1100px; margin:0 auto;
      padding: 14px 16px; display:flex; align-items:center; gap:12px;
    }
    .brand-dot{
      width: 40px; height: 40px; border-radius: 50%;
      background: radial-gradient(circle at 30% 30%, var(--brand2), var(--brand));
      border: 2px solid rgba(60,46,23,.08);
      box-shadow: inset 0 0 8px rgba(0,0,0,.08);
      flex: 0 0 auto;
    }
    .brand-title{
      font-weight: 700; font-size: var(--fs-h1); letter-spacing: .2px;
    }
    .brand-sub{
      font-size: var(--fs-small); color: var(--muted); margin-top:-4px;
    }

    /* Layout container */
    .container{
      max-width: 1100px; margin: 0 auto; padding: 16px;
    }

    /* Header (avatar + name) */
    header.profile{
      display:flex; align-items:center; gap: 14px; margin: 14px 0 8px;
    }
    .avatar{
      width:76px; height:76px; border-radius:50%; object-fit:cover;
      border: 3px solid #f6e3a6; background:#fff;
      box-shadow: var(--shadow);
      flex: 0 0 auto;
    }
    .h-title{ font-size: 26px; font-weight: 700; margin:0; }
    .h-sub{ color: var(--muted); font-size: var(--fs-small); margin-top:2px }

    /* Card */
    .card{
      background: var(--card);
      border: 1px solid var(--line);
      border-radius: var(--radius-lg);
      padding: 16px;
      margin: 12px 0;
      box-shadow: var(--shadow);
    }
    .card h2{
      font-size: var(--fs-h2);
      margin: 0 0 12px;
      display:flex; align-items:center; gap:10px;
    }
    .pill{
      display:inline-block; padding: 6px 10px;
      border-radius: 999px; background:#fff8d8;
      border: 1px solid #f2dfab; color: #4b3a1a; font-weight: 600; font-size: 17px;
    }
    .row{ display:flex; gap: 12px; align-items:center; flex-wrap: wrap }
    .grid{
      display:grid; gap: 14px;
      grid-template-columns: repeat(2, minmax(0,1fr));
    }
    @media (max-width: 820px){
      .grid{ grid-template-columns: 1fr; }
    }

    .value{ margin-top:6px; font-weight:600 }
    .muted{ color: var(--muted); font-size: var(--fs-small) }
    .tag{
      font-size: 15px; color:#5b451f;
      background:#fff7d2; padding:5px 10px; border-radius:999px; border:1px solid #f2dfab;
    }
    .btn{
      padding: 12px 16px; border-radius: 12px; border: 1px solid #f2dfab;
      background: linear-gradient(180deg, #ffe38b, #ffd45e);
      color: #4b3a1a; font-weight: 700; font-size: 18px; cursor: pointer;
      box-shadow: 0 6px 16px rgba(213,159,0,.18);
    }
    .btn:disabled{ opacity:.6; cursor:not-allowed }

    /* Loading overlay */
    #loading{ position:fixed; inset:0; background:rgba(0,0,0,.25); display:none; place-items:center; z-index:999 }
    #loading .box{
      background:#fff9e6; border:1px solid #f2dfab; padding: 16px 20px; border-radius: 14px;
      box-shadow: var(--shadow);
    }

    /* Disclaimer modal */
    .modal{
      position:fixed; inset:0; background:rgba(0,0,0,.45); display:none; place-items:center; z-index:200;
      padding: 18px;
    }
    .modal .panel{
      width: min(680px, 96vw);
      background: #fffef6;
      border: 1px solid #f0dfb1; border-radius: 18px;
      box-shadow: 0 20px 48px rgba(60,46,23,.25);
      padding: 18px;
    }
    .modal .m-header{ display:flex; gap:12px; align-items:center; margin-bottom: 8px }
    .modal .m-avatar{
      width:72px; height:72px; border-radius:50%; object-fit:cover;
      border:2px solid #f3d789; background:#fff;
      box-shadow: var(--shadow);
    }
    .modal h3{ font-size: 24px; margin: 0 }
    .modal p{ margin: 6px 0; font-size: 18px }
    .modal ul{ margin: 6px 0 0 22px; padding: 0 }
    .modal li{ margin: 6px 0; font-size: 18px }
    .modal .m-actions{ display:flex; justify-content:flex-end; gap:10px; margin-top: 10px }

    /* Advice carousel */
    .carousel{
      display:flex; gap: 14px; overflow-x:auto; padding-bottom: 6px;
      scroll-snap-type: x mandatory;
    }
    .carousel::-webkit-scrollbar{ height: 10px }
    .carousel::-webkit-scrollbar-thumb{ background:#e8d494; border-radius:999px }
    .c-item{
      flex: 0 0 86%;
      max-width: 520px; min-width: 320px;
      scroll-snap-align: start;
      background:#fff; border:1px solid #f2dfab; border-radius:14px; padding:14px; box-shadow: var(--shadow);
    }
    .c-item h3{ margin:4px 0 6px; font-size: 22px }
    .c-item .hero{
      width:100%; border-radius:12px; border:1px solid #f2dfab; background:#fff; object-fit:cover; margin-bottom: 8px;
    }
    .c-muted{ color: var(--muted); font-size: 16px }

    /* Goals collapsible */
    .section-head{
      display:flex; align-items:center; justify-content:space-between; gap: 8px; flex-wrap: wrap;
    }
    .goal-wrap{ display:none }
    .goal-card{
      background:#fff; border:1px solid #f2dfab; border-radius:14px; padding:12px; box-shadow: var(--shadow);
    }
    .goal-title{ font-weight:700; font-size: 20px }
    .goal-meta{ display:flex; gap:10px; flex-wrap:wrap; margin-top:6px }

    /* Charts grid (responsive, ไม่ล้น) */
    .charts-grid{
      display:grid; gap: 14px;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    }
    .chart-card{ padding: 12px; border: 1px solid #f2dfab; border-radius: 14px; background: #fff; box-shadow: var(--shadow); }
    .chart-card h3{ font-size: var(--fs-h3); margin: 0 0 8px }
    .chart-box{ width:100%; height: 220px; }
    .chart-box canvas{ width:100% !important; height: 100% !important }

    /* Table (FOOD) */
    table{ width:100%; border-collapse: collapse; font-size: 18px }
    th, td{ border-bottom:1px solid #f2dfab; padding:10px 8px; text-align:left; vertical-align: top }
    th{ background:#fff7d2 }

    /* Register card */
    .hint{ color: var(--muted); font-size: 16px; margin: 4px 0 10px }
    label{ font-size: 18px; font-weight: 600; display:block; margin: 10px 0 6px }
    input, select{
      width:100%; padding: 14px 16px; border: 1px solid #e8d494; border-radius: 12px; background:#fff;
      font-size: 18px; color: var(--ink);
    }
  </style>
</head>
<body>

  <!-- Navbar -->
  <nav class="navbar">
    <div class="nav-inner">
      <div class="brand-dot" aria-hidden="true"></div>
      <div>
        <div class="brand-title">สวีคุมหวาน</div>
        <div class="brand-sub">ข้อมูลส่วนตัว • คลินิกลดยาเบาหวาน (DM Remission) รพ.สวี</div>
      </div>
    </div>
  </nav>

  <!-- Loading -->
  <div id="loading"><div class="box">กำลังโหลดข้อมูล…</div></div>

  <div class="container">
    <!-- Header -->
    <header class="profile">
      <img id="avatar" class="avatar" src="" alt="avatar">
      <div>
        <h1 id="uname" class="h-title">กำลังโหลด…</h1>
        <div id="sub" class="h-sub"></div>
      </div>
    </header>

    <!-- Register form -->
    <div id="reg" class="card" style="display:none">
      <h2>ลงทะเบียนผู้ป่วย</h2>
      <p class="hint">
        คลินิกลดยาเบาหวาน (DM Remission) รพ.สวี จะนำข้อมูลที่ท่านบันทึก
        มาใช้ประมวลผลเพื่อติดตามผลการรักษา โปรดให้ความอนุญาตใช้ข้อมูลที่ท่านบันทึก
      </p>
      <div class="grid">
        <div>
          <label>HN</label>
          <input id="hn" type="text" placeholder="เลขรพ. 9 หลัก (ดูได้จากสมุดประจำตัว)">
        </div>
        <div>
          <label>ชื่อที่อยากให้ LINE เรียก</label>
          <input id="nameuse" type="text" placeholder="เช่น น้องส้ม, พี่แดง, ลุงดำ หรือชื่อจริง">
        </div>
      </div>
      <div class="grid">
        <div>
          <label>เพศ</label>
          <select id="gender">
            <option value="">— เลือกเพศ —</option>
            <option value="Male">ชาย</option>
            <option value="Female">หญิง</option>
            <option value="Other">อื่น ๆ</option>
          </select>
        </div>
        <div>
          <label>อายุ</label>
          <input id="age" type="number" min="1" max="120" placeholder="ตัวอย่าง 45">
        </div>
      </div>
      <div class="row" style="margin:12px 0">
        <input id="consent" type="checkbox" style="transform: scale(1.2); margin-right:8px">
        <span class="muted">ฉันยินยอมให้คลินิกใช้ข้อมูลที่ฉันบันทึก เพื่อการดูแลรักษา</span>
      </div>
      <button id="btnSave" class="btn">บันทึกข้อมูล</button>
    </div>

    <!-- Dashboard -->
    <div id="dash" style="display:none">
      <!-- Profile card -->
      <div class="card">
        <h2>ข้อมูลส่วนตัว</h2>
        <div class="grid">
          <div><div class="pill">ชื่อ</div><div id="p_name" class="value">-</div></div>
          <div><div class="pill">HN</div><div id="p_hn" class="value">-</div></div>
          <div><div class="pill">เพศ</div><div id="p_gender" class="value">-</div></div>
          <div><div class="pill">อายุ</div><div id="p_age" class="value">-</div></div>
        </div>
        <div style="height:10px"></div>
        <div class="muted">ลงทะเบียนเมื่อ <span id="p_reg">-</span></div>
      </div>

      <!-- Advice carousel -->
      <div class="card">
        <h2>คำแนะนำโดยพี่หวี (AI)</h2>
        <div id="adviceCarousel" class="carousel"></div>
      </div>

      <!-- Goals -->
      <div class="card">
        <div class="section-head">
          <h2 id="goalsToggle" style="cursor:pointer">เป้าหมายของฉัน <span id="goalCount" class="pill" style="margin-left:6px">0 เป้าหมาย</span></h2>
          <button id="btnAboutGoals" class="btn" style="padding:10px 14px;font-size:17px">เกี่ยวกับการตั้งเป้าหมาย</button>
        </div>
        <div id="goalsWrap" class="goal-wrap"></div>
      </div>

      <!-- Charts -->
      <div class="card">
        <h2>ประวัติการบันทึกผล</h2>
        <div id="chartsWrap" class="charts-grid"></div>
        <div id="foodWrap"></div>
      </div>
    </div>
  </div>

  <!-- Disclaimer modal (โชว์ครั้งแรก) -->
  <div id="disclaimerModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="disclaimerTitle">
    <div class="panel">
      <div class="m-header">
        <img class="m-avatar" src="https://img2.pic.in.th/pic/ChatGPT-Image-10-..-2568-12_14_20.png" alt="พยาบาลประจำคลินิก">
        <div>
          <h3 id="disclaimerTitle">ประกาศสำคัญ</h3>
          <div class="muted">สวีคุมหวาน • คลินิกลดยาเบาหวาน (DM Remission) รพ.สวี</div>
        </div>
      </div>
      <div class="m-body">
        <p><strong>บริการนี้จัดทำโดยคลินิกลดยาเบาหวาน รพ.สวี</strong> เพื่อช่วยผู้ป่วยติดตามตนเองและรับคำแนะนำเบื้องต้น</p>
        <ul>
          <li>ข้อมูลที่เห็นเกิดจาก <strong>การบันทึกด้วยตนเอง</strong> และการประมวลผลโดย <strong>ปัญญาประดิษฐ์ (AI)</strong> เพื่อการแนะนำ ไม่ใช่การวินิจฉัย</li>
          <li>โปรดใช้วิจารณญาณ และ <strong>ปรึกษาแพทย์/พยาบาล</strong> เมื่อมีข้อสงสัย</li>
          <li>ข้อมูลที่ท่านบันทึกจะถูก <strong>แบ่งปันกับ รพ.สวี</strong> เพื่อช่วยดูแลรักษา</li>
        </ul>
        <p style="margin-top:10px">
          <strong>เป้าหมายของคลินิก</strong> คือช่วยให้ผู้ป่วย <strong>ลด/หยุดยาลดน้ำตาล</strong> และควบคุม
          <strong>HbA1c &lt; 6.5%</strong> ภายใน <strong>3 เดือน</strong> โดยเน้นการควบคุมอาหาร ออกกำลังกาย น้ำหนักตัว การนอน และติดตามค่าน้ำตาลปลายนิ้วอย่างสม่ำเสมอ
        </p>
        <p style="margin-top:10px">
          <strong>วิธีใช้งาน</strong> เมื่อมีการเจาะน้ำตาลก่อน/หลังอาหาร หรือเมื่อวัดความดัน ให้เข้าเมนู
          <em>บันทึกค่า</em> แล้วใส่ข้อมูลเป็นประจำ ระบบจะสรุปความคืบหน้าและประเมินโอกาสสำเร็จของการคุมเบาหวานให้คุณ
        </p>
      </div>
      <div class="m-actions">
        <button id="btnAck" class="btn">รับทราบ</button>
      </div>
    </div>
  </div>

  <!-- SMART GOALS modal -->
  <div id="goalsModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="goalsTitle">
    <div class="panel">
      <div class="m-header">
        <div>
          <h3 id="goalsTitle">การตั้งเป้าหมายแบบ SMART GOALS</h3>
          <div class="muted">ช่วยโฟกัสและติดตามผลได้จริง</div>
        </div>
      </div>
      <div class="m-body">
        <ul>
          <li><strong>S – Specific:</strong> เจาะจง เช่น “เดินเร็ว 30 นาที”</li>
          <li><strong>M – Measurable:</strong> วัดผลได้ เช่น “5 วัน/สัปดาห์”</li>
          <li><strong>A – Achievable:</strong> ทำได้จริง เหมาะกับตัวเอง</li>
          <li><strong>R – Relevant:</strong> สอดคล้องกับสุขภาพ/ชีวิตประจำวัน</li>
          <li><strong>T – Time-bound:</strong> กำหนดกรอบเวลา เช่น “ครบภายใน 4 สัปดาห์”</li>
        </ul>
        <p style="margin-top:10px" class="muted">เมื่อคุณตั้งเป้าหมาย ระบบจะนับถอยหลังให้ และช่วยสะท้อนความก้าวหน้า</p>
      </div>
      <div class="m-actions">
        <button id="btnGoalsClose" class="btn">ปิด</button>
      </div>
    </div>
  </div>

  <script>
    // ====== CONFIG (แก้ตามระบบของคุณ) ======
    const LIFF_ID = '2007840605-zKl7p3Aa';
    const GAS_WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbzP533st24BckpABeSBxDE9d47-ZfBEApKB3xkcgY0u55SGcHX1l9AX3zZ8ZJfNhiQdZA/exec';

    // ====== Helpers ======
    const $  = (s)=>document.querySelector(s);
    const $$ = (s)=>document.querySelectorAll(s);
    const show = (el, v)=> el.style.display = v ? '' : 'none';
    const showLoading = (v)=> { $('#loading').style.display = v ? 'grid' : 'none'; };
    const fmtDate = d => {
      const t = new Date(d); if (isNaN(+t)) return '-';
      const dd = t.getDate().toString().padStart(2,'0');
      const mm = (t.getMonth()+1).toString().padStart(2,'0');
      const yy = t.getFullYear();
      const hh = t.getHours().toString().padStart(2,'0');
      const mi = t.getMinutes().toString().padStart(2,'0');
      return `${dd}/${mm}/${yy} ${hh}:${mi}`;
    };
    const daysLeft = (deadline) => {
      if(!deadline) return null;
      const d = (deadline instanceof Date) ? deadline : new Date(deadline);
      if (isNaN(+d)) return null;
      const ms = d.setHours(23,59,59,999) - Date.now();
      return Math.ceil(ms / 86400000);
    };
    const thaiGender = g => (g==='Male' ? 'ชาย' : g==='Female' ? 'หญิง' : g ? 'อื่น ๆ' : '-');

    const METRIC_THAI = {
      WEIGHT  : {label:'น้ำหนัก', unit:'กก.'},
      BP      : {label:'ความดันโลหิต', unit:'มม.ปรอท'},
      WAIST   : {label:'รอบเอว', unit:'ซม.'},
      SBGM    : {label:'ค่าน้ำตาลปลายนิ้ว', unit:'มก./ดล.'},
      HBA1C   : {label:'HbA1c', unit:'%'},
      BODY_FAT: {label:'ไขมันในร่างกาย', unit:'%'}
    };
    const NUM_METRICS = ['WEIGHT','BP','WAIST','SBGM','HBA1C','BODY_FAT'];

    // ====== API ======
    async function fetchDashboard(userId){
      const url = `${GAS_WEB_APP_URL}?action=getDashboard&userId=${encodeURIComponent(userId)}&_=${Date.now()}`;
      const res = await fetch(url); // GET ตรง ๆ
      if(!res.ok) throw new Error('HTTP '+res.status);
      return await res.json();
    }
    async function submitRegistrationNoCors(payload){
      try{
        await fetch(GAS_WEB_APP_URL, {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ action:'registerUser', ...payload }),
          mode: 'no-cors' // fire-and-forget
        });
        return true;
      }catch(_){ return false; }
    }

    // ====== Renderers ======
    function renderProfile(bundle, displayName, pictureUrl){
      const p = bundle.profile || {};
      $('#avatar').src = p.PictureURL || pictureUrl || '';
      $('#uname').textContent = p.NameUse || p.DisplayName || displayName || 'เพื่อนใหม่ของพี่หวี';
      $('#sub').textContent   = 'แดชบอร์ดสุขภาพของคุณ';

      $('#p_name').textContent   = p.NameUse || p.DisplayName || '-';
      $('#p_hn').textContent     = p.HN || '-';
      $('#p_gender').textContent = thaiGender(p.Gender);
      $('#p_age').textContent    = p.Age || '-';
      $('#p_reg').textContent    = p.Timestamp ? fmtDate(p.Timestamp) : '-';
    }

    function renderAdviceCarousel(bundle){
      const wrap = $('#adviceCarousel');
      wrap.innerHTML = '';

      // การ์ดแนะนำตัวพี่หวี (AI)
      const intro = document.createElement('div');
      intro.className = 'c-item';
      intro.innerHTML = `
        <img class="hero" src="https://img2.pic.in.th/pic/ChatGPT-Image-10-..-2568-12_18_09.png" alt="พี่หวี AI">
        <h3>พี่หวี — พยาบาล AI ของคุณ</h3>
        <div class="c-muted">คาแรกเตอร์: อ่อนโยน ใส่ใจ พูดตรงไปตรงมาแบบพยาบาลคลินิก</div>
        <p style="margin:6px 0 0">
          พี่หวีช่วยสรุปแนวโน้มสุขภาพจากข้อมูลที่คุณบันทึก และให้คำแนะนำเบื้องต้นเพื่อช่วยให้ถึงเป้าหมาย
          <br><span class="c-muted">หมายเหตุ: พี่หวีเป็น AI ให้คำแนะนำทั่วไป ไม่ใช่การวินิจฉัย โปรดปรึกษาแพทย์/พยาบาลเมื่อมีข้อสงสัย</span>
        </p>`;
      wrap.appendChild(intro);

      const adv = bundle.ai_latest || {};
      const keys = Object.keys(adv)
        .map(k => ({ metric:k, ts: new Date(adv[k].ts || adv[k].timestamp || Date.now()), text: adv[k].advice_text || '' }))
        .sort((a,b)=> b.ts - a.ts);

      if (keys.length === 0){
        const empty = document.createElement('div');
        empty.className = 'c-item';
        empty.innerHTML = `<h3>ยังไม่มีคำแนะนำล่าสุด</h3><div class="c-muted">เริ่มจากการ “บันทึกค่า” เป็นประจำ แล้วกลับมาดูคำแนะนำอีกครั้งนะคะ</div>`;
        wrap.appendChild(empty);
      } else {
        keys.forEach(({metric, ts, text})=>{
          const card = document.createElement('div');
          card.className = 'c-item';
          const th = METRIC_THAI[metric]?.label || metric;
          card.innerHTML = `
            <h3>${th}</h3>
            <div class="c-muted">${fmtDate(ts)}</div>
            <p style="white-space:pre-wrap;margin-top:6px">${text || '-'}</p>`;
          wrap.appendChild(card);
        });
      }
    }

    function renderGoals(bundle){
      const list = bundle.goals || [];
      $('#goalCount').textContent = `${list.length} เป้าหมาย`;

      const wrap = $('#goalsWrap');
      wrap.innerHTML = '';

      // เรียงตามวันที่ (ล่าสุดก่อนหรือเก่าก่อนก็ได้ ที่นี่เอาล่าสุดขึ้นก่อน)
      const sorted = [...list].sort((a,b)=> {
        const da = new Date(a.created_timestamp || a.deadline_date || 0).getTime() || 0;
        const db = new Date(b.created_timestamp || b.deadline_date || 0).getTime() || 0;
        return db - da;
      });

      if (sorted.length === 0){
        const div = document.createElement('div');
        div.className = 'muted';
        div.textContent = 'ยังไม่มีเป้าหมาย ลองเริ่มตั้งเป้าหมายจากเมนูในแชตนะคะ';
        wrap.appendChild(div);
      } else {
        sorted.forEach(g=>{
          const dleft = daysLeft(g.deadline_date);
          const status = (String(g.status||'').toUpperCase().includes('DONE') || String(g.status||'').includes('สำเร็จ'))
            ? 'สำเร็จ'
            : 'กำลังดำเนินการ';
          const card = document.createElement('div');
          card.className = 'goal-card';
          card.innerHTML = `
            <div class="goal-title">${g.goal_category || '-'} • ${g.goal_specific || '-'}</div>
            <div class="goal-meta">
              <span class="tag">ค่าเป้า: ${g.target_value || '-'} ${g.target_unit || ''}</span>
              <span class="tag">วัดผล: ${g.goal_measurable || '-'}</span>
              <span class="tag">ความเกี่ยวข้อง: ${g.goal_relevant || '-'}</span>
            </div>
            <div class="row" style="margin-top:8px">
              <span class="pill">เส้นตาย: ${g.deadline_date ? fmtDate(g.deadline_date).split(' ')[0] : '-'}</span>
              <span class="pill">${dleft!=null ? 'เหลืออีก ' + dleft + ' วัน' : '—'}</span>
              <span class="pill">${status}</span>
            </div>`;
          wrap.appendChild(card);
        });
      }
    }

    function renderChartsAndFood(bundle){
      const chartsWrap = $('#chartsWrap');
      const foodWrap   = $('#foodWrap');
      chartsWrap.innerHTML = '';
      foodWrap.innerHTML   = '';

      const series = bundle.events || {};
      // เฉพาะ metric แบบตัวเลข
      const metricKeys = Object.keys(series).filter(k => NUM_METRICS.includes(k));
      if (metricKeys.length === 0){
        const div = document.createElement('div');
        div.className = 'muted';
        div.textContent = 'ยังไม่มีประวัติการบันทึกที่เป็นตัวเลข';
        chartsWrap.appendChild(div);
      } else {
        metricKeys.forEach(k=>{
          const card = document.createElement('div');
          card.className = 'chart-card';
          const th = METRIC_THAI[k]?.label || k;
          const unit = METRIC_THAI[k]?.unit ? ` (${METRIC_THAI[k].unit})` : '';
          card.innerHTML = `<h3>${th}${unit}</h3><div class="chart-box"><canvas></canvas></div>`;
          chartsWrap.appendChild(card);

          const ctx = card.querySelector('canvas').getContext('2d');
          const rows = (series[k] || []).map(r => ({...r, ts: new Date(r.ts)})).sort((a,b)=> a.ts - b.ts);
          const labels = rows.map(r=> fmtDate(r.ts));

          if (k==='BP'){
            const sbp = rows.map(r=> (typeof r.v1==='number'? r.v1 : parseFloat(r.v1) || null));
            const dbp = rows.map(r=> (typeof r.v2==='number'? r.v2 : parseFloat(r.v2) || null));
            new Chart(ctx, {
              type: 'line',
              data: { labels, datasets: [
                { label: 'ตัวบน (SBP)', data: sbp },
                { label: 'ตัวล่าง (DBP)', data: dbp }
              ]},
              options: { responsive:true, maintainAspectRatio:false, interaction:{mode:'nearest', intersect:false} }
            });
          } else {
            const v = rows.map(r=> (typeof r.v1==='number'? r.v1 : (parseFloat(r.v1) || null)));
            new Chart(ctx, {
              type: 'line',
              data: { labels, datasets: [{ label: th, data: v }]},
              options: { responsive:true, maintainAspectRatio:false, interaction:{mode:'nearest', intersect:false} }
            });
          }
        });
      }

      // FOOD เป็นตาราง
      if (series.FOOD && series.FOOD.length){
        const card = document.createElement('div');
        card.className = 'card';
        card.innerHTML = `<h2>บันทึกอาหาร (FOOD)</h2>
          <div class="table-wrap" style="overflow:auto">
            <table>
              <thead><tr><th>วันที่เวลา</th><th>รายละเอียด</th></tr></thead>
              <tbody id="foodBody"></tbody>
            </table>
          </div>`;
        foodWrap.appendChild(card);
        const body = card.querySelector('#foodBody');
        series.FOOD
          .map(r => ({...r, ts: new Date(r.ts)}))
          .sort((a,b)=> b.ts - a.ts)
          .forEach(r=>{
            const tr = document.createElement('tr');
            tr.innerHTML = `<td>${fmtDate(r.ts)}</td><td>${(r.vt || '').toString().trim() || '-'}</td>`;
            body.appendChild(tr);
          });
      }
    }

    function renderRegister(userId, displayName, pictureUrl){
      show($('#reg'), true);
      show($('#dash'), false);

      $('#avatar').src = pictureUrl || 'https://placehold.co/160x160/fff7d2/3c2e17?text=LINE';
      $('#uname').textContent = displayName || 'เพื่อนใหม่ของพี่หวี';
      $('#sub').textContent = 'กรุณาลงทะเบียนเพื่อเริ่มใช้งาน';

      $('#btnSave').onclick = async ()=>{
        const payload = {
          userId, displayName, pictureUrl,
          hn: $('#hn').value.trim(),
          name_use: $('#nameuse').value.trim() || displayName,
          gender: $('#gender').value,
          age: $('#age').value.trim(),
          consent: $('#consent').checked
        };
        if (!payload.consent){ alert('โปรดยอมรับการใช้งานข้อมูลเพื่อการดูแลรักษา'); return; }
        $('#btnSave').disabled = true; showLoading(true);
        const ok = await submitRegistrationNoCors(payload);
        showLoading(false); $('#btnSave').disabled = false;
        if (ok) location.reload(); else alert('ส่งข้อมูลไม่สำเร็จ ลองใหม่อีกครั้งค่ะ');
      };
    }

    function renderDashboard(bundle, userId, displayName, pictureUrl){
      show($('#reg'), false);
      show($('#dash'), true);
      renderProfile(bundle, displayName, pictureUrl);
      renderAdviceCarousel(bundle);
      renderGoals(bundle);
      renderChartsAndFood(bundle);

      // เป้าหมาย: toggle แสดง/ซ่อน
      const goalsWrap = $('#goalsWrap');
      const toggle = $('#goalsToggle');
      goalsWrap.style.display = 'none';
      toggle.onclick = ()=> {
        const opened = goalsWrap.style.display !== 'none';
        goalsWrap.style.display = opened ? 'none' : '';
      };
    }

    // ====== Modals ======
    function openModal(el){ el.style.display = 'grid'; }
    function closeModal(el){ el.style.display = 'none'; }

    function maybeShowDisclaimer(){
      const key = 'dm_disclaimer_ack_v1';
      if (!localStorage.getItem(key)){
        openModal($('#disclaimerModal'));
        $('#btnAck').onclick = ()=> {
          localStorage.setItem(key, '1');
          closeModal($('#disclaimerModal'));
        };
      }
    }

    function initGoalsModal(){
      $('#btnAboutGoals').onclick = ()=> openModal($('#goalsModal'));
      $('#btnGoalsClose').onclick = ()=> closeModal($('#goalsModal'));
      // คลิกพื้นหลังเพื่อปิด
      $$('#goalsModal, #disclaimerModal').forEach(m=>{
        m.addEventListener('click', (e)=> { if (e.target === m) closeModal(m); });
      });
    }

    // ====== Boot ======
    async function init(){
      showLoading(true);
      try{
        await liff.init({ liffId: LIFF_ID });
        if(!liff.isLoggedIn()){ liff.login(); return; }

        initGoalsModal();
        maybeShowDisclaimer();

        const ctx = liff.getContext?.() || {};
        const tok = liff.getDecodedIDToken?.() || {};
        const prof = await liff.getProfile();

        const userId = ctx.userId || tok.sub || prof.userId || '';
        const displayName = prof.displayName || '';
        const pictureUrl  = prof.pictureUrl || '';

        $('#avatar').src = pictureUrl || 'https://placehold.co/160x160/fff7d2/3c2e17?text=LINE';
        $('#uname').textContent = displayName || 'เพื่อนใหม่ของพี่หวี';
        $('#sub').textContent = 'กำลังโหลดข้อมูลจากคลินิก…';

        const bundle = await fetchDashboard(userId);
        if (!bundle || bundle.ok === false){
          $('#sub').textContent = 'โหลดข้อมูลไม่สำเร็จ';
          renderRegister(userId, displayName, pictureUrl);
        } else if (!bundle.profile){
          $('#sub').textContent = '';
          renderRegister(userId, displayName, pictureUrl);
        } else {
          $('#sub').textContent = '';
          renderDashboard(bundle, userId, displayName, pictureUrl);
        }
      }catch(e){
        console.error('init error', e);
        $('#sub').textContent = 'มีปัญหาในการเชื่อมต่อ LIFF';
      }finally{
        showLoading(false);
      }
    }

    window.addEventListener('load', init);
  </script>
</body>
</html>
